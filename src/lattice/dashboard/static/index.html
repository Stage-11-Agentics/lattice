<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lattice Dashboard</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f8f9fa;color:#212529;line-height:1.5}
a{color:#0d6efd;text-decoration:none}
a:hover{text-decoration:underline}

/* Nav */
.nav{background:#fff;border-bottom:1px solid #dee2e6;padding:8px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;position:sticky;top:0;z-index:10}
.nav-brand{font-weight:700;font-size:1.1rem;margin-right:8px;color:#212529}
.nav-tab{padding:4px 12px;border-radius:4px;cursor:pointer;font-size:.875rem;color:#495057;border:1px solid transparent}
.nav-tab:hover{background:#e9ecef}
.nav-tab.active{background:#0d6efd;color:#fff;border-color:#0d6efd}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.75rem;font-weight:600}
.badge-stat{background:#e9ecef;color:#495057}
.btn{padding:4px 12px;border:1px solid #dee2e6;border-radius:4px;background:#fff;cursor:pointer;font-size:.875rem}
.btn:hover{background:#e9ecef}
.btn-icon{padding:4px 8px;font-size:1rem;line-height:1;border:1px solid #dee2e6;border-radius:4px;background:#fff;cursor:pointer}
.btn-icon:hover{background:#e9ecef}

/* Content */
.content{max-width:1400px;margin:0 auto;padding:16px}

/* Loading & errors */
.loading{text-align:center;padding:48px;color:#6c757d}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid #dee2e6;border-top-color:#0d6efd;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.error-box{background:#fff3cd;border:1px solid #ffc107;border-radius:6px;padding:16px;margin:16px 0;text-align:center}
.error-box .btn{margin-top:8px}
.empty{text-align:center;padding:48px;color:#6c757d}
.empty code{background:#e9ecef;padding:2px 6px;border-radius:3px;font-size:.875rem}

/* Toast notifications */
.toast-container{position:fixed;top:60px;right:16px;z-index:100;display:flex;flex-direction:column;gap:8px}
.toast{padding:10px 16px;border-radius:6px;font-size:.85rem;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15);animation:toastIn .3s ease;max-width:360px;word-break:break-word}
.toast-success{background:#198754}
.toast-error{background:#dc3545}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

/* Board view */
.board{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;align-items:start}
.board-col{background:#fff;border:1px solid #dee2e6;border-radius:6px;min-height:auto;transition:box-shadow .2s,border-color .2s}
.board-col-header{padding:8px 12px;font-weight:600;font-size:.875rem;border-bottom:1px solid #dee2e6;display:flex;justify-content:space-between;align-items:center;border-radius:6px 6px 0 0;position:relative}
.board-col-header .count{font-weight:400;color:rgba(255,255,255,.8);font-size:.75rem}
.board-col-header .lane-color-btn{position:absolute;right:4px;top:4px;width:20px;height:20px;border:2px solid rgba(255,255,255,.6);border-radius:50%;cursor:pointer;padding:0;background:transparent;opacity:0;transition:opacity .2s}
.board-col-header:hover .lane-color-btn{opacity:1}
.board-col-body{padding:8px;min-height:60px}

/* Drag and drop states */
.board-col.drag-over{border-color:#0d6efd;box-shadow:0 0 0 2px rgba(13,110,253,.25)}
.board-col.drag-invalid{border-color:#dc3545;box-shadow:0 0 0 2px rgba(220,53,69,.25)}
.card.dragging{opacity:.4;transform:scale(.95)}
.card{background:#f8f9fa;border:1px solid #e9ecef;border-radius:4px;padding:8px 10px;margin-bottom:6px;cursor:grab;font-size:.85rem;transition:box-shadow .15s,opacity .15s,transform .15s}
.card:hover{box-shadow:0 1px 4px rgba(0,0,0,.1)}
.card:active{cursor:grabbing}
.card-title{font-weight:600;margin-bottom:4px;word-break:break-word}
.card-meta{display:flex;gap:6px;flex-wrap:wrap;align-items:center}

/* Priority badges */
.pri-critical{background:#dc3545;color:#fff}
.pri-high{background:#fd7e14;color:#fff}
.pri-medium{background:#0d6efd;color:#fff}
.pri-low{background:#6c757d;color:#fff}

/* Type badges */
.type-badge{background:#e9ecef;color:#495057}

/* Status colors for column headers (fallback) */
.status-done .board-col-header{background:#198754;color:#fff}
.status-cancelled .board-col-header{background:#6c757d;color:#fff}
.status-in_planning .board-col-header{background:#17a2b8;color:#fff}
.status-planned .board-col-header{background:#20c997;color:#fff}
.status-in_implementation .board-col-header{background:#0d6efd;color:#fff}
.status-implemented .board-col-header{background:#0dcaf0;color:#fff}
.status-in_review .board-col-header{background:#6f42c1;color:#fff}
.status-backlog .board-col-header{background:#adb5bd;color:#fff}

/* List view */
.filters{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.filters select,.filters input{padding:4px 8px;border:1px solid #dee2e6;border-radius:4px;font-size:.85rem}
.filters input{min-width:200px}
.filters label{font-size:.85rem;display:flex;align-items:center;gap:4px;cursor:pointer}
table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #dee2e6;border-radius:6px;overflow:hidden;font-size:.85rem}
th{text-align:left;padding:8px 10px;background:#f8f9fa;border-bottom:2px solid #dee2e6;font-weight:600;white-space:nowrap}
td{padding:6px 10px;border-bottom:1px solid #f0f0f0;vertical-align:top}
tr:hover td{background:#f8f9fa}
.id-cell{font-family:monospace;font-size:.8rem;color:#6c757d;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Detail view */
.detail{background:#fff;border:1px solid #dee2e6;border-radius:6px;padding:20px;max-width:900px}
.detail-header{margin-bottom:16px}
.detail-title{font-size:1.3rem;font-weight:700;margin-bottom:4px}
.detail-meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.detail-field{margin-bottom:12px}
.detail-field dt{font-weight:600;font-size:.85rem;color:#6c757d;margin-bottom:2px}
.detail-field dd{font-size:.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.detail-section{margin-top:20px;padding-top:16px;border-top:1px solid #dee2e6}
.detail-section h3{font-size:.95rem;font-weight:600;margin-bottom:8px}
.event-item{padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:.85rem;display:flex;gap:8px;flex-wrap:wrap}
.event-item:last-child{border-bottom:none}
.event-ts{color:#6c757d;font-family:monospace;font-size:.8rem;white-space:nowrap}
.event-type{font-weight:600}
.event-actor{color:#6c757d}
.back-link{display:inline-block;margin-bottom:12px;font-size:.9rem}
.archived-badge{background:#ffc107;color:#212529;padding:2px 8px;border-radius:4px;font-size:.8rem;font-weight:600}
.rel-list,.art-list{list-style:none;padding:0}
.rel-list li,.art-list li{padding:4px 0;font-size:.85rem}

/* Activity view */
.activity-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid #f0f0f0;font-size:.85rem;align-items:flex-start}
.activity-item:last-child{border-bottom:none}
.activity-list{background:#fff;border:1px solid #dee2e6;border-radius:6px;padding:12px 16px}

/* Settings panel */
.settings-panel{position:fixed;top:0;right:0;width:320px;height:100%;background:#fff;border-left:1px solid #dee2e6;z-index:20;box-shadow:-2px 0 8px rgba(0,0,0,.1);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .25s ease}
.settings-panel.open{transform:translateX(0)}
.settings-header{padding:12px 16px;border-bottom:1px solid #dee2e6;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:.95rem}
.settings-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:#6c757d;padding:4px}
.settings-close:hover{color:#212529}
.settings-body{padding:16px;overflow-y:auto;flex:1}
.settings-group{margin-bottom:20px}
.settings-group label{display:block;font-size:.85rem;font-weight:600;color:#495057;margin-bottom:4px}
.settings-group input[type="text"],.settings-group input[type="url"]{width:100%;padding:6px 8px;border:1px solid #dee2e6;border-radius:4px;font-size:.85rem}
.settings-group .hint{font-size:.75rem;color:#6c757d;margin-top:2px}
.settings-group .btn{margin-top:6px}
.lane-color-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:.85rem}
.lane-color-row .lane-name{min-width:90px}
.lane-color-row input[type="color"]{width:32px;height:28px;border:1px solid #dee2e6;border-radius:4px;padding:1px;cursor:pointer}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:50;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:#fff;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.2);width:90%;max-width:560px;max-height:90vh;overflow-y:auto;animation:slideUp .2s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-header{padding:16px 20px;border-bottom:1px solid #dee2e6;display:flex;justify-content:space-between;align-items:center}
.modal-header h2{font-size:1.1rem;font-weight:700;margin:0}
.modal-body{padding:20px}
.modal-footer{padding:12px 20px;border-top:1px solid #dee2e6;display:flex;justify-content:flex-end;gap:8px}

/* Form controls */
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:.85rem;font-weight:600;color:#495057;margin-bottom:4px}
.form-control{width:100%;padding:6px 10px;border:1px solid #dee2e6;border-radius:4px;font-size:.875rem;font-family:inherit;line-height:1.5}
.form-control:focus{outline:none;border-color:#0d6efd;box-shadow:0 0 0 2px rgba(13,110,253,.15)}
textarea.form-control{min-height:80px;resize:vertical}
select.form-control{cursor:pointer}

/* Buttons */
.btn-primary{background:#0d6efd;color:#fff;border-color:#0d6efd}
.btn-primary:hover{background:#0b5ed7}
.btn-danger{background:#dc3545;color:#fff;border-color:#dc3545}
.btn-danger:hover{background:#bb2d3b}
.btn-sm{padding:2px 8px;font-size:.8rem}
.btn-new-task{background:#0d6efd;color:#fff;border-color:#0d6efd;font-weight:600}
.btn-new-task:hover{background:#0b5ed7}

/* Detail view: inline editing */
.editable{cursor:pointer;border-bottom:1px dashed transparent;transition:border-color .15s}
.editable:hover{border-bottom-color:#0d6efd}
.inline-edit{display:flex;gap:6px;align-items:center}
.inline-edit .form-control{flex:1}
.inline-edit .btn{flex-shrink:0}

/* Detail view: action bar */
.detail-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.detail-actions select{padding:4px 8px;border:1px solid #dee2e6;border-radius:4px;font-size:.85rem}

/* Comment section */
.comment-form{display:flex;gap:8px;margin-top:8px}
.comment-form textarea{flex:1;min-height:60px}
.comment-item{padding:8px;background:#f8f9fa;border-radius:4px;margin-bottom:6px;font-size:.85rem}
.comment-item .comment-meta{font-size:.8rem;color:#6c757d;margin-bottom:2px}
.comment-item .comment-body{white-space:pre-wrap}
</style>
</head>
<body>

<div class="nav">
  <span class="nav-brand">Lattice</span>
  <span class="nav-tab" data-view="board">Board</span>
  <span class="nav-tab" data-view="list">List</span>
  <span class="nav-tab" data-view="activity">Activity</span>
  <div class="nav-right">
    <span id="stats-badges"></span>
    <button type="button" class="btn btn-new-task" id="new-task-btn" title="Create new task">+ New Task</button>
    <button type="button" class="btn-icon" id="settings-btn" title="Dashboard Settings">&#9881;</button>
    <button type="button" class="btn" id="refresh-btn" title="Refresh">Refresh</button>
  </div>
</div>

<div class="content" id="app">
  <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
</div>

<div class="toast-container" id="toast-container"></div>

<div class="modal-overlay" id="create-task-modal" style="display:none">
  <div class="modal">
    <div class="modal-header">
      <h2>Create Task</h2>
      <button class="settings-close" id="create-task-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="ct-title">Title *</label>
        <input type="text" class="form-control" id="ct-title" placeholder="Task title">
      </div>
      <div class="form-group">
        <label for="ct-type">Type</label>
        <select class="form-control" id="ct-type"></select>
      </div>
      <div class="form-group">
        <label for="ct-priority">Priority</label>
        <select class="form-control" id="ct-priority">
          <option value="critical">critical</option>
          <option value="high">high</option>
          <option value="medium" selected>medium</option>
          <option value="low">low</option>
        </select>
      </div>
      <div class="form-group">
        <label for="ct-description">Description</label>
        <textarea class="form-control" id="ct-description" placeholder="Optional description"></textarea>
      </div>
      <div class="form-group">
        <label for="ct-tags">Tags</label>
        <input type="text" class="form-control" id="ct-tags" placeholder="Comma-separated tags">
      </div>
      <div class="form-group">
        <label for="ct-assigned">Assigned To</label>
        <input type="text" class="form-control" id="ct-assigned" placeholder="e.g. human:atin, agent:claude">
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" id="create-task-cancel">Cancel</button>
      <button type="button" class="btn btn-primary" id="create-task-submit">Create Task</button>
    </div>
  </div>
</div>

<div class="settings-panel" id="settings-panel">
  <div class="settings-header">
    <span>Dashboard Settings</span>
    <button class="settings-close" id="settings-close">&times;</button>
  </div>
  <div class="settings-body">
    <div class="settings-group">
      <label for="bg-image-input">Background Image URL</label>
      <input type="text" id="bg-image-input" placeholder="https://example.com/bg.jpg">
      <div class="hint">Set a background image for the board view. Leave empty to clear.</div>
      <button type="button" class="btn" id="bg-image-save">Apply</button>
      <button type="button" class="btn" id="bg-image-clear">Clear</button>
    </div>
    <div class="settings-group">
      <label>Lane Colors</label>
      <div class="hint" style="margin-bottom:8px">Click a color to customize each swim lane header.</div>
      <div id="lane-colors-list"></div>
      <button type="button" class="btn" id="lane-colors-save" style="margin-top:8px">Apply Lane Colors</button>
      <button type="button" class="btn" id="lane-colors-reset" style="margin-top:4px">Reset to Defaults</button>
    </div>
  </div>
</div>

<script>
(function(){
"use strict";

// --- Default lane colors (fallback) ---
var DEFAULT_LANE_COLORS = {
  backlog: "#adb5bd",
  in_planning: "#17a2b8",
  planned: "#20c997",
  in_implementation: "#0d6efd",
  implemented: "#0dcaf0",
  in_review: "#6f42c1",
  done: "#198754",
  cancelled: "#6c757d"
};

// --- State ---
var config = null;
var tasks = [];
var archivedTasks = null;
var currentView = "board";
var draggedTaskId = null;
var draggedFromStatus = null;

// --- API ---
async function api(path, opts) {
  var r = await fetch(path, opts);
  var body = await r.json();
  if (!body.ok) throw new Error(body.error ? body.error.message : "API error");
  return body.data;
}

async function apiPost(path, data) {
  return api(path, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  });
}

// --- Toast Notifications ---
function showToast(message, type) {
  var container = document.getElementById("toast-container");
  var toast = document.createElement("div");
  toast.className = "toast toast-" + (type || "success");
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(function() {
    toast.style.opacity = "0";
    toast.style.transition = "opacity .3s";
    setTimeout(function() { toast.remove(); }, 300);
  }, 3000);
}

// --- Init ---
async function init() {
  var hash = location.hash.slice(1) || "/board";
  var parts = hash.split("/").filter(Boolean);
  currentView = parts[0] || "board";
  updateTabs();

  try {
    var results = await Promise.all([api("/api/config"), api("/api/tasks")]);
    config = results[0];
    tasks = results[1];
    updateStatsBadges();
    populateLaneColorSettings();
    loadBackgroundSetting();
    await route(hash);
  } catch(e) {
    showError(e.message);
  }
}

function updateTabs() {
  document.querySelectorAll(".nav-tab").forEach(function(el) {
    el.classList.toggle("active", el.dataset.view === currentView);
  });
}

function updateStatsBadges() {
  var el = document.getElementById("stats-badges");
  var total = tasks.length;
  var byStatus = {};
  tasks.forEach(function(t) { byStatus[t.status] = (byStatus[t.status]||0)+1; });
  var html = '<span class="badge badge-stat">' + total + " tasks</span>";
  for (var s in byStatus) {
    html += ' <span class="badge badge-stat">' + s + ": " + byStatus[s] + "</span>";
  }
  el.innerHTML = html;
}

// --- Routing ---
async function route(hash) {
  var h = (hash || "/board").replace(/^#?\/?/, "/");
  var parts = h.split("/").filter(Boolean);
  var view = parts[0] || "board";
  currentView = view === "task" ? currentView : view;
  updateTabs();

  if (view === "board") renderBoard();
  else if (view === "list") renderList();
  else if (view === "activity") await renderActivity();
  else if (view === "task" && parts[1]) await renderDetail(parts[1]);
  else renderBoard();
}

window.addEventListener("hashchange", function() { route(location.hash.slice(1)); });

// --- Dashboard config helpers ---
function getDashboardConfig() {
  return (config && config.dashboard) || {};
}

function getLaneColor(status) {
  var dc = getDashboardConfig();
  if (dc.lane_colors && dc.lane_colors[status]) return dc.lane_colors[status];
  return DEFAULT_LANE_COLORS[status] || "#6c757d";
}

function getBackgroundImage() {
  var dc = getDashboardConfig();
  return dc.background_image || "";
}

// --- Background image ---
function applyBackgroundImage() {
  var app = document.getElementById("app");
  var bg = getBackgroundImage();
  if (bg) {
    app.style.backgroundImage = "url(" + bg + ")";
    app.style.backgroundSize = "cover";
    app.style.backgroundPosition = "center";
    app.style.backgroundRepeat = "no-repeat";
    app.style.backgroundAttachment = "fixed";
    app.style.minHeight = "calc(100vh - 50px)";
  } else {
    app.style.backgroundImage = "";
    app.style.backgroundSize = "";
    app.style.backgroundPosition = "";
    app.style.backgroundRepeat = "";
    app.style.backgroundAttachment = "";
    app.style.minHeight = "";
  }
}

function loadBackgroundSetting() {
  var input = document.getElementById("bg-image-input");
  input.value = getBackgroundImage();
  applyBackgroundImage();
}

// --- Lane color settings ---
function populateLaneColorSettings() {
  var container = document.getElementById("lane-colors-list");
  if (!config || !config.workflow) return;
  var statuses = config.workflow.statuses || [];
  var html = "";
  statuses.forEach(function(s) {
    var color = getLaneColor(s);
    html += '<div class="lane-color-row">';
    html += '<span class="lane-name">' + esc(s) + '</span>';
    html += '<input type="color" data-status="' + esc(s) + '" value="' + esc(color) + '">';
    html += '</div>';
  });
  container.innerHTML = html;
}

// --- Board View ---
function renderBoard() {
  var app = document.getElementById("app");
  if (!config || !tasks) { app.innerHTML = '<div class="loading"><div class="spinner"></div></div>'; return; }

  applyBackgroundImage();

  var statuses = config.workflow ? config.workflow.statuses : [];
  if (tasks.length === 0) {
    app.innerHTML = '<div class="empty"><p>No tasks yet.</p><p><button class="btn btn-primary" onclick="showCreateTaskModal()">+ Create your first task</button></p></div>';
    return;
  }

  var transitions = (config.workflow && config.workflow.transitions) || {};
  var grouped = {};
  statuses.forEach(function(s) { grouped[s] = []; });
  tasks.forEach(function(t) {
    var s = t.status || "unknown";
    if (!grouped[s]) grouped[s] = [];
    grouped[s].push(t);
  });

  var html = '<div class="board">';
  var allStatuses = statuses.concat(Object.keys(grouped).filter(function(s) { return !statuses.includes(s); }));
  allStatuses.forEach(function(status) {
    var items = grouped[status] || [];
    var cls = "status-" + status.replace(/\s+/g,"_");
    var laneColor = getLaneColor(status);
    html += '<div class="board-col ' + cls + '" data-status="' + esc(status) + '"';
    html += ' ondragover="window._boardDragOver(event)" ondragleave="window._boardDragLeave(event)" ondrop="window._boardDrop(event)">';
    html += '<div class="board-col-header" style="background:' + esc(laneColor) + ';color:#fff">';
    html += '<span>' + esc(status) + '</span>';
    html += '<span class="count">' + items.length + '</span>';
    html += '</div>';
    html += '<div class="board-col-body">';
    items.forEach(function(t) {
      html += '<div class="card" draggable="true" data-task-id="' + esc(t.id) + '" data-task-status="' + esc(t.status || "") + '"';
      html += ' ondragstart="window._boardDragStart(event)" ondragend="window._boardDragEnd(event)">';
      html += '<div class="card-title">' + esc(t.title || "Untitled") + "</div>";
      html += '<div class="card-meta">';
      if (t.priority) html += '<span class="badge pri-' + esc(t.priority) + '">' + esc(t.priority) + "</span>";
      if (t.type) html += '<span class="badge type-badge">' + esc(t.type) + "</span>";
      if (t.assigned_to) html += '<span style="color:#6c757d;font-size:.8rem">' + esc(t.assigned_to) + "</span>";
      html += "</div></div>";
    });
    if (items.length === 0) html += '<div style="color:#adb5bd;font-size:.8rem;padding:8px;text-align:center">No tasks</div>';
    html += "</div></div>";
  });
  html += "</div>";
  app.innerHTML = html;

  // Add click handlers for card navigation (separate from drag)
  app.querySelectorAll(".card").forEach(function(card) {
    card.addEventListener("click", function(e) {
      // Only navigate if this was a real click, not end of drag
      if (!card.classList.contains("was-dragged")) {
        location.hash = "#/task/" + card.dataset.taskId;
      }
      card.classList.remove("was-dragged");
    });
  });
}

// --- Drag and Drop ---
window._boardDragStart = function(e) {
  var card = e.target.closest(".card");
  if (!card) return;
  draggedTaskId = card.dataset.taskId;
  draggedFromStatus = card.dataset.taskStatus;
  card.classList.add("dragging");
  e.dataTransfer.effectAllowed = "move";
  e.dataTransfer.setData("text/plain", draggedTaskId);

  // Highlight valid drop targets
  var transitions = (config.workflow && config.workflow.transitions) || {};
  var allowedTargets = transitions[draggedFromStatus] || [];
  setTimeout(function() {
    document.querySelectorAll(".board-col").forEach(function(col) {
      var colStatus = col.dataset.status;
      if (colStatus === draggedFromStatus) return;
      if (allowedTargets.includes(colStatus)) {
        col.style.opacity = "1";
      } else {
        col.style.opacity = "0.5";
      }
    });
  }, 0);
};

window._boardDragEnd = function(e) {
  var card = e.target.closest(".card");
  if (card) {
    card.classList.remove("dragging");
    card.classList.add("was-dragged");
  }
  draggedTaskId = null;
  draggedFromStatus = null;
  document.querySelectorAll(".board-col").forEach(function(col) {
    col.classList.remove("drag-over", "drag-invalid");
    col.style.opacity = "";
  });
};

window._boardDragOver = function(e) {
  e.preventDefault();
  var col = e.target.closest(".board-col");
  if (!col || !draggedFromStatus) return;
  var targetStatus = col.dataset.status;
  if (targetStatus === draggedFromStatus) return;

  var transitions = (config.workflow && config.workflow.transitions) || {};
  var allowed = transitions[draggedFromStatus] || [];
  if (allowed.includes(targetStatus)) {
    e.dataTransfer.dropEffect = "move";
    col.classList.add("drag-over");
    col.classList.remove("drag-invalid");
  } else {
    e.dataTransfer.dropEffect = "none";
    col.classList.add("drag-invalid");
    col.classList.remove("drag-over");
  }
};

window._boardDragLeave = function(e) {
  var col = e.target.closest(".board-col");
  if (col) {
    col.classList.remove("drag-over", "drag-invalid");
  }
};

window._boardDrop = async function(e) {
  e.preventDefault();
  var col = e.target.closest(".board-col");
  if (!col || !draggedTaskId || !draggedFromStatus) return;

  var targetStatus = col.dataset.status;
  col.classList.remove("drag-over", "drag-invalid");

  if (targetStatus === draggedFromStatus) return;

  var transitions = (config.workflow && config.workflow.transitions) || {};
  var allowed = transitions[draggedFromStatus] || [];
  if (!allowed.includes(targetStatus)) {
    showToast("Invalid transition: " + draggedFromStatus + " to " + targetStatus, "error");
    return;
  }

  try {
    await apiPost("/api/tasks/" + draggedTaskId + "/status", {
      status: targetStatus,
      actor: "dashboard:web"
    });
    showToast("Moved to " + targetStatus, "success");
    // Refresh tasks and re-render
    tasks = await api("/api/tasks");
    updateStatsBadges();
    renderBoard();
  } catch(err) {
    showToast(err.message, "error");
  }
};

// --- List View ---
function renderList() {
  var app = document.getElementById("app");
  if (!config) return;

  var statuses = config.workflow ? config.workflow.statuses : [];
  var types = config.task_types || [];

  var html = '<div class="filters">';
  html += '<input type="text" id="f-search" placeholder="Search title...">';
  html += '<select id="f-status"><option value="">All statuses</option>';
  statuses.forEach(function(s) { html += '<option value="'+esc(s)+'">'+esc(s)+"</option>"; });
  html += "</select>";
  html += '<select id="f-type"><option value="">All types</option>';
  types.forEach(function(t) { html += '<option value="'+esc(t)+'">'+esc(t)+"</option>"; });
  html += "</select>";
  html += '<select id="f-priority"><option value="">All priorities</option>';
  ["critical","high","medium","low"].forEach(function(p) { html += '<option value="'+p+'">'+p+"</option>"; });
  html += "</select>";
  html += '<label><input type="checkbox" id="f-archived"> Show archived</label>';
  html += "</div>";
  html += '<div id="list-table"></div>';
  app.innerHTML = html;

  document.getElementById("f-search").addEventListener("input", applyListFilters);
  document.getElementById("f-status").addEventListener("change", applyListFilters);
  document.getElementById("f-type").addEventListener("change", applyListFilters);
  document.getElementById("f-priority").addEventListener("change", applyListFilters);
  document.getElementById("f-archived").addEventListener("change", async function() {
    if (this.checked && archivedTasks === null) {
      try { archivedTasks = await api("/api/archived"); } catch(e) { archivedTasks = []; }
    }
    applyListFilters();
  });
  applyListFilters();
}

function applyListFilters() {
  var search = (document.getElementById("f-search").value || "").toLowerCase();
  var status = document.getElementById("f-status").value;
  var type = document.getElementById("f-type").value;
  var priority = document.getElementById("f-priority").value;
  var showArchived = document.getElementById("f-archived").checked;

  var items = tasks.slice();
  if (showArchived && archivedTasks) items = items.concat(archivedTasks);

  items = items.filter(function(t) {
    if (search && !(t.title||"").toLowerCase().includes(search)) return false;
    if (status && t.status !== status) return false;
    if (type && t.type !== type) return false;
    if (priority && t.priority !== priority) return false;
    return true;
  });

  if (items.length === 0 && tasks.length === 0) {
    document.getElementById("list-table").innerHTML = '<div class="empty"><p>No tasks yet.</p></div>';
    return;
  }
  if (items.length === 0) {
    document.getElementById("list-table").innerHTML = '<div class="empty"><p>No tasks match your filters.</p></div>';
    return;
  }

  var html = "<table><thead><tr>";
  html += "<th>ID</th><th>Title</th><th>Status</th><th>Priority</th><th>Type</th><th>Assigned</th><th>Updated</th>";
  html += "</tr></thead><tbody>";
  items.forEach(function(t) {
    var shortId = t.id ? t.id.slice(0,18) + "..." : "?";
    var updated = t.updated_at ? t.updated_at.slice(0,16).replace("T"," ") : "";
    html += '<tr style="cursor:pointer" onclick="location.hash=\'#/task/' + esc(t.id) + '\'">';
    html += '<td class="id-cell" title="' + esc(t.id) + '">' + esc(shortId) + "</td>";
    html += "<td>" + esc(t.title || "Untitled") + (t.archived ? ' <span class="archived-badge">archived</span>' : "") + "</td>";
    html += "<td>" + esc(t.status || "") + "</td>";
    html += "<td>";
    if (t.priority) html += '<span class="badge pri-' + esc(t.priority) + '">' + esc(t.priority) + "</span>";
    html += "</td>";
    html += "<td>" + esc(t.type || "") + "</td>";
    html += "<td>" + esc(t.assigned_to || "") + "</td>";
    html += "<td>" + esc(updated) + "</td>";
    html += "</tr>";
  });
  html += "</tbody></table>";
  document.getElementById("list-table").innerHTML = '<div style="overflow-x:auto">' + html + '</div>';
}

// --- Detail View ---
var _detailTaskId = null;

async function renderDetail(taskId) {
  var app = document.getElementById("app");
  app.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  _detailTaskId = taskId;

  try {
    var results = await Promise.all([
      api("/api/tasks/" + taskId),
      api("/api/tasks/" + taskId + "/events")
    ]);
    var task = results[0];
    var events = results[1];
    var isArchived = !!task.archived;

    var html = '<a href="#/' + esc(currentView) + '" class="back-link">&larr; Back</a>';
    html += '<div class="detail">';

    // --- Title (inline editable) ---
    html += '<div class="detail-header">';
    if (isArchived) {
      html += '<div class="detail-title">' + esc(task.title || "Untitled") + ' <span class="archived-badge">ARCHIVED</span></div>';
    } else {
      html += '<div class="detail-title editable" id="detail-title" title="Click to edit">' + esc(task.title || "Untitled") + '</div>';
    }

    // --- Status + Action bar ---
    if (!isArchived) {
      html += '<div class="detail-actions">';
      // Status dropdown
      var transitions = (config && config.workflow && config.workflow.transitions) || {};
      var allowed = transitions[task.status] || [];
      html += '<select id="detail-status" title="Change status">';
      html += '<option value="' + esc(task.status) + '" selected>' + esc(task.status) + '</option>';
      allowed.forEach(function(s) {
        html += '<option value="' + esc(s) + '">' + esc(s) + '</option>';
      });
      html += '</select>';

      // Priority dropdown
      html += '<select id="detail-priority" title="Change priority">';
      ["critical","high","medium","low"].forEach(function(p) {
        html += '<option value="' + esc(p) + '"' + (p === task.priority ? ' selected' : '') + '>' + esc(p) + '</option>';
      });
      html += '</select>';

      // Type dropdown
      var types = (config && config.task_types) || [];
      html += '<select id="detail-type" title="Change type">';
      types.forEach(function(t) {
        html += '<option value="' + esc(t) + '"' + (t === task.type ? ' selected' : '') + '>' + esc(t) + '</option>';
      });
      html += '</select>';

      // Archive button
      html += '<button class="btn btn-danger btn-sm" id="detail-archive-btn">Archive</button>';
      html += '</div>';
    } else {
      html += '<div class="detail-meta">';
      if (task.status) html += '<span class="badge badge-stat">' + esc(task.status) + '</span>';
      if (task.priority) html += '<span class="badge pri-' + esc(task.priority) + '">' + esc(task.priority) + '</span>';
      if (task.type) html += '<span class="badge type-badge">' + esc(task.type) + '</span>';
      html += '</div>';
    }
    html += '</div>';

    // --- Info fields ---
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">';
    html += '<div class="detail-field"><dt>ID</dt><dd style="font-family:monospace;font-size:.8rem">' + esc(task.id) + '</dd></div>';

    // Assigned to (editable)
    if (!isArchived) {
      html += '<div class="detail-field"><dt>Assigned to</dt><dd>';
      html += '<span class="editable" id="detail-assigned" title="Click to edit">' + esc(task.assigned_to || "unassigned") + '</span>';
      html += '</dd></div>';
    } else {
      html += '<div class="detail-field"><dt>Assigned to</dt><dd>' + esc(task.assigned_to || "unassigned") + '</dd></div>';
    }

    var infoFields = [
      ["Created by", task.created_by], ["Created", task.created_at], ["Updated", task.updated_at],
      ["Urgency", task.urgency]
    ];
    infoFields.forEach(function(pair) {
      if (pair[1]) {
        html += '<div class="detail-field"><dt>' + esc(pair[0]) + '</dt><dd>' + esc(String(pair[1])) + '</dd></div>';
      }
    });
    html += '</div>';

    // --- Description (editable) ---
    html += '<div class="detail-section"><h3>Description</h3>';
    if (!isArchived) {
      html += '<pre class="editable" id="detail-description" style="white-space:pre-wrap;font-size:.9rem;min-height:20px" title="Click to edit">' + esc(task.description || "(no description \u2014 click to add)") + '</pre>';
    } else {
      html += '<pre style="white-space:pre-wrap;font-size:.9rem">' + esc(task.description || "") + '</pre>';
    }
    html += '</div>';

    // --- Tags (editable) ---
    html += '<div class="detail-section"><h3>Tags</h3>';
    if (!isArchived) {
      var tagStr = (task.tags && task.tags.length) ? task.tags.join(", ") : "";
      html += '<span class="editable" id="detail-tags" title="Click to edit">' + esc(tagStr || "(no tags \u2014 click to add)") + '</span>';
    } else if (task.tags && task.tags.length) {
      html += '<div>';
      task.tags.forEach(function(tag) { html += '<span class="badge badge-stat" style="margin-right:4px">' + esc(tag) + '</span>'; });
      html += '</div>';
    }
    html += '</div>';

    if (task.custom_fields && Object.keys(task.custom_fields).length) {
      html += '<div class="detail-section"><h3>Custom Fields</h3><dl>';
      Object.entries(task.custom_fields).forEach(function(pair) {
        html += '<dt>' + esc(pair[0]) + '</dt><dd>' + esc(String(pair[1])) + '</dd>';
      });
      html += '</dl></div>';
    }

    // Relationships
    if (task.relationships_out && task.relationships_out.length) {
      html += '<div class="detail-section"><h3>Relationships</h3><ul class="rel-list">';
      task.relationships_out.forEach(function(r) {
        html += '<li>' + esc(r.type) + ' &rarr; <a href="#/task/' + esc(r.target_task_id) + '">' + esc(r.target_task_id) + '</a>';
        if (r.note) html += ' (' + esc(r.note) + ')';
        html += '</li>';
      });
      html += '</ul></div>';
    }

    // Artifacts
    if (task.artifacts && task.artifacts.length) {
      html += '<div class="detail-section"><h3>Artifacts</h3><ul class="art-list">';
      task.artifacts.forEach(function(a) {
        html += '<li>' + esc(a.id);
        if (a.title) html += ' "' + esc(a.title) + '"';
        if (a.type) html += ' (' + esc(a.type) + ')';
        html += '</li>';
      });
      html += '</ul></div>';
    }

    // Notes
    if (task.notes_exists) {
      html += '<div class="detail-section"><h3>Notes</h3><p style="font-size:.85rem;color:#6c757d">Notes file exists: <code>notes/' + esc(task.id) + '.md</code></p></div>';
    }

    // --- Comments section ---
    var comments = (events || []).filter(function(ev) { return ev.type === "comment_added"; });
    html += '<div class="detail-section"><h3>Comments (' + comments.length + ')</h3>';
    if (!isArchived) {
      html += '<div class="comment-form">';
      html += '<textarea class="form-control" id="detail-comment-text" placeholder="Add a comment..."></textarea>';
      html += '<button class="btn btn-primary btn-sm" id="detail-comment-submit" style="align-self:flex-end">Post</button>';
      html += '</div>';
    }
    if (comments.length) {
      html += '<div style="margin-top:8px">';
      comments.forEach(function(ev) {
        html += '<div class="comment-item">';
        html += '<div class="comment-meta">' + esc(ev.actor || "") + ' &middot; ' + esc(ev.ts || "") + '</div>';
        html += '<div class="comment-body">' + esc((ev.data && ev.data.body) || "") + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }
    html += '</div>';

    // --- Events (non-comment) ---
    var nonCommentEvents = (events || []).filter(function(ev) { return ev.type !== "comment_added"; });
    if (nonCommentEvents.length) {
      html += '<div class="detail-section"><h3>History (' + nonCommentEvents.length + ')</h3>';
      nonCommentEvents.forEach(function(ev) {
        html += '<div class="event-item">';
        html += '<span class="event-ts">' + esc(ev.ts || "") + '</span>';
        html += '<span class="event-type badge badge-stat">' + esc(ev.type || "") + '</span>';
        html += '<span>' + eventSummary(ev) + '</span>';
        html += '<span class="event-actor">' + esc(ev.actor || "") + '</span>';
        html += '</div>';
      });
      html += '</div>';
    }

    html += '</div>';
    app.innerHTML = html;

    // Wire up interactive elements
    if (!isArchived) {
      _wireDetailActions(taskId, task);
    }

  } catch(e) {
    app.innerHTML = '<a href="#/' + esc(currentView) + '" class="back-link">&larr; Back</a>' +
      '<div class="error-box"><p>' + esc(e.message) + '</p><button class="btn" onclick="location.reload()">Retry</button></div>';
  }
}

// Wire up detail view interactive controls
function _wireDetailActions(taskId, task) {
  // Status change
  var statusSel = document.getElementById("detail-status");
  if (statusSel) {
    statusSel.addEventListener("change", async function() {
      var newStatus = this.value;
      if (newStatus === task.status) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/status", { status: newStatus });
        showToast("Status changed to " + newStatus, "success");
        tasks = await api("/api/tasks");
        updateStatsBadges();
        renderDetail(taskId);
      } catch(e) {
        showToast(e.message, "error");
        this.value = task.status;
      }
    });
  }

  // Priority change
  var priSel = document.getElementById("detail-priority");
  if (priSel) {
    priSel.addEventListener("change", async function() {
      var newPri = this.value;
      if (newPri === task.priority) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/update", { fields: { priority: newPri } });
        showToast("Priority changed to " + newPri, "success");
        tasks = await api("/api/tasks");
        updateStatsBadges();
        renderDetail(taskId);
      } catch(e) {
        showToast(e.message, "error");
        this.value = task.priority;
      }
    });
  }

  // Type change
  var typeSel = document.getElementById("detail-type");
  if (typeSel) {
    typeSel.addEventListener("change", async function() {
      var newType = this.value;
      if (newType === task.type) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/update", { fields: { type: newType } });
        showToast("Type changed to " + newType, "success");
        tasks = await api("/api/tasks");
        updateStatsBadges();
        renderDetail(taskId);
      } catch(e) {
        showToast(e.message, "error");
        this.value = task.type;
      }
    });
  }

  // Title inline edit
  var titleEl = document.getElementById("detail-title");
  if (titleEl) {
    titleEl.addEventListener("click", function() {
      _inlineEdit(titleEl, task.title || "", function(newVal) {
        if (!newVal.trim()) { showToast("Title cannot be empty", "error"); return Promise.reject(); }
        return apiPost("/api/tasks/" + taskId + "/update", { fields: { title: newVal.trim() } })
          .then(function() {
            showToast("Title updated", "success");
            api("/api/tasks").then(function(t) { tasks = t; updateStatsBadges(); });
            renderDetail(taskId);
          });
      });
    });
  }

  // Description inline edit
  var descEl = document.getElementById("detail-description");
  if (descEl) {
    descEl.addEventListener("click", function() {
      var currentVal = task.description || "";
      _inlineEditTextarea(descEl, currentVal, function(newVal) {
        return apiPost("/api/tasks/" + taskId + "/update", { fields: { description: newVal } })
          .then(function() {
            showToast("Description updated", "success");
            renderDetail(taskId);
          });
      });
    });
  }

  // Assigned to inline edit
  var assignEl = document.getElementById("detail-assigned");
  if (assignEl) {
    assignEl.addEventListener("click", function() {
      _inlineEdit(assignEl, task.assigned_to || "", function(newVal) {
        var assignedTo = newVal.trim() || null;
        return apiPost("/api/tasks/" + taskId + "/assign", { assigned_to: assignedTo })
          .then(function() {
            showToast(assignedTo ? "Assigned to " + assignedTo : "Unassigned", "success");
            api("/api/tasks").then(function(t) { tasks = t; updateStatsBadges(); });
            renderDetail(taskId);
          });
      });
    });
  }

  // Tags inline edit
  var tagsEl = document.getElementById("detail-tags");
  if (tagsEl) {
    tagsEl.addEventListener("click", function() {
      var tagStr = (task.tags && task.tags.length) ? task.tags.join(", ") : "";
      _inlineEdit(tagsEl, tagStr, function(newVal) {
        var newTags = newVal.split(",").map(function(t){ return t.trim(); }).filter(Boolean);
        return apiPost("/api/tasks/" + taskId + "/update", { fields: { tags: newTags } })
          .then(function() {
            showToast("Tags updated", "success");
            api("/api/tasks").then(function(t) { tasks = t; updateStatsBadges(); });
            renderDetail(taskId);
          });
      });
    });
  }

  // Comment submit
  var commentBtn = document.getElementById("detail-comment-submit");
  if (commentBtn) {
    commentBtn.addEventListener("click", async function() {
      var textarea = document.getElementById("detail-comment-text");
      var text = textarea.value.trim();
      if (!text) { showToast("Comment cannot be empty", "error"); return; }
      try {
        await apiPost("/api/tasks/" + taskId + "/comment", { body: text });
        showToast("Comment added", "success");
        renderDetail(taskId);
      } catch(e) {
        showToast(e.message, "error");
      }
    });

    // Ctrl+Enter to submit
    document.getElementById("detail-comment-text").addEventListener("keydown", function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        e.preventDefault();
        commentBtn.click();
      }
    });
  }

  // Archive button
  var archiveBtn = document.getElementById("detail-archive-btn");
  if (archiveBtn) {
    archiveBtn.addEventListener("click", async function() {
      if (!confirm("Archive this task? It will be moved to the archive.")) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/archive", {});
        showToast("Task archived", "success");
        tasks = await api("/api/tasks");
        updateStatsBadges();
        location.hash = "#/" + currentView;
      } catch(e) {
        showToast(e.message, "error");
      }
    });
  }
}

// Inline edit: replaces element with input field
function _inlineEdit(el, currentValue, onSave) {
  if (el.dataset.editing === "true") return;
  el.dataset.editing = "true";

  var wrapper = document.createElement("div");
  wrapper.className = "inline-edit";
  var input = document.createElement("input");
  input.type = "text";
  input.className = "form-control";
  input.value = currentValue;
  var saveBtn = document.createElement("button");
  saveBtn.className = "btn btn-primary btn-sm";
  saveBtn.textContent = "Save";
  var cancelBtn = document.createElement("button");
  cancelBtn.className = "btn btn-sm";
  cancelBtn.textContent = "Cancel";

  wrapper.appendChild(input);
  wrapper.appendChild(saveBtn);
  wrapper.appendChild(cancelBtn);

  var parent = el.parentNode;
  parent.replaceChild(wrapper, el);
  input.focus();
  input.select();

  function cancel() { parent.replaceChild(el, wrapper); el.dataset.editing = "false"; }

  cancelBtn.addEventListener("click", cancel);
  input.addEventListener("keydown", function(e) {
    if (e.key === "Escape") cancel();
    if (e.key === "Enter") saveBtn.click();
  });
  saveBtn.addEventListener("click", function() {
    var result = onSave(input.value);
    if (result && result.catch) {
      result.catch(function() { cancel(); });
    }
  });
}

// Inline edit: textarea variant for multiline fields
function _inlineEditTextarea(el, currentValue, onSave) {
  if (el.dataset.editing === "true") return;
  el.dataset.editing = "true";

  var wrapper = document.createElement("div");
  var textarea = document.createElement("textarea");
  textarea.className = "form-control";
  textarea.value = currentValue;
  textarea.style.minHeight = "100px";
  var btnRow = document.createElement("div");
  btnRow.style.cssText = "display:flex;gap:6px;margin-top:6px;justify-content:flex-end";
  var saveBtn = document.createElement("button");
  saveBtn.className = "btn btn-primary btn-sm";
  saveBtn.textContent = "Save";
  var cancelBtn = document.createElement("button");
  cancelBtn.className = "btn btn-sm";
  cancelBtn.textContent = "Cancel";

  btnRow.appendChild(cancelBtn);
  btnRow.appendChild(saveBtn);
  wrapper.appendChild(textarea);
  wrapper.appendChild(btnRow);

  var parent = el.parentNode;
  parent.replaceChild(wrapper, el);
  textarea.focus();

  function cancel() { parent.replaceChild(el, wrapper); el.dataset.editing = "false"; }

  cancelBtn.addEventListener("click", cancel);
  textarea.addEventListener("keydown", function(e) {
    if (e.key === "Escape") cancel();
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") saveBtn.click();
  });
  saveBtn.addEventListener("click", function() {
    var result = onSave(textarea.value);
    if (result && result.catch) {
      result.catch(function() { cancel(); });
    }
  });
}

function eventSummary(ev) {
  var d = ev.data || {};
  switch(ev.type) {
    case "status_changed": return esc((d.from||"?") + " \u2192 " + (d.to||"?"));
    case "assignment_changed": return esc((d.from||"unassigned") + " \u2192 " + (d.to||"?"));
    case "field_updated": return esc(d.field + ": " + (d.from||"?") + " \u2192 " + (d.to||"?"));
    case "comment_added": {
      var body = d.body || "";
      if (body.length > 80) body = body.slice(0,77) + "...";
      return '"' + esc(body) + '"';
    }
    case "relationship_added": return esc(d.type) + " \u2192 " + esc(d.target_task_id||"");
    case "relationship_removed": return esc(d.type) + " -x- " + esc(d.target_task_id||"");
    case "artifact_attached": return "artifact " + esc(d.artifact_id||"");
    case "task_created": return "";
    default: return "";
  }
}

// --- Activity View ---
async function renderActivity() {
  var app = document.getElementById("app");
  app.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    var events = await api("/api/activity");
    if (events.length === 0) {
      app.innerHTML = '<div class="empty"><p>No recent activity.</p></div>';
      return;
    }
    var html = '<div class="activity-list">';
    events.forEach(function(ev) {
      html += '<div class="activity-item">';
      html += '<span class="event-ts">' + esc(ev.ts || "") + "</span>";
      html += '<span class="badge badge-stat">' + esc(ev.type || "") + "</span>";
      html += '<a href="#/task/' + esc(ev.task_id || "") + '">' + esc(ev.task_id ? ev.task_id.slice(0,18)+"..." : "") + "</a>";
      html += "<span>" + eventSummary(ev) + "</span>";
      html += '<span class="event-actor">' + esc(ev.actor || "") + "</span>";
      html += "</div>";
    });
    html += "</div>";
    app.innerHTML = html;
  } catch(e) {
    app.innerHTML = '<div class="error-box"><p>' + esc(e.message) + '</p><button class="btn" onclick="location.reload()">Retry</button></div>';
  }
}

// --- Helpers ---
function esc(s) {
  if (s == null) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function showError(msg) {
  document.getElementById("app").innerHTML = '<div class="error-box"><p>' + esc(msg) + '</p><button class="btn" onclick="location.reload()">Retry</button></div>';
}

// --- Create Task Modal ---
function showCreateTaskModal() {
  var modal = document.getElementById("create-task-modal");
  // Populate type dropdown from config
  var typeSelect = document.getElementById("ct-type");
  typeSelect.innerHTML = "";
  var types = (config && config.task_types) || ["task"];
  types.forEach(function(t) {
    var opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    if (t === "task") opt.selected = true;
    typeSelect.appendChild(opt);
  });
  // Reset form
  document.getElementById("ct-title").value = "";
  document.getElementById("ct-priority").value = config ? (config.default_priority || "medium") : "medium";
  document.getElementById("ct-description").value = "";
  document.getElementById("ct-tags").value = "";
  document.getElementById("ct-assigned").value = "";
  modal.style.display = "flex";
  document.getElementById("ct-title").focus();
}

function hideCreateTaskModal() {
  document.getElementById("create-task-modal").style.display = "none";
}

document.getElementById("new-task-btn").addEventListener("click", showCreateTaskModal);
document.getElementById("create-task-close").addEventListener("click", hideCreateTaskModal);
document.getElementById("create-task-cancel").addEventListener("click", hideCreateTaskModal);

document.getElementById("create-task-modal").addEventListener("click", function(e) {
  if (e.target === this) hideCreateTaskModal();
});

document.getElementById("create-task-submit").addEventListener("click", async function() {
  var title = document.getElementById("ct-title").value.trim();
  if (!title) {
    showToast("Title is required", "error");
    return;
  }
  var payload = { title: title };
  var taskType = document.getElementById("ct-type").value;
  if (taskType) payload.type = taskType;
  var priority = document.getElementById("ct-priority").value;
  if (priority) payload.priority = priority;
  var desc = document.getElementById("ct-description").value.trim();
  if (desc) payload.description = desc;
  var tags = document.getElementById("ct-tags").value.trim();
  if (tags) payload.tags = tags.split(",").map(function(t){ return t.trim(); }).filter(Boolean);
  var assigned = document.getElementById("ct-assigned").value.trim();
  if (assigned) payload.assigned_to = assigned;

  try {
    var created = await apiPost("/api/tasks", payload);
    hideCreateTaskModal();
    showToast("Task created: " + title, "success");
    tasks = await api("/api/tasks");
    updateStatsBadges();
    // Navigate to the new task's detail
    location.hash = "#/task/" + created.id;
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Allow Enter in title to submit
document.getElementById("ct-title").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    document.getElementById("create-task-submit").click();
  }
});

// --- Settings Panel ---
document.getElementById("settings-btn").addEventListener("click", function() {
  document.getElementById("settings-panel").classList.add("open");
});

document.getElementById("settings-close").addEventListener("click", function() {
  document.getElementById("settings-panel").classList.remove("open");
});

// Background image: save
document.getElementById("bg-image-save").addEventListener("click", async function() {
  var url = document.getElementById("bg-image-input").value.trim();
  try {
    var result = await apiPost("/api/config/dashboard", {background_image: url || null});
    if (config) config.dashboard = result;
    applyBackgroundImage();
    showToast("Background image updated", "success");
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Background image: clear
document.getElementById("bg-image-clear").addEventListener("click", async function() {
  document.getElementById("bg-image-input").value = "";
  try {
    var result = await apiPost("/api/config/dashboard", {background_image: null});
    if (config) config.dashboard = result;
    applyBackgroundImage();
    showToast("Background image cleared", "success");
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Lane colors: save
document.getElementById("lane-colors-save").addEventListener("click", async function() {
  var inputs = document.querySelectorAll("#lane-colors-list input[type=color]");
  var colors = {};
  inputs.forEach(function(inp) {
    colors[inp.dataset.status] = inp.value;
  });
  try {
    var result = await apiPost("/api/config/dashboard", {lane_colors: colors});
    if (config) config.dashboard = result;
    showToast("Lane colors updated", "success");
    if (currentView === "board") renderBoard();
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Lane colors: reset
document.getElementById("lane-colors-reset").addEventListener("click", async function() {
  try {
    var result = await apiPost("/api/config/dashboard", {lane_colors: DEFAULT_LANE_COLORS});
    if (config) config.dashboard = result;
    populateLaneColorSettings();
    showToast("Lane colors reset to defaults", "success");
    if (currentView === "board") renderBoard();
  } catch(e) {
    showToast(e.message, "error");
  }
});

// --- Nav Events ---
document.querySelectorAll(".nav-tab").forEach(function(el) {
  el.addEventListener("click", function() { location.hash = "#/" + el.dataset.view; });
});

document.getElementById("refresh-btn").addEventListener("click", async function() {
  try {
    var results = await Promise.all([api("/api/config"), api("/api/tasks")]);
    config = results[0];
    tasks = results[1];
    archivedTasks = null;
    updateStatsBadges();
    populateLaneColorSettings();
    loadBackgroundSetting();
    await route(location.hash.slice(1));
  } catch(e) { showError(e.message); }
});

// --- Auto-refresh ---
var autoRefreshInterval = null;
var AUTO_REFRESH_MS = 5000;

function startAutoRefresh() {
  stopAutoRefresh();
  autoRefreshInterval = setInterval(async function() {
    // Only auto-refresh on board, list, and activity views
    if (currentView !== "board" && currentView !== "list" && currentView !== "activity") return;
    try {
      var newTasks = await api("/api/tasks");
      var newConfig = await api("/api/config");
      // Only re-render if data actually changed
      var tasksChanged = JSON.stringify(newTasks) !== JSON.stringify(tasks);
      var configChanged = JSON.stringify(newConfig) !== JSON.stringify(config);
      if (tasksChanged || configChanged) {
        tasks = newTasks;
        config = newConfig;
        updateStatsBadges();
        if (configChanged) {
          populateLaneColorSettings();
          loadBackgroundSetting();
        }
        await route(location.hash.slice(1));
      }
    } catch(e) {
      // Silently ignore refresh errors  server may be restarting
    }
  }, AUTO_REFRESH_MS);
}

function stopAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
}

// Pause auto-refresh when tab is hidden to avoid unnecessary requests
document.addEventListener("visibilitychange", function() {
  if (document.hidden) {
    stopAutoRefresh();
  } else {
    startAutoRefresh();
  }
});

// --- Boot ---
init().then(function() { startAutoRefresh(); });

})();
</script>
</body>
</html>
