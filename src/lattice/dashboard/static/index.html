<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lattice Dashboard</title>
<style>
/* === Theme Variables === */
:root,[data-theme="classic"]{
  --bg-base:#f8f9fa;--surface:#ffffff;--surface-hover:#e9ecef;--surface-raised:#e9ecef;--surface-card:#f8f9fa;
  --border:#dee2e6;--border-subtle:#e9ecef;--border-row:#f0f0f0;
  --text-primary:#212529;--text-secondary:#495057;--text-muted:#6c757d;--text-on-accent:#fff;
  --accent-primary:#0d6efd;--accent-hover:#0b5ed7;--accent-glow:rgba(13,110,253,.15);--danger-glow:rgba(220,53,69,.25);
  --color-success:#198754;--color-danger:#dc3545;--color-danger-hover:#bb2d3b;
  --color-warning:#ffc107;--color-warning-bg:#fff3cd;
  --pri-critical-bg:#dc3545;--pri-high-bg:#fd7e14;--pri-medium-bg:#0d6efd;--pri-low-bg:#6c757d;
  --shadow-card-hover:0 1px 4px rgba(0,0,0,.1);--shadow-toast:0 2px 8px rgba(0,0,0,.15);
  --shadow-modal:0 8px 32px rgba(0,0,0,.2);--shadow-settings:-2px 0 8px rgba(0,0,0,.1);
  --overlay-bg:rgba(0,0,0,.4);
  --radius-sm:4px;--radius-md:6px;--radius-lg:8px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#212529;
  --chip-human-bg:#e8f5e9;--chip-human-text:#2e7d32;--chip-human-border:#c8e6c9;--chip-human-hover:#c8e6c9;
  --chip-agent-bg:#e3f2fd;--chip-agent-text:#1565c0;--chip-agent-border:#bbdefb;--chip-agent-hover:#bbdefb;
  --chip-team-bg:#fff3e0;--chip-team-text:#e65100;--chip-team-border:#ffe0b2;--chip-team-hover:#ffe0b2;
  --glow-primary:transparent;--glow-primary-strong:transparent
}
[data-theme="station-console"]{
  --bg-base:#0a0e17;--surface:rgba(15,23,42,.85);--surface-hover:rgba(0,212,255,.08);
  --surface-raised:rgba(30,41,59,.6);--surface-card:rgba(15,23,42,.6);
  --border:rgba(0,212,255,.15);--border-subtle:rgba(0,212,255,.08);--border-row:rgba(0,212,255,.06);
  --text-primary:#e0f0ff;--text-secondary:rgba(224,240,255,.7);--text-muted:rgba(224,240,255,.4);--text-on-accent:#fff;
  --accent-primary:#00d4ff;--accent-hover:#00b8e6;--accent-glow:rgba(0,212,255,.25);--danger-glow:rgba(239,68,68,.25);
  --color-success:#22c55e;--color-danger:#ef4444;--color-danger-hover:#dc2626;
  --color-warning:#f59e0b;--color-warning-bg:rgba(245,158,11,.15);
  --pri-critical-bg:rgba(239,68,68,.7);--pri-high-bg:rgba(249,115,22,.6);
  --pri-medium-bg:rgba(0,212,255,.5);--pri-low-bg:rgba(224,240,255,.15);
  --shadow-card-hover:0 0 15px rgba(0,212,255,.15);--shadow-toast:0 0 20px rgba(0,0,0,.4);
  --shadow-modal:0 0 40px rgba(0,212,255,.1),0 8px 32px rgba(0,0,0,.4);
  --shadow-settings:-2px 0 15px rgba(0,212,255,.08);
  --overlay-bg:rgba(0,0,0,.7);
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#e0f0ff;
  --chip-human-bg:rgba(34,197,94,.15);--chip-human-text:#4ade80;--chip-human-border:rgba(34,197,94,.3);--chip-human-hover:rgba(34,197,94,.25);
  --chip-agent-bg:rgba(0,212,255,.15);--chip-agent-text:#67e8f9;--chip-agent-border:rgba(0,212,255,.3);--chip-agent-hover:rgba(0,212,255,.25);
  --chip-team-bg:rgba(249,115,22,.15);--chip-team-text:#fb923c;--chip-team-border:rgba(249,115,22,.3);--chip-team-hover:rgba(249,115,22,.25);
  --glow-primary:rgba(0,212,255,.08);--glow-primary-strong:rgba(0,212,255,.15)
}


[data-theme="linear"]{
  --bg-base:#F7F8FA;--surface:#FFFFFF;--surface-hover:rgba(94,106,210,.06);
  --surface-raised:#EDEEF3;--surface-card:#FFFFFF;
  --border:#E1E4EA;--border-subtle:#EDEEF3;--border-row:#F2F3F7;
  --text-primary:#1B1D2A;--text-secondary:#5E6071;--text-muted:#8B8FA3;--text-on-accent:#FFFFFF;
  --accent-primary:#5E6AD2;--accent-hover:#4E5BBF;--accent-glow:rgba(94,106,210,.15);
  --color-success:#4CB782;--color-danger:#E5484D;--color-danger-hover:#CE2C31;
  --color-warning:#F5A623;--color-warning-bg:rgba(245,166,35,.1);
  --pri-critical-bg:#E5484D;--pri-high-bg:#F76808;--pri-medium-bg:#5E6AD2;--pri-low-bg:#8B8FA3;
  --shadow-card-hover:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --shadow-toast:0 4px 12px rgba(0,0,0,.1);
  --shadow-modal:0 16px 48px rgba(0,0,0,.12),0 2px 8px rgba(0,0,0,.08);
  --shadow-settings:-1px 0 12px rgba(0,0,0,.06);
  --overlay-bg:rgba(15,15,20,.45);
  --radius-sm:6px;--radius-md:8px;--radius-lg:12px;
  --font-body:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  --font-mono:"JetBrains Mono",ui-monospace,SFMono-Regular,Menlo,monospace;
  --glow-primary:transparent;--glow-primary-strong:transparent;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#1B1D2A;
  --chip-human-bg:#e8f5e9;--chip-human-text:#2e7d32;--chip-human-border:#c8e6c9;--chip-human-hover:#c8e6c9;
  --chip-agent-bg:#ede7f6;--chip-agent-text:#5e35b1;--chip-agent-border:#d1c4e9;--chip-agent-hover:#d1c4e9;
  --chip-team-bg:#fff3e0;--chip-team-text:#e65100;--chip-team-border:#ffe0b2;--chip-team-hover:#ffe0b2;
}
[data-theme="github"]{
  --bg-base:#f6f8fa;--surface:#ffffff;--surface-hover:#eaeef2;--surface-raised:#e8ecf0;--surface-card:#ffffff;
  --border:#d0d7de;--border-subtle:#d8dee4;--border-row:#d8dee4;
  --text-primary:#1f2328;--text-secondary:#656d76;--text-muted:#656d76;--text-on-accent:#ffffff;
  --accent-primary:#0969da;--accent-hover:#0550ae;--accent-glow:rgba(9,105,218,.15);
  --color-success:#1a7f37;--color-danger:#cf222e;--color-danger-hover:#a40e26;
  --color-warning:#bf8700;--color-warning-bg:#fff8c5;
  --pri-critical-bg:#cf222e;--pri-high-bg:#bc4c00;--pri-medium-bg:#0969da;--pri-low-bg:#656d76;
  --shadow-card-hover:0 1px 3px rgba(31,35,40,.12),0 1px 2px rgba(31,35,40,.06);--shadow-toast:0 1px 6px rgba(31,35,40,.16);
  --shadow-modal:0 8px 24px rgba(140,149,159,.2);--shadow-settings:-1px 0 6px rgba(31,35,40,.08);
  --overlay-bg:rgba(31,35,40,.5);
  --radius-sm:6px;--radius-md:6px;--radius-lg:12px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,"SF Mono",Menlo,Consolas,"Liberation Mono",monospace;
  --glow-primary:transparent;--glow-primary-strong:transparent;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#1f2328;
  --chip-human-bg:#dafbe1;--chip-human-text:#1a7f37;--chip-human-border:#aceebb;--chip-human-hover:#aceebb;
  --chip-agent-bg:#ddf4ff;--chip-agent-text:#0550ae;--chip-agent-border:#b6e3ff;--chip-agent-hover:#b6e3ff;
  --chip-team-bg:#fff1e5;--chip-team-text:#bc4c00;--chip-team-border:#ffd8b5;--chip-team-hover:#ffd8b5;
}
[data-theme="slate"]{
  --bg-base:#0f172a;--surface:#1e293b;--surface-hover:#334155;--surface-raised:#334155;--surface-card:#273548;
  --border:#334155;--border-subtle:#2d3d50;--border-row:#1e293b;
  --text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--text-on-accent:#ffffff;
  --accent-primary:#60a5fa;--accent-hover:#3b82f6;--accent-glow:rgba(96,165,250,.15);
  --color-success:#22c55e;--color-danger:#ef4444;--color-danger-hover:#dc2626;
  --color-warning:#f59e0b;--color-warning-bg:rgba(245,158,11,.12);
  --pri-critical-bg:#ef4444;--pri-high-bg:#f97316;--pri-medium-bg:#60a5fa;--pri-low-bg:#64748b;
  --shadow-card-hover:0 2px 8px rgba(0,0,0,.3);--shadow-toast:0 2px 10px rgba(0,0,0,.4);
  --shadow-modal:0 8px 32px rgba(0,0,0,.5);--shadow-settings:-2px 0 10px rgba(0,0,0,.3);
  --overlay-bg:rgba(0,0,0,.6);
  --radius-sm:4px;--radius-md:6px;--radius-lg:8px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --glow-primary:transparent;--glow-primary-strong:transparent;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#f1f5f9;
  --chip-human-bg:rgba(34,197,94,.12);--chip-human-text:#4ade80;--chip-human-border:rgba(34,197,94,.25);--chip-human-hover:rgba(34,197,94,.2);
  --chip-agent-bg:rgba(96,165,250,.12);--chip-agent-text:#93bbfd;--chip-agent-border:rgba(96,165,250,.25);--chip-agent-hover:rgba(96,165,250,.2);
  --chip-team-bg:rgba(249,115,22,.12);--chip-team-text:#fb923c;--chip-team-border:rgba(249,115,22,.25);--chip-team-hover:rgba(249,115,22,.2);
}
[data-theme="asana"]{
  --bg-base:#ffffff;--surface:#ffffff;--surface-hover:#fef0ef;--surface-raised:#f9f0ef;--surface-card:#fff8f7;
  --border:#e8e0de;--border-subtle:#f2ebe9;--border-row:#f5f0ef;
  --text-primary:#1e1b19;--text-secondary:#6f6562;--text-muted:#9b918d;--text-on-accent:#fff;
  --accent-primary:#F06A6A;--accent-hover:#e05555;--accent-glow:rgba(240,106,106,.15);
  --color-success:#5da283;--color-danger:#e8384f;--color-danger-hover:#cf2e43;
  --color-warning:#f8b849;--color-warning-bg:#fef6e4;
  --pri-critical-bg:#e8384f;--pri-high-bg:#f06a6a;--pri-medium-bg:#7c8af7;--pri-low-bg:#b8b8b8;
  --shadow-card-hover:0 2px 8px rgba(0,0,0,.07);--shadow-toast:0 4px 12px rgba(0,0,0,.1);
  --shadow-modal:0 10px 40px rgba(0,0,0,.12);--shadow-settings:-3px 0 12px rgba(0,0,0,.06);
  --overlay-bg:rgba(30,27,25,.35);
  --radius-sm:8px;--radius-md:12px;--radius-lg:16px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --glow-primary:transparent;--glow-primary-strong:transparent;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#1e1b19;
  --chip-human-bg:#e6f5ec;--chip-human-text:#3a8a5c;--chip-human-border:#c4e6d1;--chip-human-hover:#c4e6d1;
  --chip-agent-bg:#eee8fb;--chip-agent-text:#7c5cbf;--chip-agent-border:#ddd0f7;--chip-agent-hover:#ddd0f7;
  --chip-team-bg:#fef0ef;--chip-team-text:#d4574f;--chip-team-border:#fcd9d6;--chip-team-hover:#fcd9d6;
}
[data-theme="basecamp"]{
  --bg-base:#FBF9F4;--surface:#ffffff;--surface-hover:#f3efe8;--surface-raised:#eee9e0;--surface-card:#fdfcf9;
  --border:#d6cfc5;--border-subtle:#e5dfd6;--border-row:#ede8e0;
  --text-primary:#2c2416;--text-secondary:#5c5040;--text-muted:#8c7f6d;--text-on-accent:#fff;
  --accent-primary:#1D6D37;--accent-hover:#155a2c;--accent-glow:rgba(29,109,55,.12);
  --color-success:#1D6D37;--color-danger:#c0392b;--color-danger-hover:#a93226;
  --color-warning:#d4a017;--color-warning-bg:#fdf5dc;
  --pri-critical-bg:#c0392b;--pri-high-bg:#d4772c;--pri-medium-bg:#1D6D37;--pri-low-bg:#8c7f6d;
  --shadow-card-hover:0 1px 3px rgba(44,36,22,.1);--shadow-toast:0 3px 10px rgba(44,36,22,.12);
  --shadow-modal:0 8px 30px rgba(44,36,22,.15);--shadow-settings:-2px 0 10px rgba(44,36,22,.08);
  --overlay-bg:rgba(44,36,22,.4);
  --radius-sm:4px;--radius-md:6px;--radius-lg:8px;
  --font-body:"Georgia","Times New Roman",serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --glow-primary:transparent;--glow-primary-strong:transparent;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#2c2416;
  --chip-human-bg:#e8f2eb;--chip-human-text:#1D6D37;--chip-human-border:#c5deca;--chip-human-hover:#c5deca;
  --chip-agent-bg:#e9edf5;--chip-agent-text:#3d5a80;--chip-agent-border:#cdd5e4;--chip-agent-hover:#cdd5e4;
  --chip-team-bg:#f5efe4;--chip-team-text:#8c6c2f;--chip-team-border:#e5d9c3;--chip-team-hover:#e5d9c3;
}
[data-theme="porcelain"]{
  --bg-base:#E0E5EC;--surface:#E0E5EC;--surface-hover:#d3d8e0;--surface-raised:#E0E5EC;--surface-card:#f5f7fa;
  --border:transparent;--border-subtle:transparent;--border-row:rgba(163,177,198,.15);
  --text-primary:#2d3436;--text-secondary:#4a5568;--text-muted:#8395a7;--text-on-accent:#fff;
  --accent-primary:#6b8aab;--accent-hover:#5a7a9e;--accent-glow:rgba(107,138,171,.2);
  --color-success:#48bb78;--color-danger:#e53e3e;--color-danger-hover:#c53030;
  --color-warning:#ed8936;--color-warning-bg:rgba(237,137,54,.12);
  --pri-critical-bg:#e53e3e;--pri-high-bg:#ed8936;--pri-medium-bg:#6b8aab;--pri-low-bg:#8395a7;
  --shadow-card-hover:8px 8px 16px #b8bec7,-8px -8px 16px #ffffff;--shadow-toast:6px 6px 12px #b8bec7,-6px -6px 12px #ffffff;
  --shadow-modal:12px 12px 24px #a3b1c6,-12px -12px 24px #ffffff;--shadow-settings:-6px 0 16px #b8bec7,6px 0 16px #ffffff;
  --overlay-bg:rgba(45,52,54,.35);
  --radius-sm:12px;--radius-md:14px;--radius-lg:16px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --glow-primary:transparent;--glow-primary-strong:transparent;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#2d3436;
  --chip-human-bg:#E0E5EC;--chip-human-text:#48bb78;--chip-human-border:transparent;--chip-human-hover:#d3d8e0;
  --chip-agent-bg:#E0E5EC;--chip-agent-text:#6b8aab;--chip-agent-border:transparent;--chip-agent-hover:#d3d8e0;
  --chip-team-bg:#E0E5EC;--chip-team-text:#ed8936;--chip-team-border:transparent;--chip-team-hover:#d3d8e0;
}
[data-theme="frost"]{
  --bg-base:#0f0e1a;--surface:rgba(255,255,255,.08);--surface-hover:rgba(255,255,255,.12);--surface-raised:rgba(255,255,255,.1);--surface-card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.18);--border-subtle:rgba(255,255,255,.1);--border-row:rgba(255,255,255,.06);
  --text-primary:#f0f0f8;--text-secondary:#b8c0d0;--text-muted:#7a8498;--text-on-accent:#fff;
  --accent-primary:#60a5fa;--accent-hover:#3b82f6;--accent-glow:rgba(96,165,250,.25);
  --color-success:#34d399;--color-danger:#f87171;--color-danger-hover:#ef4444;
  --color-warning:#fbbf24;--color-warning-bg:rgba(251,191,36,.12);
  --pri-critical-bg:#f87171;--pri-high-bg:#fb923c;--pri-medium-bg:#60a5fa;--pri-low-bg:#7a8498;
  --shadow-card-hover:0 4px 16px rgba(0,0,0,.3),0 0 12px rgba(96,165,250,.08);--shadow-toast:0 4px 20px rgba(0,0,0,.4);
  --shadow-modal:0 12px 48px rgba(0,0,0,.5),0 0 24px rgba(96,165,250,.1);--shadow-settings:-4px 0 20px rgba(0,0,0,.4);
  --overlay-bg:rgba(8,6,18,.6);
  --radius-sm:10px;--radius-md:14px;--radius-lg:18px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --glow-primary:rgba(96,165,250,.08);--glow-primary-strong:rgba(96,165,250,.18);
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#1a1a2e;
  --chip-human-bg:rgba(52,211,153,.12);--chip-human-text:#6ee7b7;--chip-human-border:rgba(52,211,153,.25);--chip-human-hover:rgba(52,211,153,.2);
  --chip-agent-bg:rgba(96,165,250,.12);--chip-agent-text:#93c5fd;--chip-agent-border:rgba(96,165,250,.25);--chip-agent-hover:rgba(96,165,250,.2);
  --chip-team-bg:rgba(251,191,36,.12);--chip-team-text:#fcd34d;--chip-team-border:rgba(251,191,36,.25);--chip-team-hover:rgba(251,191,36,.2);
}
[data-theme="paper"]{
  --bg-base:#ffffff;--surface:#ffffff;--surface-hover:#f5f5f5;--surface-raised:#f0f0f0;--surface-card:#ffffff;
  --border:#d0d0d0;--border-subtle:#e0e0e0;--border-row:#ebebeb;
  --text-primary:#111111;--text-secondary:#333333;--text-muted:#777777;--text-on-accent:#ffffff;
  --accent-primary:#111111;--accent-hover:#333333;--accent-glow:transparent;
  --color-success:#111111;--color-danger:#b91c1c;--color-danger-hover:#991b1b;
  --color-warning:#111111;--color-warning-bg:#f5f5f5;
  --pri-critical-bg:#b91c1c;--pri-high-bg:#dc2626;--pri-medium-bg:#555555;--pri-low-bg:#999999;
  --shadow-card-hover:none;--shadow-toast:none;
  --shadow-modal:none;--shadow-settings:none;
  --overlay-bg:rgba(0,0,0,.25);
  --radius-sm:2px;--radius-md:2px;--radius-lg:2px;
  --font-body:"Georgia","Times New Roman","Iowan Old Style","Palatino Linotype","Book Antiqua",serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --glow-primary:transparent;--glow-primary-strong:transparent;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#111111;
  --chip-human-bg:#f0f0f0;--chip-human-text:#333333;--chip-human-border:#d0d0d0;--chip-human-hover:#e0e0e0;
  --chip-agent-bg:#f0f0f0;--chip-agent-text:#333333;--chip-agent-border:#d0d0d0;--chip-agent-hover:#e0e0e0;
  --chip-team-bg:#f0f0f0;--chip-team-text:#333333;--chip-team-border:#d0d0d0;--chip-team-hover:#e0e0e0;
}
[data-theme="midnight"]{
  --bg-base:#000000;--surface:#0a0a0a;--surface-hover:#1a1a1a;--surface-raised:#161616;--surface-card:#0a0a0a;
  --border:#222222;--border-subtle:#1a1a1a;--border-row:#151515;
  --text-primary:#E2E8F0;--text-secondary:#94A3B8;--text-muted:#64748B;--text-on-accent:#000000;
  --accent-primary:#E2E8F0;--accent-hover:#CBD5E1;--accent-glow:transparent;
  --color-success:#22c55e;--color-danger:#ef4444;--color-danger-hover:#dc2626;
  --color-warning:#f59e0b;--color-warning-bg:rgba(245,158,11,.1);
  --pri-critical-bg:#ef4444;--pri-high-bg:#f97316;--pri-medium-bg:#64748B;--pri-low-bg:#334155;
  --shadow-card-hover:none;--shadow-toast:0 2px 8px rgba(0,0,0,.6);
  --shadow-modal:0 8px 32px rgba(0,0,0,.8);--shadow-settings:-2px 0 8px rgba(0,0,0,.5);
  --overlay-bg:rgba(0,0,0,.75);
  --radius-sm:4px;--radius-md:6px;--radius-lg:8px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --glow-primary:transparent;--glow-primary-strong:transparent;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.8);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#E2E8F0;
  --chip-human-bg:rgba(226,232,240,.08);--chip-human-text:#94A3B8;--chip-human-border:rgba(226,232,240,.15);--chip-human-hover:rgba(226,232,240,.15);
  --chip-agent-bg:rgba(226,232,240,.08);--chip-agent-text:#94A3B8;--chip-agent-border:rgba(226,232,240,.15);--chip-agent-hover:rgba(226,232,240,.15);
  --chip-team-bg:rgba(226,232,240,.08);--chip-team-text:#94A3B8;--chip-team-border:rgba(226,232,240,.15);--chip-team-hover:rgba(226,232,240,.15);
}
[data-theme="obsidian"]{
  --bg-base:#1A1A2E;--surface:#23233D;--surface-hover:#2E2E4A;--surface-raised:#2A2A45;--surface-card:#262640;
  --border:#3A3A56;--border-subtle:#31314D;--border-row:#2C2C48;
  --text-primary:#E8E4DC;--text-secondary:#B8B2A6;--text-muted:#7D7872;--text-on-accent:#1A1A2E;
  --accent-primary:#E2B340;--accent-hover:#C99D2F;--accent-glow:rgba(226,179,64,.2);
  --color-success:#4CAF6A;--color-danger:#CF4444;--color-danger-hover:#B53636;
  --color-warning:#E2B340;--color-warning-bg:rgba(226,179,64,.12);
  --pri-critical-bg:rgba(207,68,68,.75);--pri-high-bg:rgba(224,140,40,.7);--pri-medium-bg:rgba(226,179,64,.6);--pri-low-bg:rgba(184,178,166,.2);
  --shadow-card-hover:0 2px 12px rgba(0,0,0,.35),0 0 8px rgba(226,179,64,.06);--shadow-toast:0 4px 16px rgba(0,0,0,.5);
  --shadow-modal:0 12px 48px rgba(0,0,0,.6),0 0 24px rgba(226,179,64,.05);--shadow-settings:-4px 0 16px rgba(0,0,0,.4);
  --overlay-bg:rgba(10,10,20,.75);
  --radius-sm:4px;--radius-md:6px;--radius-lg:10px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.78);--lane-btn-border:rgba(255,255,255,.5);
  --text-on-warning:#1A1A2E;
  --chip-human-bg:rgba(76,175,106,.14);--chip-human-text:#6FCF8A;--chip-human-border:rgba(76,175,106,.3);--chip-human-hover:rgba(76,175,106,.22);
  --chip-agent-bg:rgba(226,179,64,.14);--chip-agent-text:#E8C95A;--chip-agent-border:rgba(226,179,64,.3);--chip-agent-hover:rgba(226,179,64,.22);
  --chip-team-bg:rgba(180,130,220,.14);--chip-team-text:#C4A0E0;--chip-team-border:rgba(180,130,220,.3);--chip-team-hover:rgba(180,130,220,.22);
  --glow-primary:rgba(226,179,64,.06);--glow-primary-strong:rgba(226,179,64,.14)
}
[data-theme="carbon"]{
  --bg-base:#171717;--surface:#1E1E1E;--surface-hover:#292929;--surface-raised:#252525;--surface-card:#1C1C1C;
  --border:#333333;--border-subtle:#2A2A2A;--border-row:#222222;
  --text-primary:#E0E0E0;--text-secondary:#A0A0A0;--text-muted:#666666;--text-on-accent:#fff;
  --accent-primary:#EA580C;--accent-hover:#C2410C;--accent-glow:rgba(234,88,12,.18);
  --color-success:#16A34A;--color-danger:#DC2626;--color-danger-hover:#B91C1C;
  --color-warning:#D97706;--color-warning-bg:rgba(217,119,6,.12);
  --pri-critical-bg:#DC2626;--pri-high-bg:#EA580C;--pri-medium-bg:#2563EB;--pri-low-bg:#525252;
  --shadow-card-hover:0 1px 4px rgba(0,0,0,.4);--shadow-toast:0 2px 10px rgba(0,0,0,.5);
  --shadow-modal:0 8px 32px rgba(0,0,0,.7);--shadow-settings:-2px 0 10px rgba(0,0,0,.5);
  --overlay-bg:rgba(0,0,0,.7);
  --radius-sm:3px;--radius-md:4px;--radius-lg:6px;
  --font-body:ui-monospace,SFMono-Regular,Menlo,"Cascadia Mono",monospace;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,"Cascadia Mono",monospace;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.75);--lane-btn-border:rgba(255,255,255,.5);
  --text-on-warning:#E0E0E0;
  --chip-human-bg:rgba(22,163,74,.12);--chip-human-text:#4ADE80;--chip-human-border:rgba(22,163,74,.28);--chip-human-hover:rgba(22,163,74,.2);
  --chip-agent-bg:rgba(234,88,12,.12);--chip-agent-text:#FB923C;--chip-agent-border:rgba(234,88,12,.28);--chip-agent-hover:rgba(234,88,12,.2);
  --chip-team-bg:rgba(99,102,241,.12);--chip-team-text:#A5B4FC;--chip-team-border:rgba(99,102,241,.28);--chip-team-hover:rgba(99,102,241,.2);
  --glow-primary:transparent;--glow-primary-strong:transparent
}
[data-theme="vaporwave"]{
  --bg-base:#0d0221;--surface:rgba(26,10,46,.85);--surface-hover:rgba(255,113,206,.1);--surface-raised:rgba(45,20,80,.7);--surface-card:rgba(30,12,55,.6);
  --border:rgba(0,255,209,.2);--border-subtle:rgba(255,113,206,.15);--border-row:rgba(0,255,209,.08);
  --text-primary:#f0d0ff;--text-secondary:rgba(240,208,255,.75);--text-muted:rgba(240,208,255,.45);--text-on-accent:#fff;
  --accent-primary:#FF71CE;--accent-hover:#ff4fc0;--accent-glow:rgba(255,113,206,.25);--danger-glow:rgba(255,0,80,.3);
  --color-success:#00FFD1;--color-danger:#ff0050;--color-danger-hover:#d4003f;
  --color-warning:#ffb347;--color-warning-bg:rgba(255,179,71,.15);
  --pri-critical-bg:rgba(255,0,80,.8);--pri-high-bg:rgba(255,113,206,.7);--pri-medium-bg:rgba(0,255,209,.5);--pri-low-bg:rgba(240,208,255,.15);
  --shadow-card-hover:0 0 20px rgba(255,113,206,.2),0 0 40px rgba(0,255,209,.1);--shadow-toast:0 0 25px rgba(255,113,206,.3);
  --shadow-modal:0 0 60px rgba(255,113,206,.2),0 0 120px rgba(0,255,209,.1),0 8px 32px rgba(0,0,0,.5);
  --shadow-settings:-2px 0 20px rgba(255,113,206,.15);
  --overlay-bg:rgba(13,2,33,.8);
  --radius-sm:6px;--radius-md:10px;--radius-lg:14px;
  --font-body:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.85);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#0d0221;
  --chip-human-bg:rgba(0,255,209,.15);--chip-human-text:#00FFD1;--chip-human-border:rgba(0,255,209,.3);--chip-human-hover:rgba(0,255,209,.25);
  --chip-agent-bg:rgba(255,113,206,.15);--chip-agent-text:#FF71CE;--chip-agent-border:rgba(255,113,206,.3);--chip-agent-hover:rgba(255,113,206,.25);
  --chip-team-bg:rgba(1,205,254,.15);--chip-team-text:#01CDFE;--chip-team-border:rgba(1,205,254,.3);--chip-team-hover:rgba(1,205,254,.25);
  --glow-primary:rgba(255,113,206,.1);--glow-primary-strong:rgba(255,113,206,.2)
}
[data-theme="neon-noir"]{
  --bg-base:#000000;--surface:rgba(8,8,8,.95);--surface-hover:rgba(255,0,128,.08);--surface-raised:rgba(18,18,18,.9);--surface-card:rgba(10,10,10,.9);
  --border:rgba(255,0,128,.2);--border-subtle:rgba(0,212,255,.12);--border-row:rgba(255,0,128,.06);
  --text-primary:#f0f0f0;--text-secondary:rgba(240,240,240,.7);--text-muted:rgba(240,240,240,.4);--text-on-accent:#fff;
  --accent-primary:#FF0080;--accent-hover:#e00070;--accent-glow:rgba(255,0,128,.3);--danger-glow:rgba(255,0,0,.3);
  --color-success:#00FF88;--color-danger:#FF0040;--color-danger-hover:#cc0033;
  --color-warning:#FFB800;--color-warning-bg:rgba(255,184,0,.1);
  --pri-critical-bg:#FF0040;--pri-high-bg:#FF0080;--pri-medium-bg:#00D4FF;--pri-low-bg:rgba(240,240,240,.12);
  --shadow-card-hover:0 0 15px rgba(255,0,128,.2),0 0 30px rgba(255,0,128,.05);--shadow-toast:0 0 30px rgba(255,0,128,.3);
  --shadow-modal:0 0 80px rgba(255,0,128,.15),0 0 40px rgba(0,212,255,.1),0 8px 32px rgba(0,0,0,.8);
  --shadow-settings:-2px 0 25px rgba(255,0,128,.1);
  --overlay-bg:rgba(0,0,0,.85);
  --radius-sm:3px;--radius-md:5px;--radius-lg:8px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.85);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#000;
  --chip-human-bg:rgba(0,255,136,.1);--chip-human-text:#00FF88;--chip-human-border:rgba(0,255,136,.25);--chip-human-hover:rgba(0,255,136,.2);
  --chip-agent-bg:rgba(0,212,255,.1);--chip-agent-text:#00D4FF;--chip-agent-border:rgba(0,212,255,.25);--chip-agent-hover:rgba(0,212,255,.2);
  --chip-team-bg:rgba(255,0,128,.1);--chip-team-text:#FF0080;--chip-team-border:rgba(255,0,128,.25);--chip-team-hover:rgba(255,0,128,.2);
  --glow-primary:rgba(255,0,128,.08);--glow-primary-strong:rgba(255,0,128,.18)
}
[data-theme="acid-rain"]{
  --bg-base:#0a0a0a;--surface:rgba(0,10,0,.85);--surface-hover:rgba(57,255,20,.08);--surface-raised:rgba(57,255,20,.06);--surface-card:rgba(0,15,0,.7);
  --border:rgba(57,255,20,.2);--border-subtle:rgba(57,255,20,.1);--border-row:rgba(57,255,20,.06);
  --text-primary:#39FF14;--text-secondary:rgba(57,255,20,.75);--text-muted:rgba(57,255,20,.4);--text-on-accent:#0a0a0a;
  --accent-primary:#39FF14;--accent-hover:#2ed60f;--accent-glow:rgba(57,255,20,.3);
  --color-success:#39FF14;--color-danger:#ff2040;--color-danger-hover:#cc1a33;
  --color-warning:#bfff00;--color-warning-bg:rgba(191,255,0,.1);
  --pri-critical-bg:#ff2040;--pri-high-bg:#ff6600;--pri-medium-bg:#39FF14;--pri-low-bg:rgba(57,255,20,.2);
  --shadow-card-hover:0 0 15px rgba(57,255,20,.25),0 0 5px rgba(57,255,20,.15);--shadow-toast:0 0 20px rgba(57,255,20,.3);
  --shadow-modal:0 0 60px rgba(57,255,20,.15),0 0 120px rgba(57,255,20,.05);--shadow-settings:-2px 0 20px rgba(57,255,20,.1);
  --overlay-bg:rgba(0,0,0,.85);
  --radius-sm:2px;--radius-md:3px;--radius-lg:4px;
  --font-body:"Courier New",Courier,"Lucida Console",monospace;--font-mono:"Courier New",Courier,"Lucida Console",monospace;
  --text-on-lane:#0a0a0a;--text-on-lane-muted:rgba(10,10,10,.8);--lane-btn-border:rgba(10,10,10,.6);
  --text-on-warning:#0a0a0a;
  --chip-human-bg:rgba(57,255,20,.12);--chip-human-text:#39FF14;--chip-human-border:rgba(57,255,20,.3);--chip-human-hover:rgba(57,255,20,.2);
  --chip-agent-bg:rgba(0,255,128,.12);--chip-agent-text:#00ff80;--chip-agent-border:rgba(0,255,128,.3);--chip-agent-hover:rgba(0,255,128,.2);
  --chip-team-bg:rgba(180,255,20,.12);--chip-team-text:#b4ff14;--chip-team-border:rgba(180,255,20,.3);--chip-team-hover:rgba(180,255,20,.2);
  --glow-primary:rgba(57,255,20,.1);--glow-primary-strong:rgba(57,255,20,.25)
}
[data-theme="solar-flare"]{
  --bg-base:#0C0A09;--surface:rgba(28,25,23,.9);--surface-hover:rgba(234,88,12,.08);--surface-raised:rgba(41,37,36,.8);--surface-card:rgba(28,25,23,.7);
  --border:rgba(234,88,12,.18);--border-subtle:rgba(234,88,12,.1);--border-row:rgba(234,88,12,.06);
  --text-primary:#FDE8D0;--text-secondary:rgba(253,232,208,.7);--text-muted:rgba(253,232,208,.4);--text-on-accent:#0C0A09;
  --accent-primary:#EA580C;--accent-hover:#DC4A04;--accent-glow:rgba(234,88,12,.25);
  --color-success:#65A30D;--color-danger:#DC2626;--color-danger-hover:#B91C1C;
  --color-warning:#FCD34D;--color-warning-bg:rgba(252,211,77,.12);
  --pri-critical-bg:#FEFCE8;--pri-high-bg:#EF4444;--pri-medium-bg:#EA580C;--pri-low-bg:rgba(120,113,108,.5);
  --shadow-card-hover:0 0 15px rgba(234,88,12,.2),0 2px 8px rgba(0,0,0,.3);--shadow-toast:0 0 20px rgba(234,88,12,.25);
  --shadow-modal:0 0 60px rgba(234,88,12,.15),0 8px 32px rgba(0,0,0,.5);--shadow-settings:-2px 0 20px rgba(234,88,12,.1);
  --overlay-bg:rgba(0,0,0,.8);
  --radius-sm:4px;--radius-md:6px;--radius-lg:8px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;--font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --text-on-lane:#FDE8D0;--text-on-lane-muted:rgba(253,232,208,.8);--lane-btn-border:rgba(253,232,208,.6);
  --text-on-warning:#0C0A09;
  --chip-human-bg:rgba(101,163,13,.15);--chip-human-text:#A3E635;--chip-human-border:rgba(101,163,13,.3);--chip-human-hover:rgba(101,163,13,.25);
  --chip-agent-bg:rgba(234,88,12,.15);--chip-agent-text:#FB923C;--chip-agent-border:rgba(234,88,12,.3);--chip-agent-hover:rgba(234,88,12,.25);
  --chip-team-bg:rgba(252,211,77,.12);--chip-team-text:#FCD34D;--chip-team-border:rgba(252,211,77,.3);--chip-team-hover:rgba(252,211,77,.25);
  --glow-primary:rgba(234,88,12,.08);--glow-primary-strong:rgba(234,88,12,.2)
}
[data-theme="ultraviolet"]{
  --bg-base:#0D001A;--surface:rgba(20,3,40,.9);--surface-hover:rgba(191,64,255,.1);--surface-raised:rgba(30,5,60,.8);--surface-card:rgba(25,4,50,.85);
  --border:rgba(191,64,255,.2);--border-subtle:rgba(191,64,255,.1);--border-row:rgba(191,64,255,.06);
  --text-primary:#e8d5f5;--text-secondary:rgba(232,213,245,.7);--text-muted:rgba(200,170,230,.4);--text-on-accent:#fff;
  --accent-primary:#BF40FF;--accent-hover:#a020e0;--accent-glow:rgba(191,64,255,.3);--danger-glow:rgba(255,50,80,.3);
  --color-success:#a855f7;--color-danger:#ff3250;--color-danger-hover:#e0203a;
  --color-warning:#e879f9;--color-warning-bg:rgba(232,121,249,.12);
  --pri-critical-bg:rgba(255,50,80,.8);--pri-high-bg:rgba(255,120,50,.7);--pri-medium-bg:rgba(191,64,255,.7);--pri-low-bg:rgba(200,170,230,.2);
  --shadow-card-hover:0 0 20px rgba(191,64,255,.25),0 0 40px rgba(150,0,255,.1);--shadow-toast:0 0 24px rgba(191,64,255,.3);
  --shadow-modal:0 0 60px rgba(191,64,255,.2),0 8px 32px rgba(0,0,0,.5);--shadow-settings:-2px 0 20px rgba(191,64,255,.12);
  --overlay-bg:rgba(5,0,15,.8);
  --radius-sm:4px;--radius-md:8px;--radius-lg:12px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.85);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#f0e0ff;
  --chip-human-bg:rgba(168,85,247,.15);--chip-human-text:#d8b4fe;--chip-human-border:rgba(168,85,247,.3);--chip-human-hover:rgba(168,85,247,.25);
  --chip-agent-bg:rgba(191,64,255,.15);--chip-agent-text:#e879f9;--chip-agent-border:rgba(191,64,255,.3);--chip-agent-hover:rgba(191,64,255,.25);
  --chip-team-bg:rgba(255,120,200,.12);--chip-team-text:#f9a8d4;--chip-team-border:rgba(255,120,200,.25);--chip-team-hover:rgba(255,120,200,.2);
  --glow-primary:rgba(191,64,255,.1);--glow-primary-strong:rgba(191,64,255,.2)
}
[data-theme="holographic"]{
  --bg-base:#0a0a0f;--surface:rgba(16,16,24,.92);--surface-hover:rgba(255,255,255,.05);--surface-raised:rgba(22,22,32,.85);--surface-card:rgba(14,14,22,.9);
  --border:rgba(255,255,255,.1);--border-subtle:rgba(255,255,255,.06);--border-row:rgba(255,255,255,.04);
  --text-primary:#e8e8f0;--text-secondary:rgba(232,232,240,.65);--text-muted:rgba(200,200,220,.4);--text-on-accent:#fff;
  --accent-primary:#6bccff;--accent-hover:#4db8ff;--accent-glow:rgba(107,204,255,.2);--danger-glow:rgba(255,107,107,.25);
  --color-success:#6bff6b;--color-danger:#ff6b6b;--color-danger-hover:#e05555;
  --color-warning:#ffd93d;--color-warning-bg:rgba(255,217,61,.1);
  --pri-critical-bg:rgba(255,107,107,.75);--pri-high-bg:rgba(255,170,60,.7);--pri-medium-bg:rgba(107,204,255,.6);--pri-low-bg:rgba(200,200,220,.15);
  --shadow-card-hover:0 0 16px rgba(107,204,255,.15),0 0 32px rgba(204,107,255,.08);--shadow-toast:0 0 20px rgba(0,0,0,.5);
  --shadow-modal:0 0 50px rgba(107,204,255,.1),0 8px 32px rgba(0,0,0,.6);--shadow-settings:-2px 0 16px rgba(204,107,255,.08);
  --overlay-bg:rgba(5,5,10,.85);
  --radius-sm:6px;--radius-md:8px;--radius-lg:12px;
  --font-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,monospace;
  --text-on-lane:#fff;--text-on-lane-muted:rgba(255,255,255,.85);--lane-btn-border:rgba(255,255,255,.6);
  --text-on-warning:#1a1a24;
  --chip-human-bg:rgba(107,255,107,.1);--chip-human-text:#6bff6b;--chip-human-border:rgba(107,255,107,.25);--chip-human-hover:rgba(107,255,107,.18);
  --chip-agent-bg:rgba(107,204,255,.1);--chip-agent-text:#6bccff;--chip-agent-border:rgba(107,204,255,.25);--chip-agent-hover:rgba(107,204,255,.18);
  --chip-team-bg:rgba(255,217,61,.1);--chip-team-text:#ffd93d;--chip-team-border:rgba(255,217,61,.25);--chip-team-hover:rgba(255,217,61,.18);
  --glow-primary:rgba(107,204,255,.06);--glow-primary-strong:rgba(107,204,255,.12)
}
/* === Base === */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font-body);background-color:var(--bg-base);color:var(--text-primary);line-height:1.5}
a{color:var(--accent-primary);text-decoration:none}
a:hover{text-decoration:underline}

/* Nav */
.nav{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;position:sticky;top:0;z-index:10}
.nav-brand{font-weight:700;font-size:1.1rem;margin-right:8px;color:var(--text-primary)}
.nav-tab{padding:4px 12px;border-radius:var(--radius-sm);cursor:pointer;font-size:.875rem;color:var(--text-secondary);border:1px solid transparent}
.nav-tab:hover{background:var(--surface-hover)}
.nav-tab.active{background:var(--accent-primary);color:var(--text-on-accent);border-color:var(--accent-primary)}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.75rem;font-weight:600}
.badge-stat{background:var(--surface-raised);color:var(--text-secondary)}
.btn{padding:4px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface);cursor:pointer;font-size:.875rem;color:var(--text-primary)}
.btn:hover{background:var(--surface-hover)}
.btn-icon{padding:4px 8px;font-size:1rem;line-height:1;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface);cursor:pointer;color:var(--text-primary)}
.btn-icon:hover{background:var(--surface-hover)}
.btn-with-icon{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface);cursor:pointer;font-size:0.875rem;color:var(--text-primary)}
.btn-with-icon:hover{background:var(--surface-hover)}
.btn-with-icon svg{flex-shrink:0}

/* Nav Search */
.nav-search{display:flex;align-items:center;position:relative}
.nav-search-btn{background:none;border:1px solid var(--border);border-radius:var(--radius-sm);padding:4px 8px;cursor:pointer;color:var(--text-secondary);font-size:.875rem;display:flex;align-items:center;gap:4px}
.nav-search-btn:hover{background:var(--surface-hover);color:var(--text-primary)}
.nav-search-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.nav-search-input{width:0;border:none;outline:none;background:transparent;font-size:.875rem;color:var(--text-primary);padding:0;transition:width .2s ease,padding .2s ease}
.nav-search.open .nav-search-input{width:180px;padding:4px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface)}
.nav-search.open .nav-search-btn{border-color:var(--accent-primary);color:var(--accent-primary)}
.nav-search-kbd{font-size:.65rem;color:var(--text-muted);border:1px solid var(--border);border-radius:3px;padding:1px 4px;margin-left:2px;font-family:var(--font-mono)}

/* Content */
.content{margin:0 auto;padding:16px}

/* Loading & errors */
.loading{text-align:center;padding:48px;color:var(--text-muted)}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent-primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.error-box{background:var(--color-warning-bg);border:1px solid var(--color-warning);border-radius:var(--radius-md);padding:16px;margin:16px 0;text-align:center}
.error-box .btn{margin-top:8px}
.empty{text-align:center;padding:48px;color:var(--text-muted)}
.empty code{background:var(--surface-raised);padding:2px 6px;border-radius:3px;font-size:.875rem}

/* Toast notifications */
.toast-container{position:fixed;top:60px;right:16px;z-index:200;display:flex;flex-direction:column;gap:8px}
.toast{padding:10px 16px;border-radius:var(--radius-md);font-size:.85rem;color:var(--text-on-accent);box-shadow:var(--shadow-toast);animation:toastIn .3s ease;max-width:360px;word-break:break-word}
.toast-success{background:var(--color-success)}
.toast-error{background:var(--color-danger)}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

/* Board view */
.board{display:grid;gap:12px;align-items:start}
.board-col{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);min-height:auto;transition:box-shadow .2s,border-color .2s}
.board-col-header{padding:8px 12px;font-weight:600;font-size:.875rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;border-radius:var(--radius-md) var(--radius-md) 0 0;position:relative}
.board-col-header .count{font-weight:400;color:var(--text-on-lane-muted);font-size:.75rem}
.board-col-header .lane-color-btn{position:absolute;right:4px;top:4px;width:20px;height:20px;border:2px solid var(--lane-btn-border);border-radius:50%;cursor:pointer;padding:0;background:transparent;opacity:0;transition:opacity .2s}
.board-col-header:hover .lane-color-btn{opacity:1}
.board-col-body{padding:8px}
.board-sub-header{font-size:.75rem;font-weight:600;color:var(--text-muted);padding:6px 4px 4px;margin-top:4px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.board-sub-header:first-child{margin-top:0;border-top:none}
.board-sub-header .count{font-weight:400;font-size:.7rem;opacity:.7}

/* Drag and drop states */
.board-col.drag-over{border-color:var(--accent-primary);box-shadow:0 0 0 2px var(--accent-glow)}
.board-col.drag-invalid{border-color:var(--color-danger);box-shadow:0 0 0 2px var(--danger-glow)}
.card.dragging{opacity:.4;transform:scale(.95)}
.card{background:var(--surface-card);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);padding:8px 10px;margin-bottom:6px;cursor:grab;font-size:.85rem;transition:box-shadow .15s,opacity .15s,transform .15s}
.card:hover{box-shadow:var(--shadow-card-hover)}
.card:active{cursor:grabbing}
.card-title{font-weight:600;margin-bottom:4px;word-break:break-word}
.card-meta{display:flex;gap:6px;flex-wrap:wrap;align-items:center}

/* Priority badges */
.pri-critical{background:var(--pri-critical-bg);color:var(--text-on-accent)}
.pri-high{background:var(--pri-high-bg);color:var(--text-on-accent)}
.pri-medium{background:var(--pri-medium-bg);color:var(--text-on-accent)}
.pri-low{background:var(--pri-low-bg);color:var(--text-on-accent)}

/* Type badges */
.type-badge{background:var(--surface-raised);color:var(--text-secondary)}

/* Epic top lane */
.board-epic-lane{border-bottom:2px solid var(--border);padding-bottom:12px;margin-bottom:12px}
.board-epic-header{font-weight:600;font-size:.875rem;margin-bottom:8px;color:var(--text-secondary)}
.board-epic-cards{display:flex;gap:8px;flex-wrap:wrap}
.epic-card{background:var(--surface-card);border:2px solid var(--border-subtle);border-radius:var(--radius-sm);padding:8px 12px;font-size:.85rem;cursor:pointer;transition:border-color .15s,box-shadow .15s;min-width:180px;max-width:320px}
.epic-card:hover{box-shadow:var(--shadow-card-hover)}
.epic-card.epic-selected{border-color:var(--accent-primary);box-shadow:0 0 8px var(--accent-glow)}
.epic-card .epic-short-id{font-size:.7rem;font-weight:600;color:var(--accent-primary);margin-bottom:2px}
.epic-card .epic-title{font-weight:600;margin-bottom:4px;word-break:break-word}
.epic-card .epic-progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-bottom:4px}
.epic-card .epic-progress-fill{height:100%;background:var(--accent-primary);border-radius:2px;transition:width .3s}
.epic-card .epic-meta{display:flex;gap:6px;align-items:center;font-size:.75rem;color:var(--text-muted)}
.epic-card .epic-status-badge{font-size:.7rem;padding:1px 6px;border-radius:var(--radius-sm);font-weight:600}
.epic-card .epic-health-indicator{font-size:.7rem}
.card.epic-highlight{border-color:var(--accent-primary);box-shadow:0 0 8px var(--accent-glow)}
.board-wrapper{position:relative}
.epic-threads-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;overflow:visible}

/* Status colors for column headers (CSS fallback â€” JS inline styles override these) */
.status-done .board-col-header{background:#198754;color:var(--text-on-lane)}
.status-cancelled .board-col-header{background:#6c757d;color:var(--text-on-lane)}
.status-in_planning .board-col-header{background:#17a2b8;color:var(--text-on-lane)}
.status-planned .board-col-header{background:#20c997;color:var(--text-on-lane)}
.status-in_implementation .board-col-header{background:#0d6efd;color:var(--text-on-lane)}
.status-implemented .board-col-header{background:#0dcaf0;color:var(--text-on-lane)}
.status-in_review .board-col-header{background:#6f42c1;color:var(--text-on-lane)}
.status-backlog .board-col-header{background:#adb5bd;color:var(--text-on-lane)}
.status-blocked .board-col-header{background:#dc3545;color:var(--text-on-lane)}
.status-needs_human .board-col-header{background:#f59e0b;color:#212529}
.status-in_progress .board-col-header{background:#0d6efd;color:var(--text-on-lane)}
.status-review .board-col-header{background:#6f42c1;color:var(--text-on-lane)}
[data-theme="station-console"] .status-done .board-col-header{background:#22c55e}
[data-theme="station-console"] .status-cancelled .board-col-header{background:#475569}
[data-theme="station-console"] .status-in_planning .board-col-header{background:#06b6d4}
[data-theme="station-console"] .status-planned .board-col-header{background:#14b8a6}
[data-theme="station-console"] .status-in_implementation .board-col-header{background:#3b82f6}
[data-theme="station-console"] .status-implemented .board-col-header{background:#38bdf8}
[data-theme="station-console"] .status-in_review .board-col-header{background:#a78bfa}
[data-theme="station-console"] .status-backlog .board-col-header{background:#334155}
[data-theme="station-console"] .status-blocked .board-col-header{background:#ef4444}
[data-theme="station-console"] .status-needs_human .board-col-header{background:#f59e0b;color:#0a0e17}
[data-theme="station-console"] .status-in_progress .board-col-header{background:#3b82f6}
[data-theme="station-console"] .status-review .board-col-header{background:#a78bfa}

/* List view */
.filters{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.filters select,.filters input{padding:4px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.85rem;background:var(--surface);color:var(--text-primary)}
.filters input{min-width:200px}
.filters label{font-size:.85rem;display:flex;align-items:center;gap:4px;cursor:pointer;color:var(--text-secondary)}
table{width:100%;border-collapse:collapse;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden;font-size:.85rem}
th{text-align:left;padding:8px 10px;background:var(--bg-base);border-bottom:2px solid var(--border);font-weight:600;white-space:nowrap;color:var(--text-primary)}
td{padding:6px 10px;border-bottom:1px solid var(--border-row);vertical-align:top;color:var(--text-primary)}
tr:hover td{background:var(--surface-hover)}
.id-cell{font-family:var(--font-mono);font-size:.8rem;color:var(--text-muted);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Detail view */
.detail{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;max-width:900px}
.detail-header{margin-bottom:16px}
.detail-title{font-size:1.3rem;font-weight:700;margin-bottom:4px}
.detail-meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.detail-field{margin-bottom:12px}
.detail-field dt{font-weight:600;font-size:.85rem;color:var(--text-muted);margin-bottom:2px}
.detail-field dd{font-size:.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-primary)}
.detail-section{margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.detail-section h3{font-size:.95rem;font-weight:600;margin-bottom:8px}
.event-item{padding:6px 0;border-bottom:1px solid var(--border-row);font-size:.85rem;display:flex;gap:8px;flex-wrap:wrap}
.event-item:last-child{border-bottom:none}
.event-ts{color:var(--text-muted);font-family:var(--font-mono);font-size:.8rem;white-space:nowrap}
.event-type{font-weight:600}
.event-actor{color:var(--text-muted)}
.back-link{display:inline-block;margin-bottom:12px;font-size:.9rem}
.archived-badge{background:var(--color-warning);color:var(--text-on-warning);padding:2px 8px;border-radius:var(--radius-sm);font-size:.8rem;font-weight:600}
.rel-list,.art-list{list-style:none;padding:0}
.rel-list li,.art-list li{padding:4px 0;font-size:.85rem}

/* Activity view */
.activity-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-row);font-size:.85rem;align-items:flex-start}
.activity-item:last-child{border-bottom:none}
.activity-list{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px 16px}

/* Settings panel */
.settings-panel{position:fixed;top:0;right:0;width:320px;height:100%;background:var(--surface);border-left:1px solid var(--border);z-index:150;box-shadow:var(--shadow-settings);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .25s ease}
.settings-panel.open{transform:translateX(0)}
.settings-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:.95rem;color:var(--text-primary)}
.settings-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-muted);padding:4px}
.settings-close:hover{color:var(--text-primary)}
.settings-body{padding:16px;overflow-y:auto;flex:1}
.settings-group{margin-bottom:20px}
.settings-group label{display:block;font-size:.85rem;font-weight:600;color:var(--text-secondary);margin-bottom:4px}
.settings-group input[type="text"],.settings-group input[type="url"]{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.85rem;background:var(--surface);color:var(--text-primary)}
.settings-group .hint{font-size:.75rem;color:var(--text-muted);margin-top:2px}
.settings-group .btn{margin-top:6px}
.lane-color-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:.85rem}
.lane-color-row .lane-name{min-width:90px;color:var(--text-primary)}
.lane-color-row input[type="color"]{width:32px;height:28px;border:1px solid var(--border);border-radius:var(--radius-sm);padding:1px;cursor:pointer}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--overlay-bg);z-index:50;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-modal);width:90%;max-width:560px;max-height:90vh;overflow-y:auto;animation:slideUp .2s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;color:var(--text-primary)}
.modal-header h2{font-size:1.1rem;font-weight:700;margin:0}
.modal-body{padding:20px}
.modal-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

/* Form controls */
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:.85rem;font-weight:600;color:var(--text-secondary);margin-bottom:4px}
.form-control{width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.875rem;font-family:inherit;line-height:1.5;background:var(--surface);color:var(--text-primary)}
.form-control:focus{outline:none;border-color:var(--accent-primary);box-shadow:0 0 0 2px var(--accent-glow)}
textarea.form-control{min-height:80px;resize:vertical}
select.form-control{cursor:pointer}

/* Buttons */
.btn-primary{background:var(--accent-primary);color:var(--text-on-accent);border-color:var(--accent-primary)}
.btn-primary:hover{background:var(--accent-hover)}
.btn-danger{background:var(--color-danger);color:var(--text-on-accent);border-color:var(--color-danger)}
.btn-danger:hover{background:var(--color-danger-hover)}
.btn-sm{padding:2px 8px;font-size:.8rem}
.btn-new-task{background:var(--accent-primary);color:var(--text-on-accent);border-color:var(--accent-primary);font-weight:600}
.btn-new-task:hover{background:var(--accent-hover)}

/* Detail view: inline editing */
.editable{cursor:pointer;border-bottom:1px dashed transparent;transition:border-color .15s}
.editable:hover{border-bottom-color:var(--accent-primary)}
.inline-edit{display:flex;gap:6px;align-items:center}
.inline-edit .form-control{flex:1}
.inline-edit .btn{flex-shrink:0}

/* Detail view: action bar */
.detail-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.detail-actions select{padding:4px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.85rem;background:var(--surface);color:var(--text-primary)}

/* Comment section */
.comment-form{display:flex;gap:8px;margin-top:8px}
.comment-form textarea{flex:1;min-height:60px}
.comment-item{padding:8px;background:var(--surface-card);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);margin-bottom:6px;font-size:.85rem}
.comment-item .comment-meta{font-size:.8rem;color:var(--text-muted);margin-bottom:2px}
.comment-item .comment-body{white-space:pre-wrap}

/* === Station Console Theme Overrides === */
[data-theme="station-console"] body{
  background-image:
    repeating-linear-gradient(0deg,transparent,transparent 49px,rgba(0,212,255,.03) 49px,rgba(0,212,255,.03) 50px),
    repeating-linear-gradient(90deg,transparent,transparent 49px,rgba(0,212,255,.03) 49px,rgba(0,212,255,.03) 50px)
}
[data-theme="station-console"] .nav{backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
[data-theme="station-console"] .nav-brand{letter-spacing:.1em;text-shadow:0 0 20px rgba(0,212,255,.3)}
[data-theme="station-console"] .nav-tab.active{box-shadow:0 0 10px rgba(0,212,255,.25)}
[data-theme="station-console"] .board-col{backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);box-shadow:0 0 15px var(--glow-primary)}
[data-theme="station-console"] .board-col:hover{box-shadow:0 0 20px var(--glow-primary-strong)}
[data-theme="station-console"] .board-col-header{box-shadow:0 2px 10px rgba(0,0,0,.3)}
[data-theme="station-console"] .card{backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);box-shadow:0 0 10px var(--glow-primary)}
[data-theme="station-console"] .card:hover{box-shadow:0 0 20px var(--glow-primary-strong);transform:translateY(-1px)}
[data-theme="station-console"] .card.dragging{box-shadow:0 0 30px var(--glow-primary-strong)}
[data-theme="station-console"] .board-col.drag-over{box-shadow:0 0 25px rgba(0,212,255,.25)}
[data-theme="station-console"] .board-col.drag-invalid{box-shadow:0 0 25px rgba(239,68,68,.25)}
[data-theme="station-console"] .pri-critical{box-shadow:0 0 8px rgba(239,68,68,.5);animation:pulse-critical 2s ease-in-out infinite}
[data-theme="station-console"] .pri-high{box-shadow:0 0 8px rgba(249,115,22,.4)}
[data-theme="station-console"] .pri-medium{box-shadow:0 0 8px rgba(0,212,255,.4)}
[data-theme="station-console"] .pri-low{box-shadow:0 0 6px rgba(224,240,255,.1)}
@keyframes pulse-critical{0%,100%{box-shadow:0 0 8px rgba(239,68,68,.5)}50%{box-shadow:0 0 16px rgba(239,68,68,.8)}}
[data-theme="station-console"] .detail{backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);box-shadow:0 0 20px var(--glow-primary)}
[data-theme="station-console"] .detail-title{letter-spacing:.02em;text-shadow:0 0 20px rgba(0,212,255,.15)}
[data-theme="station-console"] .form-control:focus{box-shadow:0 0 0 2px rgba(0,212,255,.25),0 0 15px var(--glow-primary)}
[data-theme="station-console"] .settings-panel{backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
[data-theme="station-console"] .detail-panel{backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
[data-theme="station-console"] .modal{backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(0,212,255,.2)}
[data-theme="station-console"] .modal-overlay{backdrop-filter:blur(4px)}
[data-theme="station-console"] .activity-list{backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
[data-theme="station-console"] table{backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
[data-theme="station-console"] .toast-success{box-shadow:0 0 15px rgba(34,197,94,.3)}
[data-theme="station-console"] .toast-error{box-shadow:0 0 15px rgba(239,68,68,.3)}
[data-theme="station-console"] .comment-item{backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
[data-theme="station-console"] ::-webkit-scrollbar{width:8px}
[data-theme="station-console"] ::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}
[data-theme="station-console"] ::-webkit-scrollbar-thumb{background:rgba(0,212,255,.2);border-radius:4px}
[data-theme="station-console"] ::-webkit-scrollbar-thumb:hover{background:rgba(0,212,255,.4)}


/* === Linear Theme Overrides === */
/* Linear: tight, dense, professional SaaS feel */
[data-theme="linear"] body{
  background:#F7F8FA;
  font-feature-settings:"cv02","cv03","cv04","cv11";
  -webkit-font-smoothing:antialiased;
  letter-spacing:-.01em
}
[data-theme="linear"] .nav{
  background:rgba(255,255,255,.85);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border-bottom:1px solid #E1E4EA;
  padding:6px 16px
}
[data-theme="linear"] .nav-brand{
  font-weight:600;
  font-size:1rem;
  letter-spacing:-.02em;
  color:#1B1D2A
}
[data-theme="linear"] .nav-tab{
  font-size:.8125rem;
  font-weight:500;
  padding:3px 10px;
  border-radius:6px;
  color:#5E6071;
  transition:background .12s,color .12s
}
[data-theme="linear"] .nav-tab:hover{
  background:rgba(94,106,210,.06);
  color:#1B1D2A
}
[data-theme="linear"] .nav-tab.active{
  background:#5E6AD2;
  color:#fff;
  font-weight:600;
  box-shadow:none
}
[data-theme="linear"] .board-col{
  background:#FFFFFF;
  border:1px solid #E1E4EA;
  border-radius:8px;
  box-shadow:0 1px 2px rgba(0,0,0,.03)
}
[data-theme="linear"] .board-col:hover{
  box-shadow:0 1px 4px rgba(0,0,0,.06)
}
[data-theme="linear"] .board-col-header{
  font-size:.8125rem;
  font-weight:600;
  padding:7px 12px;
  letter-spacing:.01em;
  border-radius:8px 8px 0 0
}
[data-theme="linear"] .card{
  background:#FFFFFF;
  border:1px solid #EDEEF3;
  border-radius:6px;
  padding:8px 10px;
  margin-bottom:4px;
  transition:box-shadow .12s,border-color .12s
}
[data-theme="linear"] .card:hover{
  border-color:#D3D5E0;
  box-shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04)
}
[data-theme="linear"] .badge{
  font-size:.7rem;
  font-weight:600;
  padding:1px 6px;
  border-radius:4px;
  letter-spacing:.02em;
  text-transform:uppercase
}
[data-theme="linear"] .detail{
  background:#FFFFFF;
  border:1px solid #E1E4EA;
  border-radius:10px;
  box-shadow:0 1px 3px rgba(0,0,0,.04)
}
[data-theme="linear"] .detail-title{
  font-size:1.2rem;
  font-weight:700;
  letter-spacing:-.02em
}
[data-theme="linear"] .modal{
  border-radius:12px;
  border:1px solid #E1E4EA;
  box-shadow:0 16px 48px rgba(0,0,0,.12),0 2px 8px rgba(0,0,0,.08)
}
[data-theme="linear"] .settings-panel{
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border-left:1px solid #E1E4EA
}
[data-theme="linear"] .form-control{
  border-radius:6px;
  font-size:.8125rem;
  padding:5px 10px;
  border:1px solid #E1E4EA;
  transition:border-color .12s,box-shadow .12s
}
[data-theme="linear"] .form-control:focus{
  border-color:#5E6AD2;
  box-shadow:0 0 0 3px rgba(94,106,210,.12)
}
[data-theme="linear"] .btn{
  font-size:.8125rem;
  font-weight:500;
  border-radius:6px;
  padding:4px 12px;
  transition:background .1s,border-color .1s
}
[data-theme="linear"] .btn-primary{
  background:#5E6AD2;
  border-color:#5E6AD2;
  font-weight:600
}
[data-theme="linear"] .btn-primary:hover{
  background:#4E5BBF;
  border-color:#4E5BBF
}
[data-theme="linear"] table{
  border:1px solid #E1E4EA;
  border-radius:8px
}
[data-theme="linear"] th{
  font-size:.75rem;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.04em;
  color:#8B8FA3;
  background:#F7F8FA;
  padding:6px 10px
}
[data-theme="linear"] td{
  font-size:.8125rem;
  padding:5px 10px
}
[data-theme="linear"] tr:hover td{
  background:rgba(94,106,210,.03)
}
[data-theme="linear"] .activity-list{
  background:#FFFFFF;
  border:1px solid #E1E4EA;
  border-radius:8px;
  box-shadow:0 1px 2px rgba(0,0,0,.03)
}
[data-theme="linear"] .toast-success{
  background:#4CB782;
  border-radius:8px
}
[data-theme="linear"] .toast-error{
  background:#E5484D;
  border-radius:8px
}
[data-theme="linear"] .comment-item{
  background:#F7F8FA;
  border:1px solid #EDEEF3;
  border-radius:6px
}
[data-theme="linear"] .member-chip-human{background:#E8F5E9;color:#2E7D32;border-color:#C8E6C9}
[data-theme="linear"] .member-chip-agent{background:#EDE7F6;color:#5E35B1;border-color:#D1C4E9}
[data-theme="linear"] .member-chip-team{background:#FFF3E0;color:#E65100;border-color:#FFE0B2}
[data-theme="linear"] ::-webkit-scrollbar{width:6px;height:6px}
[data-theme="linear"] ::-webkit-scrollbar-track{background:transparent}
[data-theme="linear"] ::-webkit-scrollbar-thumb{background:#D3D5E0;border-radius:3px}
[data-theme="linear"] ::-webkit-scrollbar-thumb:hover{background:#B0B3C4}

/* === Github Theme Overrides === */
[data-theme="github"] .nav{background:#ffffff;border-bottom:1px solid #d0d7de}
[data-theme="github"] .nav-brand{font-weight:600;color:#1f2328}
[data-theme="github"] .nav-tab{border-radius:6px;font-weight:500;color:#656d76}
[data-theme="github"] .nav-tab:hover{background:#eaeef2;color:#1f2328}
[data-theme="github"] .nav-tab.active{background:#0969da;color:#fff;font-weight:600}
[data-theme="github"] .board-col{border:1px solid #d0d7de;border-radius:6px;background:#ffffff}
[data-theme="github"] .board-col-header{border-radius:6px 6px 0 0;font-weight:600;font-size:.8rem;text-transform:uppercase;letter-spacing:.03em}
[data-theme="github"] .card{background:#ffffff;border:1px solid #d0d7de;border-radius:6px}
[data-theme="github"] .card:hover{box-shadow:0 1px 3px rgba(31,35,40,.12);border-color:#0969da}
[data-theme="github"] .badge{border-radius:20px;font-weight:600}
[data-theme="github"] .id-cell{font-family:ui-monospace,SFMono-Regular,"SF Mono",Menlo,Consolas,monospace;font-size:.8rem;color:#0969da}
[data-theme="github"] .detail{border:1px solid #d0d7de;border-radius:6px}
[data-theme="github"] .form-control{border-radius:6px;border:1px solid #d0d7de}
[data-theme="github"] .form-control:focus{border-color:#0969da;box-shadow:0 0 0 3px rgba(9,105,218,.3);outline:none}
[data-theme="github"] .btn{border-radius:6px;font-weight:500}
[data-theme="github"] .btn-primary{background:#1f883d;border-color:#1b7f37}
[data-theme="github"] .btn-primary:hover{background:#1a7f37}
[data-theme="github"] .btn-new-task{background:#1f883d;border-color:#1b7f37;border-radius:6px}
[data-theme="github"] .btn-new-task:hover{background:#1a7f37}
[data-theme="github"] .modal{border-radius:12px;border:1px solid #d0d7de}
[data-theme="github"] .settings-panel{border-left:1px solid #d0d7de}
[data-theme="github"] .member-chip-human{background:#dafbe1;color:#1a7f37;border-color:#aceebb}
[data-theme="github"] .member-chip-human:hover{background:#aceebb}
[data-theme="github"] .member-chip-agent{background:#ddf4ff;color:#0550ae;border-color:#b6e3ff}
[data-theme="github"] .member-chip-agent:hover{background:#b6e3ff}
[data-theme="github"] .member-chip-team{background:#fff1e5;color:#bc4c00;border-color:#ffd8b5}
[data-theme="github"] .member-chip-team:hover{background:#ffd8b5}
[data-theme="github"] .toast-success{background:#1a7f37;border-radius:6px}
[data-theme="github"] .toast-error{background:#cf222e;border-radius:6px}
[data-theme="github"] table{border:1px solid #d0d7de;border-radius:6px}
[data-theme="github"] th{background:#f6f8fa;border-bottom:1px solid #d0d7de;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;color:#656d76}
[data-theme="github"] td{border-bottom:1px solid #d8dee4}
[data-theme="github"] tr:hover td{background:#f6f8fa}

/* === Slate Theme Overrides === */
[data-theme="slate"] body{
  background-image:
    linear-gradient(135deg,#0f172a 0%,#131c2e 25%,#0f172a 50%,#111a2d 75%,#0f172a 100%),
    radial-gradient(ellipse at 20% 80%,rgba(96,165,250,.03) 0%,transparent 50%),
    radial-gradient(ellipse at 80% 20%,rgba(96,165,250,.02) 0%,transparent 50%);
  background-attachment:fixed
}
[data-theme="slate"] .nav{background:#1e293b;border-bottom:1px solid #334155}
[data-theme="slate"] .nav-brand{color:#f1f5f9;font-weight:700}
[data-theme="slate"] .nav-tab{color:#94a3b8}
[data-theme="slate"] .nav-tab:hover{background:#334155;color:#e2e8f0}
[data-theme="slate"] .nav-tab.active{background:#60a5fa;color:#ffffff}
[data-theme="slate"] .board-col{background:#1e293b;border:1px solid #334155}
[data-theme="slate"] .board-col-header{border-bottom:1px solid rgba(0,0,0,.2)}
[data-theme="slate"] .card{background:#273548;border:1px solid #334155}
[data-theme="slate"] .card:hover{box-shadow:0 2px 8px rgba(0,0,0,.3);border-color:#475569}
[data-theme="slate"] .detail{background:#1e293b;border:1px solid #334155}
[data-theme="slate"] .form-control{background:#0f172a;border:1px solid #334155;color:#f1f5f9}
[data-theme="slate"] .form-control:focus{border-color:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,.25)}
[data-theme="slate"] .filters select,[data-theme="slate"] .filters input{background:#0f172a;border-color:#334155;color:#f1f5f9}
[data-theme="slate"] .settings-panel{background:#1e293b;border-left:1px solid #334155}
[data-theme="slate"] .settings-group input[type="text"],[data-theme="slate"] .settings-group input[type="url"]{background:#0f172a;border-color:#334155;color:#f1f5f9}
[data-theme="slate"] .modal{background:#1e293b;border:1px solid #334155}
[data-theme="slate"] table{background:#1e293b;border:1px solid #334155}
[data-theme="slate"] th{background:#0f172a;border-bottom:1px solid #334155;color:#94a3b8}
[data-theme="slate"] td{border-bottom:1px solid #1e293b;color:#e2e8f0}
[data-theme="slate"] tr:hover td{background:#273548}
[data-theme="slate"] .member-chip-human{background:rgba(34,197,94,.12);color:#4ade80;border-color:rgba(34,197,94,.25)}
[data-theme="slate"] .member-chip-human:hover{background:rgba(34,197,94,.2)}
[data-theme="slate"] .member-chip-agent{background:rgba(96,165,250,.12);color:#93bbfd;border-color:rgba(96,165,250,.25)}
[data-theme="slate"] .member-chip-agent:hover{background:rgba(96,165,250,.2)}
[data-theme="slate"] .member-chip-team{background:rgba(249,115,22,.12);color:#fb923c;border-color:rgba(249,115,22,.25)}
[data-theme="slate"] .member-chip-team:hover{background:rgba(249,115,22,.2)}
[data-theme="slate"] .comment-item{background:#273548;border:1px solid #334155}
[data-theme="slate"] .activity-list{background:#1e293b;border:1px solid #334155}
[data-theme="slate"] ::-webkit-scrollbar{width:8px}
[data-theme="slate"] ::-webkit-scrollbar-track{background:#0f172a}
[data-theme="slate"] ::-webkit-scrollbar-thumb{background:#475569;border-radius:4px}
[data-theme="slate"] ::-webkit-scrollbar-thumb:hover{background:#64748b}

/* === Asana Theme Overrides === */
[data-theme="asana"] body{background:#ffffff}
[data-theme="asana"] .nav{background:#ffffff;border-bottom:1px solid #e8e0de;box-shadow:0 1px 3px rgba(0,0,0,.04)}
[data-theme="asana"] .nav-brand{color:#1e1b19;font-weight:800;letter-spacing:-.02em}
[data-theme="asana"] .nav-tab{border-radius:8px;font-weight:500;transition:background .15s,color .15s}
[data-theme="asana"] .nav-tab:hover{background:#fef0ef;color:#F06A6A}
[data-theme="asana"] .nav-tab.active{background:#F06A6A;color:#fff;border-color:#F06A6A;box-shadow:0 1px 4px rgba(240,106,106,.3)}
[data-theme="asana"] .board-col{border-radius:12px;border:1px solid #e8e0de;background:#ffffff;box-shadow:0 1px 3px rgba(0,0,0,.03)}
[data-theme="asana"] .board-col-header{border-radius:12px 12px 0 0;font-weight:700;letter-spacing:.01em}
[data-theme="asana"] .card{border-radius:8px;border:1px solid #f2ebe9;background:#fff8f7;transition:box-shadow .15s,transform .15s}
[data-theme="asana"] .card:hover{box-shadow:0 2px 8px rgba(240,106,106,.1);transform:translateY(-1px)}
[data-theme="asana"] .card-title{font-weight:600}
[data-theme="asana"] .detail{border-radius:12px;border:1px solid #e8e0de;box-shadow:0 2px 8px rgba(0,0,0,.04)}
[data-theme="asana"] .detail-title{font-weight:800;letter-spacing:-.01em}
[data-theme="asana"] .modal{border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.12);border:1px solid #e8e0de}
[data-theme="asana"] .modal-overlay{backdrop-filter:blur(3px)}
[data-theme="asana"] .settings-panel{box-shadow:-3px 0 12px rgba(0,0,0,.06)}
[data-theme="asana"] .form-control{border-radius:8px;border:1px solid #e8e0de}
[data-theme="asana"] .form-control:focus{border-color:#F06A6A;box-shadow:0 0 0 3px rgba(240,106,106,.12)}
[data-theme="asana"] .btn{border-radius:8px;font-weight:500;transition:background .15s,box-shadow .15s}
[data-theme="asana"] .btn-primary{background:#F06A6A;border-color:#F06A6A;box-shadow:0 1px 3px rgba(240,106,106,.25)}
[data-theme="asana"] .btn-primary:hover{background:#e05555;box-shadow:0 2px 6px rgba(240,106,106,.35)}
[data-theme="asana"] .btn-new-task{background:#F06A6A;border-color:#F06A6A;border-radius:8px;box-shadow:0 1px 3px rgba(240,106,106,.25)}
[data-theme="asana"] .btn-new-task:hover{background:#e05555}
[data-theme="asana"] .badge{border-radius:12px}
[data-theme="asana"] .toast-success{background:#5da283;border-radius:12px;box-shadow:0 4px 12px rgba(93,162,131,.3)}
[data-theme="asana"] .toast-error{background:#e8384f;border-radius:12px;box-shadow:0 4px 12px rgba(232,56,79,.3)}
[data-theme="asana"] table{border-radius:12px;overflow:hidden}
[data-theme="asana"] th{background:#fff8f7;border-bottom:2px solid #e8e0de;color:#6f6562;text-transform:uppercase;font-size:.75rem;letter-spacing:.04em}
[data-theme="asana"] .activity-list{border-radius:12px}
[data-theme="asana"] .comment-item{border-radius:8px;background:#fff8f7}
[data-theme="asana"] .member-chip-human{background:#e6f5ec;color:#3a8a5c;border-color:#c4e6d1}
[data-theme="asana"] .member-chip-human:hover{background:#c4e6d1}
[data-theme="asana"] .member-chip-agent{background:#eee8fb;color:#7c5cbf;border-color:#ddd0f7}
[data-theme="asana"] .member-chip-agent:hover{background:#ddd0f7}
[data-theme="asana"] .member-chip-team{background:#fef0ef;color:#d4574f;border-color:#fcd9d6}
[data-theme="asana"] .member-chip-team:hover{background:#fcd9d6}
[data-theme="asana"] .pri-critical{border-radius:8px}
[data-theme="asana"] .pri-high{border-radius:8px}
[data-theme="asana"] .pri-medium{border-radius:8px}
[data-theme="asana"] .pri-low{border-radius:8px}
[data-theme="asana"] .board-col.drag-over{border-color:#F06A6A;box-shadow:0 0 0 3px rgba(240,106,106,.15)}
[data-theme="asana"] .board-col.drag-invalid{border-color:#e8384f;box-shadow:0 0 0 3px rgba(232,56,79,.15)}
[data-theme="asana"] ::-webkit-scrollbar{width:7px}
[data-theme="asana"] ::-webkit-scrollbar-track{background:transparent}
[data-theme="asana"] ::-webkit-scrollbar-thumb{background:#e0d5d2;border-radius:8px}
[data-theme="asana"] ::-webkit-scrollbar-thumb:hover{background:#c9bbb7}

/* === Basecamp Theme Overrides === */
[data-theme="basecamp"] body{background:#FBF9F4}
[data-theme="basecamp"] .nav{background:#ffffff;border-bottom:2px solid #d6cfc5;box-shadow:none}
[data-theme="basecamp"] .nav-brand{font-family:"Georgia","Times New Roman",serif;font-weight:700;font-size:1.2rem;letter-spacing:-.01em;color:#2c2416}
[data-theme="basecamp"] .nav-tab{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:.85rem;font-weight:600;border-radius:4px;border:1px solid transparent}
[data-theme="basecamp"] .nav-tab:hover{background:#f3efe8;color:#2c2416}
[data-theme="basecamp"] .nav-tab.active{background:#1D6D37;color:#fff;border-color:#1D6D37}
[data-theme="basecamp"] .board-col{border:1px solid #d6cfc5;background:#ffffff;border-radius:6px}
[data-theme="basecamp"] .board-col-header{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-weight:700;font-size:.85rem;text-transform:uppercase;letter-spacing:.06em;border-radius:6px 6px 0 0}
[data-theme="basecamp"] .card{border:1px solid #d6cfc5;border-radius:4px;background:#fdfcf9;padding:10px 12px}
[data-theme="basecamp"] .card:hover{box-shadow:0 1px 3px rgba(44,36,22,.1);background:#ffffff}
[data-theme="basecamp"] .card-title{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-weight:700;font-size:.875rem}
[data-theme="basecamp"] .card-meta{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
[data-theme="basecamp"] .detail{border:2px solid #d6cfc5;border-radius:6px;background:#ffffff}
[data-theme="basecamp"] .detail-title{font-family:"Georgia","Times New Roman",serif;font-size:1.4rem;font-weight:700;color:#2c2416}
[data-theme="basecamp"] .modal{border:2px solid #d6cfc5;border-radius:8px;background:#ffffff}
[data-theme="basecamp"] .modal-header{border-bottom:2px solid #d6cfc5}
[data-theme="basecamp"] .modal-header h2{font-family:"Georgia","Times New Roman",serif}
[data-theme="basecamp"] .modal-footer{border-top:2px solid #d6cfc5}
[data-theme="basecamp"] .settings-panel{background:#ffffff;border-left:2px solid #d6cfc5}
[data-theme="basecamp"] .form-control{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;border:1px solid #d6cfc5;border-radius:4px}
[data-theme="basecamp"] .form-control:focus{border-color:#1D6D37;box-shadow:0 0 0 2px rgba(29,109,55,.12)}
[data-theme="basecamp"] .btn{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-weight:600;border:1px solid #d6cfc5;border-radius:4px}
[data-theme="basecamp"] .btn-primary{background:#1D6D37;border-color:#1D6D37}
[data-theme="basecamp"] .btn-primary:hover{background:#155a2c}
[data-theme="basecamp"] .btn-new-task{background:#1D6D37;border-color:#1D6D37}
[data-theme="basecamp"] .btn-new-task:hover{background:#155a2c}
[data-theme="basecamp"] .badge{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
[data-theme="basecamp"] .toast-success{background:#1D6D37;border-radius:4px}
[data-theme="basecamp"] .toast-error{background:#c0392b;border-radius:4px}
[data-theme="basecamp"] table{border:1px solid #d6cfc5;border-radius:6px}
[data-theme="basecamp"] th{background:#f3efe8;border-bottom:2px solid #d6cfc5;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;text-transform:uppercase;font-size:.75rem;letter-spacing:.05em;color:#5c5040}
[data-theme="basecamp"] td{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:.85rem}
[data-theme="basecamp"] .activity-list{border:1px solid #d6cfc5;border-radius:6px}
[data-theme="basecamp"] .comment-item{border:1px solid #d6cfc5;border-radius:4px;background:#fdfcf9}
[data-theme="basecamp"] .member-chip{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
[data-theme="basecamp"] .member-chip-human{background:#e8f2eb;color:#1D6D37;border-color:#c5deca}
[data-theme="basecamp"] .member-chip-human:hover{background:#c5deca}
[data-theme="basecamp"] .member-chip-agent{background:#e9edf5;color:#3d5a80;border-color:#cdd5e4}
[data-theme="basecamp"] .member-chip-agent:hover{background:#cdd5e4}
[data-theme="basecamp"] .member-chip-team{background:#f5efe4;color:#8c6c2f;border-color:#e5d9c3}
[data-theme="basecamp"] .member-chip-team:hover{background:#e5d9c3}
[data-theme="basecamp"] .board-col.drag-over{border-color:#1D6D37;box-shadow:0 0 0 2px rgba(29,109,55,.15)}
[data-theme="basecamp"] .board-col.drag-invalid{border-color:#c0392b;box-shadow:0 0 0 2px rgba(192,57,43,.15)}
[data-theme="basecamp"] .filters select,[data-theme="basecamp"] .filters input{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
[data-theme="basecamp"] ::-webkit-scrollbar{width:8px}
[data-theme="basecamp"] ::-webkit-scrollbar-track{background:#f3efe8}
[data-theme="basecamp"] ::-webkit-scrollbar-thumb{background:#d6cfc5;border-radius:4px}
[data-theme="basecamp"] ::-webkit-scrollbar-thumb:hover{background:#bfb6aa}

/* === Porcelain Theme Overrides === */
[data-theme="porcelain"] body{
  background:#E0E5EC
}
[data-theme="porcelain"] .nav{
  background:#E0E5EC;border-bottom:none;
  box-shadow:0 4px 8px #b8bec7,0 -2px 6px #ffffff
}
[data-theme="porcelain"] .nav-brand{
  color:#4a5568;letter-spacing:.03em
}
[data-theme="porcelain"] .nav-tab.active{
  background:var(--accent-primary);color:#fff;border:none;
  box-shadow:inset 2px 2px 4px rgba(0,0,0,.15),inset -2px -2px 4px rgba(255,255,255,.3)
}
[data-theme="porcelain"] .nav-tab:hover{
  box-shadow:inset 2px 2px 5px #b8bec7,inset -2px -2px 5px #ffffff
}
[data-theme="porcelain"] .board-col{
  background:#E0E5EC;border:none;
  box-shadow:6px 6px 12px #b8bec7,-6px -6px 12px #ffffff;
  border-radius:14px
}
[data-theme="porcelain"] .board-col-header{
  border-bottom:none;border-radius:14px 14px 0 0;
  box-shadow:inset 2px 2px 4px rgba(0,0,0,.08),inset -2px -2px 4px rgba(255,255,255,.25)
}
[data-theme="porcelain"] .card{
  background:#f5f7fa;border:none;
  box-shadow:4px 4px 10px #b8bec7,-4px -4px 10px #ffffff;
  border-radius:12px;transition:box-shadow .2s,transform .2s
}
[data-theme="porcelain"] .card:hover{
  background:#f8f9fc;
  box-shadow:6px 6px 16px #b0b6bf,-6px -6px 16px #ffffff;transform:translateY(-2px)
}
[data-theme="porcelain"] .card.dragging{
  box-shadow:2px 2px 4px #b8bec7,-2px -2px 4px #ffffff;transform:scale(.97)
}
[data-theme="porcelain"] .board-col.drag-over{
  box-shadow:6px 6px 12px #b8bec7,-6px -6px 12px #ffffff,0 0 0 3px rgba(107,138,171,.35)
}
[data-theme="porcelain"] .board-col.drag-invalid{
  box-shadow:6px 6px 12px #b8bec7,-6px -6px 12px #ffffff,0 0 0 3px rgba(229,62,62,.3)
}
[data-theme="porcelain"] .detail{
  background:#E0E5EC;border:none;
  box-shadow:8px 8px 16px #b8bec7,-8px -8px 16px #ffffff;
  border-radius:16px
}
[data-theme="porcelain"] .modal{
  background:#E0E5EC;border:none;
  box-shadow:12px 12px 24px #a3b1c6,-12px -12px 24px #ffffff;
  border-radius:16px
}
[data-theme="porcelain"] .modal-header{border-bottom:1px solid rgba(163,177,198,.2)}
[data-theme="porcelain"] .modal-footer{border-top:1px solid rgba(163,177,198,.2)}
[data-theme="porcelain"] .settings-panel{
  background:#E0E5EC;border-left:none;
  box-shadow:-8px 0 20px #b8bec7,8px 0 20px #ffffff
}
[data-theme="porcelain"] .detail-panel{
  background:#E0E5EC;border-left:none;
  box-shadow:-8px 0 20px #b8bec7,8px 0 20px #ffffff
}
[data-theme="porcelain"] .form-control{
  background:#E0E5EC;border:none;
  box-shadow:inset 3px 3px 6px #b8bec7,inset -3px -3px 6px #ffffff;
  border-radius:10px
}
[data-theme="porcelain"] .form-control:focus{
  box-shadow:inset 3px 3px 6px #b8bec7,inset -3px -3px 6px #ffffff,0 0 0 2px rgba(107,138,171,.3);
  outline:none
}
[data-theme="porcelain"] .btn{
  background:#E0E5EC;border:none;
  box-shadow:4px 4px 8px #b8bec7,-4px -4px 8px #ffffff;
  border-radius:10px;transition:box-shadow .15s
}
[data-theme="porcelain"] .btn:hover{
  box-shadow:2px 2px 4px #b8bec7,-2px -2px 4px #ffffff
}
[data-theme="porcelain"] .btn:active{
  box-shadow:inset 2px 2px 4px #b8bec7,inset -2px -2px 4px #ffffff
}
[data-theme="porcelain"] .btn-primary{
  background:var(--accent-primary);color:#fff;
  box-shadow:4px 4px 8px #b8bec7,-4px -4px 8px #ffffff
}
[data-theme="porcelain"] .btn-primary:hover{
  box-shadow:2px 2px 4px #b8bec7,-2px -2px 4px #ffffff
}
[data-theme="porcelain"] .btn-icon{
  background:#E0E5EC;border:none;
  box-shadow:3px 3px 6px #b8bec7,-3px -3px 6px #ffffff;
  border-radius:10px
}
[data-theme="porcelain"] .btn-icon:hover{
  box-shadow:inset 2px 2px 4px #b8bec7,inset -2px -2px 4px #ffffff
}
[data-theme="porcelain"] .btn-new-task{
  box-shadow:4px 4px 8px #b8bec7,-4px -4px 8px #ffffff;border:none
}
[data-theme="porcelain"] .toast-success{
  box-shadow:6px 6px 12px #b8bec7,-6px -6px 12px #ffffff;border-radius:12px
}
[data-theme="porcelain"] .toast-error{
  box-shadow:6px 6px 12px #b8bec7,-6px -6px 12px #ffffff;border-radius:12px
}
[data-theme="porcelain"] table{
  background:#E0E5EC;border:none;
  box-shadow:6px 6px 12px #b8bec7,-6px -6px 12px #ffffff;
  border-radius:14px;overflow:hidden
}
[data-theme="porcelain"] th{
  background:#E0E5EC;border-bottom:1px solid rgba(163,177,198,.2)
}
[data-theme="porcelain"] td{border-bottom:1px solid rgba(163,177,198,.1)}
[data-theme="porcelain"] tr:hover td{background:rgba(163,177,198,.12)}
[data-theme="porcelain"] .activity-list{
  background:#E0E5EC;border:none;
  box-shadow:6px 6px 12px #b8bec7,-6px -6px 12px #ffffff;
  border-radius:14px
}
[data-theme="porcelain"] .badge-stat{
  background:#E0E5EC;
  box-shadow:2px 2px 4px #b8bec7,-2px -2px 4px #ffffff;
  border-radius:10px
}
[data-theme="porcelain"] .comment-item{
  background:#E0E5EC;border:none;
  box-shadow:inset 2px 2px 5px #b8bec7,inset -2px -2px 5px #ffffff;
  border-radius:10px
}
[data-theme="porcelain"] .filters select,[data-theme="porcelain"] .filters input{
  background:#E0E5EC;border:none;
  box-shadow:inset 2px 2px 5px #b8bec7,inset -2px -2px 5px #ffffff;
  border-radius:10px
}
[data-theme="porcelain"] .member-chip-human{
  background:#E0E5EC;color:#48bb78;border:none;
  box-shadow:2px 2px 4px #b8bec7,-2px -2px 4px #ffffff
}
[data-theme="porcelain"] .member-chip-human:hover{
  box-shadow:inset 2px 2px 4px #b8bec7,inset -2px -2px 4px #ffffff
}
[data-theme="porcelain"] .member-chip-agent{
  background:#E0E5EC;color:#6b8aab;border:none;
  box-shadow:2px 2px 4px #b8bec7,-2px -2px 4px #ffffff
}
[data-theme="porcelain"] .member-chip-agent:hover{
  box-shadow:inset 2px 2px 4px #b8bec7,inset -2px -2px 4px #ffffff
}
[data-theme="porcelain"] .member-chip-team{
  background:#E0E5EC;color:#ed8936;border:none;
  box-shadow:2px 2px 4px #b8bec7,-2px -2px 4px #ffffff
}
[data-theme="porcelain"] .member-chip-team:hover{
  box-shadow:inset 2px 2px 4px #b8bec7,inset -2px -2px 4px #ffffff
}
[data-theme="porcelain"] .pri-critical{box-shadow:3px 3px 6px #b8bec7,-3px -3px 6px #ffffff}
[data-theme="porcelain"] .pri-high{box-shadow:3px 3px 6px #b8bec7,-3px -3px 6px #ffffff}
[data-theme="porcelain"] .pri-medium{box-shadow:3px 3px 6px #b8bec7,-3px -3px 6px #ffffff}
[data-theme="porcelain"] .pri-low{box-shadow:3px 3px 6px #b8bec7,-3px -3px 6px #ffffff}
[data-theme="porcelain"] .detail-section{border-top:1px solid rgba(163,177,198,.18)}
[data-theme="porcelain"] .settings-header{border-bottom:1px solid rgba(163,177,198,.2)}
[data-theme="porcelain"] ::-webkit-scrollbar{width:8px}
[data-theme="porcelain"] ::-webkit-scrollbar-track{background:#E0E5EC}
[data-theme="porcelain"] ::-webkit-scrollbar-thumb{background:#c8cdd5;border-radius:4px;box-shadow:inset 1px 1px 2px #b8bec7}
[data-theme="porcelain"] ::-webkit-scrollbar-thumb:hover{background:#b0b6bf}

/* === Glassmorphic Theme Overrides === */
@keyframes frost-drift{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
@keyframes frost-orb1{
  0%,100%{transform:translate(0,0) scale(1)}
  33%{transform:translate(60px,-40px) scale(1.1)}
  66%{transform:translate(-30px,50px) scale(0.95)}
}
@keyframes frost-orb2{
  0%,100%{transform:translate(0,0) scale(1)}
  33%{transform:translate(-50px,60px) scale(1.05)}
  66%{transform:translate(40px,-30px) scale(0.9)}
}
@keyframes frost-orb3{
  0%,100%{transform:translate(0,0) scale(1)}
  33%{transform:translate(30px,40px) scale(1.08)}
  66%{transform:translate(-60px,-20px) scale(0.92)}
}
[data-theme="frost"] body{
  background:#0f0e1a;
  overflow-x:hidden
}
[data-theme="frost"] body::before{
  content:"";position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(600px circle at 20% 30%,rgba(59,130,246,.35) 0%,transparent 60%),
    radial-gradient(500px circle at 75% 60%,rgba(168,85,247,.3) 0%,transparent 55%),
    radial-gradient(450px circle at 50% 80%,rgba(6,182,212,.28) 0%,transparent 55%),
    radial-gradient(400px circle at 85% 20%,rgba(236,72,153,.2) 0%,transparent 50%);
  background-size:200% 200%;
  animation:frost-drift 25s ease-in-out infinite
}
[data-theme="frost"] body::after{
  content:"";position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(300px circle at 30% 70%,rgba(34,211,238,.18) 0%,transparent 50%),
    radial-gradient(350px circle at 70% 25%,rgba(129,140,248,.2) 0%,transparent 50%);
  animation:frost-drift 35s ease-in-out infinite reverse
}
[data-theme="frost"] .content{position:relative;z-index:1}
[data-theme="frost"] .nav{position:relative;z-index:2}
[data-theme="frost"] .nav{
  background:rgba(255,255,255,.07);
  backdrop-filter:blur(20px) saturate(1.4);-webkit-backdrop-filter:blur(20px) saturate(1.4);
  border-bottom:1px solid rgba(255,255,255,.12);
  box-shadow:0 1px 0 rgba(255,255,255,.05) inset,0 4px 16px rgba(0,0,0,.2)
}
[data-theme="frost"] .nav-brand{
  color:#e0e8f8;letter-spacing:.03em;text-shadow:0 0 20px rgba(96,165,250,.3)
}
[data-theme="frost"] .nav-tab{
  border:1px solid transparent
}
[data-theme="frost"] .nav-tab:hover{
  background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.08)
}
[data-theme="frost"] .nav-tab.active{
  background:rgba(96,165,250,.2);color:#fff;
  border:1px solid rgba(96,165,250,.3);
  box-shadow:0 0 12px rgba(96,165,250,.2),0 1px 0 rgba(255,255,255,.1) inset
}
[data-theme="frost"] .board-col{
  background:rgba(255,255,255,.05);
  backdrop-filter:blur(16px) saturate(1.3);-webkit-backdrop-filter:blur(16px) saturate(1.3);
  border:1px solid rgba(255,255,255,.1);
  box-shadow:0 1px 0 rgba(255,255,255,.05) inset,0 4px 12px rgba(0,0,0,.15)
}
[data-theme="frost"] .board-col:hover{
  background:rgba(255,255,255,.07);
  box-shadow:0 1px 0 rgba(255,255,255,.08) inset,0 6px 20px rgba(0,0,0,.2)
}
[data-theme="frost"] .board-col-header{
  border-bottom:1px solid rgba(255,255,255,.08)
}
[data-theme="frost"] .card{
  background:rgba(255,255,255,.08);
  backdrop-filter:blur(12px) saturate(1.2);-webkit-backdrop-filter:blur(12px) saturate(1.2);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 1px 0 rgba(255,255,255,.06) inset,0 2px 8px rgba(0,0,0,.15);
  transition:all .25s cubic-bezier(.4,0,.2,1)
}
[data-theme="frost"] .card:hover{
  background:rgba(255,255,255,.13);
  border-color:rgba(255,255,255,.2);
  box-shadow:0 1px 0 rgba(255,255,255,.1) inset,0 8px 24px rgba(0,0,0,.25),0 0 12px rgba(96,165,250,.08);
  transform:translateY(-2px)
}
[data-theme="frost"] .card.dragging{
  background:rgba(255,255,255,.04);box-shadow:0 0 8px rgba(96,165,250,.15)
}
[data-theme="frost"] .board-col.drag-over{
  border-color:rgba(96,165,250,.4);
  box-shadow:0 0 0 2px rgba(96,165,250,.2),0 0 20px rgba(96,165,250,.1)
}
[data-theme="frost"] .board-col.drag-invalid{
  border-color:rgba(248,113,113,.4);
  box-shadow:0 0 0 2px rgba(248,113,113,.2)
}
[data-theme="frost"] .detail{
  background:rgba(255,255,255,.06);
  backdrop-filter:blur(20px) saturate(1.4);-webkit-backdrop-filter:blur(20px) saturate(1.4);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 1px 0 rgba(255,255,255,.06) inset,0 8px 32px rgba(0,0,0,.2)
}
[data-theme="frost"] .modal{
  background:rgba(255,255,255,.08);
  backdrop-filter:blur(24px) saturate(1.5);-webkit-backdrop-filter:blur(24px) saturate(1.5);
  border:1px solid rgba(255,255,255,.15);
  box-shadow:0 1px 0 rgba(255,255,255,.08) inset,0 12px 48px rgba(0,0,0,.4),0 0 24px rgba(96,165,250,.06)
}
[data-theme="frost"] .modal-overlay{
  backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)
}
[data-theme="frost"] .settings-panel{
  background:rgba(255,255,255,.06);
  backdrop-filter:blur(20px) saturate(1.4);-webkit-backdrop-filter:blur(20px) saturate(1.4);
  border-left:1px solid rgba(255,255,255,.1);
  box-shadow:-4px 0 20px rgba(0,0,0,.2)
}
[data-theme="frost"] .detail-panel{
  background:rgba(255,255,255,.06);
  backdrop-filter:blur(20px) saturate(1.4);-webkit-backdrop-filter:blur(20px) saturate(1.4);
  border-left:1px solid rgba(255,255,255,.1);
  box-shadow:-4px 0 20px rgba(0,0,0,.2)
}
[data-theme="frost"] .form-control{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  color:#f0f0f8
}
[data-theme="frost"] .form-control:focus{
  border-color:rgba(96,165,250,.5);
  box-shadow:0 0 0 2px rgba(96,165,250,.15),0 0 12px rgba(96,165,250,.08);
  background:rgba(255,255,255,.1)
}
[data-theme="frost"] .toast-success{
  background:rgba(52,211,153,.15);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(52,211,153,.3);
  box-shadow:0 4px 16px rgba(0,0,0,.3),0 0 12px rgba(52,211,153,.1)
}
[data-theme="frost"] .toast-error{
  background:rgba(248,113,113,.15);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(248,113,113,.3);
  box-shadow:0 4px 16px rgba(0,0,0,.3),0 0 12px rgba(248,113,113,.1)
}
[data-theme="frost"] table{
  background:rgba(255,255,255,.05);
  backdrop-filter:blur(16px) saturate(1.3);-webkit-backdrop-filter:blur(16px) saturate(1.3);
  border:1px solid rgba(255,255,255,.1)
}
[data-theme="frost"] th{
  background:rgba(255,255,255,.04);border-bottom:1px solid rgba(255,255,255,.08);
}
[data-theme="frost"] tr:hover td{background:rgba(96,165,250,.06)}
[data-theme="frost"] .activity-list{
  background:rgba(255,255,255,.05);
  backdrop-filter:blur(16px) saturate(1.3);-webkit-backdrop-filter:blur(16px) saturate(1.3);
  border:1px solid rgba(255,255,255,.1)
}
[data-theme="frost"] .comment-item{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.08);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)
}
[data-theme="frost"] .badge-stat{
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1)
}
[data-theme="frost"] .filters select,[data-theme="frost"] .filters input{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  color:#f0f0f8
}
[data-theme="frost"] .member-chip-human{
  background:rgba(52,211,153,.12);color:#6ee7b7;border-color:rgba(52,211,153,.25)
}
[data-theme="frost"] .member-chip-human:hover{background:rgba(52,211,153,.2)}
[data-theme="frost"] .member-chip-agent{
  background:rgba(96,165,250,.12);color:#93c5fd;border-color:rgba(96,165,250,.25)
}
[data-theme="frost"] .member-chip-agent:hover{background:rgba(96,165,250,.2)}
[data-theme="frost"] .member-chip-team{
  background:rgba(251,191,36,.12);color:#fcd34d;border-color:rgba(251,191,36,.25)
}
[data-theme="frost"] .member-chip-team:hover{background:rgba(251,191,36,.2)}
[data-theme="frost"] ::-webkit-scrollbar{width:7px}
[data-theme="frost"] ::-webkit-scrollbar-track{background:rgba(255,255,255,.03)}
[data-theme="frost"] ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:4px}
[data-theme="frost"] ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.2)}

/* === Paper Theme Overrides === */
[data-theme="paper"] body{background:#ffffff}
[data-theme="paper"] .nav{background:#ffffff;border-bottom:1px solid #c0c0c0;box-shadow:none}
[data-theme="paper"] .nav-brand{font-family:"Georgia","Times New Roman",serif;font-weight:700;letter-spacing:.04em;text-transform:uppercase;font-size:.95rem;color:#111111}
[data-theme="paper"] .nav-tab.active{background:#111111;color:#ffffff;border-radius:2px}
[data-theme="paper"] .board-col{background:#ffffff;border:1px solid #d0d0d0;border-radius:2px;box-shadow:none}
[data-theme="paper"] .board-col:hover{box-shadow:none}
[data-theme="paper"] .board-col-header{border-radius:2px 2px 0 0}
[data-theme="paper"] .card{background:#ffffff;border:1px solid #d0d0d0;border-radius:2px;box-shadow:none}
[data-theme="paper"] .card:hover{box-shadow:none;border-color:#999999}
[data-theme="paper"] .detail{background:#ffffff;border:1px solid #d0d0d0;border-radius:2px;box-shadow:none}
[data-theme="paper"] .modal{background:#ffffff;border:1px solid #c0c0c0;border-radius:2px;box-shadow:none}
[data-theme="paper"] .modal-overlay{backdrop-filter:none}
[data-theme="paper"] .settings-panel{background:#ffffff;border-left:1px solid #c0c0c0;box-shadow:none}
[data-theme="paper"] .form-control:focus{outline:none;border-color:#111111;box-shadow:none}
[data-theme="paper"] .toast-success{background:#111111;color:#ffffff;box-shadow:none}
[data-theme="paper"] .toast-error{background:#b91c1c;color:#ffffff;box-shadow:none}
[data-theme="paper"] .member-chip-human{background:#f0f0f0;color:#333333;border-color:#d0d0d0}
[data-theme="paper"] .member-chip-human:hover{background:#e0e0e0}
[data-theme="paper"] .member-chip-agent{background:#f0f0f0;color:#333333;border-color:#d0d0d0}
[data-theme="paper"] .member-chip-agent:hover{background:#e0e0e0}
[data-theme="paper"] .member-chip-team{background:#f0f0f0;color:#333333;border-color:#d0d0d0}
[data-theme="paper"] .member-chip-team:hover{background:#e0e0e0}
[data-theme="paper"] .badge-stat{background:#f0f0f0;color:#333333}
[data-theme="paper"] .type-badge{background:#f0f0f0;color:#555555}
[data-theme="paper"] .btn{border:1px solid #c0c0c0;border-radius:2px}
[data-theme="paper"] .btn-primary{background:#111111;color:#ffffff;border-color:#111111}
[data-theme="paper"] .btn-primary:hover{background:#333333}
[data-theme="paper"] .btn-new-task{background:#111111;color:#ffffff;border-color:#111111}
[data-theme="paper"] .btn-new-task:hover{background:#333333}
[data-theme="paper"] table{border:1px solid #d0d0d0;border-radius:2px}
[data-theme="paper"] th{background:#f5f5f5;border-bottom:2px solid #c0c0c0;font-family:"Georgia","Times New Roman",serif}
[data-theme="paper"] .activity-list{border:1px solid #d0d0d0;border-radius:2px}
[data-theme="paper"] .comment-item{background:#f8f8f8;border:1px solid #e0e0e0;border-radius:2px}
[data-theme="paper"] .pri-critical{box-shadow:none}
[data-theme="paper"] .pri-high{box-shadow:none}
[data-theme="paper"] .pri-medium{box-shadow:none}
[data-theme="paper"] .pri-low{box-shadow:none}
[data-theme="paper"] ::-webkit-scrollbar{width:6px}
[data-theme="paper"] ::-webkit-scrollbar-track{background:#f5f5f5}
[data-theme="paper"] ::-webkit-scrollbar-thumb{background:#c0c0c0;border-radius:2px}
[data-theme="paper"] ::-webkit-scrollbar-thumb:hover{background:#999999}

/* === Midnight Theme Overrides === */
[data-theme="midnight"] body{
  background:#000000;
  background-image:
    radial-gradient(1px 1px at 10% 20%,rgba(226,232,240,.07) 50%,transparent 50%),
    radial-gradient(1px 1px at 40% 65%,rgba(226,232,240,.05) 50%,transparent 50%),
    radial-gradient(1px 1px at 70% 35%,rgba(226,232,240,.04) 50%,transparent 50%),
    radial-gradient(1px 1px at 25% 80%,rgba(226,232,240,.06) 50%,transparent 50%),
    radial-gradient(1px 1px at 85% 15%,rgba(226,232,240,.03) 50%,transparent 50%),
    radial-gradient(1px 1px at 55% 90%,rgba(226,232,240,.05) 50%,transparent 50%),
    radial-gradient(1px 1px at 90% 70%,rgba(226,232,240,.04) 50%,transparent 50%);
  background-size:300px 300px,250px 250px,350px 350px,200px 200px,280px 280px,320px 320px,260px 260px;
  background-attachment:fixed
}
[data-theme="midnight"] .nav{background:#0a0a0a;border-bottom:1px solid #222222}
[data-theme="midnight"] .nav-brand{color:#E2E8F0;letter-spacing:.03em}
[data-theme="midnight"] .nav-tab.active{background:#E2E8F0;color:#000000}
[data-theme="midnight"] .board-col{background:#0a0a0a;border:1px solid #222222}
[data-theme="midnight"] .board-col:hover{border-color:#333333}
[data-theme="midnight"] .board-col-header{border-bottom:1px solid #222222}
[data-theme="midnight"] .card{background:#111111;border:1px solid #222222}
[data-theme="midnight"] .card:hover{border-color:#333333;box-shadow:none}
[data-theme="midnight"] .detail{background:#0a0a0a;border:1px solid #222222}
[data-theme="midnight"] .modal{background:#0a0a0a;border:1px solid #222222}
[data-theme="midnight"] .modal-overlay{backdrop-filter:blur(4px)}
[data-theme="midnight"] .settings-panel{background:#0a0a0a;border-left:1px solid #222222}
[data-theme="midnight"] .form-control:focus{outline:none;border-color:#E2E8F0;box-shadow:none}
[data-theme="midnight"] .form-control{background:#111111;border-color:#222222;color:#E2E8F0}
[data-theme="midnight"] .toast-success{background:#22c55e;color:#000000;box-shadow:none}
[data-theme="midnight"] .toast-error{background:#ef4444;color:#ffffff;box-shadow:none}
[data-theme="midnight"] .member-chip-human{background:rgba(226,232,240,.08);color:#94A3B8;border-color:rgba(226,232,240,.15)}
[data-theme="midnight"] .member-chip-human:hover{background:rgba(226,232,240,.15)}
[data-theme="midnight"] .member-chip-agent{background:rgba(226,232,240,.08);color:#94A3B8;border-color:rgba(226,232,240,.15)}
[data-theme="midnight"] .member-chip-agent:hover{background:rgba(226,232,240,.15)}
[data-theme="midnight"] .member-chip-team{background:rgba(226,232,240,.08);color:#94A3B8;border-color:rgba(226,232,240,.15)}
[data-theme="midnight"] .member-chip-team:hover{background:rgba(226,232,240,.15)}
[data-theme="midnight"] .badge-stat{background:#161616;color:#94A3B8}
[data-theme="midnight"] .type-badge{background:#161616;color:#94A3B8}
[data-theme="midnight"] .btn{background:#111111;border:1px solid #222222;color:#E2E8F0}
[data-theme="midnight"] .btn:hover{background:#1a1a1a;border-color:#333333}
[data-theme="midnight"] .btn-primary{background:#E2E8F0;color:#000000;border-color:#E2E8F0}
[data-theme="midnight"] .btn-primary:hover{background:#CBD5E1}
[data-theme="midnight"] .btn-new-task{background:#E2E8F0;color:#000000;border-color:#E2E8F0}
[data-theme="midnight"] .btn-new-task:hover{background:#CBD5E1}
[data-theme="midnight"] table{background:#0a0a0a;border:1px solid #222222}
[data-theme="midnight"] th{background:#060606;border-bottom:2px solid #222222;color:#94A3B8}
[data-theme="midnight"] td{border-bottom:1px solid #151515;color:#E2E8F0}
[data-theme="midnight"] tr:hover td{background:#111111}
[data-theme="midnight"] .activity-list{background:#0a0a0a;border:1px solid #222222}
[data-theme="midnight"] .comment-item{background:#111111;border:1px solid #1a1a1a}
[data-theme="midnight"] .filters select,.filters input{background:#111111;border-color:#222222;color:#E2E8F0}
[data-theme="midnight"] .pri-critical{color:#ffffff}
[data-theme="midnight"] .pri-high{color:#ffffff}
[data-theme="midnight"] .pri-medium{color:#E2E8F0}
[data-theme="midnight"] .pri-low{color:#94A3B8}
[data-theme="midnight"] .board-col.drag-over{border-color:#E2E8F0;box-shadow:0 0 0 2px rgba(226,232,240,.15)}
[data-theme="midnight"] .board-col.drag-invalid{border-color:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,.15)}
[data-theme="midnight"] ::-webkit-scrollbar{width:8px}
[data-theme="midnight"] ::-webkit-scrollbar-track{background:#060606}
[data-theme="midnight"] ::-webkit-scrollbar-thumb{background:#222222;border-radius:4px}
[data-theme="midnight"] ::-webkit-scrollbar-thumb:hover{background:#333333}

/* === Obsidian Theme Overrides === */
[data-theme="obsidian"] body{
  background-image:
    radial-gradient(ellipse at 50% 0%,rgba(226,179,64,.05) 0%,transparent 55%),
    radial-gradient(ellipse at 0% 100%,rgba(226,179,64,.025) 0%,transparent 40%),
    radial-gradient(ellipse at 100% 80%,rgba(180,130,220,.02) 0%,transparent 40%);
  background-attachment:fixed
}
[data-theme="obsidian"] .nav{background:rgba(26,26,46,.92);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);border-bottom-color:#3A3A56}
[data-theme="obsidian"] .nav-brand{color:#E2B340;letter-spacing:.04em;text-shadow:0 0 18px rgba(226,179,64,.25)}
[data-theme="obsidian"] .nav-tab.active{background:#E2B340;color:#1A1A2E;box-shadow:0 0 12px rgba(226,179,64,.2)}
[data-theme="obsidian"] .board-col{background:rgba(35,35,61,.8);border-color:#3A3A56;box-shadow:0 1px 6px rgba(0,0,0,.25)}
[data-theme="obsidian"] .board-col:hover{box-shadow:0 2px 12px rgba(0,0,0,.3),0 0 10px rgba(226,179,64,.06)}
[data-theme="obsidian"] .board-col-header{box-shadow:0 2px 8px rgba(0,0,0,.25)}
[data-theme="obsidian"] .card{background:rgba(38,38,64,.85);border-color:#3A3A56;box-shadow:0 1px 4px rgba(0,0,0,.2)}
[data-theme="obsidian"] .card:hover{box-shadow:0 4px 16px rgba(0,0,0,.3),0 0 8px rgba(226,179,64,.08);transform:translateY(-1px)}
[data-theme="obsidian"] .card.dragging{box-shadow:0 0 20px rgba(226,179,64,.15)}
[data-theme="obsidian"] .board-col.drag-over{border-color:#E2B340;box-shadow:0 0 16px rgba(226,179,64,.2)}
[data-theme="obsidian"] .board-col.drag-invalid{box-shadow:0 0 16px rgba(207,68,68,.25)}
[data-theme="obsidian"] .detail{background:rgba(35,35,61,.9);box-shadow:0 2px 16px rgba(0,0,0,.3)}
[data-theme="obsidian"] .detail-title{text-shadow:0 0 12px rgba(226,179,64,.1)}
[data-theme="obsidian"] .form-control:focus{box-shadow:0 0 0 2px rgba(226,179,64,.25),0 0 10px rgba(226,179,64,.08)}
[data-theme="obsidian"] .settings-panel{background:rgba(26,26,46,.95);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px)}
[data-theme="obsidian"] .detail-panel{background:rgba(26,26,46,.95);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px)}
[data-theme="obsidian"] .modal{background:rgba(35,35,61,.96);border:1px solid rgba(226,179,64,.15);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
[data-theme="obsidian"] .modal-overlay{backdrop-filter:blur(3px)}
[data-theme="obsidian"] .toast-success{box-shadow:0 2px 12px rgba(76,175,106,.25)}
[data-theme="obsidian"] .toast-error{box-shadow:0 2px 12px rgba(207,68,68,.25)}
[data-theme="obsidian"] .pri-critical{box-shadow:0 0 6px rgba(207,68,68,.4)}
[data-theme="obsidian"] .pri-high{box-shadow:0 0 6px rgba(224,140,40,.35)}
[data-theme="obsidian"] .pri-medium{box-shadow:0 0 6px rgba(226,179,64,.3)}
[data-theme="obsidian"] .activity-list{background:rgba(35,35,61,.85)}
[data-theme="obsidian"] table{background:rgba(35,35,61,.85)}
[data-theme="obsidian"] .comment-item{background:rgba(42,42,69,.6);border-color:#3A3A56}
[data-theme="obsidian"] ::-webkit-scrollbar{width:8px}
[data-theme="obsidian"] ::-webkit-scrollbar-track{background:rgba(26,26,46,.6)}
[data-theme="obsidian"] ::-webkit-scrollbar-thumb{background:rgba(226,179,64,.2);border-radius:4px}
[data-theme="obsidian"] ::-webkit-scrollbar-thumb:hover{background:rgba(226,179,64,.35)}
[data-theme="obsidian"] .status-backlog .board-col-header{background:#4A4A5E}
[data-theme="obsidian"] .status-in_planning .board-col-header{background:#2A7A8A}
[data-theme="obsidian"] .status-planned .board-col-header{background:#2A8A6A}
[data-theme="obsidian"] .status-in_implementation .board-col-header{background:#4060C0}
[data-theme="obsidian"] .status-implemented .board-col-header{background:#3090B0}
[data-theme="obsidian"] .status-in_review .board-col-header{background:#7A52B5}
[data-theme="obsidian"] .status-done .board-col-header{background:#3A8A54}
[data-theme="obsidian"] .status-cancelled .board-col-header{background:#505060}

/* === Carbon Theme Overrides === */
[data-theme="carbon"] body{
  background-image:
    repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(255,255,255,.01) 3px,rgba(255,255,255,.01) 4px),
    radial-gradient(ellipse at 50% 0%,rgba(234,88,12,.03) 0%,transparent 50%),
    radial-gradient(ellipse at 0% 100%,rgba(234,88,12,.015) 0%,transparent 40%);
  background-attachment:fixed;
  font-variant-numeric:tabular-nums;letter-spacing:.01em
}
[data-theme="carbon"] .nav{background:#1A1A1A;border-bottom:2px solid #EA580C;padding:6px 16px}
[data-theme="carbon"] .nav-brand{font-weight:700;text-transform:uppercase;font-size:.95rem;letter-spacing:.12em;color:#EA580C}
[data-theme="carbon"] .nav-tab{border-radius:2px;text-transform:uppercase;font-size:.75rem;font-weight:600;letter-spacing:.08em;padding:4px 10px}
[data-theme="carbon"] .nav-tab.active{background:#EA580C;color:#fff;border-radius:2px}
[data-theme="carbon"] .board-col{background:#1E1E1E;border-color:#333;border-radius:3px}
[data-theme="carbon"] .board-col-header{font-size:.78rem;text-transform:uppercase;letter-spacing:.1em;font-weight:700;border-radius:3px 3px 0 0;padding:6px 10px}
[data-theme="carbon"] .card{background:#1C1C1C;border-color:#2A2A2A;border-radius:2px;padding:6px 8px;margin-bottom:4px;font-size:.8rem}
[data-theme="carbon"] .card:hover{box-shadow:0 1px 6px rgba(0,0,0,.4);border-color:#EA580C}
[data-theme="carbon"] .card-title{font-size:.82rem}
[data-theme="carbon"] .board-col.drag-over{border-color:#EA580C;box-shadow:inset 0 0 0 1px #EA580C}
[data-theme="carbon"] .board-col.drag-invalid{border-color:#DC2626;box-shadow:inset 0 0 0 1px #DC2626}
[data-theme="carbon"] .detail{background:#1E1E1E;border-color:#333;border-radius:4px}
[data-theme="carbon"] .detail-title{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;letter-spacing:.02em}
[data-theme="carbon"] .form-control{border-radius:2px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.82rem}
[data-theme="carbon"] .form-control:focus{box-shadow:0 0 0 2px rgba(234,88,12,.25)}
[data-theme="carbon"] .settings-panel{background:#1A1A1A;border-left:2px solid #333}
[data-theme="carbon"] .modal{background:#1E1E1E;border:1px solid #444;border-radius:4px}
[data-theme="carbon"] .modal-header h2{text-transform:uppercase;font-size:.95rem;letter-spacing:.06em}
[data-theme="carbon"] .toast-success{background:#16A34A;border-radius:2px}
[data-theme="carbon"] .toast-error{background:#DC2626;border-radius:2px}
[data-theme="carbon"] .badge{border-radius:2px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.72rem;text-transform:uppercase;letter-spacing:.04em}
[data-theme="carbon"] .pri-critical,.pri-high,.pri-medium,.pri-low{border-radius:2px}
[data-theme="carbon"] .activity-list{background:#1E1E1E;border-color:#333}
[data-theme="carbon"] table{background:#1E1E1E;border-color:#333}
[data-theme="carbon"] th{text-transform:uppercase;font-size:.72rem;letter-spacing:.08em;border-bottom:2px solid #EA580C}
[data-theme="carbon"] .comment-item{background:#1C1C1C;border-color:#2A2A2A;border-radius:2px}
[data-theme="carbon"] .member-chip{border-radius:2px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.72rem;letter-spacing:.02em}
[data-theme="carbon"] ::-webkit-scrollbar{width:6px}
[data-theme="carbon"] ::-webkit-scrollbar-track{background:#171717}
[data-theme="carbon"] ::-webkit-scrollbar-thumb{background:#444;border-radius:1px}
[data-theme="carbon"] ::-webkit-scrollbar-thumb:hover{background:#EA580C}
[data-theme="carbon"] .status-backlog .board-col-header{background:#404040}
[data-theme="carbon"] .status-in_planning .board-col-header{background:#0E7490}
[data-theme="carbon"] .status-planned .board-col-header{background:#0F766E}
[data-theme="carbon"] .status-in_implementation .board-col-header{background:#2563EB}
[data-theme="carbon"] .status-implemented .board-col-header{background:#0284C7}
[data-theme="carbon"] .status-in_review .board-col-header{background:#7C3AED}
[data-theme="carbon"] .status-done .board-col-header{background:#16A34A}
[data-theme="carbon"] .status-cancelled .board-col-header{background:#525252}

/* === Vaporwave Theme Overrides === */
[data-theme="vaporwave"] body{
  background-image:
    repeating-linear-gradient(0deg,transparent,transparent 59px,rgba(0,255,209,.04) 59px,rgba(0,255,209,.04) 60px),
    repeating-linear-gradient(90deg,transparent,transparent 59px,rgba(255,113,206,.04) 59px,rgba(255,113,206,.04) 60px),
    linear-gradient(180deg,#0d0221 0%,#1a0a2e 40%,#2d1450 100%)
}
[data-theme="vaporwave"] .nav{
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  background:linear-gradient(90deg,rgba(26,10,46,.9),rgba(45,20,80,.85),rgba(26,10,46,.9));
  border-bottom:1px solid rgba(255,113,206,.25);
  box-shadow:0 2px 30px rgba(255,113,206,.1)
}
[data-theme="vaporwave"] .nav-brand{
  letter-spacing:.15em;
  background:linear-gradient(90deg,#FF71CE,#01CDFE,#00FFD1);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  filter:drop-shadow(0 0 10px rgba(255,113,206,.5));
  animation:vw-brand-glow 3s ease-in-out infinite alternate
}
@keyframes vw-brand-glow{
  0%{filter:drop-shadow(0 0 10px rgba(255,113,206,.5))}
  100%{filter:drop-shadow(0 0 20px rgba(0,255,209,.5))}
}
[data-theme="vaporwave"] .nav-tab.active{
  background:linear-gradient(135deg,#FF71CE,#B967FF);
  box-shadow:0 0 15px rgba(255,113,206,.4),0 0 30px rgba(185,103,255,.2);
  border-color:transparent
}
[data-theme="vaporwave"] .board-col{
  backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  background:rgba(26,10,46,.5);
  border:1px solid rgba(255,113,206,.12);
  box-shadow:0 0 20px var(--glow-primary)
}
[data-theme="vaporwave"] .board-col:hover{box-shadow:0 0 30px var(--glow-primary-strong)}
[data-theme="vaporwave"] .board-col-header{
  box-shadow:0 2px 15px rgba(0,0,0,.3);
  text-shadow:0 0 10px rgba(255,255,255,.3)
}
[data-theme="vaporwave"] .card{
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  background:linear-gradient(135deg,rgba(45,20,80,.5),rgba(26,10,46,.6));
  border:1px solid rgba(0,255,209,.1);
  box-shadow:0 0 12px var(--glow-primary);
  transition:box-shadow .2s,transform .2s,border-color .2s
}
[data-theme="vaporwave"] .card:hover{
  box-shadow:0 0 25px rgba(255,113,206,.25),0 0 50px rgba(0,255,209,.1);
  transform:translateY(-2px);
  border-color:rgba(255,113,206,.3)
}
[data-theme="vaporwave"] .card.dragging{
  box-shadow:0 0 40px rgba(255,113,206,.4),0 0 80px rgba(0,255,209,.2)
}
[data-theme="vaporwave"] .board-col.drag-over{
  border-color:#00FFD1;
  box-shadow:0 0 30px rgba(0,255,209,.3)
}
[data-theme="vaporwave"] .board-col.drag-invalid{
  border-color:#ff0050;
  box-shadow:0 0 30px rgba(255,0,80,.3)
}
[data-theme="vaporwave"] .pri-critical{
  box-shadow:0 0 10px rgba(255,0,80,.6);
  animation:vw-pulse-critical 2s ease-in-out infinite
}
[data-theme="vaporwave"] .pri-high{box-shadow:0 0 8px rgba(255,113,206,.5)}
[data-theme="vaporwave"] .pri-medium{box-shadow:0 0 8px rgba(0,255,209,.4)}
[data-theme="vaporwave"] .pri-low{box-shadow:0 0 6px rgba(240,208,255,.1)}
@keyframes vw-pulse-critical{
  0%,100%{box-shadow:0 0 10px rgba(255,0,80,.6)}
  50%{box-shadow:0 0 22px rgba(255,0,80,.9),0 0 44px rgba(255,0,80,.3)}
}
[data-theme="vaporwave"] .detail{
  backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  background:linear-gradient(160deg,rgba(45,20,80,.6),rgba(26,10,46,.7));
  box-shadow:0 0 30px var(--glow-primary)
}
[data-theme="vaporwave"] .detail-title{
  background:linear-gradient(90deg,#FF71CE,#01CDFE);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text
}
[data-theme="vaporwave"] .modal{
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border:1px solid rgba(255,113,206,.25);
  background:linear-gradient(160deg,rgba(45,20,80,.9),rgba(26,10,46,.95))
}
[data-theme="vaporwave"] .modal-overlay{backdrop-filter:blur(6px)}
[data-theme="vaporwave"] .form-control:focus{
  box-shadow:0 0 0 2px rgba(255,113,206,.3),0 0 20px rgba(255,113,206,.1);
  border-color:#FF71CE
}
[data-theme="vaporwave"] .settings-panel{
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  background:linear-gradient(180deg,rgba(45,20,80,.95),rgba(26,10,46,.98))
}
[data-theme="vaporwave"] .toast-success{
  background:linear-gradient(135deg,#00FFD1,#00c9a7);
  color:#0d0221;
  box-shadow:0 0 20px rgba(0,255,209,.4)
}
[data-theme="vaporwave"] .toast-error{
  background:linear-gradient(135deg,#ff0050,#ff3377);
  box-shadow:0 0 20px rgba(255,0,80,.4)
}
[data-theme="vaporwave"] .activity-list{
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  background:rgba(26,10,46,.5)
}
[data-theme="vaporwave"] table{
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  background:rgba(26,10,46,.5)
}
[data-theme="vaporwave"] .comment-item{
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  background:linear-gradient(135deg,rgba(45,20,80,.4),rgba(26,10,46,.5))
}
[data-theme="vaporwave"] ::-webkit-scrollbar{width:8px}
[data-theme="vaporwave"] ::-webkit-scrollbar-track{background:rgba(13,2,33,.5)}
[data-theme="vaporwave"] ::-webkit-scrollbar-thumb{
  background:linear-gradient(180deg,#FF71CE,#B967FF);
  border-radius:4px
}
[data-theme="vaporwave"] ::-webkit-scrollbar-thumb:hover{
  background:linear-gradient(180deg,#ff4fc0,#a64dff)
}
[data-theme="vaporwave"] .status-backlog .board-col-header{background:#4a2870}
[data-theme="vaporwave"] .status-in_planning .board-col-header{background:linear-gradient(135deg,#B967FF,#8B5CF6)}
[data-theme="vaporwave"] .status-planned .board-col-header{background:linear-gradient(135deg,#01CDFE,#05a8cc)}
[data-theme="vaporwave"] .status-in_implementation .board-col-header{background:linear-gradient(135deg,#FF71CE,#d45fad)}
[data-theme="vaporwave"] .status-implemented .board-col-header{background:linear-gradient(135deg,#00FFD1,#00c9a7)}
[data-theme="vaporwave"] .status-in_review .board-col-header{background:linear-gradient(135deg,#B967FF,#FF71CE)}
[data-theme="vaporwave"] .status-done .board-col-header{background:linear-gradient(135deg,#00FFD1,#01CDFE)}
[data-theme="vaporwave"] .status-cancelled .board-col-header{background:#3d2060}
[data-theme="vaporwave"] .badge-stat{
  background:rgba(255,113,206,.12);
  color:#FF71CE;
  border:1px solid rgba(255,113,206,.2)
}
[data-theme="vaporwave"] .btn{
  border-color:rgba(255,113,206,.2);
  background:rgba(45,20,80,.5)
}
[data-theme="vaporwave"] .btn:hover{
  background:rgba(255,113,206,.15);
  border-color:rgba(255,113,206,.4)
}
[data-theme="vaporwave"] a{color:#01CDFE}
[data-theme="vaporwave"] a:hover{color:#00FFD1}
[data-theme="vaporwave"] .member-chip{text-shadow:0 0 8px currentColor}

/* === Neon Noir Theme Overrides === */
[data-theme="neon-noir"] body{
  background:#000;
  background-image:
    repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(255,0,128,.008) 3px,rgba(255,0,128,.008) 4px),
    radial-gradient(ellipse at 50% 100%,rgba(255,0,128,.04) 0%,transparent 60%),
    radial-gradient(ellipse at 0% 50%,rgba(0,212,255,.02) 0%,transparent 40%)
}
[data-theme="neon-noir"] body::before{
  content:"";position:fixed;top:0;left:0;right:0;bottom:0;
  pointer-events:none;z-index:998;
  background:repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(0,0,0,.05) 1px,rgba(0,0,0,.05) 2px)
}
[data-theme="neon-noir"] .nav{
  background:rgba(0,0,0,.95);
  border-bottom:1px solid rgba(255,0,128,.3);
  box-shadow:0 1px 0 rgba(255,0,128,.5),0 4px 30px rgba(255,0,128,.08);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)
}
[data-theme="neon-noir"] .nav-brand{
  color:#FF0080;
  text-shadow:0 0 10px rgba(255,0,128,.6),0 0 30px rgba(255,0,128,.3),0 0 60px rgba(255,0,128,.15);
  letter-spacing:.12em;
  animation:nn-brand-flicker 4s ease-in-out infinite
}
@keyframes nn-brand-flicker{
  0%,100%{text-shadow:0 0 10px rgba(255,0,128,.6),0 0 30px rgba(255,0,128,.3),0 0 60px rgba(255,0,128,.15)}
  92%{text-shadow:0 0 10px rgba(255,0,128,.6),0 0 30px rgba(255,0,128,.3),0 0 60px rgba(255,0,128,.15)}
  93%{text-shadow:0 0 4px rgba(255,0,128,.2)}
  94%{text-shadow:0 0 10px rgba(255,0,128,.6),0 0 30px rgba(255,0,128,.3),0 0 60px rgba(255,0,128,.15)}
  96%{text-shadow:0 0 2px rgba(255,0,128,.1)}
  97%{text-shadow:0 0 10px rgba(255,0,128,.6),0 0 30px rgba(255,0,128,.3),0 0 60px rgba(255,0,128,.15)}
}
[data-theme="neon-noir"] .nav-tab.active{
  background:transparent;
  color:#FF0080;
  border:1px solid #FF0080;
  box-shadow:0 0 10px rgba(255,0,128,.4),inset 0 0 10px rgba(255,0,128,.1)
}
[data-theme="neon-noir"] .board-col{
  background:rgba(5,5,5,.9);
  border:1px solid rgba(255,0,128,.1);
  box-shadow:0 0 15px rgba(0,0,0,.5)
}
[data-theme="neon-noir"] .board-col:hover{
  border-color:rgba(255,0,128,.25);
  box-shadow:0 0 20px rgba(255,0,128,.08)
}
[data-theme="neon-noir"] .board-col-header{
  text-shadow:0 0 8px rgba(255,255,255,.2);
  box-shadow:0 2px 10px rgba(0,0,0,.5)
}
[data-theme="neon-noir"] .card{
  background:rgba(8,8,8,.95);
  border:1px solid rgba(0,212,255,.1);
  box-shadow:0 0 0 0 transparent;
  transition:box-shadow .25s,transform .25s,border-color .25s
}
[data-theme="neon-noir"] .card:hover{
  border-color:rgba(0,212,255,.4);
  box-shadow:0 0 12px rgba(0,212,255,.15),0 0 24px rgba(0,212,255,.05);
  transform:translateY(-1px)
}
[data-theme="neon-noir"] .card.dragging{
  border-color:rgba(255,0,128,.5);
  box-shadow:0 0 30px rgba(255,0,128,.3),0 0 60px rgba(255,0,128,.1)
}
[data-theme="neon-noir"] .board-col.drag-over{
  border-color:#00D4FF;
  box-shadow:0 0 20px rgba(0,212,255,.25),inset 0 0 30px rgba(0,212,255,.03)
}
[data-theme="neon-noir"] .board-col.drag-invalid{
  border-color:#FF0040;
  box-shadow:0 0 20px rgba(255,0,64,.25)
}
[data-theme="neon-noir"] .pri-critical{
  box-shadow:0 0 6px rgba(255,0,64,.5),0 0 12px rgba(255,0,64,.2);
  animation:nn-pulse-critical 1.5s ease-in-out infinite
}
[data-theme="neon-noir"] .pri-high{
  box-shadow:0 0 6px rgba(255,0,128,.4)
}
[data-theme="neon-noir"] .pri-medium{
  box-shadow:0 0 6px rgba(0,212,255,.4)
}
[data-theme="neon-noir"] .pri-low{
  box-shadow:0 0 4px rgba(240,240,240,.06)
}
@keyframes nn-pulse-critical{
  0%,100%{box-shadow:0 0 6px rgba(255,0,64,.5),0 0 12px rgba(255,0,64,.2)}
  50%{box-shadow:0 0 14px rgba(255,0,64,.8),0 0 28px rgba(255,0,64,.3),0 0 56px rgba(255,0,64,.1)}
}
[data-theme="neon-noir"] .detail{
  background:rgba(5,5,5,.95);
  border:1px solid rgba(255,0,128,.15);
  box-shadow:0 0 25px rgba(0,0,0,.5)
}
[data-theme="neon-noir"] .detail-title{
  color:#FF0080;
  text-shadow:0 0 15px rgba(255,0,128,.3)
}
[data-theme="neon-noir"] .modal{
  background:rgba(5,5,5,.98);
  border:1px solid rgba(255,0,128,.3);
  box-shadow:0 0 60px rgba(255,0,128,.1),0 0 120px rgba(0,212,255,.05),0 8px 32px rgba(0,0,0,.8)
}
[data-theme="neon-noir"] .modal-overlay{
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)
}
[data-theme="neon-noir"] .form-control:focus{
  box-shadow:0 0 0 1px #FF0080,0 0 15px rgba(255,0,128,.15);
  border-color:#FF0080
}
[data-theme="neon-noir"] .settings-panel{
  background:rgba(0,0,0,.98);
  border-left:1px solid rgba(255,0,128,.3);
  box-shadow:-4px 0 30px rgba(255,0,128,.08)
}
[data-theme="neon-noir"] .toast-success{
  background:#000;
  color:#00FF88;
  border:1px solid #00FF88;
  box-shadow:0 0 20px rgba(0,255,136,.25),inset 0 0 15px rgba(0,255,136,.05)
}
[data-theme="neon-noir"] .toast-error{
  background:#000;
  color:#FF0040;
  border:1px solid #FF0040;
  box-shadow:0 0 20px rgba(255,0,64,.25),inset 0 0 15px rgba(255,0,64,.05)
}
[data-theme="neon-noir"] .activity-list{
  background:rgba(5,5,5,.95);
  border:1px solid rgba(0,212,255,.1)
}
[data-theme="neon-noir"] table{
  background:rgba(5,5,5,.95);
  border:1px solid rgba(255,0,128,.15)
}
[data-theme="neon-noir"] th{
  background:rgba(0,0,0,.95);
  border-bottom:1px solid rgba(255,0,128,.25)
}
[data-theme="neon-noir"] .comment-item{
  background:rgba(8,8,8,.9);
  border:1px solid rgba(0,212,255,.08)
}
[data-theme="neon-noir"] .badge-stat{
  background:rgba(255,0,128,.08);
  color:#FF0080;
  border:1px solid rgba(255,0,128,.2)
}
[data-theme="neon-noir"] .btn{
  border-color:rgba(255,0,128,.2);
  background:rgba(10,10,10,.9)
}
[data-theme="neon-noir"] .btn:hover{
  border-color:rgba(255,0,128,.5);
  box-shadow:0 0 10px rgba(255,0,128,.1);
  background:rgba(255,0,128,.05)
}
[data-theme="neon-noir"] a{color:#00D4FF;text-shadow:0 0 8px rgba(0,212,255,.2)}
[data-theme="neon-noir"] a:hover{color:#FF0080;text-shadow:0 0 8px rgba(255,0,128,.3)}
[data-theme="neon-noir"] .member-chip{
  text-shadow:0 0 6px currentColor;
  box-shadow:0 0 4px rgba(255,0,128,.05)
}
[data-theme="neon-noir"] .status-backlog .board-col-header{background:#1a1a1a;border-bottom:2px solid #444}
[data-theme="neon-noir"] .status-in_planning .board-col-header{background:rgba(0,0,0,.9);border-bottom:2px solid #00D4FF;box-shadow:0 2px 15px rgba(0,212,255,.2)}
[data-theme="neon-noir"] .status-planned .board-col-header{background:rgba(0,0,0,.9);border-bottom:2px solid #00FFA3;box-shadow:0 2px 15px rgba(0,255,163,.2)}
[data-theme="neon-noir"] .status-in_implementation .board-col-header{background:rgba(0,0,0,.9);border-bottom:2px solid #FF0080;box-shadow:0 2px 15px rgba(255,0,128,.2)}
[data-theme="neon-noir"] .status-implemented .board-col-header{background:rgba(0,0,0,.9);border-bottom:2px solid #00D4FF;box-shadow:0 2px 15px rgba(0,212,255,.15)}
[data-theme="neon-noir"] .status-in_review .board-col-header{background:rgba(0,0,0,.9);border-bottom:2px solid #BF00FF;box-shadow:0 2px 15px rgba(191,0,255,.2)}
[data-theme="neon-noir"] .status-done .board-col-header{background:rgba(0,0,0,.9);border-bottom:2px solid #00FF88;box-shadow:0 2px 15px rgba(0,255,136,.2)}
[data-theme="neon-noir"] .status-cancelled .board-col-header{background:#0a0a0a;border-bottom:2px solid #333}
[data-theme="neon-noir"] ::-webkit-scrollbar{width:6px}
[data-theme="neon-noir"] ::-webkit-scrollbar-track{background:#000}
[data-theme="neon-noir"] ::-webkit-scrollbar-thumb{
  background:rgba(255,0,128,.3);
  border-radius:3px;
  box-shadow:0 0 6px rgba(255,0,128,.2)
}
[data-theme="neon-noir"] ::-webkit-scrollbar-thumb:hover{
  background:rgba(255,0,128,.6);
  box-shadow:0 0 10px rgba(255,0,128,.4)
}

/* === Acid Rain Theme Overrides === */
/* Matrix rain background animation */
@keyframes acid-rain-fall{
  0%{background-position:0% 0%,50% 0%,25% 0%}
  100%{background-position:0% 3000px,50% 4500px,25% 2000px}
}
@keyframes acid-scanline{
  0%{transform:translateY(-100%)}
  100%{transform:translateY(100vh)}
}
@keyframes acid-flicker{
  0%,95%,100%{opacity:1}
  96%{opacity:.85}
  97%{opacity:.9}
}
@keyframes acid-glow-pulse{
  0%,100%{text-shadow:0 0 10px rgba(57,255,20,.4),0 0 20px rgba(57,255,20,.2)}
  50%{text-shadow:0 0 20px rgba(57,255,20,.6),0 0 40px rgba(57,255,20,.3),0 0 60px rgba(57,255,20,.1)}
}
@keyframes acid-cursor-blink{
  0%,100%{opacity:1}
  50%{opacity:0}
}
[data-theme="acid-rain"] body{
  background-color:#0a0a0a;
  background-image:
    repeating-linear-gradient(180deg,
      transparent,transparent 2px,rgba(57,255,20,.015) 2px,rgba(57,255,20,.015) 4px),
    linear-gradient(180deg,
      transparent 0%,rgba(57,255,20,.03) 25%,transparent 30%,
      transparent 45%,rgba(57,255,20,.02) 60%,transparent 65%,
      transparent 80%,rgba(57,255,20,.025) 90%,transparent 100%),
    linear-gradient(180deg,
      rgba(57,255,20,.02) 0%,transparent 15%,
      transparent 50%,rgba(57,255,20,.015) 70%,transparent 85%),
    linear-gradient(180deg,
      transparent 10%,rgba(57,255,20,.01) 30%,transparent 50%,
      rgba(57,255,20,.02) 75%,transparent 90%);
  background-size:100% 4px,100% 800px,100% 600px,100% 1000px;
  animation:acid-rain-fall 20s linear infinite,acid-flicker 8s ease-in-out infinite;
  font-family:"Courier New",Courier,"Lucida Console",monospace!important;
}
/* Scanline overlay */
[data-theme="acid-rain"] body::before{
  content:"";
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  pointer-events:none;
  z-index:999;
  background:repeating-linear-gradient(
    0deg,
    transparent,
    transparent 1px,
    rgba(0,0,0,.08) 1px,
    rgba(0,0,0,.08) 2px
  );
}
/* Moving scanline bar */
[data-theme="acid-rain"] body::after{
  content:"";
  position:fixed;
  top:0;left:0;right:0;
  height:4px;
  pointer-events:none;
  z-index:1000;
  background:linear-gradient(180deg,transparent,rgba(57,255,20,.12),transparent);
  box-shadow:0 0 30px 10px rgba(57,255,20,.05);
  animation:acid-scanline 6s linear infinite;
}
[data-theme="acid-rain"] .nav{
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  background:rgba(0,10,0,.9);
  border-bottom:1px solid rgba(57,255,20,.3);
  box-shadow:0 2px 20px rgba(57,255,20,.1);
}
[data-theme="acid-rain"] .nav-brand{
  letter-spacing:.2em;
  text-transform:uppercase;
  animation:acid-glow-pulse 3s ease-in-out infinite;
  font-size:1rem;
}
[data-theme="acid-rain"] .nav-brand::before{
  content:"> ";
  animation:acid-cursor-blink 1s step-end infinite;
}
[data-theme="acid-rain"] .nav-tab{
  font-family:"Courier New",Courier,monospace;
  text-transform:uppercase;
  letter-spacing:.1em;
  font-size:.8rem;
}
[data-theme="acid-rain"] .nav-tab.active{
  background:rgba(57,255,20,.15);
  color:#39FF14;
  border:1px solid rgba(57,255,20,.5);
  box-shadow:0 0 15px rgba(57,255,20,.2),inset 0 0 15px rgba(57,255,20,.05);
}
[data-theme="acid-rain"] .board-col{
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  background:rgba(0,10,0,.6);
  border:1px solid rgba(57,255,20,.15);
  box-shadow:0 0 20px rgba(57,255,20,.05),inset 0 0 30px rgba(57,255,20,.02);
}
[data-theme="acid-rain"] .board-col:hover{
  box-shadow:0 0 30px rgba(57,255,20,.12),inset 0 0 40px rgba(57,255,20,.04);
}
[data-theme="acid-rain"] .board-col-header{
  text-transform:uppercase;
  letter-spacing:.15em;
  font-size:.75rem;
  font-family:"Courier New",Courier,monospace;
  box-shadow:0 2px 15px rgba(0,0,0,.4);
}
[data-theme="acid-rain"] .card{
  backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  background:rgba(0,15,0,.65);
  border:1px solid rgba(57,255,20,.12);
  box-shadow:0 0 8px rgba(57,255,20,.06);
  font-family:"Courier New",Courier,monospace;
  position:relative;
}
[data-theme="acid-rain"] .card::before{
  content:"";
  position:absolute;top:0;left:0;right:0;bottom:0;
  border-radius:inherit;
  pointer-events:none;
  box-shadow:inset 0 0 20px rgba(57,255,20,.03);
}
[data-theme="acid-rain"] .card:hover{
  box-shadow:0 0 20px rgba(57,255,20,.2),0 0 40px rgba(57,255,20,.05);
  border-color:rgba(57,255,20,.3);
  transform:translateY(-1px);
}
[data-theme="acid-rain"] .card-title{
  text-shadow:0 0 8px rgba(57,255,20,.2);
}
[data-theme="acid-rain"] .detail{
  background:rgba(0,10,0,.9);
  border:1px solid rgba(57,255,20,.2);
  box-shadow:0 0 30px rgba(57,255,20,.05);
}
[data-theme="acid-rain"] .modal{
  background:rgba(0,10,0,.95);
  border:1px solid rgba(57,255,20,.3);
  box-shadow:0 0 60px rgba(57,255,20,.15),0 0 120px rgba(57,255,20,.05);
}
[data-theme="acid-rain"] .settings-panel{
  background:rgba(0,10,0,.95);
  border-left:1px solid rgba(57,255,20,.2);
  box-shadow:-4px 0 30px rgba(57,255,20,.08);
}
[data-theme="acid-rain"] .form-control{
  background:rgba(0,10,0,.8);
  border:1px solid rgba(57,255,20,.2);
  color:#39FF14;
  font-family:"Courier New",Courier,monospace;
}
[data-theme="acid-rain"] .form-control:focus{
  border-color:#39FF14;
  box-shadow:0 0 0 2px rgba(57,255,20,.2),0 0 15px rgba(57,255,20,.1);
}
[data-theme="acid-rain"] .toast-success{
  background:rgba(0,15,0,.9);
  border:1px solid #39FF14;
  color:#39FF14;
  box-shadow:0 0 20px rgba(57,255,20,.3);
}
[data-theme="acid-rain"] .toast-error{
  background:rgba(20,0,0,.9);
  border:1px solid #ff2040;
  color:#ff2040;
  box-shadow:0 0 20px rgba(255,32,64,.3);
}
[data-theme="acid-rain"] .badge{
  font-family:"Courier New",Courier,monospace;
  text-transform:uppercase;
  letter-spacing:.05em;
}
[data-theme="acid-rain"] .pri-critical{
  background:#ff2040;color:#0a0a0a;
  box-shadow:0 0 10px rgba(255,32,64,.4);
  text-shadow:none;
}
[data-theme="acid-rain"] .pri-high{
  background:#ff6600;color:#0a0a0a;
  box-shadow:0 0 8px rgba(255,102,0,.3);
  text-shadow:none;
}
[data-theme="acid-rain"] .pri-medium{
  background:rgba(57,255,20,.2);color:#39FF14;
  border:1px solid rgba(57,255,20,.4);
  box-shadow:0 0 8px rgba(57,255,20,.15);
}
[data-theme="acid-rain"] .pri-low{
  background:rgba(57,255,20,.08);color:rgba(57,255,20,.5);
  border:1px solid rgba(57,255,20,.15);
}
[data-theme="acid-rain"] .btn{
  font-family:"Courier New",Courier,monospace;
  text-transform:uppercase;
  letter-spacing:.05em;
  font-size:.8rem;
}
[data-theme="acid-rain"] .btn-primary{
  background:rgba(57,255,20,.15);
  color:#39FF14;
  border:1px solid rgba(57,255,20,.5);
  box-shadow:0 0 10px rgba(57,255,20,.1);
}
[data-theme="acid-rain"] .btn-primary:hover{
  background:rgba(57,255,20,.25);
  box-shadow:0 0 20px rgba(57,255,20,.2);
}
[data-theme="acid-rain"] .btn-new-task{
  background:rgba(57,255,20,.15);
  color:#39FF14;
  border:1px solid rgba(57,255,20,.5);
  box-shadow:0 0 10px rgba(57,255,20,.15);
}
[data-theme="acid-rain"] .btn-new-task:hover{
  background:rgba(57,255,20,.25);
  box-shadow:0 0 20px rgba(57,255,20,.25);
}
[data-theme="acid-rain"] table{
  background:rgba(0,10,0,.6);
  border:1px solid rgba(57,255,20,.15);
}
[data-theme="acid-rain"] th{
  background:rgba(0,10,0,.8);
  border-bottom:2px solid rgba(57,255,20,.3);
  text-transform:uppercase;
  letter-spacing:.1em;
  font-size:.75rem;
}
[data-theme="acid-rain"] td{
  border-bottom:1px solid rgba(57,255,20,.06);
  font-family:"Courier New",Courier,monospace;
}
[data-theme="acid-rain"] tr:hover td{
  background:rgba(57,255,20,.05);
}
[data-theme="acid-rain"] .filters select,
[data-theme="acid-rain"] .filters input{
  background:rgba(0,10,0,.8);
  border:1px solid rgba(57,255,20,.2);
  color:#39FF14;
  font-family:"Courier New",Courier,monospace;
}
[data-theme="acid-rain"] ::-webkit-scrollbar{width:6px;height:6px}
[data-theme="acid-rain"] ::-webkit-scrollbar-track{background:rgba(0,10,0,.4)}
[data-theme="acid-rain"] ::-webkit-scrollbar-thumb{background:rgba(57,255,20,.25);border-radius:3px}
[data-theme="acid-rain"] ::-webkit-scrollbar-thumb:hover{background:rgba(57,255,20,.4)}
[data-theme="acid-rain"] ::selection{background:rgba(57,255,20,.3);color:#39FF14}
[data-theme="acid-rain"] .activity-list{
  background:rgba(0,10,0,.6);
  border:1px solid rgba(57,255,20,.15);
}
[data-theme="acid-rain"] .comment-item{
  background:rgba(0,10,0,.5);
  border:1px solid rgba(57,255,20,.1);
}

/* === Solar Flare Theme Overrides === */
@keyframes solar-pulse{
  0%,100%{box-shadow:0 0 20px rgba(234,88,12,.15),0 0 40px rgba(234,88,12,.05)}
  50%{box-shadow:0 0 30px rgba(234,88,12,.25),0 0 60px rgba(234,88,12,.1)}
}
@keyframes solar-header-glow{
  0%,100%{text-shadow:0 0 10px rgba(252,211,77,.3)}
  50%{text-shadow:0 0 20px rgba(252,211,77,.5),0 0 40px rgba(234,88,12,.2)}
}
@keyframes solar-card-ember{
  0%,100%{box-shadow:0 0 8px rgba(234,88,12,.08),inset 0 -2px 10px rgba(234,88,12,.03)}
  50%{box-shadow:0 0 12px rgba(234,88,12,.12),inset 0 -2px 15px rgba(234,88,12,.05)}
}
@keyframes solar-critical-hotglow{
  0%,100%{box-shadow:0 0 6px rgba(254,252,232,.4)}
  50%{box-shadow:0 0 12px rgba(254,252,232,.6),0 0 20px rgba(252,211,77,.3)}
}
[data-theme="solar-flare"] body{
  background-color:#0C0A09;
  background-image:
    radial-gradient(ellipse 120% 80% at 50% 120%,rgba(153,27,27,.15) 0%,rgba(234,88,12,.05) 40%,transparent 70%),
    radial-gradient(ellipse 80% 60% at 20% 100%,rgba(153,27,27,.1) 0%,transparent 60%),
    radial-gradient(ellipse 80% 60% at 80% 100%,rgba(234,88,12,.08) 0%,transparent 60%),
    radial-gradient(circle 300px at 50% 90%,rgba(252,211,77,.03) 0%,transparent 100%);
  background-attachment:fixed;
}
/* Subtle heat distortion shimmer on body */
[data-theme="solar-flare"] body::before{
  content:"";
  position:fixed;top:0;left:0;right:0;bottom:0;
  pointer-events:none;z-index:998;
  background:
    repeating-linear-gradient(180deg,
      transparent,transparent 3px,rgba(234,88,12,.008) 3px,rgba(234,88,12,.008) 4px);
}
/* Bottom ember glow */
[data-theme="solar-flare"] body::after{
  content:"";
  position:fixed;bottom:0;left:0;right:0;height:200px;
  pointer-events:none;z-index:997;
  background:linear-gradient(0deg,
    rgba(153,27,27,.08) 0%,rgba(234,88,12,.04) 40%,transparent 100%);
}
[data-theme="solar-flare"] .nav{
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  background:rgba(28,25,23,.92);
  border-bottom:1px solid rgba(234,88,12,.2);
  box-shadow:0 2px 20px rgba(0,0,0,.3),0 1px 0 rgba(234,88,12,.1);
}
[data-theme="solar-flare"] .nav-brand{
  background:linear-gradient(135deg,#DC2626,#EA580C,#FCD34D);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  animation:solar-header-glow 4s ease-in-out infinite;
  font-weight:800;
}
[data-theme="solar-flare"] .nav-tab.active{
  background:linear-gradient(135deg,#991B1B,#EA580C);
  color:#FDE8D0;
  border:1px solid rgba(234,88,12,.5);
  box-shadow:0 0 15px rgba(234,88,12,.25);
}
[data-theme="solar-flare"] .board-col{
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  background:rgba(28,25,23,.65);
  border:1px solid rgba(234,88,12,.1);
  animation:solar-pulse 6s ease-in-out infinite;
}
[data-theme="solar-flare"] .board-col:hover{
  box-shadow:0 0 30px rgba(234,88,12,.2),0 0 60px rgba(234,88,12,.05);
  border-color:rgba(234,88,12,.2);
}
[data-theme="solar-flare"] .board-col-header{
  box-shadow:0 2px 10px rgba(0,0,0,.4),inset 0 -1px 0 rgba(255,255,255,.05);
  border-bottom:none;
}
[data-theme="solar-flare"] .card{
  backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  background:rgba(28,25,23,.6);
  border:1px solid rgba(234,88,12,.08);
  animation:solar-card-ember 5s ease-in-out infinite;
  position:relative;
  overflow:hidden;
}
/* Warm inner glow along bottom edge */
[data-theme="solar-flare"] .card::after{
  content:"";
  position:absolute;bottom:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,rgba(234,88,12,.15),rgba(252,211,77,.1),rgba(234,88,12,.15),transparent);
  pointer-events:none;
}
[data-theme="solar-flare"] .card:hover{
  box-shadow:0 0 20px rgba(234,88,12,.2),0 0 40px rgba(234,88,12,.06),inset 0 -4px 15px rgba(234,88,12,.06);
  border-color:rgba(234,88,12,.25);
  transform:translateY(-1px);
}
/* Priority badges as heat levels */
[data-theme="solar-flare"] .pri-critical{
  background:linear-gradient(135deg,#FEFCE8,#FDE68A);
  color:#78350F;
  box-shadow:0 0 8px rgba(254,252,232,.5),0 0 16px rgba(252,211,77,.2);
  animation:solar-critical-hotglow 2s ease-in-out infinite;
  font-weight:700;
  text-shadow:none;
}
[data-theme="solar-flare"] .pri-high{
  background:linear-gradient(135deg,#EF4444,#F97316);
  color:#FDE8D0;
  box-shadow:0 0 8px rgba(239,68,68,.3);
}
[data-theme="solar-flare"] .pri-medium{
  background:linear-gradient(135deg,#EA580C,#B45309);
  color:#FDE8D0;
  box-shadow:0 0 6px rgba(234,88,12,.2);
}
[data-theme="solar-flare"] .pri-low{
  background:rgba(120,113,108,.35);
  color:rgba(253,232,208,.5);
  border:1px solid rgba(120,113,108,.3);
}
[data-theme="solar-flare"] .detail{
  background:rgba(28,25,23,.92);
  border:1px solid rgba(234,88,12,.15);
  box-shadow:0 0 30px rgba(234,88,12,.05),inset 0 0 60px rgba(234,88,12,.02);
}
[data-theme="solar-flare"] .modal{
  background:rgba(28,25,23,.97);
  border:1px solid rgba(234,88,12,.25);
  box-shadow:0 0 60px rgba(234,88,12,.15),0 0 120px rgba(153,27,27,.08),0 8px 32px rgba(0,0,0,.5);
}
[data-theme="solar-flare"] .settings-panel{
  background:rgba(28,25,23,.97);
  border-left:1px solid rgba(234,88,12,.15);
  box-shadow:-4px 0 30px rgba(234,88,12,.08);
}
[data-theme="solar-flare"] .form-control{
  background:rgba(12,10,9,.7);
  border:1px solid rgba(234,88,12,.15);
  color:#FDE8D0;
}
[data-theme="solar-flare"] .form-control:focus{
  border-color:#EA580C;
  box-shadow:0 0 0 2px rgba(234,88,12,.2),0 0 15px rgba(234,88,12,.1);
}
[data-theme="solar-flare"] .toast-success{
  background:linear-gradient(135deg,#365314,#3F6212);
  color:#D9F99D;
  border:1px solid rgba(101,163,13,.3);
  box-shadow:0 0 15px rgba(101,163,13,.2);
}
[data-theme="solar-flare"] .toast-error{
  background:linear-gradient(135deg,#7F1D1D,#991B1B);
  color:#FECACA;
  border:1px solid rgba(220,38,38,.3);
  box-shadow:0 0 15px rgba(220,38,38,.2);
}
[data-theme="solar-flare"] .btn-primary{
  background:linear-gradient(135deg,#991B1B,#EA580C);
  color:#FDE8D0;
  border:1px solid rgba(234,88,12,.4);
  box-shadow:0 0 10px rgba(234,88,12,.15);
}
[data-theme="solar-flare"] .btn-primary:hover{
  background:linear-gradient(135deg,#B91C1C,#F97316);
  box-shadow:0 0 20px rgba(234,88,12,.3);
}
[data-theme="solar-flare"] .btn-new-task{
  background:linear-gradient(135deg,#991B1B,#EA580C);
  color:#FDE8D0;
  border:1px solid rgba(234,88,12,.4);
  box-shadow:0 0 10px rgba(234,88,12,.15);
}
[data-theme="solar-flare"] .btn-new-task:hover{
  background:linear-gradient(135deg,#B91C1C,#F97316);
  box-shadow:0 0 20px rgba(234,88,12,.3);
}
[data-theme="solar-flare"] table{
  background:rgba(28,25,23,.6);
  border:1px solid rgba(234,88,12,.12);
}
[data-theme="solar-flare"] th{
  background:rgba(12,10,9,.8);
  border-bottom:2px solid rgba(234,88,12,.2);
}
[data-theme="solar-flare"] td{
  border-bottom:1px solid rgba(234,88,12,.06);
}
[data-theme="solar-flare"] tr:hover td{
  background:rgba(234,88,12,.05);
}
[data-theme="solar-flare"] .filters select,
[data-theme="solar-flare"] .filters input{
  background:rgba(12,10,9,.7);
  border:1px solid rgba(234,88,12,.15);
  color:#FDE8D0;
}
[data-theme="solar-flare"] ::-webkit-scrollbar{width:6px;height:6px}
[data-theme="solar-flare"] ::-webkit-scrollbar-track{background:rgba(12,10,9,.5)}
[data-theme="solar-flare"] ::-webkit-scrollbar-thumb{
  background:linear-gradient(180deg,#991B1B,#EA580C);
  border-radius:3px;
}
[data-theme="solar-flare"] ::-webkit-scrollbar-thumb:hover{
  background:linear-gradient(180deg,#B91C1C,#F97316);
}
[data-theme="solar-flare"] ::selection{
  background:rgba(234,88,12,.35);color:#FDE8D0;
}
[data-theme="solar-flare"] .activity-list{
  background:rgba(28,25,23,.6);
  border:1px solid rgba(234,88,12,.12);
}
[data-theme="solar-flare"] .comment-item{
  background:rgba(28,25,23,.5);
  border:1px solid rgba(234,88,12,.08);
}
[data-theme="solar-flare"] .badge-stat{
  background:rgba(234,88,12,.1);
  color:rgba(253,232,208,.7);
  border:1px solid rgba(234,88,12,.15);
}
[data-theme="solar-flare"] .editable:hover{
  border-bottom-color:#EA580C;
}
[data-theme="solar-flare"] a{color:#FB923C}
[data-theme="solar-flare"] a:hover{color:#FCD34D}

/* === Ultraviolet Theme Overrides === */
/* UV background pulse animation */
@keyframes uvPulse {
  0%, 100% { background-color: #0D001A; }
  50% { background-color: #110022; }
}
@keyframes uvGlow {
  0%, 100% { box-shadow: 0 0 8px rgba(191,64,255,.15), inset 0 0 8px rgba(191,64,255,.03); }
  50% { box-shadow: 0 0 16px rgba(191,64,255,.25), inset 0 0 12px rgba(191,64,255,.06); }
}
@keyframes uvBorderPulse {
  0%, 100% { border-color: rgba(191,64,255,.2); }
  50% { border-color: rgba(191,64,255,.35); }
}
[data-theme="ultraviolet"] body {
  animation: uvPulse 6s ease-in-out infinite;
  background-image: radial-gradient(ellipse at 20% 50%, rgba(100,0,180,.08) 0%, transparent 60%),
                    radial-gradient(ellipse at 80% 20%, rgba(191,64,255,.05) 0%, transparent 50%);
  background-attachment: fixed;
}
[data-theme="ultraviolet"] .nav {
  background: rgba(15,2,30,.95);
  border-bottom: 1px solid rgba(191,64,255,.2);
  box-shadow: 0 2px 20px rgba(191,64,255,.08);
  backdrop-filter: blur(12px);
}
[data-theme="ultraviolet"] .nav-brand {
  color: #BF40FF;
  text-shadow: 0 0 12px rgba(191,64,255,.5), 0 0 30px rgba(191,64,255,.2);
}
[data-theme="ultraviolet"] .nav-tab.active {
  background: linear-gradient(135deg, #BF40FF, #9020d0);
  border-color: transparent;
  box-shadow: 0 0 12px rgba(191,64,255,.4);
}
[data-theme="ultraviolet"] .board-col {
  background: rgba(20,3,40,.85);
  border: 1px solid rgba(191,64,255,.15);
  animation: uvBorderPulse 4s ease-in-out infinite;
  backdrop-filter: blur(8px);
}
[data-theme="ultraviolet"] .board-col-header {
  border-bottom: 1px solid rgba(191,64,255,.15);
  text-shadow: 0 0 8px rgba(255,255,255,.2);
}
[data-theme="ultraviolet"] .card {
  background: rgba(30,5,60,.7);
  border: 1px solid rgba(191,64,255,.12);
  box-shadow: 0 0 8px rgba(191,64,255,.08);
  transition: box-shadow .3s, border-color .3s, transform .15s, opacity .15s;
}
[data-theme="ultraviolet"] .card:hover {
  border-color: rgba(191,64,255,.35);
  box-shadow: 0 0 20px rgba(191,64,255,.25), 0 0 40px rgba(150,0,255,.1), inset 0 0 12px rgba(191,64,255,.05);
  transform: translateY(-1px);
}
[data-theme="ultraviolet"] .detail {
  background: rgba(20,3,40,.92);
  border: 1px solid rgba(191,64,255,.2);
  box-shadow: 0 0 30px rgba(191,64,255,.08);
}
[data-theme="ultraviolet"] .modal {
  background: rgba(15,2,30,.96);
  border: 1px solid rgba(191,64,255,.25);
  box-shadow: 0 0 60px rgba(191,64,255,.15), 0 8px 32px rgba(0,0,0,.5);
}
[data-theme="ultraviolet"] .settings-panel {
  background: rgba(15,2,30,.97);
  border-left: 1px solid rgba(191,64,255,.2);
  box-shadow: -4px 0 24px rgba(191,64,255,.1);
}
[data-theme="ultraviolet"] .form-control:focus {
  border-color: #BF40FF;
  box-shadow: 0 0 0 3px rgba(191,64,255,.25), 0 0 12px rgba(191,64,255,.15);
  outline: none;
}
[data-theme="ultraviolet"] .toast-success {
  background: linear-gradient(135deg, #a855f7, #7c3aed);
  box-shadow: 0 0 20px rgba(168,85,247,.4);
}
[data-theme="ultraviolet"] .toast-error {
  background: linear-gradient(135deg, #ff3250, #dc2040);
  box-shadow: 0 0 20px rgba(255,50,80,.4);
}
[data-theme="ultraviolet"] ::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
[data-theme="ultraviolet"] ::-webkit-scrollbar-track {
  background: rgba(13,0,26,.5);
}
[data-theme="ultraviolet"] ::-webkit-scrollbar-thumb {
  background: rgba(191,64,255,.3);
  border-radius: 4px;
}
[data-theme="ultraviolet"] ::-webkit-scrollbar-thumb:hover {
  background: rgba(191,64,255,.5);
}

/* === Holographic Theme Overrides === */
/* Holographic rainbow gradient animation */
@keyframes holoShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
@keyframes holoShimmer {
  0% { background-position: 0% 50%; }
  100% { background-position: 200% 50%; }
}
[data-theme="holographic"] body {
  background: #0a0a0f;
  background-image: radial-gradient(ellipse at 30% 70%, rgba(107,204,255,.03) 0%, transparent 50%),
                    radial-gradient(ellipse at 70% 30%, rgba(204,107,255,.03) 0%, transparent 50%);
  background-attachment: fixed;
}
[data-theme="holographic"] .nav {
  background: rgba(12,12,18,.96);
  border-bottom: 2px solid transparent;
  border-image: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bff6b, #6bccff, #cc6bff, #ff6b6b) 1;
  backdrop-filter: blur(12px);
}
[data-theme="holographic"] .nav-brand {
  background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bff6b, #6bccff, #cc6bff);
  background-size: 300% 300%;
  animation: holoShift 6s ease-in-out infinite;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 800;
}
[data-theme="holographic"] .nav-tab.active {
  background: rgba(20,20,30,.9);
  border: 1.5px solid transparent;
  background-clip: padding-box;
  position: relative;
}
[data-theme="holographic"] .nav-tab.active::before {
  content: "";
  position: absolute;
  inset: -1.5px;
  border-radius: inherit;
  padding: 1.5px;
  background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bff6b, #6bccff, #cc6bff);
  background-size: 300% 300%;
  animation: holoShift 4s ease-in-out infinite;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
}
[data-theme="holographic"] .board-col {
  background: rgba(14,14,22,.85);
  border: 1.5px solid transparent;
  position: relative;
  overflow: visible;
}
[data-theme="holographic"] .board-col::before {
  content: "";
  position: absolute;
  inset: -1.5px;
  border-radius: var(--radius-md);
  padding: 1.5px;
  background: linear-gradient(135deg, #ff6b6b44, #ffd93d44, #6bff6b44, #6bccff44, #cc6bff44);
  background-size: 300% 300%;
  animation: holoShift 8s ease-in-out infinite;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
  z-index: 0;
}
[data-theme="holographic"] .board-col-header {
  position: relative;
  z-index: 1;
  text-shadow: 0 0 8px rgba(255,255,255,.15);
}
[data-theme="holographic"] .board-col-body {
  position: relative;
  z-index: 1;
}
[data-theme="holographic"] .card {
  background: rgba(16,16,24,.92);
  border: 1.5px solid transparent;
  position: relative;
  overflow: visible;
  transition: transform .2s, box-shadow .3s, opacity .15s;
}
[data-theme="holographic"] .card::before {
  content: "";
  position: absolute;
  inset: -1.5px;
  border-radius: var(--radius-sm);
  padding: 1.5px;
  background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bff6b, #6bccff, #cc6bff, #ff6b6b);
  background-size: 400% 400%;
  animation: holoShimmer 5s linear infinite;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
  opacity: 0.4;
  transition: opacity .3s;
}
[data-theme="holographic"] .card:hover::before {
  opacity: 1;
}
[data-theme="holographic"] .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 20px rgba(107,204,255,.12), 0 0 40px rgba(204,107,255,.06);
}
[data-theme="holographic"] .detail {
  background: rgba(14,14,22,.95);
  border: 1.5px solid transparent;
  position: relative;
}
[data-theme="holographic"] .detail::before {
  content: "";
  position: absolute;
  inset: -1.5px;
  border-radius: var(--radius-md);
  padding: 1.5px;
  background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bff6b, #6bccff, #cc6bff);
  background-size: 300% 300%;
  animation: holoShift 6s ease-in-out infinite;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
  z-index: -1;
}
[data-theme="holographic"] .modal {
  background: rgba(12,12,18,.97);
  border: 1.5px solid transparent;
  position: relative;
}
[data-theme="holographic"] .modal::before {
  content: "";
  position: absolute;
  inset: -1.5px;
  border-radius: var(--radius-lg);
  padding: 1.5px;
  background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bff6b, #6bccff, #cc6bff);
  background-size: 300% 300%;
  animation: holoShift 5s ease-in-out infinite;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
  z-index: -1;
}
[data-theme="holographic"] .settings-panel {
  background: rgba(12,12,18,.97);
  border-left: 2px solid transparent;
  border-image: linear-gradient(180deg, #ff6b6b, #ffd93d, #6bff6b, #6bccff, #cc6bff) 1;
}
[data-theme="holographic"] .form-control:focus {
  border-color: transparent;
  box-shadow: 0 0 0 2px rgba(107,204,255,.3);
  outline: none;
  background-image: linear-gradient(rgba(14,14,22,1), rgba(14,14,22,1)), linear-gradient(135deg, #ff6b6b, #ffd93d, #6bff6b, #6bccff, #cc6bff);
  background-origin: border-box;
  background-clip: padding-box, border-box;
}
[data-theme="holographic"] .toast-success {
  background: linear-gradient(135deg, #1a3a1a, #0d2d0d);
  border: 1px solid #6bff6b;
  color: #6bff6b;
  box-shadow: 0 0 16px rgba(107,255,107,.2);
}
[data-theme="holographic"] .toast-error {
  background: linear-gradient(135deg, #3a1a1a, #2d0d0d);
  border: 1px solid #ff6b6b;
  color: #ff6b6b;
  box-shadow: 0 0 16px rgba(255,107,107,.2);
}
[data-theme="holographic"] ::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
[data-theme="holographic"] ::-webkit-scrollbar-track {
  background: rgba(10,10,15,.5);
}
[data-theme="holographic"] ::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #ff6b6b88, #ffd93d88, #6bff6b88, #6bccff88, #cc6bff88);
  border-radius: 4px;
}
[data-theme="holographic"] ::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #ff6b6bcc, #ffd93dcc, #6bff6bcc, #6bccffcc, #cc6bffcc);
}

/* Member chips for assignment */
.member-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.member-chip{display:inline-flex;align-items:center;gap:3px;padding:3px 10px;border-radius:12px;font-size:.78rem;cursor:pointer;border:1px solid transparent;transition:background .15s,border-color .15s;font-weight:500;user-select:none}
.member-chip:hover{filter:brightness(.9)}
.member-chip-human{background:var(--chip-human-bg);color:var(--chip-human-text);border-color:var(--chip-human-border)}
.member-chip-human:hover{background:var(--chip-human-hover)}
.member-chip-agent{background:var(--chip-agent-bg);color:var(--chip-agent-text);border-color:var(--chip-agent-border)}
.member-chip-agent:hover{background:var(--chip-agent-hover)}
.member-chip-team{background:var(--chip-team-bg);color:var(--chip-team-text);border-color:var(--chip-team-border)}
.member-chip-team:hover{background:var(--chip-team-hover)}

/* Stats view */
.stats-view{max-width:1000px;padding:0 16px}
.stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
.stats-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md,8px);padding:16px 20px;text-align:center}
.stats-card-value{font-size:2rem;font-weight:700;color:var(--accent-primary);line-height:1.2}
.stats-card-label{font-size:.8rem;color:var(--text-muted);margin-top:4px;text-transform:uppercase;letter-spacing:.04em}
.stats-section{margin-bottom:20px}
.stats-section h3{font-size:.95rem;font-weight:600;margin-bottom:8px;color:var(--text-primary)}
.stats-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.stats-bar-label{width:140px;font-size:.8rem;color:var(--text-secondary);text-align:right;flex-shrink:0}
.stats-bar-track{flex:1;height:18px;background:var(--surface-raised,var(--surface));border-radius:var(--radius-sm,4px);overflow:hidden}
.stats-bar-fill{height:100%;border-radius:var(--radius-sm,4px);min-width:2px;transition:width .3s}
.stats-bar-count{width:30px;font-size:.8rem;font-weight:600;color:var(--text-primary);text-align:right}
.stats-distributions{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px}
.stats-dist-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md,8px);padding:12px}
.stats-dist-card h4{font-size:.85rem;font-weight:600;margin-bottom:8px;color:var(--text-primary)}
.stats-dist-table{width:100%;font-size:.8rem}
.stats-dist-table td{padding:3px 6px;border-bottom:1px solid var(--border)}
.stats-dist-count{text-align:right;font-weight:600;font-variant-numeric:tabular-nums}
.stats-wip-alerts{margin-bottom:16px}
.stats-wip-alert{background:rgba(255,180,0,0.1);border:1px solid rgba(255,180,0,0.4);border-radius:var(--radius-sm,4px);padding:8px 12px;margin-bottom:4px;font-size:.85rem;color:var(--text-primary)}
.stats-stale{border-left:3px solid rgba(255,180,0,0.6);padding-left:12px}
.stats-metrics-heading{font-size:1.05rem;font-weight:700;margin:28px 0 16px;padding-top:16px;border-top:1px solid var(--border);color:var(--text-primary)}
.velocity-chart{display:flex;align-items:flex-end;gap:4px;height:100px;padding:8px 0}
.velocity-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.velocity-bar{width:100%;border-radius:var(--radius-sm,4px) var(--radius-sm,4px) 0 0;background:var(--accent-primary);min-height:2px;transition:height .3s}
.velocity-bar-label{font-size:.65rem;color:var(--text-muted);white-space:nowrap}
.velocity-bar-count{font-size:.7rem;font-weight:600;color:var(--text-primary)}
.blocked-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.blocked-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md,8px);padding:12px 16px;text-align:center}
.blocked-card-value{font-size:1.5rem;font-weight:700;color:var(--text-primary);line-height:1.2}
.blocked-card-value.danger{color:var(--color-danger)}
.blocked-card-label{font-size:.75rem;color:var(--text-muted);margin-top:2px}
/* Cube (graph view) */
.cube-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:calc(100vh - 120px);color:var(--text-muted);text-align:center;padding:40px}
.cube-fallback-icon{font-size:48px;margin-bottom:16px}
.cube-fallback-title{font-size:18px;font-weight:600;margin-bottom:8px;color:var(--text-primary)}
.cube-fallback-msg{max-width:400px;line-height:1.5;margin-bottom:16px}
.cube-fallback-retry{padding:8px 24px;background:var(--accent-primary);color:#fff;border:none;border-radius:var(--radius-md);cursor:pointer}
.cube-fallback-retry:hover{background:var(--accent-hover)}
.cube-mobile-notice{background:var(--color-warning-bg);color:var(--text-primary);padding:8px 12px;font-size:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
/* Web (Indra's Web view) */
.web-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:calc(100vh - 120px);color:var(--text-muted);text-align:center;padding:40px}
.web-fallback-icon{font-size:48px;margin-bottom:16px}
.web-fallback-title{font-size:18px;font-weight:600;margin-bottom:8px;color:var(--text-primary)}
.web-fallback-msg{max-width:400px;line-height:1.5;margin-bottom:16px}
.web-fallback-retry{padding:8px 24px;background:var(--accent-primary);color:#fff;border:none;border-radius:var(--radius-md);cursor:pointer}
.web-fallback-retry:hover{background:var(--accent-hover)}
.web-mobile-notice{background:var(--color-warning-bg);color:var(--text-primary);padding:8px 12px;font-size:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.web-orphan-badge{position:absolute;top:12px;right:12px;z-index:10;background:rgba(255,180,0,0.15);border:1px solid rgba(255,180,0,0.5);border-radius:var(--radius-md);padding:6px 12px;font-size:.75rem;color:var(--text-primary);cursor:pointer}
.web-orphan-badge:hover{background:rgba(255,180,0,0.25)}
/* Web detail pane â€” slides in from right */
.web-detail-pane{position:fixed;top:var(--nav-h,52px);right:0;width:420px;max-width:90vw;height:calc(100vh - var(--nav-h,52px));background:var(--surface);border-left:1px solid var(--border);box-shadow:-4px 0 24px rgba(0,0,0,0.2);z-index:100;transform:translateX(100%);transition:transform .25s ease;overflow-y:auto;padding:0}
.web-detail-pane.open{transform:translateX(0)}
.web-detail-pane .pane-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:1}
.web-detail-pane .pane-header h2{font-size:1rem;font-weight:700;margin:0;display:flex;align-items:center;gap:8px}
.web-detail-pane .pane-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-secondary);padding:4px 8px;border-radius:var(--radius-sm)}
.web-detail-pane .pane-close:hover{color:var(--text-primary);background:var(--surface-hover)}
.web-detail-pane .pane-body{padding:16px 20px}
.web-detail-pane .pane-status-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.web-detail-pane .pane-field{margin-bottom:10px}
.web-detail-pane .pane-field dt{font-weight:600;font-size:.8rem;color:var(--text-muted);margin-bottom:1px}
.web-detail-pane .pane-field dd{font-size:.85rem;color:var(--text-primary)}
.web-detail-pane .pane-section{margin-top:16px;padding-top:12px;border-top:1px solid var(--border)}
.web-detail-pane .pane-section h3{font-size:.85rem;font-weight:600;margin-bottom:6px}
.web-detail-pane .pane-event{font-size:.8rem;padding:4px 0;display:flex;gap:6px;color:var(--text-secondary)}
.web-detail-pane .pane-event .ev-type{font-weight:600;color:var(--text-primary)}
.web-detail-pane .pane-comment{background:var(--surface-raised,var(--surface));border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px;margin-bottom:6px;font-size:.85rem}
.web-detail-pane .pane-comment-meta{font-size:.75rem;color:var(--text-muted);margin-bottom:4px}
.web-detail-pane .pane-open-full{display:block;width:100%;padding:8px;margin-top:12px;background:var(--accent-primary);color:#fff;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:.85rem;text-align:center}
.web-detail-pane .pane-open-full:hover{background:var(--accent-hover)}
.web-detail-overlay{position:fixed;top:var(--nav-h,52px);left:0;right:0;bottom:0;z-index:99;display:none}
.web-detail-overlay.open{display:block}
/* Floating detail panel â€” slides in from right on Board/List card click */
.detail-panel{position:fixed;top:var(--nav-h,52px);right:0;width:480px;max-width:92vw;height:calc(100vh - var(--nav-h,52px));background:var(--surface);border-left:1px solid var(--border);box-shadow:-4px 0 24px rgba(0,0,0,0.18);z-index:100;transform:translateX(100%);transition:transform .25s ease;overflow-y:auto;padding:0}
.detail-panel.open{transform:translateX(0)}
.detail-panel-overlay{position:fixed;top:var(--nav-h,52px);left:0;right:0;bottom:0;z-index:99;display:none}
.detail-panel-overlay.open{display:block}
.dp-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:1}
.dp-header h2{font-size:1rem;font-weight:700;margin:0;display:flex;align-items:center;gap:8px;min-width:0;overflow:hidden;text-overflow:ellipsis}
.dp-header-actions{display:flex;gap:4px;flex-shrink:0}
.dp-close,.dp-full-link{background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-secondary);padding:4px 8px;border-radius:var(--radius-sm)}
.dp-close:hover,.dp-full-link:hover{color:var(--text-primary);background:var(--surface-hover)}
.dp-body{padding:16px 20px}
.dp-body .dp-actions{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
.dp-body .dp-actions select{font-size:.8rem;padding:3px 6px}
.dp-body .dp-field{margin-bottom:8px}
.dp-body .dp-field dt{font-weight:600;font-size:.78rem;color:var(--text-muted);margin-bottom:1px}
.dp-body .dp-field dd{font-size:.85rem;color:var(--text-primary)}
.dp-body .editable{cursor:pointer;border-bottom:1px dashed transparent;transition:border-color .15s}
.dp-body .editable:hover{border-bottom-color:var(--accent-primary)}
.dp-section{margin-top:14px;padding-top:10px;border-top:1px solid var(--border)}
.dp-section h3{font-size:.85rem;font-weight:600;margin-bottom:6px}
.dp-comment{background:var(--surface-raised,var(--surface));border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px;margin-bottom:6px;font-size:.85rem}
.dp-comment-meta{font-size:.75rem;color:var(--text-muted);margin-bottom:4px}
.dp-event{font-size:.8rem;padding:3px 0;display:flex;gap:6px;color:var(--text-secondary)}
.dp-event .ev-type{font-weight:600;color:var(--text-primary)}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>

<div class="nav">
  <span class="nav-brand">Lattice</span>
  <div class="nav-search" id="nav-search">
    <button type="button" class="nav-search-btn" id="nav-search-btn" title="Search tasks (/)" aria-label="Search tasks" aria-expanded="false" aria-controls="nav-search-input">
      <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <kbd class="nav-search-kbd">/</kbd>
    </button>
    <input type="text" class="nav-search-input" id="nav-search-input" placeholder="Search tasks..." aria-label="Search tasks" tabindex="-1">
  </div>
  <span class="nav-tab" data-view="board">Board</span>
  <span class="nav-tab" data-view="list">List</span>
  <span class="nav-tab" data-view="activity">Activity</span>
  <span class="nav-tab" data-view="stats">Stats</span>
  <span class="nav-tab" data-view="cube" onclick="location.hash='#/cube'">Cube</span>
  <span class="nav-tab" data-view="web" onclick="location.hash='#/web'">Web</span>
  <div class="nav-right" style="position:relative">
    <span id="stats-badges"></span>
    <button type="button" class="btn btn-new-task" id="new-task-btn" title="Create new task">+ New Task</button>
    <button type="button" class="btn btn-with-icon" id="settings-btn" title="Dashboard Settings"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg> Settings</button>
    <button type="button" class="btn btn-with-icon" id="help-btn" title="User Guide"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Help</button>
    <button type="button" class="btn btn-with-icon" id="refresh-btn" title="Refresh"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10"/><path d="M20.49 15a9 9 0 01-14.85 3.36L1 14"/></svg> Refresh</button>
  </div>
</div>

<div class="content" id="app">
  <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
</div>

<div class="toast-container" id="toast-container"></div>

<!-- Web detail pane (slides from right, overlays graph) -->
<div class="web-detail-overlay" id="web-detail-overlay"></div>
<div class="web-detail-pane" id="web-detail-pane">
  <div class="pane-header">
    <h2 id="web-pane-title">Task</h2>
    <button class="pane-close" id="web-pane-close">&times;</button>
  </div>
  <div class="pane-body" id="web-pane-body">
    <div class="loading"><div class="spinner"></div></div>
  </div>
</div>

<!-- Floating detail panel (slides from right, overlays Board/List) -->
<div class="detail-panel-overlay" id="detail-panel-overlay"></div>
<div class="detail-panel" id="detail-panel" role="dialog" aria-modal="true" aria-label="Task detail">
  <div class="dp-header">
    <h2 id="dp-title">Task</h2>
    <div class="dp-header-actions">
      <button class="dp-full-link" id="dp-open-full" title="Open full detail view">&#x2197;</button>
      <button class="dp-close" id="dp-close">&times;</button>
    </div>
  </div>
  <div class="dp-body" id="dp-body">
    <div class="loading"><div class="spinner"></div></div>
  </div>
</div>

<div class="modal-overlay" id="create-task-modal" style="display:none">
  <div class="modal">
    <div class="modal-header">
      <h2>Create Task</h2>
      <button class="settings-close" id="create-task-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="ct-title">Title *</label>
        <input type="text" class="form-control" id="ct-title" placeholder="Task title">
      </div>
      <div class="form-group">
        <label for="ct-type">Type</label>
        <select class="form-control" id="ct-type"></select>
      </div>
      <div class="form-group">
        <label for="ct-priority">Priority</label>
        <select class="form-control" id="ct-priority">
          <option value="critical">critical</option>
          <option value="high">high</option>
          <option value="medium" selected>medium</option>
          <option value="low">low</option>
        </select>
      </div>
      <div class="form-group">
        <label for="ct-description">Description</label>
        <textarea class="form-control" id="ct-description" placeholder="Optional description"></textarea>
      </div>
      <div class="form-group">
        <label for="ct-tags">Tags</label>
        <input type="text" class="form-control" id="ct-tags" placeholder="Comma-separated tags">
      </div>
      <div class="form-group">
        <label for="ct-assigned">Assigned To</label>
        <input type="text" class="form-control" id="ct-assigned" placeholder="e.g. human:atin, agent:claude">
        <div id="ct-assigned-chips" class="member-chips"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" id="create-task-cancel">Cancel</button>
      <button type="button" class="btn btn-primary" id="create-task-submit">Create Task</button>
    </div>
  </div>
</div>

<div class="settings-panel" id="settings-panel">
  <div class="settings-header">
    <span>Dashboard Settings</span>
    <button class="settings-close" id="settings-close">&times;</button>
  </div>
  <div class="settings-body">
    <div class="settings-group">
      <label for="theme-select">Theme</label>
      <select class="form-control" id="theme-select"></select>
      <div class="hint">Choose a visual theme for the dashboard.</div>
    </div>
    <div class="settings-group">
      <label for="voice-select">Voice</label>
      <select class="form-control" id="voice-select"></select>
      <div class="hint">Choose how the dashboard speaks to you.</div>
    </div>
    <div class="settings-group">
      <label for="bg-image-input">Background Image URL</label>
      <input type="text" id="bg-image-input" placeholder="https://example.com/bg.jpg">
      <div class="hint">Set a background image for the board view. Leave empty to clear.</div>
      <button type="button" class="btn" id="bg-image-save">Apply</button>
      <button type="button" class="btn" id="bg-image-clear">Clear</button>
    </div>
    <div class="settings-group">
      <label>Lane Colors</label>
      <div class="hint" style="margin-bottom:8px">Click a color to customize each swim lane header.</div>
      <div id="lane-colors-list"></div>
      <button type="button" class="btn" id="lane-colors-save" style="margin-top:8px">Apply Lane Colors</button>
      <button type="button" class="btn" id="lane-colors-reset" style="margin-top:4px">Reset to Defaults</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/d3-binarytree@1"></script>
<script src="https://unpkg.com/d3-octree@1"></script>
<script src="https://unpkg.com/d3-force-3d@3"></script>
<script src="https://unpkg.com/force-graph@1/dist/force-graph.min.js"></script>
<script>
(function(){
"use strict";

// --- Default lane colors per theme ---
var LANE_COLORS_BY_THEME = {
  classic: {
    backlog: "#adb5bd",
    in_planning: "#17a2b8",
    planned: "#20c997",
    in_progress: "#0d6efd",
    in_implementation: "#0d6efd",
    implemented: "#0dcaf0",
    review: "#6f42c1",
    in_review: "#6f42c1",
    blocked: "#dc3545",
    needs_human: "#f59e0b",
    done: "#198754",
    cancelled: "#6c757d"
  },
  "station-console": {
    backlog: "#334155",
    in_planning: "#06b6d4",
    planned: "#14b8a6",
    in_progress: "#3b82f6",
    in_implementation: "#3b82f6",
    implemented: "#38bdf8",
    review: "#a78bfa",
    in_review: "#a78bfa",
    blocked: "#ef4444",
    needs_human: "#f59e0b",
    done: "#22c55e",
    cancelled: "#475569"
  },
  "linear": {
  backlog: "#B0B3C4",
  in_planning: "#59A2E0",
  planned: "#4CB782",
  in_progress: "#5E6AD2",
  in_implementation: "#5E6AD2",
  implemented: "#37B5E6",
  review: "#9B6DD7",
  in_review: "#9B6DD7",
  blocked: "#EB5757",
  needs_human: "#F2994A",
  done: "#3BA672",
  cancelled: "#8B8FA3"
},
  "github": {
  backlog: "#8c959f",
  in_planning: "#0969da",
  planned: "#1a7f37",
  in_progress: "#8250df",
  in_implementation: "#8250df",
  implemented: "#0550ae",
  review: "#bf8700",
  in_review: "#bf8700",
  blocked: "#cf222e",
  needs_human: "#bf8700",
  done: "#1a7f37",
  cancelled: "#656d76"
},
  "slate": {
  backlog: "#475569",
  in_planning: "#38bdf8",
  planned: "#2dd4bf",
  in_progress: "#60a5fa",
  in_implementation: "#60a5fa",
  implemented: "#818cf8",
  review: "#c084fc",
  in_review: "#c084fc",
  blocked: "#f87171",
  needs_human: "#fbbf24",
  done: "#4ade80",
  cancelled: "#64748b"
},
  "asana": {
  backlog: "#c1bdb9",
  in_planning: "#f1bd6c",
  planned: "#5da283",
  in_progress: "#7c8af7",
  in_implementation: "#7c8af7",
  implemented: "#4ecbc4",
  review: "#aa62e3",
  in_review: "#aa62e3",
  blocked: "#e8384f",
  needs_human: "#fd9a00",
  done: "#5da283",
  cancelled: "#b8b8b8"
},
  "basecamp": {
  backlog: "#a09585",
  in_planning: "#c69026",
  planned: "#2e8b57",
  in_progress: "#3d5a80",
  in_implementation: "#3d5a80",
  implemented: "#5b9ea6",
  review: "#7b5ea7",
  in_review: "#7b5ea7",
  blocked: "#c0392b",
  needs_human: "#e67e22",
  done: "#1D6D37",
  cancelled: "#8c7f6d"
},
  "porcelain": {
  backlog: "#99a8b8",
  in_planning: "#6ba4b8",
  planned: "#6bab8a",
  in_progress: "#6b8aab",
  in_implementation: "#6b8aab",
  implemented: "#7baac4",
  review: "#8a7bab",
  in_review: "#8a7bab",
  blocked: "#c44b4b",
  needs_human: "#d4a24b",
  done: "#5b9a6b",
  cancelled: "#8a919a"
},
  "frost": {
  backlog: "#64748b",
  in_planning: "#38bdf8",
  planned: "#34d399",
  in_progress: "#818cf8",
  in_implementation: "#818cf8",
  implemented: "#22d3ee",
  review: "#a78bfa",
  in_review: "#a78bfa",
  blocked: "#f87171",
  needs_human: "#fbbf24",
  done: "#34d399",
  cancelled: "#475569"
},
  "paper": {
  backlog: "#999999", in_planning: "#777777", planned: "#555555", in_progress: "#333333",
  in_implementation: "#333333", implemented: "#444444", review: "#666666", in_review: "#666666",
  blocked: "#cc3333", needs_human: "#cc8833", done: "#111111", cancelled: "#aaaaaa"
},
  "midnight": {
  backlog: "#334155", in_planning: "#475569", planned: "#64748B", in_progress: "#94A3B8",
  in_implementation: "#94A3B8", implemented: "#78716C", review: "#6B7280", in_review: "#6B7280",
  blocked: "#ef4444", needs_human: "#f59e0b", done: "#22c55e", cancelled: "#1e293b"
},
  "obsidian": {
  backlog: "#4A4A5E", in_planning: "#2A7A8A", planned: "#2A8A6A", in_progress: "#4060C0",
  in_implementation: "#4060C0", implemented: "#3090B0", review: "#7A52B5", in_review: "#7A52B5",
  blocked: "#C04040", needs_human: "#C09040", done: "#3A8A54", cancelled: "#505060"
},
  "carbon": {
  backlog: "#404040", in_planning: "#0E7490", planned: "#0F766E", in_progress: "#2563EB",
  in_implementation: "#2563EB", implemented: "#0284C7", review: "#7C3AED", in_review: "#7C3AED",
  blocked: "#DC2626", needs_human: "#D97706", done: "#16A34A", cancelled: "#525252"
},
  "vaporwave": {
  backlog: "#4a2870", in_planning: "#B967FF", planned: "#01CDFE", in_progress: "#FF71CE",
  in_implementation: "#FF71CE", implemented: "#00FFD1", review: "#c471ed", in_review: "#c471ed",
  blocked: "#FF4081", needs_human: "#FFD740", done: "#05ffd2", cancelled: "#3d2060"
},
  "neon-noir": {
  backlog: "#333333", in_planning: "#00D4FF", planned: "#00FFA3", in_progress: "#FF0080",
  in_implementation: "#FF0080", implemented: "#00B4D8", review: "#BF00FF", in_review: "#BF00FF",
  blocked: "#FF1744", needs_human: "#FFAB00", done: "#00FF88", cancelled: "#1a1a1a"
},
  "acid-rain": {
  backlog: "#1a3a1a", in_planning: "#0f4f0f", planned: "#1a6b1a", in_progress: "#228B22",
  in_implementation: "#228B22", implemented: "#2eb82e", review: "#39FF14", in_review: "#39FF14",
  blocked: "#FF3333", needs_human: "#CCCC00", done: "#00cc44", cancelled: "#333333"
},
  "solar-flare": {
  backlog: "#44403C", in_planning: "#78350F", planned: "#92400E", in_progress: "#B45309",
  in_implementation: "#B45309", implemented: "#EA580C", review: "#C2410C", in_review: "#C2410C",
  blocked: "#DC2626", needs_human: "#F59E0B", done: "#65A30D", cancelled: "#292524"
},
  "ultraviolet": {
  backlog: "#3b1a5e",
  in_planning: "#7c3aed",
  planned: "#a855f7",
  in_progress: "#BF40FF",
  in_implementation: "#BF40FF",
  implemented: "#d946ef",
  review: "#e879f9",
  in_review: "#e879f9",
  blocked: "#f43f5e",
  needs_human: "#f59e0b",
  done: "#c026d3",
  cancelled: "#2d1650"
},
  "holographic": {
  backlog: "#2a2a3a",
  in_planning: "#6b8bff",
  planned: "#6bccff",
  in_progress: "#6bff6b",
  in_implementation: "#6bff6b",
  implemented: "#ffd93d",
  review: "#cc6bff",
  in_review: "#cc6bff",
  blocked: "#ff6b6b",
  needs_human: "#ffb86b",
  done: "#50e890",
  cancelled: "#3a2a2a"
}
};
var DEFAULT_LANE_COLORS = LANE_COLORS_BY_THEME.classic;

// --- Themes ---
var THEMES = [
  {id: "classic", name: "Classic", desc: "Clean, light interface"},
  {id: "station-console", name: "Station Console", desc: "Dark sci-fi HUD"},
  {id: "linear", name: "Linear", desc: "Tight, modern product UI"},
  {id: "github", name: "GitHub", desc: "Clean developer-tool inspired light theme"},
  {id: "slate", name: "Slate", desc: "Professional dark blue-gray theme"},
  {id: "asana", name: "Asana", desc: "Warm coral accents, friendly rounded shapes"},
  {id: "basecamp", name: "Basecamp", desc: "Earthy tones, grounded and readable"},
  {id: "porcelain", name: "Porcelain", desc: "White-on-white neumorphic depth"},
  {id: "frost", name: "Glassmorphic", desc: "Frosted glass panels with blue-tinted translucency"},
  {id: "paper", name: "Paper", desc: "Minimal ink-on-paper, typographic, zero decoration"},
  {id: "midnight", name: "Midnight", desc: "True black, monochrome, content-forward dark theme"},
  {id: "obsidian", name: "Obsidian", desc: "Polished dark stone with gold inlay"},
  {id: "carbon", name: "Carbon", desc: "Industrial dark engineering dashboard"},
  {id: "vaporwave", name: "Vaporwave", desc: "Pink-purple retro-future dreamscape"},
  {id: "neon-noir", name: "Neon Noir", desc: "Blade Runner neon-on-black terminal"},
  {id: "acid-rain", name: "Acid Rain", desc: "Full hacker terminal: matrix rain, scanlines, green-on-black everything"},
  {id: "solar-flare", name: "Solar Flare", desc: "Molten forge: ember glows, heat gradients from deep red to white-hot"},
  {id: "ultraviolet", name: "Ultraviolet", desc: "Blacklight room with UV-purple glow"},
  {id: "holographic", name: "Holographic", desc: "Iridescent rainbow-edge trading card aesthetic"}
];

// --- Voice Packs (i18n) ---
var VOICES = {
  "en-oracle": {
    _meta: { label: "Oracle (English)", lang: "en" },
    "nav.brand": "Lattice",
    "nav.board": "Board",
    "nav.list": "List",
    "nav.activity": "Activity",
    "btn.new_task": "+ New Task",
    "btn.refresh": "Refresh",
    "btn.help": "Help",
    "btn.help_title": "User Guide",
    "btn.settings": "Dashboard Settings",
    "btn.create_task": "Create Task",
    "btn.cancel": "Cancel",
    "btn.save": "Save",
    "btn.apply": "Apply",
    "btn.clear": "Clear",
    "btn.apply_lane_colors": "Apply Lane Colors",
    "btn.reset_defaults": "Reset to Defaults",
    "btn.post": "Post",
    "btn.archive": "Archive",
    "btn.retry": "Retry",
    "btn.back": "&larr; Back",
    "loading": "Gathering state...",
    "empty.board": "The board is clear \u2014 a workspace awaits its first intention.",
    "empty.board.cta": "Begin",
    "empty.list": "No tasks have been set into motion.",
    "empty.list.filtered": "No tasks match the current lens.",
    "empty.activity": "No echoes yet \u2014 all is still.",
    "empty.lane": "Awaiting",
    "toast.task_created": "Intention declared: {title}",
    "toast.status_changed": "State shifted to {status}",
    "toast.priority_changed": "Weight adjusted to {value}",
    "toast.type_changed": "Form reshaped to {value}",
    "toast.title_updated": "Name rewritten",
    "toast.description_updated": "Details refined",
    "toast.assigned": "Entrusted to {value}",
    "toast.unassigned": "Released from assignment",
    "toast.tags_updated": "Markers set",
    "toast.comment_added": "Trace left",
    "toast.task_archived": "Committed to the archive",
    "toast.theme_updated": "Appearance shifted",
    "toast.bg_updated": "Background altered",
    "toast.bg_cleared": "Background released",
    "toast.lane_colors_updated": "Lane palette applied",
    "toast.notes_opened": "Notes unveiled",
    "toast.plans_opened": "Plan unveiled",
    "toast.lane_colors_reset": "Lane palette restored",
    "toast.voice_updated": "Voice changed",
    "toast.moved_to": "Transitioned to {status}",
    "toast.invalid_transition": "That path is not permitted: {from} to {to}",
    "error.title_required": "A task requires a name \u2014 even the smallest intention must be declared.",
    "error.title_empty": "A name cannot be emptied \u2014 identity persists.",
    "error.comment_empty": "An empty trace carries no meaning.",
    "modal.create_title": "New Intention",
    "label.title": "Title *",
    "label.type": "Type",
    "label.priority": "Priority",
    "label.description": "Description",
    "label.tags": "Tags",
    "label.assigned_to": "Assigned To",
    "placeholder.title": "Name this intention...",
    "placeholder.description": "What shape does this take?...",
    "placeholder.tags": "Comma-separated markers",
    "placeholder.assigned": "e.g. human:atin, agent:claude",
    "placeholder.comment": "Leave a trace for the next mind...",
    "settings.title": "Dashboard Settings",
    "settings.theme_label": "Theme",
    "settings.theme_hint": "Choose a visual theme for the dashboard.",
    "settings.voice_label": "Voice",
    "settings.voice_hint": "Choose how the dashboard speaks to you.",
    "settings.bg_label": "Background Image URL",
    "settings.bg_hint": "Set a background image for the board view. Leave empty to clear.",
    "settings.lane_label": "Lane Colors",
    "settings.lane_hint": "Click a color to customize each swim lane header.",
    "detail.short_id": "Short ID",
    "detail.tech_id": "Technical ID",
    "detail.assigned_to": "Assigned to",
    "detail.created_by": "Created by",
    "detail.created": "Created",
    "detail.updated": "Updated",
    "detail.urgency": "Urgency",
    "detail.unassigned": "unassigned",
    "detail.no_description": "(no description \u2014 click to add)",
    "detail.no_tags": "(no tags \u2014 click to add)",
    "detail.notes_exists": "Notes file: ",
    "detail.plans_exists": "Plan file: ",
    "btn.show_plan": "Show Plan",
    "btn.show_notes": "Show Notes",
    "section.description": "Description",
    "section.tags": "Tags",
    "section.custom_fields": "Custom Fields",
    "section.relationships": "Relationships",
    "section.artifacts": "Artifacts",
    "section.plans": "Plan",
    "section.notes": "Notes",
    "section.comments": "Comments",
    "section.history": "History",
    "filter.search": "Search title...",
    "filter.all_statuses": "All statuses",
    "filter.all_types": "All types",
    "filter.all_priorities": "All priorities",
    "filter.show_archived": "Show archived",
    "table.id": "ID",
    "table.title": "Title",
    "table.status": "Status",
    "table.priority": "Priority",
    "table.type": "Type",
    "table.assigned": "Assigned",
    "table.updated": "Updated",
    "stats.tasks": "tasks",
    "nav.stats": "Stats",
    "stats.active_tasks": "Active Tasks",
    "stats.archived_tasks": "Archived",
    "stats.total_events": "Total Events",
    "stats.active_events": "Active Events",
    "stats.wip_exceeded": "WIP Limit Exceeded",
    "stats.by_status": "Status Distribution",
    "stats.by_priority": "By Priority",
    "stats.by_type": "By Type",
    "stats.by_assignee": "By Assignee",
    "stats.by_tag": "By Tag",
    "stats.recently_active": "Recently Active",
    "stats.stale_tasks": "Stale Tasks",
    "stats.busiest_tasks": "Most Active",
    "empty.stats": "No statistics yet."
  },
  "en-clinical": {
    _meta: { label: "Clinical (English)", lang: "en" },
    "nav.brand": "Lattice",
    "nav.board": "Board",
    "nav.list": "List",
    "nav.activity": "Activity",
    "btn.new_task": "+ New Task",
    "btn.refresh": "Refresh",
    "btn.help": "Help",
    "btn.help_title": "User Guide",
    "btn.settings": "Dashboard Settings",
    "btn.create_task": "Create Task",
    "btn.cancel": "Cancel",
    "btn.save": "Save",
    "btn.apply": "Apply",
    "btn.clear": "Clear",
    "btn.apply_lane_colors": "Apply Lane Colors",
    "btn.reset_defaults": "Reset to Defaults",
    "btn.post": "Post",
    "btn.archive": "Archive",
    "btn.retry": "Retry",
    "btn.back": "&larr; Back",
    "loading": "Loading...",
    "empty.board": "No tasks yet.",
    "empty.board.cta": "+ Create your first task",
    "empty.list": "No tasks yet.",
    "empty.list.filtered": "No tasks match your filters.",
    "empty.activity": "No recent activity.",
    "empty.lane": "No tasks",
    "toast.task_created": "Task created: {title}",
    "toast.status_changed": "Status changed to {status}",
    "toast.priority_changed": "Priority changed to {value}",
    "toast.type_changed": "Type changed to {value}",
    "toast.title_updated": "Title updated",
    "toast.description_updated": "Description updated",
    "toast.assigned": "Assigned to {value}",
    "toast.unassigned": "Unassigned",
    "toast.tags_updated": "Tags updated",
    "toast.comment_added": "Comment added",
    "toast.task_archived": "Task archived",
    "toast.theme_updated": "Theme updated",
    "toast.bg_updated": "Background image updated",
    "toast.bg_cleared": "Background image cleared",
    "toast.lane_colors_updated": "Lane colors updated",
    "toast.notes_opened": "Notes opened",
    "toast.plans_opened": "Plan opened",
    "toast.lane_colors_reset": "Lane colors reset to defaults",
    "toast.voice_updated": "Voice updated",
    "toast.moved_to": "Moved to {status}",
    "toast.invalid_transition": "Invalid transition: {from} to {to}",
    "error.title_required": "Title is required",
    "error.title_empty": "Title cannot be empty",
    "error.comment_empty": "Comment cannot be empty",
    "modal.create_title": "Create Task",
    "label.title": "Title *",
    "label.type": "Type",
    "label.priority": "Priority",
    "label.description": "Description",
    "label.tags": "Tags",
    "label.assigned_to": "Assigned To",
    "placeholder.title": "Task title",
    "placeholder.description": "Optional description",
    "placeholder.tags": "Comma-separated tags",
    "placeholder.assigned": "e.g. human:atin, agent:claude",
    "placeholder.comment": "Add a comment...",
    "settings.title": "Dashboard Settings",
    "settings.theme_label": "Theme",
    "settings.theme_hint": "Choose a visual theme for the dashboard.",
    "settings.voice_label": "Voice",
    "settings.voice_hint": "Choose how the dashboard speaks to you.",
    "settings.bg_label": "Background Image URL",
    "settings.bg_hint": "Set a background image for the board view. Leave empty to clear.",
    "settings.lane_label": "Lane Colors",
    "settings.lane_hint": "Click a color to customize each swim lane header.",
    "detail.short_id": "Short ID",
    "detail.tech_id": "Technical ID",
    "detail.assigned_to": "Assigned to",
    "detail.created_by": "Created by",
    "detail.created": "Created",
    "detail.updated": "Updated",
    "detail.urgency": "Urgency",
    "detail.unassigned": "unassigned",
    "detail.no_description": "(no description \u2014 click to add)",
    "detail.no_tags": "(no tags \u2014 click to add)",
    "detail.notes_exists": "Notes file: ",
    "detail.plans_exists": "Plan file: ",
    "btn.show_plan": "Show Plan",
    "btn.show_notes": "Show Notes",
    "section.description": "Description",
    "section.tags": "Tags",
    "section.custom_fields": "Custom Fields",
    "section.relationships": "Relationships",
    "section.artifacts": "Artifacts",
    "section.plans": "Plan",
    "section.notes": "Notes",
    "section.comments": "Comments",
    "section.history": "History",
    "filter.search": "Search title...",
    "filter.all_statuses": "All statuses",
    "filter.all_types": "All types",
    "filter.all_priorities": "All priorities",
    "filter.show_archived": "Show archived",
    "table.id": "ID",
    "table.title": "Title",
    "table.status": "Status",
    "table.priority": "Priority",
    "table.type": "Type",
    "table.assigned": "Assigned",
    "table.updated": "Updated",
    "stats.tasks": "tasks",
    "nav.stats": "Stats",
    "stats.active_tasks": "Active",
    "stats.archived_tasks": "Archived",
    "stats.total_events": "Events",
    "stats.active_events": "Active Events",
    "stats.wip_exceeded": "WIP Exceeded",
    "stats.by_status": "Status",
    "stats.by_priority": "Priority",
    "stats.by_type": "Type",
    "stats.by_assignee": "Assignee",
    "stats.by_tag": "Tags",
    "stats.recently_active": "Recent",
    "stats.stale_tasks": "Stale",
    "stats.busiest_tasks": "Busiest",
    "empty.stats": "No data."
  },
  "es-oracle": {
    _meta: { label: "Or\u00e1culo (Espa\u00f1ol)", lang: "es" },
    "nav.board": "Tablero",
    "nav.list": "Lista",
    "nav.activity": "Actividad",
    "btn.new_task": "+ Nueva Tarea",
    "btn.create_task": "Crear Tarea",
    "btn.cancel": "Cancelar",
    "btn.save": "Guardar",
    "btn.apply": "Aplicar",
    "btn.clear": "Limpiar",
    "btn.apply_lane_colors": "Aplicar Colores",
    "btn.reset_defaults": "Restablecer",
    "btn.post": "Publicar",
    "btn.archive": "Archivar",
    "btn.retry": "Reintentar",
    "btn.back": "&larr; Volver",
    "btn.refresh": "Actualizar",
    "btn.help": "Ayuda",
    "btn.help_title": "Gu\u00eda del Usuario",
    "loading": "Reuniendo estado...",
    "empty.board": "El tablero est\u00e1 limpio \u2014 un espacio aguarda su primera intenci\u00f3n.",
    "empty.board.cta": "Comenzar",
    "empty.list": "Ninguna tarea ha sido puesta en movimiento.",
    "empty.list.filtered": "Ninguna tarea coincide con el filtro actual.",
    "empty.activity": "Sin ecos a\u00fan \u2014 todo est\u00e1 en calma.",
    "empty.lane": "Esperando",
    "toast.task_created": "Intenci\u00f3n declarada: {title}",
    "toast.status_changed": "Estado cambiado a {status}",
    "toast.priority_changed": "Prioridad ajustada a {value}",
    "toast.type_changed": "Tipo cambiado a {value}",
    "toast.title_updated": "Nombre actualizado",
    "toast.description_updated": "Descripci\u00f3n actualizada",
    "toast.assigned": "Asignado a {value}",
    "toast.unassigned": "Sin asignar",
    "toast.tags_updated": "Etiquetas actualizadas",
    "toast.comment_added": "Rastro dejado",
    "toast.task_archived": "Tarea archivada",
    "toast.theme_updated": "Apariencia cambiada",
    "toast.bg_updated": "Fondo actualizado",
    "toast.bg_cleared": "Fondo liberado",
    "toast.lane_colors_updated": "Colores de carril aplicados",
    "toast.notes_opened": "Notas abiertas",
    "toast.plans_opened": "Plan abierto",
    "toast.lane_colors_reset": "Colores de carril restablecidos",
    "toast.voice_updated": "Voz cambiada",
    "toast.moved_to": "Transici\u00f3n a {status}",
    "toast.invalid_transition": "Esa transici\u00f3n no est\u00e1 permitida: {from} a {to}",
    "error.title_required": "Una tarea requiere un nombre \u2014 toda intenci\u00f3n debe ser declarada.",
    "error.title_empty": "El nombre no puede quedar vac\u00edo \u2014 la identidad persiste.",
    "error.comment_empty": "Un rastro vac\u00edo no tiene significado.",
    "modal.create_title": "Nueva Intenci\u00f3n",
    "label.title": "T\u00edtulo *",
    "label.type": "Tipo",
    "label.priority": "Prioridad",
    "label.description": "Descripci\u00f3n",
    "label.tags": "Etiquetas",
    "label.assigned_to": "Asignado a",
    "placeholder.title": "Nombra esta intenci\u00f3n...",
    "placeholder.description": "\u00bfQu\u00e9 forma toma esto?...",
    "placeholder.tags": "Marcadores separados por coma",
    "placeholder.comment": "Deja un rastro para la pr\u00f3xima mente...",
    "settings.title": "Configuraci\u00f3n del Panel",
    "settings.theme_label": "Tema",
    "settings.theme_hint": "Elige un tema visual para el panel.",
    "settings.voice_label": "Voz",
    "settings.voice_hint": "Elige c\u00f3mo te habla el panel.",
    "settings.bg_label": "URL de Imagen de Fondo",
    "settings.bg_hint": "Establece una imagen de fondo. Deja vac\u00edo para limpiar.",
    "settings.lane_label": "Colores de Carril",
    "settings.lane_hint": "Haz clic en un color para personalizar cada carril.",
    "detail.short_id": "ID Corto",
    "detail.tech_id": "ID T\u00e9cnico",
    "detail.assigned_to": "Asignado a",
    "detail.created_by": "Creado por",
    "detail.created": "Creado",
    "detail.updated": "Actualizado",
    "detail.urgency": "Urgencia",
    "detail.unassigned": "sin asignar",
    "detail.no_description": "(sin descripci\u00f3n \u2014 clic para a\u00f1adir)",
    "detail.no_tags": "(sin etiquetas \u2014 clic para a\u00f1adir)",
    "detail.notes_exists": "Archivo de notas: ",
    "detail.plans_exists": "Archivo del plan: ",
    "btn.show_plan": "Ver Plan",
    "btn.show_notes": "Ver Notas",
    "section.description": "Descripci\u00f3n",
    "section.tags": "Etiquetas",
    "section.custom_fields": "Campos Personalizados",
    "section.relationships": "Relaciones",
    "section.artifacts": "Artefactos",
    "section.plans": "Plan",
    "section.notes": "Notas",
    "section.comments": "Comentarios",
    "section.history": "Historial",
    "filter.search": "Buscar t\u00edtulo...",
    "filter.all_statuses": "Todos los estados",
    "filter.all_types": "Todos los tipos",
    "filter.all_priorities": "Todas las prioridades",
    "filter.show_archived": "Mostrar archivados",
    "table.id": "ID",
    "table.title": "T\u00edtulo",
    "table.status": "Estado",
    "table.priority": "Prioridad",
    "table.type": "Tipo",
    "table.assigned": "Asignado",
    "table.updated": "Actualizado",
    "stats.tasks": "tareas",
    "nav.stats": "Estad\u00edsticas",
    "stats.active_tasks": "Tareas Activas",
    "stats.archived_tasks": "Archivadas",
    "stats.total_events": "Eventos Totales",
    "stats.active_events": "Eventos Activos",
    "stats.wip_exceeded": "L\u00edmite WIP Excedido",
    "stats.by_status": "Distribuci\u00f3n por Estado",
    "stats.by_priority": "Por Prioridad",
    "stats.by_type": "Por Tipo",
    "stats.by_assignee": "Por Asignado",
    "stats.by_tag": "Por Etiqueta",
    "stats.recently_active": "Activos Recientemente",
    "stats.stale_tasks": "Tareas Estancadas",
    "stats.busiest_tasks": "M\u00e1s Activas",
    "empty.stats": "Sin estad\u00edsticas a\u00fan."
  }
};

var currentVoice = "en-oracle";

function t(key) {
  return (VOICES[currentVoice] && VOICES[currentVoice][key]) ||
         (VOICES["en-oracle"] && VOICES["en-oracle"][key]) ||
         key;
}

function tf(key, replacements) {
  var str = t(key);
  if (replacements) {
    Object.keys(replacements).forEach(function(k) {
      str = str.replace("{" + k + "}", replacements[k]);
    });
  }
  return str;
}

// --- State ---
var config = null;
var tasks = [];
var archivedTasks = null;
var currentView = "board";
var pendingSearch = null;
var draggedTaskId = null;
var draggedFromStatus = null;
var boardGraphLinks = [];
var selectedEpicId = null;

// --- Cube (graph view) state ---
var cubeGraph = null;
var cubeResizeHandler = null;
var cubeData = null;
var cubeRenderGeneration = 0;
var cubeCurrentRevision = null;

// --- Web (Indra's Web view) state ---
var webGraph = null;
var webResizeHandler = null;
var webData = null;
var webRenderGeneration = 0;
var webCurrentRevision = null;

// Web constants
var WEB_TIER_RADIUS = { epic: 20, task: 6 };
var WEB_ACTIVITY_WINDOW_MS = 10 * 60 * 1000; // 10 minutes
var WEB_ACTIVITY_COLORS = { git: "#ffc107", lattice: "#fd7e14", both: "#f0a500" };
var WEB_SPOKE_COLOR = "rgba(100,130,180,0.35)";
var WEB_LINK_DISTANCE = { "epic-task": 100, "task-task": 60 };
var WEB_CHARGE = { epic: -400, task: -50 };
var WEB_COLLISION_RADIUS = { epic: 30, task: 10 };

// --- API ---
async function api(path, opts) {
  var r = await fetch(path, opts);
  var body = await r.json();
  if (!body.ok) throw new Error(body.error ? body.error.message : "API error");
  return body.data;
}

async function apiPost(path, data) {
  return api(path, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  });
}

// --- Open Notes / Plans in System Editor ---
// Exposed on window because inline onclick handlers can't reach IIFE scope
window.openNotes = async function(taskId) {
  try {
    await apiPost("/api/tasks/" + taskId + "/open-notes", {});
    showToast(t("toast.notes_opened"));
  } catch (e) {
    showToast(e.message, "error");
  }
};

window.openPlans = async function(taskId) {
  try {
    await apiPost("/api/tasks/" + taskId + "/open-plans", {});
    showToast(t("toast.plans_opened"));
  } catch (e) {
    showToast(e.message, "error");
  }
};

// --- Toast Notifications ---
function showToast(message, type) {
  var container = document.getElementById("toast-container");
  var toast = document.createElement("div");
  toast.className = "toast toast-" + (type || "success");
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(function() {
    toast.style.opacity = "0";
    toast.style.transition = "opacity .3s";
    setTimeout(function() { toast.remove(); }, 300);
  }, 3000);
}

// --- Init ---
async function init() {
  var hash = location.hash.slice(1) || "/board";
  var parts = hash.split("/").filter(Boolean);
  currentView = parts[0] || "board";
  updateTabs();

  try {
    var results = await Promise.all([api("/api/config"), api("/api/tasks"), api("/api/graph").catch(function() { return { links: [] }; })]);
    config = results[0];
    tasks = results[1];
    boardGraphLinks = (results[2] && results[2].links) || [];
    // Load voice preference
    var dc = (config && config.dashboard) || {};
    if (dc.voice && VOICES[dc.voice]) {
      currentVoice = dc.voice;
    }
    updateAllBadges();
    applyTheme(getTheme());
    populateThemeSelector();
    populateVoiceSelector();
    updateStaticVoiceStrings();
    populateLaneColorSettings();
    loadBackgroundSetting();
    await route(hash);
  } catch(e) {
    showError(e.message);
  }
}

function updateTabs() {
  document.querySelectorAll(".nav-tab").forEach(function(el) {
    el.classList.toggle("active", el.dataset.view === currentView);
  });
}

function updateStatsBadges() {
  var el = document.getElementById("stats-badges");
  var total = tasks.length;
  el.innerHTML = '<span class="badge badge-stat">' + total + " " + t("stats.tasks") + "</span>";
}

function updateAllBadges() {
  updateStatsBadges();
}

// --- Cube (graph view) ---

// Edge colors by relationship type
var CUBE_EDGE_COLORS = {
  blocks: "#dc3545", depends_on: "#fd7e14", subtask_of: "#0d6efd",
  related_to: "#6c757d", spawned_by: "#6f42c1", duplicate_of: "#adb5bd", supersedes: "#adb5bd"
};
var CUBE_EDGE_COLOR_DEFAULT = "#adb5bd";
var CUBE_EDGE_LABELS = {
  blocks: "Blocks", depends_on: "Depends on", subtask_of: "Subtask of",
  related_to: "Related to", spawned_by: "Spawned by"
};
var CUBE_PRIORITY_SIZE = { critical: 12, high: 8, medium: 5, low: 3 };
var CUBE_PRIORITY_SIZE_DEFAULT = 5;

async function renderCube() {
  var app = document.getElementById("app");
  app.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  cleanupCube();

  cubeRenderGeneration++;
  var myGeneration = cubeRenderGeneration;

  // CDN fallback checks
  if (typeof ForceGraph === "undefined") {
    app.innerHTML = '<div class="cube-empty">'
      + '<div class="cube-fallback-icon">\u26a0</div>'
      + '<div class="cube-fallback-title">Graph library unavailable</div>'
      + '<div class="cube-fallback-msg">The Cube view requires the force-graph library. Check your network connection.</div>'
      + '<button class="cube-fallback-retry" onclick="location.reload()">Retry</button>'
      + '</div>';
    return;
  }
  if (typeof d3 === "undefined" || typeof d3.forceX !== "function") {
    app.innerHTML = '<div class="cube-empty">'
      + '<div class="cube-fallback-icon">\u26a0</div>'
      + '<div class="cube-fallback-title">Layout library unavailable</div>'
      + '<div class="cube-fallback-msg">The Cube view requires d3-force-3d. Check your network connection.</div>'
      + '<button class="cube-fallback-retry" onclick="location.reload()">Retry</button>'
      + '</div>';
    return;
  }

  // Fetch graph data
  try {
    var data = await api("/api/graph");
  } catch (e) {
    if (myGeneration !== cubeRenderGeneration) return;
    app.innerHTML = '<div class="cube-empty"><p>Failed to load graph data: ' + esc(e.message) + '</p></div>';
    return;
  }
  if (myGeneration !== cubeRenderGeneration) return;

  cubeData = data;
  cubeCurrentRevision = (data && data.revision) || null;
  var nodes = (data && data.nodes) || [];
  var links = (data && data.links) || [];

  // Empty state
  if (nodes.length < 3) {
    app.innerHTML = '<div class="cube-empty">'
      + '<p>Not enough tasks to visualize.</p>'
      + '<p style="color:var(--text-muted);font-size:.875rem;">The graph view becomes useful with 3+ tasks.</p>'
      + '</div>';
    return;
  }

  // Build container
  app.innerHTML = '<div id="cube-container" style="'
    + 'position:relative;width:100%;height:calc(100vh - 60px);overflow:hidden;'
    + 'background:var(--bg-base);">'
    + '<span class="sr-only">' + esc(nodes.length + ' tasks with ' + links.length + ' relationships in graph view. Use Board or List for full accessibility.') + '</span>'
    + '</div>';
  var container = document.getElementById("cube-container");
  container.setAttribute("role", "img");
  container.setAttribute("aria-label", "Task relationship graph");

  // Mobile notice
  if (window.innerWidth < 768) {
    container.insertAdjacentHTML("afterbegin",
      '<div class="cube-mobile-notice">'
      + '<span>Graph works best on larger screens. Pinch to zoom, drag to pan.</span>'
      + '<button onclick="this.parentNode.remove()" style="background:none;border:none;cursor:pointer;color:inherit;font-size:16px">\u2715</button>'
      + '</div>');
  }

  // Legend
  container.insertAdjacentHTML("beforeend", buildCubeLegendHTML());

  // Layout parameters (tighter for small graphs)
  var statuses = (config && config.workflow && config.workflow.statuses) || [];
  var isSmallGraph = nodes.length < 10;
  var statusSpacing = isSmallGraph ? 140 : 200;
  var chargeStrength = isSmallGraph ? -80 : -150;
  var xStrength = isSmallGraph ? 0.9 : 0.8;
  var yStrength = isSmallGraph ? 0.15 : 0.1;

  var statusX = {};
  statuses.forEach(function(s, i) { statusX[s] = i * statusSpacing; });

  // Compute text color once (CSS vars don't work in canvas)
  var textColor = getComputedStyle(document.documentElement)
    .getPropertyValue("--text-primary").trim() || "#212529";

  var w = container.offsetWidth;
  var h = container.offsetHeight;

  try {
    cubeGraph = ForceGraph()(container)
      .graphData({ nodes: nodes, links: links })
      .width(w).height(h)
      .nodeId("id")
      .nodeLabel(function(node) {
        var html = '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:12px;max-width:280px;box-shadow:0 4px 12px rgba(0,0,0,0.15);color:var(--text-primary);line-height:1.4">';
        html += '<div style="font-weight:700;font-family:var(--font-mono)">' + esc(node.short_id || node.id.substring(0, 12)) + '</div>';
        html += '<div style="font-weight:500;margin-bottom:6px">' + esc(node.title || '') + '</div>';
        if (node.status) html += '<div style="display:flex;gap:6px;align-items:center;margin-bottom:2px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + esc(getLaneColor(node.status)) + '"></span><span style="color:var(--text-muted);font-size:11px;min-width:50px">Status</span><span>' + esc(node.status) + '</span></div>';
        if (node.priority) html += '<div style="display:flex;gap:6px;margin-bottom:2px"><span style="color:var(--text-muted);font-size:11px;min-width:50px">Priority</span><span>' + esc(node.priority) + '</span></div>';
        if (node.assigned_to) html += '<div style="display:flex;gap:6px;margin-bottom:2px"><span style="color:var(--text-muted);font-size:11px;min-width:50px">Assignee</span><span>' + esc(node.assigned_to) + '</span></div>';
        html += '<div style="color:var(--text-muted);font-size:10px;margin-top:6px;border-top:1px solid var(--border);padding-top:4px">Click to open task</div>';
        html += '</div>';
        return html;
      })
      .nodeColor(function(node) { return getLaneColor(node.status); })
      .nodeVal(function(node) { return CUBE_PRIORITY_SIZE[node.priority] || CUBE_PRIORITY_SIZE_DEFAULT; })
      .linkSource("source").linkTarget("target")
      .linkColor(function(link) { return CUBE_EDGE_COLORS[link.type] || CUBE_EDGE_COLOR_DEFAULT; })
      .linkWidth(function(link) { return link.type === "blocks" ? 2 : 1; })
      .linkDirectionalArrowLength(6)
      .linkDirectionalArrowRelPos(1)
      .linkDirectionalArrowColor(function(link) { return CUBE_EDGE_COLORS[link.type] || CUBE_EDGE_COLOR_DEFAULT; })
      .linkCurvature(0.15)
      .linkLabel(function(link) {
        var s = (typeof link.source === "object") ? (link.source.short_id || link.source.id) : link.source;
        var t = (typeof link.target === "object") ? (link.target.short_id || link.target.id) : link.target;
        return esc(s) + " " + esc(link.type || "related") + " " + esc(t);
      })
      .onNodeClick(function(node) {
        if (node && node.id) location.hash = "#/task/" + node.id;
      })
      .nodeCanvasObjectMode(function() { return "replace"; })
      .nodeCanvasObject(function(node, ctx, globalScale) {
        var size = CUBE_PRIORITY_SIZE[node.priority] || CUBE_PRIORITY_SIZE_DEFAULT;
        var radius = Math.sqrt(size) * 2.5;
        var color = getLaneColor(node.status);
        ctx.beginPath();
        ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI, false);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.strokeStyle = "rgba(0,0,0,0.15)";
        ctx.lineWidth = 0.5;
        ctx.stroke();
        var fontSize = 10 / globalScale;
        if (fontSize < 2) return;
        if (fontSize > 10) fontSize = 10;
        var label = node.short_id || node.id.substring(0, 8);
        ctx.font = fontSize + "px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        ctx.fillStyle = textColor;
        ctx.fillText(label, node.x, node.y + radius + 2);
      });
  } catch (err) {
    app.innerHTML = '<div class="cube-empty">'
      + '<div class="cube-fallback-icon">\u26a0</div>'
      + '<div class="cube-fallback-title">Graph rendering failed</div>'
      + '<div class="cube-fallback-msg">' + esc(err.message) + '</div>'
      + '<button class="cube-fallback-retry" onclick="location.hash=\'#/cube\'">Retry</button>'
      + '</div>';
    return;
  }

  // Status-constrained forces (the key layout strategy â€” NOT dagMode)
  cubeGraph
    .d3Force("x", d3.forceX(function(d) { return statusX[d.status] || 0; }).strength(xStrength))
    .d3Force("y", d3.forceY(0).strength(yStrength))
    .d3Force("charge", d3.forceManyBody().strength(chargeStrength))
    .d3Force("center", null);

  // Resize handler
  cubeResizeHandler = function() {
    if (!cubeGraph) return;
    var c = document.getElementById("cube-container");
    if (!c) return;
    cubeGraph.width(c.offsetWidth).height(c.offsetHeight);
  };
  window.addEventListener("resize", cubeResizeHandler);

  // Zoom to fit after simulation stabilizes
  cubeGraph.d3ReheatSimulation();
  setTimeout(function() {
    if (cubeGraph) cubeGraph.zoomToFit(400, 40);
  }, 2000);
}

function updateCubeData(data) {
  if (!cubeGraph) return;
  if (!data) return;
  var nodes = (data.nodes) || [];
  if (cubeData && data.revision && cubeData.revision === data.revision) return;
  cubeCurrentRevision = (data.revision) || null;
  // Only re-render empty state if cube container is actually visible
  // (prevents clobbering task detail view when currentView is "cube" but detail is showing)
  if (nodes.length < 3) {
    cubeData = data;
    var container = document.getElementById("cube-container");
    if (container) renderCube();
    return;
  }
  cubeData = data;
  cubeGraph.graphData({ nodes: nodes, links: (data.links) || [] });
}

function cleanupCube() {
  if (cubeResizeHandler) {
    window.removeEventListener("resize", cubeResizeHandler);
    cubeResizeHandler = null;
  }
  if (cubeGraph) {
    cubeGraph.pauseAnimation();
    var container = document.getElementById("cube-container");
    if (container) container.innerHTML = "";
    cubeGraph = null;
  }
  cubeData = null;
  cubeCurrentRevision = null;
  cubeRenderGeneration++;
}

function buildCubeLegendHTML() {
  var statuses = (config && config.workflow && config.workflow.statuses) || [];
  var html = '<div style="'
    + 'position:absolute;bottom:16px;left:16px;z-index:10;'
    + 'background:var(--surface);border:1px solid var(--border);'
    + 'border-radius:var(--radius-md);padding:10px 14px;'
    + 'font-size:.75rem;color:var(--text-secondary);'
    + 'max-width:220px;box-shadow:var(--shadow-card-hover);opacity:0.92;'
    + '">';
  html += '<div style="font-weight:600;margin-bottom:6px;color:var(--text-primary)">Statuses</div>';
  statuses.forEach(function(s) {
    var color = getLaneColor(s);
    html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">'
      + '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:' + esc(color) + ';flex-shrink:0"></span>'
      + '<span>' + esc(s.replace(/_/g, " ")) + '</span></div>';
  });
  html += '<div style="border-top:1px solid var(--border-subtle);margin:8px 0"></div>';
  html += '<div style="font-weight:600;margin-bottom:6px;color:var(--text-primary)">Relationships</div>';
  var edgeType;
  for (edgeType in CUBE_EDGE_LABELS) {
    if (CUBE_EDGE_LABELS.hasOwnProperty(edgeType)) {
      html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">'
        + '<span style="display:inline-block;width:14px;height:2px;background:' + esc(CUBE_EDGE_COLORS[edgeType] || CUBE_EDGE_COLOR_DEFAULT) + ';flex-shrink:0"></span>'
        + '<span>' + esc(CUBE_EDGE_LABELS[edgeType]) + '</span></div>';
    }
  }
  html += '</div>';
  return html;
}

// --- Web (Indra's Web view) ---

function buildWebHierarchy(graphData, gitData) {
  var nodes = (graphData && graphData.nodes) || [];
  var links = (graphData && graphData.links) || [];

  // Index nodes by ID and short_id
  var nodeById = {};
  var nodeByShortId = {};
  nodes.forEach(function(n) {
    nodeById[n.id] = n;
    if (n.short_id) nodeByShortId[n.short_id.toUpperCase()] = n;
  });

  // Build parent/child maps from subtask_of links
  var parentMap = {};  // child_id -> parent_id
  var childrenMap = {}; // parent_id -> [child_ids]
  links.forEach(function(link) {
    if (link.type === "subtask_of") {
      var childId = (typeof link.source === "object") ? link.source.id : link.source;
      var parentId = (typeof link.target === "object") ? link.target.id : link.target;
      parentMap[childId] = parentId;
      if (!childrenMap[parentId]) childrenMap[parentId] = [];
      childrenMap[parentId].push(childId);
    }
  });

  // Assign tier per node
  var tierMap = {};
  nodes.forEach(function(n) {
    var nodeType = (n.type || "").toLowerCase();
    if (nodeType === "epic") {
      tierMap[n.id] = "epic";
    } else {
      // Topology fallback: nodes with children but no parent â†’ epic
      // Everything else â†’ task
      var hasChildren = childrenMap[n.id] && childrenMap[n.id].length > 0;
      var hasParent = !!parentMap[n.id];
      if (!hasParent && hasChildren) tierMap[n.id] = "epic";
      else tierMap[n.id] = "task";
    }
  });

  // Build branch recency map from git data
  var branchRecency = {}; // branch_name -> last_commit_timestamp_ms
  var gitBranches = (gitData && gitData.available && gitData.branches) || [];
  gitBranches.forEach(function(b) {
    if (b.last_commit_date) {
      branchRecency[b.name] = new Date(b.last_commit_date).getTime();
    }
  });

  // Map branches to tasks via branch_links + implicit convention detection
  var taskBranches = {}; // task_id -> [branch_names]
  var linkedBranches = new Set();

  // Explicit links from branch_links field
  nodes.forEach(function(n) {
    if (n.branch_links && n.branch_links.length > 0) {
      n.branch_links.forEach(function(bl) {
        var bname = bl.branch || bl;
        if (!taskBranches[n.id]) taskBranches[n.id] = [];
        taskBranches[n.id].push(bname);
        linkedBranches.add(bname);
      });
    }
  });

  // Implicit convention: branch name contains short ID (e.g., feat/LAT-47-oauth)
  gitBranches.forEach(function(b) {
    if (linkedBranches.has(b.name)) return;
    var branchUpper = b.name.toUpperCase();
    for (var sid in nodeByShortId) {
      if (nodeByShortId.hasOwnProperty(sid) && branchUpper.indexOf(sid) !== -1) {
        var matchedNode = nodeByShortId[sid];
        if (!taskBranches[matchedNode.id]) taskBranches[matchedNode.id] = [];
        taskBranches[matchedNode.id].push(b.name);
        linkedBranches.add(b.name);
        break;
      }
    }
  });

  // Detect orphan branches (no linked task, not main/master/HEAD)
  var skipBranches = new Set(["main", "master", "HEAD", "develop", "dev"]);
  var orphanBranches = [];
  gitBranches.forEach(function(b) {
    if (!linkedBranches.has(b.name) && !skipBranches.has(b.name)) {
      orphanBranches.push(b);
    }
  });

  // Compute activity state per node
  var now = Date.now();
  var activity = {};  // task_id -> { git: bool, lattice: bool }
  nodes.forEach(function(n) {
    var gitActive = false;
    var latticeActive = (n.status === "in_progress");
    var branches = taskBranches[n.id] || [];
    branches.forEach(function(bname) {
      var ts = branchRecency[bname];
      if (ts && (now - ts) < WEB_ACTIVITY_WINDOW_MS) {
        gitActive = true;
      }
    });
    if (gitActive || latticeActive) {
      activity[n.id] = { git: gitActive, lattice: latticeActive };
    }
  });

  // Build output nodes with tier info
  var outNodes = nodes.map(function(n) {
    return {
      id: n.id,
      short_id: n.short_id,
      title: n.title,
      status: n.status,
      priority: n.priority,
      type: n.type,
      assigned_to: n.assigned_to,
      tier: tierMap[n.id],
      branches: taskBranches[n.id] || [],
      activityState: activity[n.id] || null
    };
  });

  // Build links (subtask_of only for hierarchy)
  var outLinks = [];
  links.forEach(function(link) {
    if (link.type === "subtask_of") {
      outLinks.push({
        source: (typeof link.source === "object") ? link.source.id : link.source,
        target: (typeof link.target === "object") ? link.target.id : link.target,
        type: link.type
      });
    }
  });

  return {
    nodes: outNodes,
    links: outLinks,
    orphanBranches: orphanBranches,
    activity: activity
  };
}

// Semantic zoom â€” small compact cards appear first, large cards at higher zoom
var WEB_CARD_SMALL = { task: 1.5, epic: 3.0 };
var WEB_CARD_LARGE = { task: 3.5, epic: 6.0 };
// Cards fade in over this range past threshold (0â†’1 opacity ramp)
var WEB_DETAIL_FADE_RANGE = 1.0;

// Helper: truncate text to fit a max width on canvas
function webTruncText(ctx, text, maxW) {
  if (!text) return "";
  if (ctx.measureText(text).width <= maxW) return text;
  var t = text;
  while (t.length > 1 && ctx.measureText(t + "\u2026").width > maxW) t = t.slice(0, -1);
  return t + "\u2026";
}

// Word-wrap text into up to maxLines lines that fit within maxW.
// Returns an array of strings. Last line truncated with ellipsis if needed.
function webWrapText(ctx, text, maxW, maxLines) {
  if (!text) return [""];
  if (maxLines < 1) maxLines = 1;
  var words = text.split(/\s+/);
  var lines = [];
  var cur = "";
  for (var i = 0; i < words.length; i++) {
    var test = cur ? (cur + " " + words[i]) : words[i];
    if (ctx.measureText(test).width <= maxW) {
      cur = test;
    } else {
      if (cur) {
        lines.push(cur);
        if (lines.length >= maxLines) { break; }
        cur = words[i];
      } else {
        // Single word wider than maxW â€” truncate it
        cur = words[i];
      }
    }
  }
  if (cur && lines.length < maxLines) lines.push(cur);
  if (lines.length === 0) lines.push(text);
  // If we ran out of lines but have remaining text, truncate last line
  if (lines.length >= maxLines) {
    // Rebuild remaining text from where we stopped
    var lastLine = lines[maxLines - 1];
    var remaining = words.slice(i).join(" ");
    if (remaining) {
      // There's overflow â€” truncate the last line with ellipsis
      lastLine = webTruncText(ctx, lastLine + " " + remaining, maxW);
    } else if (ctx.measureText(lastLine).width > maxW) {
      lastLine = webTruncText(ctx, lastLine, maxW);
    }
    lines[maxLines - 1] = lastLine;
    lines.length = maxLines;
  }
  return lines;
}

// Helper: draw a rounded rect on canvas
function webRoundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// Helper: pick best card anchor direction based on node position in the graph.
// Returns { dx, dy } unit-ish direction pointing away from center, so cards
// fan outward. Avoids all cards stacking to one side.
function webCardDir(node) {
  var nx = node.x || 0;
  var ny = node.y || 0;
  var len = Math.sqrt(nx * nx + ny * ny) || 1;
  // Normalize, but bias horizontally (cards are wider than tall)
  var dx = (nx / len);
  var dy = (ny / len) * 0.6;
  // Re-normalize so magnitude â‰ˆ 1
  var len2 = Math.sqrt(dx * dx + dy * dy) || 1;
  return { dx: dx / len2, dy: dy / len2 };
}

// Draw a detail card on canvas next to (or centered on) a node.
// opts: { lines, statusColor, actColor, fadeAlpha, centered, large }
// Each line: { text, bold, color, maxLines? }
// If maxLines > 1, text is word-wrapped into multiple rendered lines.
function webDrawCard(ctx, node, radius, globalScale, opts) {
  var lines = opts.lines;
  var statusColor = opts.statusColor;
  var actColor = opts.actColor;
  var fa = (opts.fadeAlpha != null) ? opts.fadeAlpha : 1;
  var centered = !!opts.centered;
  var large = !!opts.large;

  // Large cards: wider, bigger font, more padding
  var baseFs = large ? 13 : 10;
  var baseW = large ? 200 : 130;
  var basePad = large ? 10 : 6;
  var baseCorner = large ? 5 : 3;

  var fs = baseFs / globalScale;
  if (fs > (large ? 16 : 12)) fs = (large ? 16 : 12);
  var lineH = fs * (large ? 1.45 : 1.35);
  var pad = basePad / globalScale;
  var cardW = baseW / globalScale;
  var cornerR = baseCorner / globalScale;
  var textMaxW = cardW - pad * 2 - 8 / globalScale;

  // Expand lines: word-wrap any line with maxLines > 1
  var rendered = [];
  lines.forEach(function(line) {
    ctx.font = (line.bold ? "bold " : "") + fs + "px sans-serif";
    if (line.maxLines && line.maxLines > 1) {
      var wrapped = webWrapText(ctx, line.text, textMaxW, line.maxLines);
      wrapped.forEach(function(wt) {
        rendered.push({ text: wt, bold: line.bold, color: line.color });
      });
    } else {
      rendered.push(line);
    }
  });

  var cardH = pad * 2 + rendered.length * lineH;

  var cardX, cardY;
  if (centered) {
    // Center card directly over the node circle (hub overlay)
    cardX = node.x - cardW / 2;
    cardY = node.y - cardH / 2;
  } else {
    // Fan outward from graph center
    var dir = webCardDir(node);
    var gap = radius + 6;
    var cx = node.x + dir.dx * (gap + cardW / 2);
    var cy = node.y + dir.dy * (gap + cardH / 2);
    cardX = cx - cardW / 2;
    cardY = cy - cardH / 2;

    // Connector line from node to card
    ctx.save();
    ctx.globalAlpha = ctx.globalAlpha * fa;
    ctx.beginPath();
    ctx.moveTo(node.x + dir.dx * radius, node.y + dir.dy * radius);
    ctx.lineTo(cardX + cardW / 2 - dir.dx * cardW / 2, cardY + cardH / 2 - dir.dy * cardH / 2);
    ctx.strokeStyle = "rgba(255,255,255,0.15)";
    ctx.lineWidth = 0.5;
    ctx.stroke();
    ctx.restore();
  }

  // Store card bounds on node for hit detection
  node.__cardBounds = { x: cardX, y: cardY, w: cardW, h: cardH };

  ctx.save();
  ctx.globalAlpha = ctx.globalAlpha * fa;

  // Card background
  webRoundRect(ctx, cardX, cardY, cardW, cardH, cornerR);
  ctx.fillStyle = "rgba(30,30,40,0.88)";
  ctx.fill();

  // Status color left stripe
  if (statusColor) {
    var stripeW = (large ? 4 : 3) / globalScale;
    webRoundRect(ctx, cardX, cardY, stripeW, cardH, cornerR);
    ctx.fillStyle = statusColor;
    ctx.fill();
  }

  // Activity dot top-right
  if (actColor) {
    var dotR = 3 / globalScale;
    ctx.beginPath();
    ctx.arc(cardX + cardW - pad, cardY + pad + dotR, dotR, 0, 2 * Math.PI);
    ctx.fillStyle = actColor;
    ctx.fill();
  }

  // Render expanded text lines
  var textY = cardY + pad + fs * 0.85;
  rendered.forEach(function(line) {
    ctx.font = (line.bold ? "bold " : "") + fs + "px sans-serif";
    ctx.fillStyle = line.color || "rgba(255,255,255,0.9)";
    ctx.textAlign = "left";
    ctx.textBaseline = "alphabetic";
    ctx.fillText(webTruncText(ctx, line.text, textMaxW), cardX + pad + 4 / globalScale, textY);
    textY += lineH;
  });

  ctx.restore();
}

function drawWebNode(node, ctx, globalScale) {
  var tier = node.tier || "task";
  var radius = WEB_TIER_RADIUS[tier] || 4;
  var color = getLaneColor(node.status);
  var alpha = 1.0;

  // Dimming for done/blocked
  if (node.status === "done" || node.status === "cancelled") alpha = 0.3;
  else if (node.status === "blocked") alpha = 0.4;

  ctx.globalAlpha = alpha;

  // Activity glow ring
  var act = node.activityState;
  if (act) {
    var glowColor;
    if (act.git && act.lattice) glowColor = WEB_ACTIVITY_COLORS.both;
    else if (act.git) glowColor = WEB_ACTIVITY_COLORS.git;
    else glowColor = WEB_ACTIVITY_COLORS.lattice;

    ctx.save();
    ctx.shadowColor = glowColor;
    ctx.shadowBlur = 12;
    ctx.beginPath();
    ctx.arc(node.x, node.y, radius + 4, 0, 2 * Math.PI, false);
    ctx.strokeStyle = glowColor;
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();
  }

  // Main circle
  ctx.beginPath();
  ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI, false);
  ctx.fillStyle = color;
  ctx.fill();
  ctx.strokeStyle = "rgba(0,0,0,0.15)";
  ctx.lineWidth = 0.5;
  ctx.stroke();


  // Inner white ring for epics (hub indicator)
  if (tier === "epic") {
    ctx.beginPath();
    ctx.arc(node.x, node.y, radius * 0.6, 0, 2 * Math.PI, false);
    ctx.strokeStyle = "rgba(255,255,255,0.7)";
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  var textColor = getComputedStyle(document.documentElement)
    .getPropertyValue("--text-primary").trim() || "#212529";

  // Determine card state: none / small / large
  var smallThresh = WEB_CARD_SMALL[tier] || 1.5;
  var largeThresh = WEB_CARD_LARGE[tier] || 3.5;
  var showSmall = globalScale >= smallThresh;
  var showLarge = globalScale >= largeThresh;

  // Fade factor: ramp from 0â†’1 over WEB_DETAIL_FADE_RANGE past the active threshold
  var activeThresh = showLarge ? largeThresh : (showSmall ? smallThresh : 0);
  var cardFade = showSmall ? Math.min(1, (globalScale - activeThresh) / WEB_DETAIL_FADE_RANGE) : 0;

  var sid = node.short_id || node.id.substring(0, 10);
  var statusLabel = (node.status || "").replace(/_/g, " ");
  var actColor = null;
  if (act) {
    if (act.git && act.lattice) actColor = WEB_ACTIVITY_COLORS.both;
    else if (act.git) actColor = WEB_ACTIVITY_COLORS.git;
    else actColor = WEB_ACTIVITY_COLORS.lattice;
  }

  if (showSmall) {
    var lines = [];
    var isLargeCard = false;

    if (showLarge) {
      // Large card: full detail, physically bigger â€” title wraps up to 4 lines
      isLargeCard = true;
      lines.push({ text: sid, bold: true, color: "rgba(255,255,255,1)" });
      if (node.title) lines.push({ text: node.title, bold: false, color: "rgba(255,255,255,0.85)", maxLines: 4 });
      lines.push({ text: statusLabel, bold: false, color: color });
      if (node.assigned_to) lines.push({ text: "\ud83d\udc64 " + node.assigned_to, bold: false, color: "rgba(200,200,255,0.7)" });
      if (tier === "epic" && node.type) lines.push({ text: "\ud83c\udfaf " + node.type, bold: false, color: "rgba(255,255,255,0.5)" });
      if (node.branches && node.branches.length > 0) {
        lines.push({ text: "\u2514 " + node.branches[0], bold: false, color: "rgba(180,220,255,0.6)" });
      }
      if (node.priority) lines.push({ text: "\u26a1 " + node.priority, bold: false, color: "rgba(255,220,150,0.7)" });
    } else {
      // Small card: compact â€” ID + title (2 lines) + status
      lines.push({ text: sid, bold: true, color: "rgba(255,255,255,1)" });
      if (node.title) lines.push({ text: node.title, bold: false, color: "rgba(255,255,255,0.8)", maxLines: 2 });
      lines.push({ text: statusLabel, bold: false, color: color });
    }

    // Epic cards center on the hub; others fan outward
    var isEpicCentered = (tier === "epic");

    webDrawCard(ctx, node, radius, globalScale, {
      lines: lines,
      statusColor: color,
      actColor: actColor,
      fadeAlpha: cardFade,
      centered: isEpicCentered,
      large: isLargeCard
    });

    // Short label below circle (skip for centered epics â€” card is right there)
    if (!isEpicCentered) {
      var fontSize = 8 / globalScale;
      if (fontSize > 12) fontSize = 12;
      if (fontSize >= 2) {
        ctx.font = fontSize + "px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        ctx.fillStyle = textColor;
        ctx.fillText(sid, node.x, node.y + radius + 2);
      }
    }
  } else {
    // No card â€” just text labels
    node.__cardBounds = null;
    var fontSize2;
    if (tier === "epic") {
      fontSize2 = 12 / globalScale;
      if (fontSize2 > 14) fontSize2 = 14;
      if (fontSize2 < 3) { ctx.globalAlpha = 1.0; return; }
      var label = node.short_id || node.title || node.id.substring(0, 8);
      ctx.font = "bold " + fontSize2 + "px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillStyle = textColor;
      ctx.fillText(label, node.x, node.y + radius + 3);
    } else {
      fontSize2 = 8 / globalScale;
      if (fontSize2 > 9) fontSize2 = 9;
      if (fontSize2 >= 4) {
        var dlabel = node.short_id || node.id.substring(0, 6);
        ctx.font = fontSize2 + "px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        ctx.fillStyle = textColor;
        ctx.fillText(dlabel, node.x, node.y + radius + 1);
      }
    }
  }

  ctx.globalAlpha = 1.0;
}

// Expand the pointer hit area to include card bounds (makes cards clickable)
function drawWebNodePointerArea(node, color, ctx) {
  var tier = node.tier || "task";
  var radius = WEB_TIER_RADIUS[tier] || 4;

  // Always paint the circle hit area
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(node.x, node.y, radius + 2, 0, 2 * Math.PI, false);
  ctx.fill();

  // If a card is visible, extend hit area to cover it
  var cb = node.__cardBounds;
  if (cb) {
    ctx.fillRect(cb.x, cb.y, cb.w, cb.h);
  }
}

function buildWebTooltipHTML(node) {
  var tierBadge = { epic: "Epic", task: "Task" };
  var html = '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:12px;max-width:300px;box-shadow:0 4px 12px rgba(0,0,0,0.15);color:var(--text-primary);line-height:1.4">';
  html += '<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">';
  html += '<span style="background:var(--surface-raised);border:1px solid var(--border);border-radius:4px;padding:1px 6px;font-size:10px;font-weight:600;text-transform:uppercase">' + esc(tierBadge[node.tier] || "Task") + '</span>';
  html += '<span style="font-weight:700;font-family:var(--font-mono)">' + esc(node.short_id || node.id.substring(0, 12)) + '</span>';
  html += '</div>';
  html += '<div style="font-weight:500;margin-bottom:6px">' + esc(node.title || '') + '</div>';
  if (node.status) {
    html += '<div style="display:flex;gap:6px;align-items:center;margin-bottom:2px"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + esc(getLaneColor(node.status)) + '"></span><span style="color:var(--text-muted);font-size:11px;min-width:50px">Status</span><span>' + esc(node.status) + '</span></div>';
  }
  if (node.assigned_to) {
    html += '<div style="display:flex;gap:6px;margin-bottom:2px"><span style="color:var(--text-muted);font-size:11px;min-width:50px">Assignee</span><span>' + esc(node.assigned_to) + '</span></div>';
  }
  // Activity indicators
  var act = node.activityState;
  if (act) {
    var indicators = [];
    if (act.git) indicators.push('<span style="color:' + WEB_ACTIVITY_COLORS.git + '">\u26a1 Git active</span>');
    if (act.lattice) indicators.push('<span style="color:' + WEB_ACTIVITY_COLORS.lattice + '">\u25cf In progress</span>');
    html += '<div style="margin-top:4px;display:flex;gap:8px">' + indicators.join("") + '</div>';
  }
  // Branch names
  if (node.branches && node.branches.length > 0) {
    html += '<div style="margin-top:4px;color:var(--text-muted);font-size:10px">';
    node.branches.forEach(function(b) { html += '<div>\u2514 ' + esc(b) + '</div>'; });
    html += '</div>';
  }
  html += '<div style="color:var(--text-muted);font-size:10px;margin-top:6px;border-top:1px solid var(--border);padding-top:4px">Click to open task</div>';
  html += '</div>';
  return html;
}

function buildWebLegendHTML(hasOrphans) {
  var html = '<div style="'
    + 'position:absolute;bottom:16px;left:16px;z-index:10;'
    + 'background:var(--surface);border:1px solid var(--border);'
    + 'border-radius:var(--radius-md);padding:10px 14px;'
    + 'font-size:.75rem;color:var(--text-secondary);'
    + 'max-width:220px;box-shadow:var(--shadow-card-hover);opacity:0.92;'
    + '">';
  html += '<div style="font-weight:600;margin-bottom:6px;color:var(--text-primary)">Node Tiers</div>';
  var tiers = [
    { label: "Epic (hub)", r: 10, tier: "epic" },
    { label: "Task", r: 5, tier: "task" }
  ];
  tiers.forEach(function(t) {
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">'
      + '<span style="display:inline-block;width:' + (t.r * 2) + 'px;height:' + (t.r * 2) + 'px;border-radius:50%;background:var(--text-muted);flex-shrink:0"></span>'
      + '<span>' + t.label + '</span></div>';
  });
  html += '<div style="border-top:1px solid var(--border-subtle);margin:8px 0"></div>';
  html += '<div style="font-weight:600;margin-bottom:6px;color:var(--text-primary)">Activity</div>';
  var activities = [
    { label: "Git active (<10m)", color: WEB_ACTIVITY_COLORS.git },
    { label: "In progress", color: WEB_ACTIVITY_COLORS.lattice },
    { label: "Both", color: WEB_ACTIVITY_COLORS.both }
  ];
  activities.forEach(function(a) {
    html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">'
      + '<span style="display:inline-block;width:12px;height:12px;border-radius:50%;border:2px solid ' + a.color + ';flex-shrink:0;box-shadow:0 0 4px ' + a.color + '"></span>'
      + '<span>' + a.label + '</span></div>';
  });
  html += '</div>';
  return html;
}

async function renderWeb() {
  var app = document.getElementById("app");
  app.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  cleanupWeb();

  webRenderGeneration++;
  var myGeneration = webRenderGeneration;

  // CDN fallback checks
  if (typeof ForceGraph === "undefined") {
    app.innerHTML = '<div class="web-empty">'
      + '<div class="web-fallback-icon">\u26a0</div>'
      + '<div class="web-fallback-title">Graph library unavailable</div>'
      + '<div class="web-fallback-msg">The Web view requires the force-graph library. Check your network connection.</div>'
      + '<button class="web-fallback-retry" onclick="location.reload()">Retry</button>'
      + '</div>';
    return;
  }
  if (typeof d3 === "undefined" || typeof d3.forceX !== "function") {
    app.innerHTML = '<div class="web-empty">'
      + '<div class="web-fallback-icon">\u26a0</div>'
      + '<div class="web-fallback-title">Layout library unavailable</div>'
      + '<div class="web-fallback-msg">The Web view requires d3-force. Check your network connection.</div>'
      + '<button class="web-fallback-retry" onclick="location.reload()">Retry</button>'
      + '</div>';
    return;
  }

  // Fetch both endpoints in parallel
  var graphData, gitData;
  try {
    var results = await Promise.all([
      api("/api/graph"),
      api("/api/git").catch(function() { return { available: false }; })
    ]);
    graphData = results[0];
    gitData = results[1];
  } catch (e) {
    if (myGeneration !== webRenderGeneration) return;
    app.innerHTML = '<div class="web-empty"><p>Failed to load data: ' + esc(e.message) + '</p></div>';
    return;
  }
  if (myGeneration !== webRenderGeneration) return;

  // Build hierarchy
  var hierarchy = buildWebHierarchy(graphData, gitData);
  var webNodes = hierarchy.nodes;
  var webLinks = hierarchy.links;

  webData = { graphRevision: graphData.revision, gitData: gitData, hierarchy: hierarchy };
  webCurrentRevision = (graphData.revision || "") + ":" + (gitData.head_commit || "");

  // Empty state
  if (webNodes.length === 0) {
    app.innerHTML = '<div class="web-empty">'
      + '<p>No tasks to visualize.</p>'
      + '<p style="color:var(--text-muted);font-size:.875rem;">Create some tasks to see the coordination web.</p>'
      + '</div>';
    return;
  }

  // Build container
  app.innerHTML = '<div id="web-container" style="'
    + 'position:relative;width:100%;height:calc(100vh - 60px);overflow:hidden;'
    + 'background:var(--bg-base);">'
    + '<span class="sr-only">' + esc(webNodes.length + ' nodes in Indra\'s Web visualization. Use Board or List for full accessibility.') + '</span>'
    + '</div>';
  var container = document.getElementById("web-container");
  container.setAttribute("role", "img");
  container.setAttribute("aria-label", "Indra's Web â€” coordination landscape");

  // Mobile notice
  if (window.innerWidth < 768) {
    container.insertAdjacentHTML("afterbegin",
      '<div class="web-mobile-notice">'
      + '<span>Web works best on larger screens. Pinch to zoom, drag to pan.</span>'
      + '<button onclick="this.parentNode.remove()" style="background:none;border:none;cursor:pointer;color:inherit;font-size:16px">\u2715</button>'
      + '</div>');
  }

  // Legend
  container.insertAdjacentHTML("beforeend", buildWebLegendHTML(hierarchy.orphanBranches.length > 0));

  // Orphan badge
  if (hierarchy.orphanBranches.length > 0) {
    var orphanNames = hierarchy.orphanBranches.map(function(b) { return b.name; });
    container.insertAdjacentHTML("beforeend",
      '<div class="web-orphan-badge" title="' + esc(orphanNames.join(", ")) + '">'
      + '\u26a0 ' + hierarchy.orphanBranches.length + ' orphan branch' + (hierarchy.orphanBranches.length > 1 ? 'es' : '')
      + '</div>');
  }

  var w = container.offsetWidth;
  var h = container.offsetHeight;

  try {
    webGraph = ForceGraph()(container)
      .graphData({ nodes: webNodes, links: webLinks })
      .width(w).height(h)
      .nodeId("id")
      .nodeLabel(function(node) { return buildWebTooltipHTML(node); })
      .linkSource("source").linkTarget("target")
      .linkColor(function() { return WEB_SPOKE_COLOR; })
      .linkWidth(function(link) {
        var src = (typeof link.source === "object") ? link.source : null;
        var tgt = (typeof link.target === "object") ? link.target : null;
        if (src && tgt) {
          if (src.tier === "epic" || tgt.tier === "epic") return 2;
        }
        return 1;
      })
      .linkDirectionalArrowLength(0) // No arrows â€” hierarchy, not dependency
      .onNodeClick(function(node) {
        if (node && node.id) openWebDetailPane(node.id);
      })
      .nodeCanvasObjectMode(function() { return "replace"; })
      .nodeCanvasObject(drawWebNode)
      .nodePointerAreaPaint(drawWebNodePointerArea);
  } catch (err) {
    app.innerHTML = '<div class="web-empty">'
      + '<div class="web-fallback-icon">\u26a0</div>'
      + '<div class="web-fallback-title">Graph rendering failed</div>'
      + '<div class="web-fallback-msg">' + esc(err.message) + '</div>'
      + '<button class="web-fallback-retry" onclick="location.hash=\'#/web\'">Retry</button>'
      + '</div>';
    return;
  }

  // Hierarchy-aware forces
  webGraph
    .d3Force("link", d3.forceLink(webLinks).id(function(d) { return d.id; })
      .distance(function(link) {
        var src = (typeof link.source === "object") ? link.source : null;
        var tgt = (typeof link.target === "object") ? link.target : null;
        if (src && (src.tier === "epic" || (tgt && tgt.tier === "epic"))) return WEB_LINK_DISTANCE["epic-task"];
        return WEB_LINK_DISTANCE["task-task"];
      })
      .strength(function(link) {
        var src = (typeof link.source === "object") ? link.source : null;
        if (src && src.tier === "epic") return 0.7;
        return 0.5;
      })
    )
    .d3Force("charge", d3.forceManyBody().strength(function(d) {
      return WEB_CHARGE[d.tier] || -30;
    }))
    .d3Force("x", d3.forceX(0).strength(0.03))
    .d3Force("y", d3.forceY(0).strength(0.03))
    .d3Force("collision", d3.forceCollide(function(d) {
      return WEB_COLLISION_RADIUS[d.tier] || 8;
    }).strength(0.7))
    .d3Force("center", null);

  // Resize handler
  webResizeHandler = function() {
    if (!webGraph) return;
    var c = document.getElementById("web-container");
    if (!c) return;
    webGraph.width(c.offsetWidth).height(c.offsetHeight);
  };
  window.addEventListener("resize", webResizeHandler);

  // Zoom to fit after stabilization
  webGraph.d3ReheatSimulation();
  setTimeout(function() {
    if (webGraph) webGraph.zoomToFit(400, 40);
  }, 2000);
}

function updateWebData(graphData, gitData) {
  if (!webGraph) return;
  if (!graphData) return;
  var newRevision = (graphData.revision || "") + ":" + ((gitData && gitData.head_commit) || "");
  if (webCurrentRevision && newRevision === webCurrentRevision) return;
  webCurrentRevision = newRevision;

  var hierarchy = buildWebHierarchy(graphData, gitData);
  var webNodes = hierarchy.nodes;

  if (webNodes.length === 0) {
    webData = null;
    renderWeb();
    return;
  }

  webData = { graphRevision: graphData.revision, gitData: gitData, hierarchy: hierarchy };
  webGraph.graphData({ nodes: webNodes, links: hierarchy.links });

  // Update orphan badge
  var container = document.getElementById("web-container");
  if (container) {
    var oldBadge = container.querySelector(".web-orphan-badge");
    if (oldBadge) oldBadge.remove();
    if (hierarchy.orphanBranches.length > 0) {
      var orphanNames = hierarchy.orphanBranches.map(function(b) { return b.name; });
      container.insertAdjacentHTML("beforeend",
        '<div class="web-orphan-badge" title="' + esc(orphanNames.join(", ")) + '">'
        + '\u26a0 ' + hierarchy.orphanBranches.length + ' orphan branch' + (hierarchy.orphanBranches.length > 1 ? 'es' : '')
        + '</div>');
    }
  }
}

function cleanupWeb() {
  closeWebDetailPane();
  if (webResizeHandler) {
    window.removeEventListener("resize", webResizeHandler);
    webResizeHandler = null;
  }
  if (webGraph) {
    webGraph.pauseAnimation();
    var container = document.getElementById("web-container");
    if (container) container.innerHTML = "";
    webGraph = null;
  }
  webData = null;
  webCurrentRevision = null;
  webRenderGeneration++;
}

// --- Web Detail Pane ---

function openWebDetailPane(taskId) {
  var pane = document.getElementById("web-detail-pane");
  var overlay = document.getElementById("web-detail-overlay");
  var body = document.getElementById("web-pane-body");
  var title = document.getElementById("web-pane-title");

  // Measure nav height and set CSS var so pane sits below it
  var nav = document.querySelector(".nav");
  if (nav) document.documentElement.style.setProperty("--nav-h", nav.offsetHeight + "px");

  body.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  title.textContent = "Loading\u2026";
  pane.classList.add("open");
  overlay.classList.add("open");

  Promise.all([
    api("/api/tasks/" + taskId),
    api("/api/tasks/" + taskId + "/events")
  ]).then(function(results) {
    var task = results[0];
    var events = results[1];

    // Header
    var sid = task.short_id || task.id.substring(0, 12);
    title.innerHTML = '<span style="color:var(--accent-primary);font-family:var(--font-mono)">' + esc(sid) + '</span> ' + esc(task.title || "Untitled");

    var html = '';

    // Status bar
    html += '<div class="pane-status-bar">';
    if (task.status) html += '<span class="badge" style="background:' + esc(getLaneColor(task.status)) + ';color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem">' + esc(task.status.replace(/_/g, " ")) + '</span>';
    if (task.priority) html += '<span class="badge pri-' + esc(task.priority) + '" style="padding:2px 8px;border-radius:4px;font-size:.8rem">' + esc(task.priority) + '</span>';
    if (task.type) html += '<span class="badge type-badge" style="padding:2px 8px;border-radius:4px;font-size:.8rem">' + esc(task.type) + '</span>';
    html += '</div>';

    // Fields
    var fields = [
      ["Assigned", task.assigned_to],
      ["Created by", task.created_by],
      ["Created", task.created_at],
      ["Updated", task.updated_at]
    ];
    fields.forEach(function(f) {
      if (f[1]) {
        html += '<div class="pane-field"><dt>' + esc(f[0]) + '</dt><dd>' + esc(String(f[1])) + '</dd></div>';
      }
    });

    // Description
    if (task.description) {
      html += '<div class="pane-section"><h3>Description</h3>';
      html += '<pre style="white-space:pre-wrap;font-size:.85rem;margin:0;color:var(--text-primary)">' + esc(task.description) + '</pre>';
      html += '</div>';
    }

    // Tags
    if (task.tags && task.tags.length) {
      html += '<div class="pane-section"><h3>Tags</h3>';
      task.tags.forEach(function(tag) { html += '<span class="badge badge-stat" style="margin-right:4px">' + esc(tag) + '</span>'; });
      html += '</div>';
    }

    // Relationships
    if (task.relationships_out && task.relationships_out.length) {
      html += '<div class="pane-section"><h3>Relationships</h3>';
      task.relationships_out.forEach(function(r) {
        html += '<div style="font-size:.85rem;margin-bottom:3px">' + esc(r.type) + ' \u2192 <a href="javascript:void(0)" onclick="openWebDetailPane(\'' + esc(r.target_task_id) + '\')" style="color:var(--accent-primary)">' + esc(r.target_task_id.substring(0, 12)) + '</a></div>';
      });
      html += '</div>';
    }

    // Comments
    var comments = (events || []).filter(function(ev) { return ev.type === "comment_added"; });
    if (comments.length) {
      html += '<div class="pane-section"><h3>Comments (' + comments.length + ')</h3>';
      comments.forEach(function(ev) {
        html += '<div class="pane-comment">';
        html += '<div class="pane-comment-meta">' + esc(ev.actor || "") + ' \u00b7 ' + esc(ev.ts || "") + '</div>';
        html += '<div>' + esc((ev.data && ev.data.body) || "") + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Recent events (non-comment, last 10)
    var nonComments = (events || []).filter(function(ev) { return ev.type !== "comment_added"; }).slice(0, 10);
    if (nonComments.length) {
      html += '<div class="pane-section"><h3>History</h3>';
      nonComments.forEach(function(ev) {
        html += '<div class="pane-event">';
        html += '<span style="color:var(--text-muted);font-size:.75rem;min-width:60px">' + esc((ev.ts || "").substring(11, 19)) + '</span>';
        html += '<span class="ev-type">' + esc(ev.type || "") + '</span>';
        html += '<span>' + esc(ev.actor || "") + '</span>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Open full detail link
    html += '<button class="pane-open-full" onclick="closeWebDetailPane(); location.hash=\'#/task/' + esc(taskId) + '\'">Open Full Detail View</button>';

    body.innerHTML = html;

  }).catch(function(e) {
    body.innerHTML = '<div style="color:var(--color-danger);padding:20px">' + esc(e.message) + '</div>';
  });
}

function closeWebDetailPane() {
  var pane = document.getElementById("web-detail-pane");
  var overlay = document.getElementById("web-detail-overlay");
  if (pane) pane.classList.remove("open");
  if (overlay) overlay.classList.remove("open");
}

// Wire pane close handlers (once, at boot)
document.addEventListener("DOMContentLoaded", function() {
  var closeBtn = document.getElementById("web-pane-close");
  if (closeBtn) closeBtn.addEventListener("click", closeWebDetailPane);
  var overlay = document.getElementById("web-detail-overlay");
  if (overlay) overlay.addEventListener("click", closeWebDetailPane);
});

// --- Floating Detail Panel (Board / List) ---

function openDetailPanel(taskId) {
  var pane = document.getElementById("detail-panel");
  var overlay = document.getElementById("detail-panel-overlay");
  var body = document.getElementById("dp-body");
  var title = document.getElementById("dp-title");

  // Measure nav height so pane starts below it
  var nav = document.querySelector(".nav");
  if (nav) document.documentElement.style.setProperty("--nav-h", nav.offsetHeight + "px");

  // Remember which element triggered the panel for focus restoration
  _detailPanelTrigger = document.activeElement;
  _detailPanelTaskId = taskId;

  body.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  title.textContent = "Loading\u2026";
  pane.classList.add("open");
  overlay.classList.add("open");

  var openGeneration = taskId; // stale-callback guard

  Promise.all([
    api("/api/tasks/" + taskId),
    api("/api/tasks/" + taskId + "/events")
  ]).then(function(results) {
    if (_detailPanelTaskId !== openGeneration) return; // user clicked a different card
    _renderPanelContent(taskId, results[0], results[1]);
  }).catch(function(e) {
    if (_detailPanelTaskId !== openGeneration) return;
    body.innerHTML = '<div style="color:var(--color-danger);padding:20px">' + esc(e.message) + '</div>';
  });

  // Wire "open full" button
  var fullBtn = document.getElementById("dp-open-full");
  fullBtn.onclick = function() {
    closeDetailPanel();
    location.hash = "#/task/" + taskId;
  };
}

function closeDetailPanel() {
  var pane = document.getElementById("detail-panel");
  var overlay = document.getElementById("detail-panel-overlay");
  if (pane) pane.classList.remove("open");
  if (overlay) overlay.classList.remove("open");

  // Restore focus
  if (_detailPanelTrigger && _detailPanelTrigger.focus) {
    try { _detailPanelTrigger.focus(); } catch(e) {}
  }
  _detailPanelTaskId = null;
  _detailPanelTrigger = null;
}

function _renderPanelContent(taskId, task, events) {
  var body = document.getElementById("dp-body");
  var title = document.getElementById("dp-title");
  var isArchived = !!task.archived;

  // Header
  var sid = task.short_id || task.id.substring(0, 12);
  title.innerHTML = '<span style="color:var(--accent-primary);font-family:var(--font-mono)">' + esc(sid) + '</span> ' + esc(task.title || "Untitled");

  var html = '';

  // Status / priority / type dropdowns (or read-only badges)
  if (!isArchived) {
    html += '<div class="dp-actions">';
    var transitions = (config && config.workflow && config.workflow.transitions) || {};
    var allowed = transitions[task.status] || [];
    html += '<select id="dp-status" title="Change status">';
    html += '<option value="' + esc(task.status) + '" selected>' + esc(task.status) + '</option>';
    allowed.forEach(function(s) {
      html += '<option value="' + esc(s) + '">' + esc(s) + '</option>';
    });
    html += '</select>';

    html += '<select id="dp-priority" title="Change priority">';
    ["critical","high","medium","low"].forEach(function(p) {
      html += '<option value="' + esc(p) + '"' + (p === task.priority ? ' selected' : '') + '>' + esc(p) + '</option>';
    });
    html += '</select>';

    var types = (config && config.task_types) || [];
    html += '<select id="dp-type" title="Change type">';
    types.forEach(function(ty) {
      html += '<option value="' + esc(ty) + '"' + (ty === task.type ? ' selected' : '') + '>' + esc(ty) + '</option>';
    });
    html += '</select>';
    html += '</div>';
  } else {
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">';
    if (task.status) html += '<span class="badge" style="background:' + esc(getLaneColor(task.status)) + ';color:#fff;padding:2px 8px;border-radius:4px;font-size:.8rem">' + esc(task.status.replace(/_/g, " ")) + '</span>';
    if (task.priority) html += '<span class="badge pri-' + esc(task.priority) + '" style="padding:2px 8px;border-radius:4px;font-size:.8rem">' + esc(task.priority) + '</span>';
    if (task.type) html += '<span class="badge type-badge" style="padding:2px 8px;border-radius:4px;font-size:.8rem">' + esc(task.type) + '</span>';
    html += ' <span class="archived-badge">ARCHIVED</span></div>';
  }

  // Title (editable)
  if (!isArchived) {
    html += '<div class="dp-field"><dt>Title</dt><dd><span class="editable" id="dp-title-edit" title="Click to edit">' + esc(task.title || "Untitled") + '</span></dd></div>';
  }

  // Info fields
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">';
  if (task.short_id) html += '<div class="dp-field"><dt>Short ID</dt><dd style="font-weight:600;color:var(--accent-primary)">' + esc(task.short_id) + '</dd></div>';

  if (!isArchived) {
    html += '<div class="dp-field"><dt>Assigned to</dt><dd><span class="editable" id="dp-assigned" title="Click to edit">' + esc(task.assigned_to || "Unassigned") + '</span></dd></div>';
  } else {
    html += '<div class="dp-field"><dt>Assigned to</dt><dd>' + esc(task.assigned_to || "Unassigned") + '</dd></div>';
  }

  if (task.created_by) html += '<div class="dp-field"><dt>Created by</dt><dd>' + esc(task.created_by) + '</dd></div>';
  if (task.created_at) html += '<div class="dp-field"><dt>Created</dt><dd>' + esc(task.created_at) + '</dd></div>';
  if (task.updated_at) html += '<div class="dp-field"><dt>Updated</dt><dd>' + esc(task.updated_at) + '</dd></div>';
  html += '</div>';

  // Description (editable)
  html += '<div class="dp-section"><h3>Description</h3>';
  if (!isArchived) {
    html += '<pre class="editable" id="dp-description" style="white-space:pre-wrap;font-size:.85rem;min-height:16px;margin:0;color:var(--text-primary)" title="Click to edit">' + esc(task.description || "No description") + '</pre>';
  } else {
    html += '<pre style="white-space:pre-wrap;font-size:.85rem;margin:0;color:var(--text-primary)">' + esc(task.description || "") + '</pre>';
  }
  html += '</div>';

  // Tags (editable)
  html += '<div class="dp-section"><h3>Tags</h3>';
  if (!isArchived) {
    var tagStr = (task.tags && task.tags.length) ? task.tags.join(", ") : "";
    html += '<span class="editable" id="dp-tags" title="Click to edit">' + esc(tagStr || "No tags") + '</span>';
  } else if (task.tags && task.tags.length) {
    task.tags.forEach(function(tag) { html += '<span class="badge badge-stat" style="margin-right:4px">' + esc(tag) + '</span>'; });
  }
  html += '</div>';

  // Plan & Notes â€” always show Plan, show Notes only if file exists
  html += '<div class="dp-section"><h3>' + esc(t("section.plans")) + ' & ' + esc(t("section.notes")) + '</h3>';
  html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
  html += '<button class="btn btn-primary btn-sm" onclick="openPlans(\'' + esc(task.id) + '\')">' + esc(t("btn.show_plan")) + '</button>';
  if (task.notes_exists) {
    html += '<button class="btn btn-primary btn-sm" onclick="openNotes(\'' + esc(task.id) + '\')">' + esc(t("btn.show_notes")) + '</button>';
  }
  html += '</div></div>';

  // Comments
  var comments = (events || []).filter(function(ev) { return ev.type === "comment_added"; });
  html += '<div class="dp-section"><h3>Comments (' + comments.length + ')</h3>';
  if (!isArchived) {
    html += '<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px">';
    html += '<textarea class="form-control" id="dp-comment-text" placeholder="Add a comment\u2026" style="min-height:50px;font-size:.85rem"></textarea>';
    html += '<button class="btn btn-primary btn-sm" id="dp-comment-submit" style="align-self:flex-end">Post</button>';
    html += '</div>';
  }
  if (comments.length) {
    comments.forEach(function(ev) {
      html += '<div class="dp-comment">';
      html += '<div class="dp-comment-meta">' + esc(ev.actor || "") + ' \u00b7 ' + esc(ev.ts || "") + '</div>';
      html += '<div>' + esc((ev.data && ev.data.body) || "") + '</div>';
      html += '</div>';
    });
  }
  html += '</div>';

  // History (last 10 non-comment events)
  var nonComments = (events || []).filter(function(ev) { return ev.type !== "comment_added"; }).slice(0, 10);
  if (nonComments.length) {
    html += '<div class="dp-section"><h3>History</h3>';
    nonComments.forEach(function(ev) {
      html += '<div class="dp-event">';
      html += '<span style="color:var(--text-muted);font-size:.75rem;min-width:55px">' + esc((ev.ts || "").substring(11, 19)) + '</span>';
      html += '<span class="ev-type">' + esc(ev.type || "") + '</span>';
      html += '<span>' + esc(ev.actor || "") + '</span>';
      html += '</div>';
    });
    html += '</div>';
  }

  // Archive button
  if (!isArchived) {
    html += '<div class="dp-section" style="border-top:none;margin-top:8px">';
    html += '<button class="btn btn-danger btn-sm" id="dp-archive-btn">Archive</button>';
    html += '</div>';
  }

  body.innerHTML = html;

  // Wire interactive elements
  if (!isArchived) {
    _wirePanelActions(taskId, task);
  }
}

function _wirePanelActions(taskId, task) {
  // Status change
  var statusSel = document.getElementById("dp-status");
  if (statusSel) {
    statusSel.addEventListener("change", async function() {
      var newStatus = this.value;
      if (newStatus === task.status) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/status", { status: newStatus });
        showToast(tf("toast.moved_to", {status: newStatus}), "success");
        await _refreshAfterPanelEdit(taskId);
      } catch(e) {
        showToast(e.message, "error");
        this.value = task.status;
      }
    });
  }

  // Priority change
  var priSel = document.getElementById("dp-priority");
  if (priSel) {
    priSel.addEventListener("change", async function() {
      var newPri = this.value;
      if (newPri === task.priority) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/update", { fields: { priority: newPri } });
        showToast(tf("toast.priority_changed", {value: newPri}), "success");
        await _refreshAfterPanelEdit(taskId);
      } catch(e) {
        showToast(e.message, "error");
        this.value = task.priority;
      }
    });
  }

  // Type change
  var typeSel = document.getElementById("dp-type");
  if (typeSel) {
    typeSel.addEventListener("change", async function() {
      var newType = this.value;
      if (newType === task.type) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/update", { fields: { type: newType } });
        showToast(tf("toast.type_changed", {value: newType}), "success");
        await _refreshAfterPanelEdit(taskId);
      } catch(e) {
        showToast(e.message, "error");
        this.value = task.type;
      }
    });
  }

  // Title inline edit
  var titleEl = document.getElementById("dp-title-edit");
  if (titleEl) {
    titleEl.addEventListener("click", function() {
      _inlineEdit(titleEl, task.title || "", function(newVal) {
        if (!newVal.trim()) { showToast(t("error.title_empty"), "error"); return Promise.reject(); }
        return apiPost("/api/tasks/" + taskId + "/update", { fields: { title: newVal.trim() } })
          .then(function() {
            showToast(t("toast.title_updated"), "success");
            _refreshAfterPanelEdit(taskId);
          });
      });
    });
  }

  // Description inline edit
  var descEl = document.getElementById("dp-description");
  if (descEl) {
    descEl.addEventListener("click", function() {
      _inlineEditTextarea(descEl, task.description || "", function(newVal) {
        return apiPost("/api/tasks/" + taskId + "/update", { fields: { description: newVal } })
          .then(function() {
            showToast(t("toast.description_updated"), "success");
            _refreshAfterPanelEdit(taskId);
          });
      });
    });
  }

  // Assigned to inline edit (with member chips)
  var assignEl = document.getElementById("dp-assigned");
  if (assignEl) {
    assignEl.addEventListener("click", function() {
      if (assignEl.dataset.editing === "true") return;
      assignEl.dataset.editing = "true";

      var wrapper = document.createElement("div");
      var row = document.createElement("div");
      row.className = "inline-edit";
      var input = document.createElement("input");
      input.type = "text";
      input.className = "form-control";
      input.value = task.assigned_to || "";
      var saveBtn = document.createElement("button");
      saveBtn.className = "btn btn-primary btn-sm";
      saveBtn.textContent = t("btn.save");
      var cancelBtn = document.createElement("button");
      cancelBtn.className = "btn btn-sm";
      cancelBtn.textContent = t("btn.cancel");

      row.appendChild(input);
      row.appendChild(saveBtn);
      row.appendChild(cancelBtn);
      wrapper.appendChild(row);

      var chips = buildMemberChips(input);
      wrapper.appendChild(chips);

      var parent = assignEl.parentNode;
      parent.replaceChild(wrapper, assignEl);
      input.focus();
      input.select();

      function cancel() { parent.replaceChild(assignEl, wrapper); assignEl.dataset.editing = "false"; }

      cancelBtn.addEventListener("click", cancel);
      input.addEventListener("keydown", function(e) {
        if (e.key === "Escape") cancel();
        if (e.key === "Enter") saveBtn.click();
      });
      saveBtn.addEventListener("click", function() {
        var assignedTo = input.value.trim() || null;
        apiPost("/api/tasks/" + taskId + "/assign", { assigned_to: assignedTo })
          .then(function() {
            showToast(assignedTo ? tf("toast.assigned", {value: assignedTo}) : t("toast.unassigned"), "success");
            _refreshAfterPanelEdit(taskId);
          })
          .catch(function(e) {
            showToast(e.message, "error");
            cancel();
          });
      });
    });
  }

  // Tags inline edit
  var tagsEl = document.getElementById("dp-tags");
  if (tagsEl) {
    tagsEl.addEventListener("click", function() {
      var tagStr = (task.tags && task.tags.length) ? task.tags.join(", ") : "";
      _inlineEdit(tagsEl, tagStr, function(newVal) {
        var newTags = newVal.split(",").map(function(t){ return t.trim(); }).filter(Boolean);
        return apiPost("/api/tasks/" + taskId + "/update", { fields: { tags: newTags } })
          .then(function() {
            showToast(t("toast.tags_updated"), "success");
            _refreshAfterPanelEdit(taskId);
          });
      });
    });
  }

  // Comment submit
  var commentBtn = document.getElementById("dp-comment-submit");
  if (commentBtn) {
    commentBtn.addEventListener("click", async function() {
      if (commentBtn.disabled) return;
      var textarea = document.getElementById("dp-comment-text");
      var text = textarea.value.trim();
      if (!text) { showToast(t("error.comment_empty"), "error"); return; }
      commentBtn.disabled = true;
      try {
        await apiPost("/api/tasks/" + taskId + "/comment", { body: text });
        showToast(t("toast.comment_added"), "success");
        textarea.blur();
        textarea.value = "";
        await _refreshAfterPanelEdit(taskId);
      } catch(e) {
        showToast(e.message, "error");
      } finally {
        commentBtn.disabled = false;
      }
    });

    var commentTextarea = document.getElementById("dp-comment-text");
    if (commentTextarea) {
      commentTextarea.addEventListener("keydown", function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          e.preventDefault();
          commentBtn.click();
        }
      });
    }
  }

  // Archive button
  var archiveBtn = document.getElementById("dp-archive-btn");
  if (archiveBtn) {
    archiveBtn.addEventListener("click", async function() {
      if (!confirm("Archive this task? It will be moved to the archive.")) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/archive", {});
        showToast(t("toast.task_archived"), "success");
        closeDetailPanel();
        tasks = await api("/api/tasks");
        updateAllBadges();
        if (currentView === "board") renderBoard();
        else if (currentView === "list") { renderList(); }
      } catch(e) {
        showToast(e.message, "error");
      }
    });
  }
}

async function _refreshAfterPanelEdit(taskId) {
  // Re-fetch tasks to update board/list behind the panel
  tasks = await api("/api/tasks");
  updateAllBadges();

  // Re-render the underlying view
  if (currentView === "board") renderBoard();
  else if (currentView === "list") renderList();

  // Re-render panel content if still open and no active edit
  if (_detailPanelTaskId === taskId) {
    var body = document.getElementById("dp-body");
    // Skip if user is mid-edit (has an active input/textarea)
    if (body && !body.querySelector("input:focus, textarea:focus")) {
      var results = await Promise.all([
        api("/api/tasks/" + taskId),
        api("/api/tasks/" + taskId + "/events")
      ]);
      if (_detailPanelTaskId === taskId) {
        _renderPanelContent(taskId, results[0], results[1]);
      }
    }
  }
}

// Wire panel close handlers (once, at boot)
document.addEventListener("DOMContentLoaded", function() {
  var closeBtn = document.getElementById("dp-close");
  if (closeBtn) closeBtn.addEventListener("click", closeDetailPanel);
  var overlay = document.getElementById("detail-panel-overlay");
  if (overlay) overlay.addEventListener("click", closeDetailPanel);

  // Escape key closes panel (unless user is in an active inline edit)
  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape" && _detailPanelTaskId) {
      var active = document.activeElement;
      var inPanel = document.getElementById("detail-panel");
      // Don't close if user is typing in an input/textarea inside the panel
      if (active && inPanel && inPanel.contains(active) && (active.tagName === "INPUT" || active.tagName === "TEXTAREA")) return;
      closeDetailPanel();
    }
  });
});

// --- Routing ---
async function route(hash) {
  var h = (hash || "/board").replace(/^#?\/?/, "/");
  var parts = h.split("/").filter(Boolean);
  var view = parts[0] || "board";

  // Close floating detail panel on any hash navigation
  if (_detailPanelTaskId) closeDetailPanel();

  // Clean up cube when navigating to a different main view
  if (currentView === "cube" && view !== "cube" && view !== "task") {
    cleanupCube();
  }
  // Clean up web when navigating to a different main view
  if (currentView === "web" && view !== "web" && view !== "task") {
    cleanupWeb();
  }

  currentView = view === "task" ? currentView : view;
  updateTabs();

  if (view === "board") renderBoard();
  else if (view === "list") renderList();
  else if (view === "activity") await renderActivity();
  else if (view === "stats") await renderStats();
  else if (view === "cube") await renderCube();
  else if (view === "web") await renderWeb();
  else if (view === "task" && parts[1]) await renderDetail(parts[1]);
  else renderBoard();
}

window.addEventListener("hashchange", function() { route(location.hash.slice(1)); });

// --- Dashboard config helpers ---
function getDashboardConfig() {
  return (config && config.dashboard) || {};
}

function getLaneColor(status) {
  var dc = getDashboardConfig();
  if (dc.lane_colors && dc.lane_colors[status]) return dc.lane_colors[status];
  var themeDefaults = LANE_COLORS_BY_THEME[getTheme()] || DEFAULT_LANE_COLORS;
  return themeDefaults[status] || "#6c757d";
}

function getBackgroundImage() {
  var dc = getDashboardConfig();
  return dc.background_image || "";
}

function getTheme() {
  var dc = getDashboardConfig();
  return dc.theme || "classic";
}

function applyTheme(themeId) {
  document.documentElement.dataset.theme = themeId || "classic";
}

function populateThemeSelector() {
  var select = document.getElementById("theme-select");
  if (!select) return;
  var current = getTheme();
  select.innerHTML = "";
  THEMES.forEach(function(t) {
    var opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = t.name;
    if (t.id === current) opt.selected = true;
    select.appendChild(opt);
  });
}

function getVoice() {
  var dc = getDashboardConfig();
  return dc.voice || "en-oracle";
}

function populateVoiceSelector() {
  var select = document.getElementById("voice-select");
  if (!select) return;
  var current = getVoice();
  select.innerHTML = "";
  Object.keys(VOICES).forEach(function(id) {
    var meta = VOICES[id]._meta || {};
    var opt = document.createElement("option");
    opt.value = id;
    opt.textContent = meta.label || id;
    if (id === current) opt.selected = true;
    select.appendChild(opt);
  });
}

function updateStaticVoiceStrings() {
  // Nav tabs
  document.querySelectorAll(".nav-tab").forEach(function(el) {
    var view = el.dataset.view;
    if (view === "board") el.textContent = t("nav.board");
    else if (view === "list") el.textContent = t("nav.list");
    else if (view === "activity") el.textContent = t("nav.activity");
    else if (view === "stats") el.textContent = t("nav.stats");
  });
  // New Task button
  var newBtn = document.getElementById("new-task-btn");
  if (newBtn) newBtn.textContent = t("btn.new_task");
  // Refresh button
  var refBtn = document.getElementById("refresh-btn");
  if (refBtn) refBtn.textContent = t("btn.refresh");
  // Help button
  var helpBtn = document.getElementById("help-btn");
  if (helpBtn) { helpBtn.title = t("btn.help_title"); helpBtn.lastChild.textContent = " " + t("btn.help"); }
  // Settings header
  var settingsHeader = document.querySelector(".settings-header span");
  if (settingsHeader) settingsHeader.textContent = t("settings.title");
  // Settings button title
  var settingsBtn = document.getElementById("settings-btn");
  if (settingsBtn) settingsBtn.title = t("btn.settings");
  // Loading text
  var loadingP = document.querySelector(".loading p");
  if (loadingP) loadingP.textContent = t("loading");
  // Settings labels and hints
  var themeLabel = document.querySelector('label[for="theme-select"]');
  if (themeLabel) themeLabel.textContent = t("settings.theme_label");
  var themeHint = document.querySelector('#theme-select + .hint, label[for="theme-select"] ~ .hint');
  if (!themeHint) {
    var themeGroup = document.getElementById("theme-select");
    if (themeGroup) themeHint = themeGroup.parentElement.querySelector(".hint");
  }
  if (themeHint) themeHint.textContent = t("settings.theme_hint");
  var voiceLabel = document.querySelector('label[for="voice-select"]');
  if (voiceLabel) voiceLabel.textContent = t("settings.voice_label");
  var voiceHint = document.getElementById("voice-select");
  if (voiceHint) {
    var vh = voiceHint.parentElement.querySelector(".hint");
    if (vh) vh.textContent = t("settings.voice_hint");
  }
  var bgLabel = document.querySelector('label[for="bg-image-input"]');
  if (bgLabel) bgLabel.textContent = t("settings.bg_label");
  var bgHint = document.getElementById("bg-image-input");
  if (bgHint) {
    var bh = bgHint.parentElement.querySelector(".hint");
    if (bh) bh.textContent = t("settings.bg_hint");
  }
  var bgSaveBtn = document.getElementById("bg-image-save");
  if (bgSaveBtn) bgSaveBtn.textContent = t("btn.apply");
  var bgClearBtn = document.getElementById("bg-image-clear");
  if (bgClearBtn) bgClearBtn.textContent = t("btn.clear");
  var laneLabelEl = document.querySelector('#lane-colors-list');
  if (laneLabelEl) {
    var lg = laneLabelEl.parentElement;
    var ll = lg.querySelector("label");
    if (ll) ll.textContent = t("settings.lane_label");
    var lh = lg.querySelector(".hint");
    if (lh) lh.textContent = t("settings.lane_hint");
  }
  var lcSaveBtn = document.getElementById("lane-colors-save");
  if (lcSaveBtn) lcSaveBtn.textContent = t("btn.apply_lane_colors");
  var lcResetBtn = document.getElementById("lane-colors-reset");
  if (lcResetBtn) lcResetBtn.textContent = t("btn.reset_defaults");
  // Create task modal static elements
  var modalHeader = document.querySelector("#create-task-modal .modal-header h2");
  if (modalHeader) modalHeader.textContent = t("modal.create_title");
  var ctCancelBtn = document.getElementById("create-task-cancel");
  if (ctCancelBtn) ctCancelBtn.textContent = t("btn.cancel");
  var ctSubmitBtn = document.getElementById("create-task-submit");
  if (ctSubmitBtn) ctSubmitBtn.textContent = t("btn.create_task");
  // Create task modal labels
  var ctTitleLabel = document.querySelector('label[for="ct-title"]');
  if (ctTitleLabel) ctTitleLabel.textContent = t("label.title");
  var ctTitleInput = document.getElementById("ct-title");
  if (ctTitleInput) ctTitleInput.placeholder = t("placeholder.title");
  var ctTypeLabel = document.querySelector('label[for="ct-type"]');
  if (ctTypeLabel) ctTypeLabel.textContent = t("label.type");
  var ctPriLabel = document.querySelector('label[for="ct-priority"]');
  if (ctPriLabel) ctPriLabel.textContent = t("label.priority");
  var ctDescLabel = document.querySelector('label[for="ct-description"]');
  if (ctDescLabel) ctDescLabel.textContent = t("label.description");
  var ctDescInput = document.getElementById("ct-description");
  if (ctDescInput) ctDescInput.placeholder = t("placeholder.description");
  var ctTagsLabel = document.querySelector('label[for="ct-tags"]');
  if (ctTagsLabel) ctTagsLabel.textContent = t("label.tags");
  var ctTagsInput = document.getElementById("ct-tags");
  if (ctTagsInput) ctTagsInput.placeholder = t("placeholder.tags");
  var ctAssignedLabel = document.querySelector('label[for="ct-assigned"]');
  if (ctAssignedLabel) ctAssignedLabel.textContent = t("label.assigned_to");
  var ctAssignedInput = document.getElementById("ct-assigned");
  if (ctAssignedInput) ctAssignedInput.placeholder = t("placeholder.assigned");
}

// --- Background image ---
function applyBackgroundImage() {
  var app = document.getElementById("app");
  var bg = getBackgroundImage();
  if (bg) {
    app.style.backgroundImage = "url(" + bg + ")";
    app.style.backgroundSize = "cover";
    app.style.backgroundPosition = "center";
    app.style.backgroundRepeat = "no-repeat";
    app.style.backgroundAttachment = "fixed";
    app.style.minHeight = "calc(100vh - 50px)";
  } else {
    app.style.backgroundImage = "";
    app.style.backgroundSize = "";
    app.style.backgroundPosition = "";
    app.style.backgroundRepeat = "";
    app.style.backgroundAttachment = "";
    app.style.minHeight = "";
  }
}

function loadBackgroundSetting() {
  var input = document.getElementById("bg-image-input");
  input.value = getBackgroundImage();
  applyBackgroundImage();
}

// --- Lane color settings ---
function populateLaneColorSettings() {
  var container = document.getElementById("lane-colors-list");
  if (!config || !config.workflow) return;
  var statuses = config.workflow.statuses || [];
  var html = "";
  statuses.forEach(function(s) {
    var color = getLaneColor(s);
    html += '<div class="lane-color-row">';
    html += '<span class="lane-name">' + esc(s) + '</span>';
    html += '<input type="color" data-status="' + esc(s) + '" value="' + esc(color) + '">';
    html += '</div>';
  });
  container.innerHTML = html;
}

// --- Board Card Helper ---
function renderBoardCard(t) {
  var html = '<div class="card" draggable="true" data-task-id="' + esc(t.id) + '" data-task-status="' + esc(t.status || "") + '"';
  html += ' ondragstart="window._boardDragStart(event)" ondragend="window._boardDragEnd(event)">';
  if (t.short_id) html += '<div style="font-size:.7rem;font-weight:600;color:var(--accent-primary);margin-bottom:2px">' + esc(t.short_id) + '</div>';
  html += '<div class="card-title">' + esc(t.title || "Untitled") + "</div>";
  html += '<div class="card-meta">';
  if (t.priority) html += '<span class="badge pri-' + esc(t.priority) + '">' + esc(t.priority) + "</span>";
  if (t.type) html += '<span class="badge type-badge">' + esc(t.type) + "</span>";
  if (t.assigned_to) html += '<span style="color:var(--text-muted);font-size:.8rem">' + esc(t.assigned_to) + "</span>";
  if (t.comment_count) html += '<span style="color:var(--text-muted);font-size:.75rem;margin-left:auto" title="' + t.comment_count + ' comment' + (t.comment_count === 1 ? '' : 's') + '">\uD83D\uDCAC ' + t.comment_count + "</span>";
  html += "</div></div>";
  return html;
}

// --- Epic Card Helper ---
function renderEpicCard(epic, childTasks) {
  var done = 0, total = 0, cancelled = 0, blockedCount = 0, needsHumanCount = 0;
  var activeStatuses = [];
  childTasks.forEach(function(ct) {
    var st = ct.status || "backlog";
    if (st === "done") { done++; }
    else if (st === "cancelled") { cancelled++; }
    else {
      activeStatuses.push(st);
      if (st === "blocked") blockedCount++;
      if (st === "needs_human") needsHumanCount++;
    }
  });
  total = childTasks.length - cancelled;
  var pct = total > 0 ? Math.round((done / total) * 100) : 0;
  // Derive status by precedence
  var precedence = ["needs_human","blocked","in_progress","review","planned","in_planning","backlog"];
  var derivedStatus = null;
  if (activeStatuses.length > 0) {
    for (var i = 0; i < precedence.length; i++) {
      if (activeStatuses.indexOf(precedence[i]) !== -1) { derivedStatus = precedence[i]; break; }
    }
  } else if (childTasks.length > 0) {
    derivedStatus = "done";
  }

  var html = '<div class="epic-card" data-epic-id="' + esc(epic.id) + '">';
  if (epic.short_id) html += '<div class="epic-short-id">' + esc(epic.short_id) + '</div>';
  html += '<div class="epic-title">' + esc(epic.title || "Untitled") + '</div>';
  html += '<div class="epic-progress-bar"><div class="epic-progress-fill" style="width:' + pct + '%"></div></div>';
  html += '<div class="epic-meta">';
  if (derivedStatus) {
    var statusColor = getLaneColor(derivedStatus);
    html += '<span class="epic-status-badge" style="background:' + esc(statusColor) + ';color:var(--text-on-lane)">' + esc(derivedStatus) + '</span>';
  } else if (childTasks.length === 0) {
    html += '<span class="epic-status-badge" style="background:var(--surface-raised);color:var(--text-muted)">unscoped</span>';
  }
  html += '<span>' + done + '/' + total + '</span>';
  if (blockedCount > 0) html += '<span class="epic-health-indicator" title="' + blockedCount + ' blocked">\u26A0 ' + blockedCount + ' blocked</span>';
  if (needsHumanCount > 0) html += '<span class="epic-health-indicator" title="' + needsHumanCount + ' needs human">\u270B ' + needsHumanCount + ' needs human</span>';
  html += '</div></div>';
  return html;
}

// --- Epic highlight + thread logic ---
function clearEpicThreads() {
  var svg = document.getElementById("epic-threads");
  if (svg) svg.innerHTML = "";
  document.querySelectorAll(".card.epic-highlight").forEach(function(el) { el.classList.remove("epic-highlight"); });
  document.querySelectorAll(".epic-card.epic-selected").forEach(function(el) { el.classList.remove("epic-selected"); });
}

function drawEpicThreads(epicId, epicChildMap) {
  var svg = document.getElementById("epic-threads");
  if (!svg) return;
  var wrapper = svg.parentElement;
  if (!wrapper) return;

  var epicCard = document.querySelector('.epic-card[data-epic-id="' + epicId + '"]');
  if (!epicCard) return;
  epicCard.classList.add("epic-selected");

  var wrapperRect = wrapper.getBoundingClientRect();
  var epicRect = epicCard.getBoundingClientRect();
  // Start point: bottom-center of epic card
  var sx = epicRect.left + epicRect.width / 2 - wrapperRect.left;
  var sy = epicRect.bottom - wrapperRect.top;

  var childIds = epicChildMap[epicId] || [];
  var accentColor = getComputedStyle(document.documentElement).getPropertyValue("--accent-primary").trim() || "#6366f1";

  var paths = "";
  childIds.forEach(function(cid) {
    var card = document.querySelector('.card[data-task-id="' + cid + '"]');
    if (!card) return;
    card.classList.add("epic-highlight");
    var cardRect = card.getBoundingClientRect();
    // End point: top-center of child card
    var ex = cardRect.left + cardRect.width / 2 - wrapperRect.left;
    var ey = cardRect.top - wrapperRect.top;
    // Cubic bezier: drop down then curve to target
    var midY = sy + (ey - sy) * 0.4;
    paths += '<path d="M' + sx + ' ' + sy + ' C' + sx + ' ' + midY + ' ' + ex + ' ' + midY + ' ' + ex + ' ' + ey + '"'
      + ' fill="none" stroke="' + accentColor + '" stroke-width="1.5" stroke-opacity="0.5" stroke-dasharray="4 3"/>';
  });
  svg.innerHTML = paths;
}

function toggleEpicSelection(epicId, epicChildMap) {
  clearEpicThreads();

  if (selectedEpicId === epicId) {
    selectedEpicId = null;
    return;
  }

  selectedEpicId = epicId;
  drawEpicThreads(epicId, epicChildMap);
}

// --- Board View ---
function renderBoard() {
  var app = document.getElementById("app");
  if (!config || !tasks) { app.innerHTML = '<div class="loading"><div class="spinner"></div></div>'; return; }

  applyBackgroundImage();

  var statuses = config.workflow ? config.workflow.statuses : [];
  if (tasks.length === 0) {
    app.innerHTML = '<div class="empty"><p>' + esc(t("empty.board")) + '</p><p><button class="btn btn-primary" onclick="showCreateTaskModal()">' + t("empty.board.cta") + '</button></p></div>';
    return;
  }

  // Separate epics from regular tasks
  var epicTasks = [];
  var regularTasks = [];
  tasks.forEach(function(t) {
    if (t.type === "epic") epicTasks.push(t);
    else regularTasks.push(t);
  });

  // Build epicId â†’ [childTaskIds] map from graph links
  var epicChildMap = {};
  if (epicTasks.length > 0 && boardGraphLinks.length > 0) {
    var epicIds = {};
    epicTasks.forEach(function(e) { epicIds[e.id] = true; });
    // subtask_of: source=child, target=parent
    // Build parent â†’ children for recursive collection
    var parentToChildren = {};
    boardGraphLinks.forEach(function(link) {
      if (link.type === "subtask_of") {
        if (!parentToChildren[link.target]) parentToChildren[link.target] = [];
        parentToChildren[link.target].push(link.source);
      }
    });
    // Recursively collect all descendants for each epic
    epicTasks.forEach(function(epic) {
      var children = [];
      var visited = {};
      var stack = parentToChildren[epic.id] ? parentToChildren[epic.id].slice() : [];
      while (stack.length > 0) {
        var cid = stack.pop();
        if (!visited[cid]) {
          visited[cid] = true;
          children.push(cid);
          if (parentToChildren[cid]) {
            parentToChildren[cid].forEach(function(gc) { stack.push(gc); });
          }
        }
      }
      epicChildMap[epic.id] = children;
    });
  }

  // Build task lookup for epic card rendering
  var taskById = {};
  tasks.forEach(function(t) { taskById[t.id] = t; });

  var transitions = (config.workflow && config.workflow.transitions) || {};
  var grouped = {};
  statuses.forEach(function(s) { grouped[s] = []; });
  // Only regular tasks go into status columns
  regularTasks.forEach(function(t) {
    var s = t.status || "unknown";
    if (!grouped[s]) grouped[s] = [];
    grouped[s].push(t);
  });

  var allStatuses = statuses.concat(Object.keys(grouped).filter(function(s) { return !statuses.includes(s); }));
  var colCount = allStatuses.length || 1;

  // Wrapper div for epic lane + board + SVG thread overlay
  var html = '<div class="board-wrapper">';

  // Epic top lane (Row 2 â€” only if epics exist)
  if (epicTasks.length > 0) {
    html += '<div class="board-epic-lane">';
    html += '<div class="board-epic-header">Epics</div>';
    html += '<div class="board-epic-cards">';
    epicTasks.forEach(function(epic) {
      var childIds = epicChildMap[epic.id] || [];
      var childSnaps = childIds.map(function(cid) { return taskById[cid]; }).filter(Boolean);
      html += renderEpicCard(epic, childSnaps);
    });
    html += '</div></div>';
  }

  // SVG overlay for epic â†’ child threads
  html += '<svg id="epic-threads" class="epic-threads-svg"></svg>';

  // Board columns (Row 3)
  html += '<div class="board" style="grid-template-columns:repeat(' + colCount + ',1fr)">';
  allStatuses.forEach(function(status) {
    var items = grouped[status] || [];
    var cls = "status-" + status.replace(/\s+/g,"_");
    var laneColor = getLaneColor(status);
    html += '<div class="board-col ' + cls + '" data-status="' + esc(status) + '"';
    html += ' ondragover="window._boardDragOver(event)" ondragleave="window._boardDragLeave(event)" ondrop="window._boardDrop(event)">';
    html += '<div class="board-col-header" style="background:' + esc(laneColor) + ';color:var(--text-on-lane)">';
    html += '<span>' + esc(status) + '</span>';
    html += '<span class="count">' + items.length + '</span>';
    html += '</div>';
    html += '<div class="board-col-body">';
    if (status === "done" && items.length > 0) {
      // Sub-group done tasks by done_at into "Done Today" and "Done Yesterday"
      var now = new Date();
      var todayStr = now.toISOString().slice(0, 10);
      var yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      var yesterdayStr = yesterday.toISOString().slice(0, 10);
      var doneToday = [];
      var doneYesterday = [];
      items.forEach(function(item) {
        var doneAt = item.done_at;
        if (doneAt && doneAt.slice(0, 10) === todayStr) {
          doneToday.push(item);
        } else if (doneAt && doneAt.slice(0, 10) === yesterdayStr) {
          doneYesterday.push(item);
        } else {
          // Legacy tasks or older â€” put in yesterday bucket
          doneYesterday.push(item);
        }
      });
      if (doneToday.length > 0) {
        html += '<div class="board-sub-header">Done Today <span class="count">' + doneToday.length + '</span></div>';
        doneToday.forEach(function(t) { html += renderBoardCard(t); });
      }
      if (doneYesterday.length > 0) {
        html += '<div class="board-sub-header">Done Yesterday <span class="count">' + doneYesterday.length + '</span></div>';
        doneYesterday.forEach(function(t) { html += renderBoardCard(t); });
      }
      if (doneToday.length === 0 && doneYesterday.length === 0) {
        html += '<div style="color:var(--text-muted);font-size:.8rem;padding:8px;text-align:center">' + esc(t("empty.lane")) + '</div>';
      }
    } else {
      items.forEach(function(t) { html += renderBoardCard(t); });
      if (items.length === 0) html += '<div style="color:var(--text-muted);font-size:.8rem;padding:8px;text-align:center">' + esc(t("empty.lane")) + '</div>';
    }
    html += "</div></div>";
  });
  html += "</div>"; // close .board
  html += "</div>"; // close .board-wrapper

  app.innerHTML = html;

  // Add click handlers for card â†’ floating detail panel (separate from drag)
  app.querySelectorAll(".card").forEach(function(card) {
    card.addEventListener("click", function(e) {
      // Only open panel if this was a real click, not end of drag
      if (!card.classList.contains("was-dragged")) {
        openDetailPanel(card.dataset.taskId);
      }
      card.classList.remove("was-dragged");
    });
  });

  // Epic card click handlers for highlight
  app.querySelectorAll(".epic-card").forEach(function(epicCard) {
    epicCard.addEventListener("click", function(e) {
      e.stopPropagation();
      toggleEpicSelection(epicCard.dataset.epicId, epicChildMap);
    });
  });

  // Restore epic selection if it was active before re-render
  if (selectedEpicId && epicChildMap[selectedEpicId]) {
    var restoreId = selectedEpicId;
    selectedEpicId = null;  // Reset so toggleEpicSelection selects (not deselects)
    toggleEpicSelection(restoreId, epicChildMap);
  }

}

// --- Drag and Drop ---
window._boardDragStart = function(e) {
  var card = e.target.closest(".card");
  if (!card) return;
  // Close detail panel when user starts dragging
  if (_detailPanelTaskId) closeDetailPanel();
  draggedTaskId = card.dataset.taskId;
  draggedFromStatus = card.dataset.taskStatus;
  card.classList.add("dragging");
  e.dataTransfer.effectAllowed = "move";
  e.dataTransfer.setData("text/plain", draggedTaskId);

  // Highlight valid drop targets
  var transitions = (config.workflow && config.workflow.transitions) || {};
  var allowedTargets = transitions[draggedFromStatus] || [];
  setTimeout(function() {
    document.querySelectorAll(".board-col").forEach(function(col) {
      var colStatus = col.dataset.status;
      if (colStatus === draggedFromStatus) return;
      if (allowedTargets.includes(colStatus)) {
        col.style.opacity = "1";
      } else {
        col.style.opacity = "0.5";
      }
    });
  }, 0);
};

window._boardDragEnd = function(e) {
  var card = e.target.closest(".card");
  if (card) {
    card.classList.remove("dragging");
    card.classList.add("was-dragged");
  }
  draggedTaskId = null;
  draggedFromStatus = null;
  document.querySelectorAll(".board-col").forEach(function(col) {
    col.classList.remove("drag-over", "drag-invalid");
    col.style.opacity = "";
  });
};

window._boardDragOver = function(e) {
  e.preventDefault();
  var col = e.target.closest(".board-col");
  if (!col || !draggedFromStatus) return;
  var targetStatus = col.dataset.status;
  if (targetStatus === draggedFromStatus) return;

  var transitions = (config.workflow && config.workflow.transitions) || {};
  var allowed = transitions[draggedFromStatus] || [];
  if (allowed.includes(targetStatus)) {
    e.dataTransfer.dropEffect = "move";
    col.classList.add("drag-over");
    col.classList.remove("drag-invalid");
  } else {
    e.dataTransfer.dropEffect = "none";
    col.classList.add("drag-invalid");
    col.classList.remove("drag-over");
  }
};

window._boardDragLeave = function(e) {
  var col = e.target.closest(".board-col");
  if (col) {
    col.classList.remove("drag-over", "drag-invalid");
  }
};

window._boardDrop = async function(e) {
  e.preventDefault();
  var col = e.target.closest(".board-col");
  if (!col || !draggedTaskId || !draggedFromStatus) return;

  var targetStatus = col.dataset.status;
  col.classList.remove("drag-over", "drag-invalid");

  if (targetStatus === draggedFromStatus) return;

  var transitions = (config.workflow && config.workflow.transitions) || {};
  var allowed = transitions[draggedFromStatus] || [];
  if (!allowed.includes(targetStatus)) {
    showToast(tf("toast.invalid_transition", {from: draggedFromStatus, to: targetStatus}), "error");
    return;
  }

  try {
    await apiPost("/api/tasks/" + draggedTaskId + "/status", {
      status: targetStatus,
      actor: "dashboard:web"
    });
    showToast(tf("toast.moved_to", {status: targetStatus}), "success");
    // Refresh tasks and re-render
    tasks = await api("/api/tasks");
    updateAllBadges();
    renderBoard();
  } catch(err) {
    showToast(err.message, "error");
  }
};

// --- List View ---
function renderList() {
  var app = document.getElementById("app");
  if (!config) return;

  var statuses = config.workflow ? config.workflow.statuses : [];
  var types = config.task_types || [];

  var html = '<div class="filters">';
  html += '<input type="text" id="f-search" placeholder="' + esc(t("filter.search")) + '">';
  html += '<select id="f-status"><option value="">' + esc(t("filter.all_statuses")) + '</option>';
  statuses.forEach(function(s) { html += '<option value="'+esc(s)+'">'+esc(s)+"</option>"; });
  html += "</select>";
  html += '<select id="f-type"><option value="">' + esc(t("filter.all_types")) + '</option>';
  types.forEach(function(ty) { html += '<option value="'+esc(ty)+'">'+esc(ty)+"</option>"; });
  html += "</select>";
  html += '<select id="f-priority"><option value="">' + esc(t("filter.all_priorities")) + '</option>';
  ["critical","high","medium","low"].forEach(function(p) { html += '<option value="'+p+'">'+p+"</option>"; });
  html += "</select>";
  html += '<label><input type="checkbox" id="f-archived"> ' + esc(t("filter.show_archived")) + '</label>';
  html += "</div>";
  html += '<div id="list-table"></div>';
  app.innerHTML = html;

  document.getElementById("f-search").addEventListener("input", applyListFilters);
  document.getElementById("f-status").addEventListener("change", applyListFilters);
  document.getElementById("f-type").addEventListener("change", applyListFilters);
  document.getElementById("f-priority").addEventListener("change", applyListFilters);
  document.getElementById("f-archived").addEventListener("change", async function() {
    if (this.checked && archivedTasks === null) {
      try { archivedTasks = await api("/api/archived"); } catch(e) { archivedTasks = []; }
    }
    applyListFilters();
  });

  // If a global nav search was submitted, populate the search box
  if (pendingSearch) {
    document.getElementById("f-search").value = pendingSearch;
    pendingSearch = null;
  }

  applyListFilters();
}

function applyListFilters() {
  var search = (document.getElementById("f-search").value || "").trim().toLowerCase();
  var status = document.getElementById("f-status").value;
  var type = document.getElementById("f-type").value;
  var priority = document.getElementById("f-priority").value;
  var showArchived = document.getElementById("f-archived").checked;

  var items = tasks.slice();
  if (showArchived && archivedTasks) items = items.concat(archivedTasks);

  items = items.filter(function(t) {
    if (search) {
      var titleMatch = (t.title||"").toLowerCase().includes(search);
      // Bare number: exact match on numeric suffix only (e.g. "50" â†’ LAT-50, not LAT-150)
      var bareNum = /^\d+$/.test(search);
      var shortIdMatch = bareNum
        ? (t.short_id && t.short_id.toLowerCase().endsWith("-" + search))
        : (t.short_id||"").toLowerCase().includes(search);
      if (!titleMatch && !shortIdMatch) return false;
    }
    if (status && t.status !== status) return false;
    if (type && t.type !== type) return false;
    if (priority && t.priority !== priority) return false;
    return true;
  });

  if (items.length === 0 && tasks.length === 0) {
    document.getElementById("list-table").innerHTML = '<div class="empty"><p>' + esc(t("empty.list")) + '</p></div>';
    return;
  }
  if (items.length === 0) {
    document.getElementById("list-table").innerHTML = '<div class="empty"><p>' + esc(t("empty.list.filtered")) + '</p></div>';
    return;
  }

  var html = "<table><thead><tr>";
  html += "<th>" + esc(t("table.id")) + "</th><th>" + esc(t("table.title")) + "</th><th>" + esc(t("table.status")) + "</th><th>" + esc(t("table.priority")) + "</th><th>" + esc(t("table.type")) + "</th><th>" + esc(t("table.assigned")) + "</th><th>" + esc(t("table.updated")) + "</th>";
  html += "</tr></thead><tbody>";
  items.forEach(function(t) {
    var displayId = t.short_id || (t.id ? t.id.slice(0,18) + "..." : "?");
    var updated = t.updated_at ? t.updated_at.slice(0,16).replace("T"," ") : "";
    html += '<tr style="cursor:pointer" onclick="openDetailPanel(\'' + esc(t.id) + '\')">';
    html += '<td class="id-cell" title="' + esc(t.id) + '">' + (t.short_id ? '<span style="font-weight:600;color:var(--accent-primary)">' + esc(t.short_id) + '</span>' : esc(displayId)) + "</td>";
    html += "<td>" + esc(t.title || "Untitled") + (t.archived ? ' <span class="archived-badge">archived</span>' : "") + (t.comment_count ? ' <span style="color:var(--text-muted);font-size:.75rem" title="' + t.comment_count + ' comment' + (t.comment_count === 1 ? '' : 's') + '">\uD83D\uDCAC ' + t.comment_count + '</span>' : '') + "</td>";
    html += "<td>" + esc(t.status || "") + "</td>";
    html += "<td>";
    if (t.priority) html += '<span class="badge pri-' + esc(t.priority) + '">' + esc(t.priority) + "</span>";
    html += "</td>";
    html += "<td>" + esc(t.type || "") + "</td>";
    html += "<td>" + esc(t.assigned_to || "") + "</td>";
    html += "<td>" + esc(updated) + "</td>";
    html += "</tr>";
  });
  html += "</tbody></table>";
  document.getElementById("list-table").innerHTML = '<div style="overflow-x:auto">' + html + '</div>';
}

// --- Detail View ---
var _detailTaskId = null;
var _detailPanelTaskId = null;
var _detailPanelTrigger = null;

async function renderDetail(taskId) {
  var app = document.getElementById("app");
  app.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  _detailTaskId = taskId;

  try {
    var results = await Promise.all([
      api("/api/tasks/" + taskId),
      api("/api/tasks/" + taskId + "/events")
    ]);
    var task = results[0];
    var events = results[1];
    var isArchived = !!task.archived;

    var html = '<a href="#/' + esc(currentView) + '" class="back-link">' + t("btn.back") + '</a>';
    html += '<div class="detail">';

    // --- Title (inline editable) ---
    html += '<div class="detail-header">';
    if (isArchived) {
      html += '<div class="detail-title">' + esc(task.title || "Untitled") + ' <span class="archived-badge">ARCHIVED</span></div>';
    } else {
      html += '<div class="detail-title editable" id="detail-title" title="Click to edit">' + esc(task.title || "Untitled") + '</div>';
    }

    // --- Status + Action bar ---
    if (!isArchived) {
      html += '<div class="detail-actions">';
      // Status dropdown
      var transitions = (config && config.workflow && config.workflow.transitions) || {};
      var allowed = transitions[task.status] || [];
      html += '<select id="detail-status" title="Change status">';
      html += '<option value="' + esc(task.status) + '" selected>' + esc(task.status) + '</option>';
      allowed.forEach(function(s) {
        html += '<option value="' + esc(s) + '">' + esc(s) + '</option>';
      });
      html += '</select>';

      // Priority dropdown
      html += '<select id="detail-priority" title="Change priority">';
      ["critical","high","medium","low"].forEach(function(p) {
        html += '<option value="' + esc(p) + '"' + (p === task.priority ? ' selected' : '') + '>' + esc(p) + '</option>';
      });
      html += '</select>';

      // Type dropdown
      var types = (config && config.task_types) || [];
      html += '<select id="detail-type" title="Change type">';
      types.forEach(function(ty) {
        html += '<option value="' + esc(ty) + '"' + (ty === task.type ? ' selected' : '') + '>' + esc(ty) + '</option>';
      });
      html += '</select>';

      // Archive button
      html += '<button class="btn btn-danger btn-sm" id="detail-archive-btn">' + esc(t("btn.archive")) + '</button>';
      html += '</div>';
    } else {
      html += '<div class="detail-meta">';
      if (task.status) html += '<span class="badge badge-stat">' + esc(task.status) + '</span>';
      if (task.priority) html += '<span class="badge pri-' + esc(task.priority) + '">' + esc(task.priority) + '</span>';
      if (task.type) html += '<span class="badge type-badge">' + esc(task.type) + '</span>';
      html += '</div>';
    }
    html += '</div>';

    // --- Info fields ---
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">';
    if (task.short_id) html += '<div class="detail-field"><dt>' + esc(t("detail.short_id")) + '</dt><dd style="font-weight:600;color:var(--accent-primary)">' + esc(task.short_id) + '</dd></div>';
    var truncId = task.id && task.id.length > 12 ? task.id.slice(0, 12) + "\u2026" : (task.id || "");
    html += '<div class="detail-field" id="tech-id-field"><dt>' + esc(t("detail.tech_id")) + '</dt><dd id="tech-id-value" data-full="' + esc(task.id) + '" data-short="' + esc(truncId) + '" data-expanded="0" style="font-family:monospace;font-size:.8rem;cursor:pointer">' + esc(truncId) + '</dd></div>';

    // Assigned to (editable)
    if (!isArchived) {
      html += '<div class="detail-field"><dt>' + esc(t("detail.assigned_to")) + '</dt><dd>';
      html += '<span class="editable" id="detail-assigned" title="Click to edit">' + esc(task.assigned_to || t("detail.unassigned")) + '</span>';
      html += '</dd></div>';
    } else {
      html += '<div class="detail-field"><dt>' + esc(t("detail.assigned_to")) + '</dt><dd title="' + esc(task.assigned_to || t("detail.unassigned")) + '">' + esc(task.assigned_to || t("detail.unassigned")) + '</dd></div>';
    }

    var infoFields = [
      [t("detail.created_by"), task.created_by], [t("detail.created"), task.created_at], [t("detail.updated"), task.updated_at],
      [t("detail.urgency"), task.urgency]
    ];
    infoFields.forEach(function(pair) {
      if (pair[1]) {
        html += '<div class="detail-field"><dt>' + esc(pair[0]) + '</dt><dd title="' + esc(String(pair[1])) + '">' + esc(String(pair[1])) + '</dd></div>';
      }
    });
    html += '</div>';

    // --- Description (editable) ---
    html += '<div class="detail-section"><h3>' + esc(t("section.description")) + '</h3>';
    if (!isArchived) {
      html += '<pre class="editable" id="detail-description" style="white-space:pre-wrap;font-size:.9rem;min-height:20px" title="Click to edit">' + esc(task.description || t("detail.no_description")) + '</pre>';
    } else {
      html += '<pre style="white-space:pre-wrap;font-size:.9rem">' + esc(task.description || "") + '</pre>';
    }
    html += '</div>';

    // --- Tags (editable) ---
    html += '<div class="detail-section"><h3>' + esc(t("section.tags")) + '</h3>';
    if (!isArchived) {
      var tagStr = (task.tags && task.tags.length) ? task.tags.join(", ") : "";
      html += '<span class="editable" id="detail-tags" title="Click to edit">' + esc(tagStr || t("detail.no_tags")) + '</span>';
    } else if (task.tags && task.tags.length) {
      html += '<div>';
      task.tags.forEach(function(tag) { html += '<span class="badge badge-stat" style="margin-right:4px">' + esc(tag) + '</span>'; });
      html += '</div>';
    }
    html += '</div>';

    if (task.custom_fields && Object.keys(task.custom_fields).length) {
      html += '<div class="detail-section"><h3>' + esc(t("section.custom_fields")) + '</h3><dl>';
      Object.entries(task.custom_fields).forEach(function(pair) {
        html += '<dt>' + esc(pair[0]) + '</dt><dd>' + esc(String(pair[1])) + '</dd>';
      });
      html += '</dl></div>';
    }

    // Relationships
    if (task.relationships_out && task.relationships_out.length) {
      html += '<div class="detail-section"><h3>' + esc(t("section.relationships")) + '</h3><ul class="rel-list">';
      task.relationships_out.forEach(function(r) {
        html += '<li>' + esc(r.type) + ' &rarr; <a href="#/task/' + esc(r.target_task_id) + '">' + esc(r.target_task_id) + '</a>';
        if (r.note) html += ' (' + esc(r.note) + ')';
        html += '</li>';
      });
      html += '</ul></div>';
    }

    // Artifacts
    if (task.artifacts && task.artifacts.length) {
      html += '<div class="detail-section"><h3>' + esc(t("section.artifacts")) + '</h3><ul class="art-list">';
      task.artifacts.forEach(function(a) {
        html += '<li>' + esc(a.id);
        if (a.title) html += ' "' + esc(a.title) + '"';
        if (a.type) html += ' (' + esc(a.type) + ')';
        html += '</li>';
      });
      html += '</ul></div>';
    }

    // Plan â€” always visible, server scaffolds if file doesn't exist yet
    html += '<div class="detail-section"><h3>' + esc(t("section.plans")) + '</h3>';
    html += '<button class="btn btn-primary btn-sm" onclick="openPlans(\'' + esc(task.id) + '\')" style="margin-top:4px">' + esc(t("btn.show_plan")) + '</button>';
    if (task.plan_exists) {
      html += '<p style="font-size:.75rem;color:var(--text-muted);margin-top:6px"><code>plans/' + esc(task.id) + '.md</code></p>';
    }
    html += '</div>';

    // Notes
    if (task.notes_exists) {
      html += '<div class="detail-section"><h3>' + esc(t("section.notes")) + '</h3>';
      html += '<button class="btn btn-primary btn-sm" onclick="openNotes(\'' + esc(task.id) + '\')" style="margin-top:4px">' + esc(t("btn.show_notes")) + '</button>';
      html += '<p style="font-size:.75rem;color:var(--text-muted);margin-top:6px"><code>notes/' + esc(task.id) + '.md</code></p>';
      html += '</div>';
    }

    // --- Comments section ---
    var comments = (events || []).filter(function(ev) { return ev.type === "comment_added"; });
    html += '<div class="detail-section"><h3>' + esc(t("section.comments")) + ' (' + comments.length + ')</h3>';
    if (!isArchived) {
      html += '<div class="comment-form">';
      html += '<textarea class="form-control" id="detail-comment-text" placeholder="' + esc(t("placeholder.comment")) + '"></textarea>';
      html += '<button class="btn btn-primary btn-sm" id="detail-comment-submit" style="align-self:flex-end">' + esc(t("btn.post")) + '</button>';
      html += '</div>';
    }
    if (comments.length) {
      html += '<div style="margin-top:8px">';
      comments.forEach(function(ev) {
        html += '<div class="comment-item">';
        html += '<div class="comment-meta">' + esc(ev.actor || "") + ' &middot; ' + esc(ev.ts || "") + '</div>';
        html += '<div class="comment-body">' + esc((ev.data && ev.data.body) || "") + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }
    html += '</div>';

    // --- Events (non-comment) ---
    var nonCommentEvents = (events || []).filter(function(ev) { return ev.type !== "comment_added"; });
    if (nonCommentEvents.length) {
      html += '<div class="detail-section"><h3>' + esc(t("section.history")) + ' (' + nonCommentEvents.length + ')</h3>';
      nonCommentEvents.forEach(function(ev) {
        html += '<div class="event-item">';
        html += '<span class="event-ts">' + esc(ev.ts || "") + '</span>';
        html += '<span class="event-type badge badge-stat">' + esc(ev.type || "") + '</span>';
        html += '<span>' + eventSummary(ev) + '</span>';
        html += '<span class="event-actor">' + esc(ev.actor || "") + '</span>';
        html += '</div>';
      });
      html += '</div>';
    }

    html += '</div>';
    app.innerHTML = html;

    // Wire up interactive elements
    if (!isArchived) {
      _wireDetailActions(taskId, task);
    }

  } catch(e) {
    app.innerHTML = '<a href="#/' + esc(currentView) + '" class="back-link">' + t("btn.back") + '</a>' +
      '<div class="error-box"><p>' + esc(e.message) + '</p><button class="btn" onclick="location.reload()">' + esc(t("btn.retry")) + '</button></div>';
  }
}

// Wire up detail view interactive controls
function _wireDetailActions(taskId, task) {
  // Status change
  var statusSel = document.getElementById("detail-status");
  if (statusSel) {
    statusSel.addEventListener("change", async function() {
      var newStatus = this.value;
      if (newStatus === task.status) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/status", { status: newStatus });
        showToast(tf("toast.status_changed", {status: newStatus}), "success");
        tasks = await api("/api/tasks");
        updateAllBadges();
        renderDetail(taskId);
      } catch(e) {
        showToast(e.message, "error");
        this.value = task.status;
      }
    });
  }

  // Priority change
  var priSel = document.getElementById("detail-priority");
  if (priSel) {
    priSel.addEventListener("change", async function() {
      var newPri = this.value;
      if (newPri === task.priority) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/update", { fields: { priority: newPri } });
        showToast(tf("toast.priority_changed", {value: newPri}), "success");
        tasks = await api("/api/tasks");
        updateAllBadges();
        renderDetail(taskId);
      } catch(e) {
        showToast(e.message, "error");
        this.value = task.priority;
      }
    });
  }

  // Type change
  var typeSel = document.getElementById("detail-type");
  if (typeSel) {
    typeSel.addEventListener("change", async function() {
      var newType = this.value;
      if (newType === task.type) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/update", { fields: { type: newType } });
        showToast(tf("toast.type_changed", {value: newType}), "success");
        tasks = await api("/api/tasks");
        updateAllBadges();
        renderDetail(taskId);
      } catch(e) {
        showToast(e.message, "error");
        this.value = task.type;
      }
    });
  }

  // Title inline edit
  var titleEl = document.getElementById("detail-title");
  if (titleEl) {
    titleEl.addEventListener("click", function() {
      _inlineEdit(titleEl, task.title || "", function(newVal) {
        if (!newVal.trim()) { showToast(t("error.title_empty"), "error"); return Promise.reject(); }
        return apiPost("/api/tasks/" + taskId + "/update", { fields: { title: newVal.trim() } })
          .then(function() {
            showToast(t("toast.title_updated"), "success");
            api("/api/tasks").then(function(t) { tasks = t; updateAllBadges(); });
            renderDetail(taskId);
          });
      });
    });
  }

  // Description inline edit
  var descEl = document.getElementById("detail-description");
  if (descEl) {
    descEl.addEventListener("click", function() {
      var currentVal = task.description || "";
      _inlineEditTextarea(descEl, currentVal, function(newVal) {
        return apiPost("/api/tasks/" + taskId + "/update", { fields: { description: newVal } })
          .then(function() {
            showToast(t("toast.description_updated"), "success");
            renderDetail(taskId);
          });
      });
    });
  }

  // Assigned to inline edit (with member chips)
  var assignEl = document.getElementById("detail-assigned");
  if (assignEl) {
    assignEl.addEventListener("click", function() {
      if (assignEl.dataset.editing === "true") return;
      assignEl.dataset.editing = "true";

      var wrapper = document.createElement("div");
      var row = document.createElement("div");
      row.className = "inline-edit";
      var input = document.createElement("input");
      input.type = "text";
      input.className = "form-control";
      input.value = task.assigned_to || "";
      var saveBtn = document.createElement("button");
      saveBtn.className = "btn btn-primary btn-sm";
      saveBtn.textContent = t("btn.save");
      var cancelBtn = document.createElement("button");
      cancelBtn.className = "btn btn-sm";
      cancelBtn.textContent = t("btn.cancel");

      row.appendChild(input);
      row.appendChild(saveBtn);
      row.appendChild(cancelBtn);
      wrapper.appendChild(row);

      // Add member chips
      var chips = buildMemberChips(input);
      wrapper.appendChild(chips);

      var parent = assignEl.parentNode;
      parent.replaceChild(wrapper, assignEl);
      input.focus();
      input.select();

      function cancel() { parent.replaceChild(assignEl, wrapper); assignEl.dataset.editing = "false"; }

      cancelBtn.addEventListener("click", cancel);
      input.addEventListener("keydown", function(e) {
        if (e.key === "Escape") cancel();
        if (e.key === "Enter") saveBtn.click();
      });
      saveBtn.addEventListener("click", function() {
        var assignedTo = input.value.trim() || null;
        apiPost("/api/tasks/" + taskId + "/assign", { assigned_to: assignedTo })
          .then(function() {
            showToast(assignedTo ? tf("toast.assigned", {value: assignedTo}) : t("toast.unassigned"), "success");
            api("/api/tasks").then(function(t) { tasks = t; updateAllBadges(); });
            renderDetail(taskId);
          })
          .catch(function(e) {
            showToast(e.message, "error");
            cancel();
          });
      });
    });
  }

  // Tags inline edit
  var tagsEl = document.getElementById("detail-tags");
  if (tagsEl) {
    tagsEl.addEventListener("click", function() {
      var tagStr = (task.tags && task.tags.length) ? task.tags.join(", ") : "";
      _inlineEdit(tagsEl, tagStr, function(newVal) {
        var newTags = newVal.split(",").map(function(t){ return t.trim(); }).filter(Boolean);
        return apiPost("/api/tasks/" + taskId + "/update", { fields: { tags: newTags } })
          .then(function() {
            showToast(t("toast.tags_updated"), "success");
            api("/api/tasks").then(function(t) { tasks = t; updateAllBadges(); });
            renderDetail(taskId);
          });
      });
    });
  }

  // Comment submit
  var commentBtn = document.getElementById("detail-comment-submit");
  if (commentBtn) {
    commentBtn.addEventListener("click", async function() {
      if (commentBtn.disabled) return;
      var textarea = document.getElementById("detail-comment-text");
      var text = textarea.value.trim();
      if (!text) { showToast(t("error.comment_empty"), "error"); return; }
      commentBtn.disabled = true;
      try {
        await apiPost("/api/tasks/" + taskId + "/comment", { body: text });
        showToast(t("toast.comment_added"), "success");
        renderDetail(taskId);
      } catch(e) {
        showToast(e.message, "error");
      } finally {
        commentBtn.disabled = false;
      }
    });

    // Ctrl+Enter to submit
    document.getElementById("detail-comment-text").addEventListener("keydown", function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        e.preventDefault();
        commentBtn.click();
      }
    });
  }

  // Archive button
  var archiveBtn = document.getElementById("detail-archive-btn");
  if (archiveBtn) {
    archiveBtn.addEventListener("click", async function() {
      if (!confirm("Archive this task? It will be moved to the archive.")) return;
      try {
        await apiPost("/api/tasks/" + taskId + "/archive", {});
        showToast(t("toast.task_archived"), "success");
        tasks = await api("/api/tasks");
        updateAllBadges();
        location.hash = "#/" + currentView;
      } catch(e) {
        showToast(e.message, "error");
      }
    });
  }

  var techIdVal = document.getElementById("tech-id-value");
  if (techIdVal) {
    techIdVal.addEventListener("click", function(e) {
      e.stopPropagation();
      var d = this, p = d.parentElement;
      if (d.dataset.expanded === "0") {
        d.textContent = d.dataset.full;
        d.style.wordBreak = "break-all";
        p.style.gridColumn = "1 / -1";
        d.dataset.expanded = "1";
      } else {
        d.textContent = d.dataset.short;
        d.style.wordBreak = "";
        p.style.gridColumn = "";
        d.dataset.expanded = "0";
      }
    });
  }
}

// Inline edit: replaces element with input field
function _inlineEdit(el, currentValue, onSave) {
  if (el.dataset.editing === "true") return;
  el.dataset.editing = "true";

  var wrapper = document.createElement("div");
  wrapper.className = "inline-edit";
  var input = document.createElement("input");
  input.type = "text";
  input.className = "form-control";
  input.value = currentValue;
  var saveBtn = document.createElement("button");
  saveBtn.className = "btn btn-primary btn-sm";
  saveBtn.textContent = t("btn.save");
  var cancelBtn = document.createElement("button");
  cancelBtn.className = "btn btn-sm";
  cancelBtn.textContent = t("btn.cancel");

  wrapper.appendChild(input);
  wrapper.appendChild(saveBtn);
  wrapper.appendChild(cancelBtn);

  var parent = el.parentNode;
  parent.replaceChild(wrapper, el);
  input.focus();
  input.select();

  function cancel() { parent.replaceChild(el, wrapper); el.dataset.editing = "false"; }

  cancelBtn.addEventListener("click", cancel);
  input.addEventListener("keydown", function(e) {
    if (e.key === "Escape") cancel();
    if (e.key === "Enter") saveBtn.click();
  });
  saveBtn.addEventListener("click", function() {
    var result = onSave(input.value);
    if (result && result.catch) {
      result.catch(function() { cancel(); });
    }
  });
}

// Inline edit: textarea variant for multiline fields
function _inlineEditTextarea(el, currentValue, onSave) {
  if (el.dataset.editing === "true") return;
  el.dataset.editing = "true";

  var wrapper = document.createElement("div");
  var textarea = document.createElement("textarea");
  textarea.className = "form-control";
  textarea.value = currentValue;
  textarea.style.minHeight = "100px";
  var btnRow = document.createElement("div");
  btnRow.style.cssText = "display:flex;gap:6px;margin-top:6px;justify-content:flex-end";
  var saveBtn = document.createElement("button");
  saveBtn.className = "btn btn-primary btn-sm";
  saveBtn.textContent = t("btn.save");
  var cancelBtn = document.createElement("button");
  cancelBtn.className = "btn btn-sm";
  cancelBtn.textContent = t("btn.cancel");

  btnRow.appendChild(cancelBtn);
  btnRow.appendChild(saveBtn);
  wrapper.appendChild(textarea);
  wrapper.appendChild(btnRow);

  var parent = el.parentNode;
  parent.replaceChild(wrapper, el);
  textarea.focus();

  function cancel() { parent.replaceChild(el, wrapper); el.dataset.editing = "false"; }

  cancelBtn.addEventListener("click", cancel);
  textarea.addEventListener("keydown", function(e) {
    if (e.key === "Escape") cancel();
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") saveBtn.click();
  });
  saveBtn.addEventListener("click", function() {
    var result = onSave(textarea.value);
    if (result && result.catch) {
      result.catch(function() { cancel(); });
    }
  });
}

function eventSummary(ev) {
  var d = ev.data || {};
  switch(ev.type) {
    case "status_changed": return esc((d.from||"?") + " \u2192 " + (d.to||"?"));
    case "assignment_changed": return esc((d.from||"unassigned") + " \u2192 " + (d.to||"?"));
    case "field_updated": return esc(d.field + ": " + (d.from||"?") + " \u2192 " + (d.to||"?"));
    case "comment_added": {
      var body = d.body || "";
      if (body.length > 80) body = body.slice(0,77) + "...";
      return '"' + esc(body) + '"';
    }
    case "relationship_added": return esc(d.type) + " \u2192 " + esc(d.target_task_id||"");
    case "relationship_removed": return esc(d.type) + " -x- " + esc(d.target_task_id||"");
    case "artifact_attached": return "artifact " + esc(d.artifact_id||"");
    case "task_created": return "";
    default: return "";
  }
}

// --- Activity View ---
async function renderActivity() {
  var app = document.getElementById("app");
  app.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    var events = await api("/api/activity");
    if (events.length === 0) {
      app.innerHTML = '<div class="empty"><p>' + esc(t("empty.activity")) + '</p></div>';
      return;
    }
    var html = '<div class="activity-list">';
    // Build task_id lookups from loaded tasks
    var taskIdMap = {};
    tasks.forEach(function(t) {
      if (t.short_id) taskIdMap[t.id] = t.short_id;
    });

    events.forEach(function(ev) {
      var taskLabel = taskIdMap[ev.task_id] || (ev.task_id ? ev.task_id.slice(0,18)+"..." : "");
      html += '<div class="activity-item">';
      html += '<span class="event-ts">' + esc(ev.ts || "") + "</span>";
      html += '<span class="badge badge-stat">' + esc(ev.type || "") + "</span>";
      html += '<a href="#/task/' + esc(ev.task_id || "") + '"' + (taskIdMap[ev.task_id] ? ' style="font-weight:600;color:var(--accent-primary)"' : '') + '>' + esc(taskLabel) + "</a>";
      html += "<span>" + eventSummary(ev) + "</span>";
      html += '<span class="event-actor">' + esc(ev.actor || "") + "</span>";
      html += "</div>";
    });
    html += "</div>";
    app.innerHTML = html;
  } catch(e) {
    app.innerHTML = '<div class="error-box"><p>' + esc(e.message) + '</p><button class="btn" onclick="location.reload()">' + esc(t("btn.retry")) + '</button></div>';
  }
}

// --- Stats View ---
async function renderStats() {
  var app = document.getElementById("app");
  app.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    var data = await api("/api/stats");
    if (!data || !data.summary) {
      app.innerHTML = '<div class="empty"><p>' + esc(t("empty.stats")) + '</p></div>';
      return;
    }
    var html = '<div class="stats-view">';

    // Summary cards
    var sum = data.summary;
    html += '<div class="stats-cards">';
    html += '<div class="stats-card"><div class="stats-card-value">' + esc(sum.active_tasks) + '</div><div class="stats-card-label">' + esc(t("stats.active_tasks")) + '</div></div>';
    html += '<div class="stats-card"><div class="stats-card-value">' + esc(sum.archived_tasks) + '</div><div class="stats-card-label">' + esc(t("stats.archived_tasks")) + '</div></div>';
    html += '<div class="stats-card"><div class="stats-card-value">' + esc(sum.total_events) + '</div><div class="stats-card-label">' + esc(t("stats.total_events")) + '</div></div>';
    html += '<div class="stats-card"><div class="stats-card-value">' + esc(sum.active_events) + '</div><div class="stats-card-label">' + esc(t("stats.active_events")) + '</div></div>';
    html += '</div>';

    // WIP alerts
    if (data.wip && data.wip.length > 0) {
      var hasOver = false;
      data.wip.forEach(function(w) { if (w.over) hasOver = true; });
      if (hasOver) {
        html += '<div class="stats-wip-alerts">';
        data.wip.forEach(function(w) {
          if (w.over) {
            html += '<div class="stats-wip-alert">' + esc(t("stats.wip_exceeded")) + ': <strong>' + esc(w.status) + '</strong> &mdash; ' + esc(w.current) + '/' + esc(w.limit) + '</div>';
          }
        });
        html += '</div>';
      }
    }

    // Status distribution (horizontal bars)
    if (data.by_status && data.by_status.length > 0) {
      var maxStatus = 0;
      data.by_status.forEach(function(row) { if (row[1] > maxStatus) maxStatus = row[1]; });
      html += '<div class="stats-section"><h3>' + esc(t("stats.by_status")) + '</h3>';
      data.by_status.forEach(function(row) {
        var pct = maxStatus > 0 ? Math.round((row[1] / maxStatus) * 100) : 0;
        var color = getLaneColor(row[0]);
        html += '<div class="stats-bar-row">';
        html += '<span class="stats-bar-label">' + esc(row[0]) + '</span>';
        html += '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:' + pct + '%;background:' + esc(color) + '"></div></div>';
        html += '<span class="stats-bar-count">' + esc(row[1]) + '</span>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Distribution tables (priority, type, assignee, tags)
    var distPanels = [];
    if (data.by_priority && data.by_priority.length > 0) {
      distPanels.push({key: "stats.by_priority", rows: data.by_priority});
    }
    if (data.by_type && data.by_type.length > 0) {
      distPanels.push({key: "stats.by_type", rows: data.by_type});
    }
    if (data.by_assignee && data.by_assignee.length > 0) {
      distPanels.push({key: "stats.by_assignee", rows: data.by_assignee});
    }
    if (data.by_tag && data.by_tag.length > 0) {
      distPanels.push({key: "stats.by_tag", rows: data.by_tag});
    }
    if (distPanels.length > 0) {
      html += '<div class="stats-distributions">';
      distPanels.forEach(function(panel) {
        html += '<div class="stats-dist-card"><h4>' + esc(t(panel.key)) + '</h4>';
        html += '<table class="stats-dist-table">';
        panel.rows.forEach(function(row) {
          html += '<tr><td>' + esc(row[0]) + '</td><td class="stats-dist-count">' + esc(row[1]) + '</td></tr>';
        });
        html += '</table></div>';
      });
      html += '</div>';
    }

    // Recently active tasks
    if (data.recently_active && data.recently_active.length > 0) {
      html += '<div class="stats-section"><h3>' + esc(t("stats.recently_active")) + '</h3>';
      html += '<table><thead><tr><th>ID</th><th>' + esc(t("table.title")) + '</th><th>' + esc(t("table.status")) + '</th><th>' + esc(t("table.updated")) + '</th></tr></thead><tbody>';
      data.recently_active.forEach(function(task) {
        html += '<tr>';
        html += '<td class="id-cell"><a href="#/task/' + esc(task.full_id) + '">' + esc(task.id) + '</a></td>';
        html += '<td><a href="#/task/' + esc(task.full_id) + '">' + esc(task.title) + '</a></td>';
        html += '<td><span class="badge badge-stat">' + esc(task.status) + '</span></td>';
        html += '<td>' + esc(task.updated_ago) + '</td>';
        html += '</tr>';
      });
      html += '</tbody></table></div>';
    }

    // Stale tasks
    if (data.stale && data.stale.length > 0) {
      html += '<div class="stats-section stats-stale"><h3>' + esc(t("stats.stale_tasks")) + '</h3>';
      html += '<table><thead><tr><th>ID</th><th>' + esc(t("table.title")) + '</th><th>' + esc(t("table.status")) + '</th><th>Days Stale</th></tr></thead><tbody>';
      var staleShown = data.stale.slice(0, 10);
      staleShown.forEach(function(task) {
        html += '<tr>';
        html += '<td class="id-cell"><a href="#/task/' + esc(task.full_id) + '">' + esc(task.id) + '</a></td>';
        html += '<td><a href="#/task/' + esc(task.full_id) + '">' + esc(task.title) + '</a></td>';
        html += '<td><span class="badge badge-stat">' + esc(task.status) + '</span></td>';
        html += '<td>' + esc(typeof task.days_stale === "number" ? task.days_stale.toFixed(1) : task.days_stale) + '</td>';
        html += '</tr>';
      });
      html += '</tbody></table>';
      if (data.stale.length > 10) {
        html += '<p style="font-size:.8rem;color:var(--text-muted);margin-top:4px">...and ' + esc(data.stale.length - 10) + ' more</p>';
      }
      html += '</div>';
    }

    // Busiest tasks
    if (data.busiest && data.busiest.length > 0) {
      html += '<div class="stats-section"><h3>' + esc(t("stats.busiest_tasks")) + '</h3>';
      html += '<table><thead><tr><th>ID</th><th>' + esc(t("table.title")) + '</th><th>Events</th></tr></thead><tbody>';
      data.busiest.forEach(function(task) {
        html += '<tr>';
        html += '<td class="id-cell"><a href="#/task/' + esc(task.full_id) + '">' + esc(task.id) + '</a></td>';
        html += '<td><a href="#/task/' + esc(task.full_id) + '">' + esc(task.title) + '</a></td>';
        html += '<td style="font-weight:600">' + esc(task.event_count) + '</td>';
        html += '</tr>';
      });
      html += '</tbody></table></div>';
    }

    // === Quality Metrics ===
    html += '<div class="stats-metrics-heading">Quality Metrics</div>';

    // Velocity chart (tasks completed per week)
    if (data.velocity && data.velocity.length > 0) {
      var maxVel = 0;
      data.velocity.forEach(function(w) { if (w.count > maxVel) maxVel = w.count; });
      var totalDone = 0;
      data.velocity.forEach(function(w) { totalDone += w.count; });
      html += '<div class="stats-section"><h3>Velocity â€” Tasks Completed per Week (' + esc(totalDone) + ' total)</h3>';
      html += '<div class="velocity-chart">';
      data.velocity.forEach(function(w) {
        var pct = maxVel > 0 ? Math.round((w.count / maxVel) * 100) : 0;
        html += '<div class="velocity-bar-wrap">';
        html += '<div class="velocity-bar-count">' + (w.count > 0 ? esc(w.count) : '') + '</div>';
        html += '<div class="velocity-bar" style="height:' + Math.max(pct, 2) + '%"></div>';
        html += '<div class="velocity-bar-label">' + esc(w.week.replace(/^\d{4}-/, '')) + '</div>';
        html += '</div>';
      });
      html += '</div></div>';
    }

    // Time in status
    if (data.time_in_status && data.time_in_status.length > 0) {
      var maxTis = 0;
      data.time_in_status.forEach(function(r) { if (r.avg_hours > maxTis) maxTis = r.avg_hours; });
      html += '<div class="stats-section"><h3>Avg Time in Status</h3>';
      data.time_in_status.forEach(function(r) {
        var pct = maxTis > 0 ? Math.round((r.avg_hours / maxTis) * 100) : 0;
        var color = getLaneColor(r.status);
        var label = r.avg_hours >= 24 ? (r.avg_hours / 24).toFixed(1) + 'd' : r.avg_hours.toFixed(1) + 'h';
        html += '<div class="stats-bar-row">';
        html += '<span class="stats-bar-label">' + esc(r.status) + '</span>';
        html += '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:' + pct + '%;background:' + esc(color) + '"></div></div>';
        html += '<span class="stats-bar-count" title="' + esc(r.sample_count) + ' samples">' + esc(label) + '</span>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Blocked counts
    if (data.blocked) {
      html += '<div class="stats-section"><h3>Blocked</h3>';
      html += '<div class="blocked-cards">';
      html += '<div class="blocked-card"><div class="blocked-card-value' + (data.blocked.currently_blocked > 0 ? ' danger' : '') + '">' + esc(data.blocked.currently_blocked) + '</div><div class="blocked-card-label">Currently Blocked</div></div>';
      html += '<div class="blocked-card"><div class="blocked-card-value">' + esc(data.blocked.total_blocked_episodes) + '</div><div class="blocked-card-label">Total Episodes</div></div>';
      var avgBlk = data.blocked.avg_blocked_hours >= 24 ? (data.blocked.avg_blocked_hours / 24).toFixed(1) + 'd' : data.blocked.avg_blocked_hours.toFixed(1) + 'h';
      html += '<div class="blocked-card"><div class="blocked-card-value">' + esc(avgBlk) + '</div><div class="blocked-card-label">Avg Resolution</div></div>';
      html += '</div></div>';
    }

    // Agent activity
    if (data.agent_activity && data.agent_activity.length > 0) {
      var maxAct = 0;
      data.agent_activity.forEach(function(a) { if (a.event_count > maxAct) maxAct = a.event_count; });
      html += '<div class="stats-section"><h3>Agent & Actor Activity</h3>';
      data.agent_activity.forEach(function(a) {
        var pct = maxAct > 0 ? Math.round((a.event_count / maxAct) * 100) : 0;
        var isAgent = a.actor.startsWith('agent:');
        var chipClass = isAgent ? 'chip-agent' : (a.actor.startsWith('human:') ? 'chip-human' : 'chip-team');
        html += '<div class="stats-bar-row">';
        html += '<span class="stats-bar-label">' + esc(a.actor) + '</span>';
        html += '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:' + pct + '%;background:var(--' + chipClass + '-text)"></div></div>';
        html += '<span class="stats-bar-count">' + esc(a.event_count) + '</span>';
        html += '</div>';
      });
      html += '</div>';
    }

    html += '<div style="margin-top:2rem;padding-top:1rem;border-top:1px solid var(--border);font-size:.8rem;opacity:.6">';
    html += '<a href="/stats-demo" target="_blank" style="color:var(--accent)">Stats Demo Page</a> â€” 27 prototype improvements for review';
    html += '</div>';

    html += '</div>';
    app.innerHTML = html;
  } catch(e) {
    app.innerHTML = '<div class="error-box"><p>' + esc(e.message) + '</p><button class="btn" onclick="renderStats()">' + esc(t("btn.retry")) + '</button></div>';
  }
}

// --- Helpers ---
function esc(s) {
  if (s == null) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function showError(msg) {
  document.getElementById("app").innerHTML = '<div class="error-box"><p>' + esc(msg) + '</p><button class="btn" onclick="location.reload()">' + esc(t("btn.retry")) + '</button></div>';
}

// --- Member Chips ---
function buildMemberChips(inputEl) {
  var container = document.createElement("div");
  container.className = "member-chips";
  if (!config || !config.members) return container;

  var members = config.members;
  var prefixIcons = { human: "\ud83d\udc64", agent: "\ud83e\udd16", team: "\ud83d\udc65" };
  var order = ["human", "agent", "team"];

  order.forEach(function(prefix) {
    var list = members[prefix];
    if (!list || !list.length) return;
    list.forEach(function(name) {
      var chip = document.createElement("span");
      chip.className = "member-chip member-chip-" + prefix;
      chip.textContent = (prefixIcons[prefix] || "") + " " + name;
      chip.dataset.actorId = prefix + ":" + name;
      chip.addEventListener("click", function() {
        inputEl.value = chip.dataset.actorId;
        inputEl.focus();
      });
      container.appendChild(chip);
    });
  });

  return container;
}

function populateMemberChips(containerId, inputId) {
  var container = document.getElementById(containerId);
  var input = document.getElementById(inputId);
  if (!container || !input) return;
  container.innerHTML = "";
  var chips = buildMemberChips(input);
  while (chips.firstChild) container.appendChild(chips.firstChild);
}

// --- Create Task Modal ---
function showCreateTaskModal() {
  // Close floating detail panel if open
  if (_detailPanelTaskId) closeDetailPanel();
  var modal = document.getElementById("create-task-modal");
  // Populate type dropdown from config
  var typeSelect = document.getElementById("ct-type");
  typeSelect.innerHTML = "";
  var types = (config && config.task_types) || ["task"];
  types.forEach(function(t) {
    var opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    if (t === "task") opt.selected = true;
    typeSelect.appendChild(opt);
  });
  // Reset form
  document.getElementById("ct-title").value = "";
  document.getElementById("ct-priority").value = config ? (config.default_priority || "medium") : "medium";
  document.getElementById("ct-description").value = "";
  document.getElementById("ct-tags").value = "";
  document.getElementById("ct-assigned").value = "";
  populateMemberChips("ct-assigned-chips", "ct-assigned");
  modal.style.display = "flex";
  document.getElementById("ct-title").focus();
}

function hideCreateTaskModal() {
  document.getElementById("create-task-modal").style.display = "none";
}

document.getElementById("new-task-btn").addEventListener("click", showCreateTaskModal);
document.getElementById("create-task-close").addEventListener("click", hideCreateTaskModal);
document.getElementById("create-task-cancel").addEventListener("click", hideCreateTaskModal);

document.getElementById("create-task-modal").addEventListener("click", function(e) {
  if (e.target === this) hideCreateTaskModal();
});

document.getElementById("create-task-submit").addEventListener("click", async function() {
  var title = document.getElementById("ct-title").value.trim();
  if (!title) {
    showToast(t("error.title_required"), "error");
    return;
  }
  var payload = { title: title };
  var taskType = document.getElementById("ct-type").value;
  if (taskType) payload.type = taskType;
  var priority = document.getElementById("ct-priority").value;
  if (priority) payload.priority = priority;
  var desc = document.getElementById("ct-description").value.trim();
  if (desc) payload.description = desc;
  var tags = document.getElementById("ct-tags").value.trim();
  if (tags) payload.tags = tags.split(",").map(function(t){ return t.trim(); }).filter(Boolean);
  var assigned = document.getElementById("ct-assigned").value.trim();
  if (assigned) payload.assigned_to = assigned;

  try {
    var created = await apiPost("/api/tasks", payload);
    hideCreateTaskModal();
    showToast(tf("toast.task_created", {title: title}), "success");
    tasks = await api("/api/tasks");
    updateAllBadges();
    // Navigate to the new task's detail
    location.hash = "#/task/" + created.id;
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Allow Enter in title to submit
document.getElementById("ct-title").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    document.getElementById("create-task-submit").click();
  }
});

// --- Settings Panel ---
document.getElementById("settings-btn").addEventListener("click", function() {
  document.getElementById("settings-panel").classList.add("open");
});

document.getElementById("settings-close").addEventListener("click", function() {
  document.getElementById("settings-panel").classList.remove("open");
});

// Theme selector
document.getElementById("theme-select").addEventListener("change", async function() {
  var newTheme = this.value;
  applyTheme(newTheme);
  try {
    var result = await apiPost("/api/config/dashboard", {theme: newTheme});
    if (config) config.dashboard = result;
    populateLaneColorSettings();
    if (currentView === "board") renderBoard();
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Voice selector
document.getElementById("voice-select").addEventListener("change", async function() {
  var newVoice = this.value;
  currentVoice = newVoice;
  try {
    var result = await apiPost("/api/config/dashboard", {voice: newVoice});
    if (config) config.dashboard = result;
    updateStaticVoiceStrings();
    showToast(t("toast.voice_updated"), "success");
    await route(location.hash.slice(1) || "/board");
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Background image: save
document.getElementById("bg-image-save").addEventListener("click", async function() {
  var url = document.getElementById("bg-image-input").value.trim();
  try {
    var result = await apiPost("/api/config/dashboard", {background_image: url || null});
    if (config) config.dashboard = result;
    applyBackgroundImage();
    showToast(t("toast.bg_updated"), "success");
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Background image: clear
document.getElementById("bg-image-clear").addEventListener("click", async function() {
  document.getElementById("bg-image-input").value = "";
  try {
    var result = await apiPost("/api/config/dashboard", {background_image: null});
    if (config) config.dashboard = result;
    applyBackgroundImage();
    showToast(t("toast.bg_cleared"), "success");
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Lane colors: save
document.getElementById("lane-colors-save").addEventListener("click", async function() {
  var inputs = document.querySelectorAll("#lane-colors-list input[type=color]");
  var colors = {};
  inputs.forEach(function(inp) {
    colors[inp.dataset.status] = inp.value;
  });
  try {
    var result = await apiPost("/api/config/dashboard", {lane_colors: colors});
    if (config) config.dashboard = result;
    showToast(t("toast.lane_colors_updated"), "success");
    if (currentView === "board") renderBoard();
  } catch(e) {
    showToast(e.message, "error");
  }
});

// Lane colors: reset
document.getElementById("lane-colors-reset").addEventListener("click", async function() {
  try {
    var themeDefaults = LANE_COLORS_BY_THEME[getTheme()] || DEFAULT_LANE_COLORS;
    var result = await apiPost("/api/config/dashboard", {lane_colors: themeDefaults});
    if (config) config.dashboard = result;
    populateLaneColorSettings();
    showToast(t("toast.lane_colors_reset"), "success");
    if (currentView === "board") renderBoard();
  } catch(e) {
    showToast(e.message, "error");
  }
});

// --- Nav Events ---
document.querySelectorAll(".nav-tab").forEach(function(el) {
  el.addEventListener("click", function() { location.hash = "#/" + el.dataset.view; });
});

document.getElementById("help-btn").addEventListener("click", async function() {
  try {
    await apiPost("/api/open-guide", {});
    showToast("Opening user guide...", "success");
  } catch(e) { showToast("Could not open user guide: " + e.message, "error"); }
});

document.getElementById("refresh-btn").addEventListener("click", async function() {
  try {
    var results = await Promise.all([api("/api/config"), api("/api/tasks"), api("/api/graph").catch(function() { return { links: [] }; })]);
    config = results[0];
    tasks = results[1];
    boardGraphLinks = (results[2] && results[2].links) || [];
    archivedTasks = null;
    var dc = (config && config.dashboard) || {};
    if (dc.voice && VOICES[dc.voice]) currentVoice = dc.voice;
    updateAllBadges();
    applyTheme(getTheme());
    populateThemeSelector();
    populateVoiceSelector();
    updateStaticVoiceStrings();
    populateLaneColorSettings();
    loadBackgroundSetting();
    await route(location.hash.slice(1));
  } catch(e) { showError(e.message); }
});

// --- Auto-refresh ---
var autoRefreshInterval = null;
var AUTO_REFRESH_MS = 5000;

function startAutoRefresh() {
  stopAutoRefresh();
  autoRefreshInterval = setInterval(async function() {
    if (currentView !== "board" && currentView !== "list" && currentView !== "activity" && currentView !== "stats" && currentView !== "cube" && currentView !== "web") return;

    // Cube: revision-based refresh (independent data path)
    if (currentView === "cube") {
      try {
        var cubeGen = cubeRenderGeneration;
        var graphData = await api("/api/graph");
        if (cubeGen !== cubeRenderGeneration) return;
        if (currentView !== "cube") return;
        if (graphData.revision && graphData.revision !== cubeCurrentRevision) {
          updateCubeData(graphData);
        }
      } catch (e) { /* server may be restarting */ }
      return;
    }

    // Web: dual-source revision refresh
    if (currentView === "web") {
      try {
        var webGen = webRenderGeneration;
        var results = await Promise.all([
          api("/api/graph"),
          api("/api/git").catch(function() { return { available: false }; })
        ]);
        if (webGen !== webRenderGeneration) return;
        if (currentView !== "web") return;
        var newWebRevision = (results[0].revision || "") + ":" + ((results[1] && results[1].head_commit) || "");
        if (newWebRevision !== webCurrentRevision) {
          updateWebData(results[0], results[1]);
        }
      } catch (e) { /* server may be restarting */ }
      return;
    }

    try {
      var fetchPromises = [api("/api/tasks"), api("/api/config")];
      if (currentView === "board") fetchPromises.push(api("/api/graph").catch(function() { return { links: [] }; }));
      var fetchResults = await Promise.all(fetchPromises);
      var newTasks = fetchResults[0];
      var newConfig = fetchResults[1];
      if (fetchResults[2]) boardGraphLinks = (fetchResults[2] && fetchResults[2].links) || [];
      // Only re-render if data actually changed
      var tasksChanged = JSON.stringify(newTasks) !== JSON.stringify(tasks);
      var configChanged = JSON.stringify(newConfig) !== JSON.stringify(config);
      if (tasksChanged || configChanged) {
        tasks = newTasks;
        config = newConfig;
        updateAllBadges();
        if (configChanged) {
          var dca = (config && config.dashboard) || {};
          if (dca.voice && VOICES[dca.voice]) currentVoice = dca.voice;
          applyTheme(getTheme());
          populateThemeSelector();
          populateVoiceSelector();
          updateStaticVoiceStrings();
          populateLaneColorSettings();
          loadBackgroundSetting();
        }
        await route(location.hash.slice(1));
        // Silently refresh floating detail panel if open and no active edit
        if (_detailPanelTaskId && tasksChanged) {
          var dpBody = document.getElementById("dp-body");
          if (dpBody && !dpBody.querySelector("input:focus, textarea:focus")) {
            try {
              var dpResults = await Promise.all([
                api("/api/tasks/" + _detailPanelTaskId),
                api("/api/tasks/" + _detailPanelTaskId + "/events")
              ]);
              if (_detailPanelTaskId) _renderPanelContent(_detailPanelTaskId, dpResults[0], dpResults[1]);
            } catch(ex) { /* panel data fetch failed, ignore */ }
          }
        }
      }
    } catch(e) {
      // Silently ignore refresh errors â€” server may be restarting
    }
  }, AUTO_REFRESH_MS);
}

function stopAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
}

// Pause auto-refresh when tab is hidden to avoid unnecessary requests
document.addEventListener("visibilitychange", function() {
  if (document.hidden) {
    stopAutoRefresh();
  } else {
    startAutoRefresh();
  }
});

// --- Global Nav Search ---
(function() {
  var wrap = document.getElementById("nav-search");
  var btn = document.getElementById("nav-search-btn");
  var input = document.getElementById("nav-search-input");

  function openSearch() {
    wrap.classList.add("open");
    input.tabIndex = 0;
    btn.setAttribute("aria-expanded", "true");
    input.focus();
  }

  function closeSearch(clearValue) {
    wrap.classList.remove("open");
    input.tabIndex = -1;
    btn.setAttribute("aria-expanded", "false");
    if (clearValue) input.value = "";
    input.blur();
  }

  btn.addEventListener("click", function() {
    if (wrap.classList.contains("open")) {
      submitNavSearch();
    } else {
      openSearch();
    }
  });

  input.addEventListener("keydown", function(e) {
    if (e.key === "Enter") { e.preventDefault(); submitNavSearch(); }
    if (e.key === "Escape") { closeSearch(true); }
  });

  // Close on outside click
  document.addEventListener("click", function(e) {
    if (!wrap.contains(e.target) && wrap.classList.contains("open")) {
      closeSearch(false);
    }
  });

  // Global keyboard shortcut: "/" to open search
  document.addEventListener("keydown", function(e) {
    if (e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey) {
      var tag = (e.target.tagName || "").toLowerCase();
      if (tag === "input" || tag === "textarea" || tag === "select" || e.target.isContentEditable) return;
      e.preventDefault();
      openSearch();
    }
  });

  function submitNavSearch() {
    var q = (input.value || "").trim();
    if (!q) { closeSearch(false); return; }
    pendingSearch = q;
    closeSearch(true);
    location.hash = "#/list";
    // If already on list view, re-render to apply the search
    if (currentView === "list") renderList();
  }
})();

// --- Boot ---
init().then(function() { startAutoRefresh(); });

})();
</script>
</body>
</html>
